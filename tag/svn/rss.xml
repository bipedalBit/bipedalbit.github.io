<?xml version="1.0"?>
<rss version="2.0">
    <channel>
        <title>Hacking to the gate! • Posts by &#34;svn&#34; tag</title>
        <link>https://blog.bipedalbit.net</link>
        <description>Bipedal Bit&#39;s blog</description>
        <language>zh-CN</language>
        <pubDate>Tue, 10 Jun 2025 20:50:30 +0800</pubDate>
        <lastBuildDate>Tue, 10 Jun 2025 20:50:30 +0800</lastBuildDate>
        <category>Qt</category>
        <category>signal-slot</category>
        <category>Q_OBJECT</category>
        <category>nginx</category>
        <category>select/poll</category>
        <category>epoll</category>
        <category>ngx_int_t</category>
        <category>rbtree</category>
        <category>C</category>
        <category>static</category>
        <category>内存分布</category>
        <category>sublime</category>
        <category>C++</category>
        <category>makefile</category>
        <category>node.js</category>
        <category>github</category>
        <category>socket.io</category>
        <category>Web请求处理机制</category>
        <category>同步/异步</category>
        <category>阻塞/非阻塞</category>
        <category>事件驱动模型</category>
        <category>BP神经网络</category>
        <category>机器学习</category>
        <category>python</category>
        <category>pybrain</category>
        <category>c++11</category>
        <category>多线程</category>
        <category>ubuntu</category>
        <category>debian</category>
        <category>apt-file</category>
        <category>cin</category>
        <category>cout</category>
        <category>scanf</category>
        <category>printf</category>
        <category>进制转换</category>
        <category>人工神经网络</category>
        <category>人机博弈</category>
        <category>Maxmin</category>
        <category>AlphaBeta</category>
        <category>PVS</category>
        <category>MTD(f)</category>
        <category>位域</category>
        <category>bitset</category>
        <category>vector&amp;lt;bool&amp;gt;</category>
        <category>网络爬虫</category>
        <category>类脑</category>
        <category>codeigniter</category>
        <category>php</category>
        <category>IIS7</category>
        <category>apache</category>
        <category>模拟登录</category>
        <category>proxy</category>
        <category>domain</category>
        <category>DNS</category>
        <category>hexo</category>
        <category>vps</category>
        <category>dropbox</category>
        <category>ffmpeg</category>
        <category>板绘</category>
        <category>sai</category>
        <category>琪露诺</category>
        <category>LLM</category>
        <category>ollama</category>
        <category>open-webui</category>
        <category>oneapi</category>
        <category>mcpserver</category>
        <category>NAS</category>
        <category>minio</category>
        <category>CDN</category>
        <category>waline</category>
        <category>mcpo</category>
        <category>svn</category>
        <item>
            <guid isPermalink="true">https://blog.bipedalbit.net/2025/06/10/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E8%B4%A1%E7%8C%AE/</guid>
            <title>记一次开源项目贡献</title>
            <link>https://blog.bipedalbit.net/2025/06/10/%E8%AE%B0%E4%B8%80%E6%AC%A1%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E8%B4%A1%E7%8C%AE/</link>
            <category>github</category>
            <category>mcpo</category>
            <category>svn</category>
            <pubDate>Tue, 10 Jun 2025 20:50:30 +0800</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;前言&#34;&gt;&lt;a href=&#34;#前言&#34; class=&#34;headerlink&#34; title=&#34;前言&#34;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;给open-webui配各种mcp工具时，用了&lt;a href=&#34;https://docs.openwebui.com/openapi-servers/mcp/&#34;&gt;mcpo&lt;/a&gt;来对各种mcp-server做openapi规范的封装（实际上我只是希望用它的鉴权封装，虽然只是个简单的静态Bearer Token）。添加图表绘制工具&lt;a href=&#34;https://github.com/antvis/mcp-server-chart&#34;&gt;mcp-server-chart&lt;/a&gt;时，发现有报错，mcpo服务起不来。翻issue无果后，手痒了，提个pr吧。&lt;/p&gt;
&lt;h1 id=&#34;科普之协作开发&#34;&gt;&lt;a href=&#34;#科普之协作开发&#34; class=&#34;headerlink&#34; title=&#34;科普之协作开发&#34;&gt;&lt;/a&gt;科普之协作开发&lt;/h1&gt;&lt;p&gt;现代协作软件开发场景中，会有多个开发人员在同一个项目中分工迭代软件物料。虽然通常会按模块（横向分工隔离）或版本（纵向分工隔离）的维度做分工，尽量保证协作开发时大家更新的物料不发生重叠，但实际上很难避免冲突。&lt;/p&gt;
&lt;p&gt;协同场景物料版本管理在我可见范围内的主流方案是svn和git。值得注意的是，一些纯客户端项目，和大部分游戏项目，都倾向使用svn做开发版本管理，这凸显了2个版本管理工具的主要区别：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;从场景角度看：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;git擅长针对代码或文本做充分的diff追踪，命令多操作细，主要基于分支做权限管理，开源社区生态好；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;svn则可以对任意资源集做更精简的版本管理，还能做目录级别权限控制。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;从实现角度看：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;git的版本存储是分布式的，本地也会维护一份增量记录的完整版本历史，对代码、配置和少量文本资源来说，这足够了，但当项目中的多媒体甚至二进制资源文件多起来，磁盘占用会很可怕；&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;svn的版本存储是集中式的，本地不保留完整版本历史，每个分支做完整深拷贝冗余存储，所以通常不搞feature分支。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;总的来说，git是个代码版本管理工具，附带项目资源顺便管管还行，多了很伤；svn是个软件资源版本管理工具，diff追踪不会那么精细，但客户端负担小、资源权限管理细。&lt;/p&gt;
&lt;h1 id=&#34;github开源贡献流程&#34;&gt;&lt;a href=&#34;#github开源贡献流程&#34; class=&#34;headerlink&#34; title=&#34;github开源贡献流程&#34;&gt;&lt;/a&gt;github开源贡献流程&lt;/h1&gt;&lt;ol&gt;
&lt;li&gt;确认issue&lt;/li&gt;
&lt;li&gt;fork&lt;/li&gt;
&lt;li&gt;开发&lt;/li&gt;
&lt;li&gt;提交pr&lt;/li&gt;
&lt;li&gt;review&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id=&#34;确认issue&#34;&gt;&lt;a href=&#34;#确认issue&#34; class=&#34;headerlink&#34; title=&#34;确认issue&#34;&gt;&lt;/a&gt;确认issue&lt;/h2&gt;&lt;p&gt;开源社区很大，如果一个开源项目足够活跃，那么很有可能项目issue里有人讨论过相同的问题或是相关的问题，开源社区就是容易给项目带来这种类似被动众测的buff。&lt;/p&gt;
&lt;p&gt;翻issue的主要目的有2个：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;找分析：用于快速定位问题场景和相关症结，定位坑后能绕就绕，绕不开也方便修。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;找解法：如果急着用项目，issue里可能会发现一些没有审完的pr或者野生的release版本或者一些fix代码。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;确认项目issue里没有合用的问题解法，而自己有解法且愿意做开源贡献时，就可以做下一步了。&lt;/p&gt;
&lt;h2 id=&#34;fork&#34;&gt;&lt;a href=&#34;#fork&#34; class=&#34;headerlink&#34; title=&#34;fork&#34;&gt;&lt;/a&gt;fork&lt;/h2&gt;&lt;p&gt;github的常规开源贡献方式是fork项目到个人空间方便获取完全权限，然后进行分支操作和开发。&lt;/p&gt;
&lt;p&gt;如果你是项目的主创团队成员，也许你有权限直接在当前项目上创建自己的feature分支进行开发。&lt;/p&gt;
&lt;p&gt;例如，要fork mcpo项目可以点击项目github首页的fork按钮，进入&lt;a href=&#34;https://github.com/open-webui/mcpo/fork&#34;&gt;fork发起页面&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;选择fork项目到组织或个人空间，可以修改项目名和项目描述，可以选择是否只fork项目的main分支（github的默认项目主分支）。&lt;/p&gt;
&lt;p&gt;选分支时需要确认当前项目的分支逻辑，确保fork时包含希望合入代码的分支。例如，mcpo项目的主分支是main，开发分支是dev，所有feature分支需要在经过评审后合入dev分支，对dev分支做版本测试，dev分支在合适时机合入main分支并打上版本tag，打包发布对应release版本。&lt;/p&gt;
&lt;h2 id=&#34;开发&#34;&gt;&lt;a href=&#34;#开发&#34; class=&#34;headerlink&#34; title=&#34;开发&#34;&gt;&lt;/a&gt;开发&lt;/h2&gt;&lt;p&gt;还是以这次我给mcpo项目提cr为例。问题背景我在pr的&lt;a href=&#34;https://github.com/open-webui/mcpo/pull/174&#34;&gt;review issue&lt;/a&gt;里有描述，大致上是这样：&lt;/p&gt;
&lt;p&gt;mcpo在给各种mcp-server做openapi规范封装时会自动生成接口文档，而接口文档的入参出参说明的生成需要走以下流程来完成：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;按照&lt;a href=&#34;https://modelcontextprotocol.io/introduction&#34;&gt;MCP（Model Context Protocol）&lt;/a&gt;这个协议，调用mcp server接口（目前有Stdio、SSE、StreamableHTTP三种通信模式），拉取输入、输出schema&lt;/li&gt;
&lt;li&gt;解析输入、输出schema，完成结构化&lt;/li&gt;
&lt;li&gt;根据结构化数据生成接口入参出参说明文档，用于进行接口文档渲染&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;我在mcpo的配置文件里包含了&lt;a href=&#34;https://github.com/antvis/mcp-server-chart&#34;&gt;mcp-server-chart&lt;/a&gt;，试图正常启动mcpo服务：&lt;/p&gt;
&lt;figure class=&#34;highlight json&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;code class=&#34;hljs json&#34;&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;  &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;mcpServers&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;mcp-server-chart&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;      &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;command&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;npx&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;      &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;args&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;[&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;-y&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;@antv/mcp-server-chart&amp;quot;&lt;/span&gt;&lt;br&gt;      &lt;span class=&#34;hljs-punctuation&#34;&gt;]&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;  &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;发现报错了（捞个issue里的相同报错日志贴上来，懒得复现问题捞日志）：&lt;/p&gt;
&lt;figure class=&#34;highlight coq&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;code class=&#34;hljs coq&#34;&gt;ERROR:      + Exception Group Traceback (most recent call last):&lt;br&gt;  |   &lt;span class=&#34;hljs-type&#34;&gt;File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/.venv/lib/python3.11/site-packages/starlette/routing.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;692&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; lifespan&lt;br&gt;  |     &lt;span class=&#34;hljs-type&#34;&gt;async&lt;/span&gt; &lt;span class=&#34;hljs-built_in&#34;&gt;with&lt;/span&gt; self.lifespan_context(app) &lt;span class=&#34;hljs-built_in&#34;&gt;as&lt;/span&gt; maybe_state:&lt;br&gt;  |   &lt;span class=&#34;hljs-type&#34;&gt;File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/opt/homebrew/Cellar/python@3.11/3.11.10/Frameworks/Python.framework/Versions/3.11/lib/python3.11/contextlib.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;210&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; __aenter__&lt;br&gt;  |     &lt;span class=&#34;hljs-type&#34;&gt;return&lt;/span&gt; await anext(self.gen)&lt;br&gt;  |            &lt;span class=&#34;hljs-type&#34;&gt;^^^^^^^^^^^^^^^^^^^^^&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-type&#34;&gt;  |   File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/src/mcpo/main.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;104&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; lifespan&lt;br&gt;  |     &lt;span class=&#34;hljs-type&#34;&gt;async&lt;/span&gt; &lt;span class=&#34;hljs-built_in&#34;&gt;with&lt;/span&gt; stdio_client(server_params) &lt;span class=&#34;hljs-built_in&#34;&gt;as&lt;/span&gt; (reader, writer):&lt;br&gt;  |   &lt;span class=&#34;hljs-type&#34;&gt;File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/opt/homebrew/Cellar/python@3.11/3.11.10/Frameworks/Python.framework/Versions/3.11/lib/python3.11/contextlib.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;231&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; __aexit__&lt;br&gt;  |     &lt;span class=&#34;hljs-type&#34;&gt;await&lt;/span&gt; self.gen.athrow(typ, value, traceback)&lt;br&gt;  |   &lt;span class=&#34;hljs-type&#34;&gt;File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/.venv/lib/python3.11/site-packages/mcp/client/stdio/__init__.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;166&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; stdio_client&lt;br&gt;  |     &lt;span class=&#34;hljs-type&#34;&gt;async&lt;/span&gt; &lt;span class=&#34;hljs-built_in&#34;&gt;with&lt;/span&gt; (&lt;br&gt;  |   &lt;span class=&#34;hljs-type&#34;&gt;File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;772&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; __aexit__&lt;br&gt;  |     &lt;span class=&#34;hljs-type&#34;&gt;raise&lt;/span&gt; BaseExceptionGroup(&lt;br&gt;  | &lt;span class=&#34;hljs-type&#34;&gt;ExceptionGroup&lt;/span&gt;: unhandled errors &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; a TaskGroup (&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt; sub-exception)&lt;br&gt;  +-+---------------- &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt; ----------------&lt;br&gt;    | &lt;span class=&#34;hljs-type&#34;&gt;Exception&lt;/span&gt; Group Traceback (most recent call last):&lt;br&gt;    |   &lt;span class=&#34;hljs-type&#34;&gt;File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/.venv/lib/python3.11/site-packages/mcp/client/stdio/__init__.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;173&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; stdio_client&lt;br&gt;    |     &lt;span class=&#34;hljs-type&#34;&gt;yield&lt;/span&gt; read_stream, write_stream&lt;br&gt;    |   &lt;span class=&#34;hljs-type&#34;&gt;File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/src/mcpo/main.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;105&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; lifespan&lt;br&gt;    |     &lt;span class=&#34;hljs-type&#34;&gt;async&lt;/span&gt; &lt;span class=&#34;hljs-built_in&#34;&gt;with&lt;/span&gt; ClientSession(reader, writer) &lt;span class=&#34;hljs-built_in&#34;&gt;as&lt;/span&gt; session:&lt;br&gt;    |   &lt;span class=&#34;hljs-type&#34;&gt;File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/.venv/lib/python3.11/site-packages/anyio/_backends/_asyncio.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;772&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; __aexit__&lt;br&gt;    |     &lt;span class=&#34;hljs-type&#34;&gt;raise&lt;/span&gt; BaseExceptionGroup(&lt;br&gt;    | &lt;span class=&#34;hljs-type&#34;&gt;ExceptionGroup&lt;/span&gt;: unhandled errors &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; a TaskGroup (&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt; sub-exception)&lt;br&gt;    +-+---------------- &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt; ----------------&lt;br&gt;      | &lt;span class=&#34;hljs-type&#34;&gt;Traceback&lt;/span&gt; (most recent call last):&lt;br&gt;      |   &lt;span class=&#34;hljs-type&#34;&gt;File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/src/mcpo/main.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;107&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; lifespan&lt;br&gt;      |     &lt;span class=&#34;hljs-type&#34;&gt;await&lt;/span&gt; create_dynamic_endpoints(app, api_dependency=api_dependency)&lt;br&gt;      |   &lt;span class=&#34;hljs-type&#34;&gt;File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/src/mcpo/main.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;43&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; create_dynamic_endpoints&lt;br&gt;      |     &lt;span class=&#34;hljs-type&#34;&gt;form_model_fields&lt;/span&gt; = get_model_fields(&lt;br&gt;      |                         &lt;span class=&#34;hljs-type&#34;&gt;^^^^^^^^^^^^^^^^^&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-type&#34;&gt;      |   File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/src/mcpo/utils/main.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;182&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; get_model_fields&lt;br&gt;      |     &lt;span class=&#34;hljs-type&#34;&gt;python_type_hint&lt;/span&gt;, pydantic_field_info = _process_schema_property(&lt;br&gt;      |                                             &lt;span class=&#34;hljs-type&#34;&gt;^^^^^^^^^^^^^^^^^^^^^^^^^&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-type&#34;&gt;      |   File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/src/mcpo/utils/main.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;84&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; _process_schema_property&lt;br&gt;      |     &lt;span class=&#34;hljs-type&#34;&gt;type_hint&lt;/span&gt;, &lt;span class=&#34;hljs-keyword&#34;&gt;_&lt;/span&gt; = _process_schema_property(&lt;br&gt;      |                    &lt;span class=&#34;hljs-type&#34;&gt;^^^^^^^^^^^^^^^^^^^^^^^^^&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-type&#34;&gt;      |   File&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/Users/ddrag/IdeaProjects/mcpo/src/mcpo/utils/main.py&amp;quot;&lt;/span&gt;, line &lt;span class=&#34;hljs-number&#34;&gt;70&lt;/span&gt;, &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; _process_schema_property&lt;br&gt;      |     &lt;span class=&#34;hljs-type&#34;&gt;assert&lt;/span&gt; ref &lt;span class=&#34;hljs-built_in&#34;&gt;in&lt;/span&gt; schema_defs, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Custom field not found&amp;quot;&lt;/span&gt;&lt;br&gt;      |            &lt;span class=&#34;hljs-type&#34;&gt;^^^^^^^^^^^^^^^^^^&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-type&#34;&gt;      | TypeError&lt;/span&gt;: argument of type &amp;#x27;NoneType&amp;#x27; is not iterable&lt;br&gt;      +------------------------------------&lt;br&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;我们可以看看这个&lt;code&gt;mcpo/src/mcpo/utils/main.py&lt;/code&gt;里的&lt;code&gt;_process_schema_property()&lt;/code&gt;函数在做什么：&lt;/p&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;52&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;53&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;54&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;55&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;56&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;57&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;58&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;59&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;60&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;61&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;62&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;63&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;64&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;65&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;66&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;67&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;68&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;69&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;70&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;71&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;72&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;73&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;74&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;75&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;76&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;77&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;78&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;79&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;80&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;81&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;82&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;83&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;84&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;85&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;86&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;87&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;88&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;89&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;90&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;91&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;92&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;93&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;94&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;95&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;96&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;97&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;98&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;99&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;100&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;101&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;102&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;103&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;104&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;105&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;106&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;107&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;108&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;109&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;110&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;111&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;112&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;113&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;114&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;115&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;116&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;117&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;118&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;119&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;120&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;121&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;122&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;123&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;124&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;125&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;126&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;127&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;128&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;129&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;130&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;131&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;132&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;133&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;code class=&#34;hljs python&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;_process_schema_property&lt;/span&gt;&lt;br&gt;(&lt;br&gt;    _model_cache: &lt;span class=&#34;hljs-type&#34;&gt;Dict&lt;/span&gt;[&lt;span class=&#34;hljs-built_in&#34;&gt;str&lt;/span&gt;, &lt;span class=&#34;hljs-type&#34;&gt;Type&lt;/span&gt;],&lt;br&gt;    prop_schema: &lt;span class=&#34;hljs-type&#34;&gt;Dict&lt;/span&gt;[&lt;span class=&#34;hljs-built_in&#34;&gt;str&lt;/span&gt;, &lt;span class=&#34;hljs-type&#34;&gt;Any&lt;/span&gt;],&lt;br&gt;    model_name_prefix: &lt;span class=&#34;hljs-built_in&#34;&gt;str&lt;/span&gt;,&lt;br&gt;    prop_name: &lt;span class=&#34;hljs-built_in&#34;&gt;str&lt;/span&gt;,&lt;br&gt;    is_required: &lt;span class=&#34;hljs-built_in&#34;&gt;bool&lt;/span&gt;,&lt;br&gt;    schema_defs: &lt;span class=&#34;hljs-type&#34;&gt;Optional&lt;/span&gt;[&lt;span class=&#34;hljs-type&#34;&gt;Dict&lt;/span&gt;] = &lt;span class=&#34;hljs-literal&#34;&gt;None&lt;/span&gt;,&lt;br&gt;) -&amp;gt; &lt;span class=&#34;hljs-built_in&#34;&gt;tuple&lt;/span&gt;[&lt;span class=&#34;hljs-type&#34;&gt;Union&lt;/span&gt;[&lt;span class=&#34;hljs-type&#34;&gt;Type&lt;/span&gt;, &lt;span class=&#34;hljs-type&#34;&gt;List&lt;/span&gt;, ForwardRef, &lt;span class=&#34;hljs-type&#34;&gt;Any&lt;/span&gt;], FieldInfo]:&lt;br&gt;    &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-string&#34;&gt;    Recursively processes a schema property to determine its Python type hint&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-string&#34;&gt;    and Pydantic Field definition.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-string&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-string&#34;&gt;    Returns:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-string&#34;&gt;        A tuple containing (python_type_hint, pydantic_field).&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-string&#34;&gt;        The pydantic_field contains default value and description.&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-string&#34;&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;$ref&amp;quot;&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; prop_schema:&lt;br&gt;        ref = prop_schema[&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;$ref&amp;quot;&lt;/span&gt;]&lt;br&gt;        ref = ref.split(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;)[-&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;]&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;assert&lt;/span&gt; ref &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; schema_defs, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Custom field not found&amp;quot;&lt;/span&gt;&lt;br&gt;        prop_schema = schema_defs[ref]&lt;br&gt;&lt;br&gt;    prop_type = prop_schema.get(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;)&lt;br&gt;    prop_desc = prop_schema.get(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;description&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;)&lt;br&gt;&lt;br&gt;    default_value = ... &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; is_required &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt; prop_schema.get(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;default&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-literal&#34;&gt;None&lt;/span&gt;)&lt;br&gt;    pydantic_field = Field(default=default_value, description=prop_desc)&lt;br&gt;&lt;br&gt;    &lt;span class=&#34;hljs-comment&#34;&gt;# Handle the case where prop_type is missing but &amp;#x27;anyOf&amp;#x27; key exists&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-comment&#34;&gt;# In this case, use data type from &amp;#x27;anyOf&amp;#x27; to determine the type hint&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;anyOf&amp;quot;&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; prop_schema:&lt;br&gt;        type_hints = []&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;for&lt;/span&gt; i, schema_option &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;hljs-built_in&#34;&gt;enumerate&lt;/span&gt;(prop_schema[&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;anyOf&amp;quot;&lt;/span&gt;]):&lt;br&gt;            type_hint, _ = _process_schema_property(&lt;br&gt;                _model_cache,&lt;br&gt;                schema_option,&lt;br&gt;                &lt;span class=&#34;hljs-string&#34;&gt;f&amp;quot;&lt;span class=&#34;hljs-subst&#34;&gt;&amp;#123;model_name_prefix&amp;#125;&lt;/span&gt;_&lt;span class=&#34;hljs-subst&#34;&gt;&amp;#123;prop_name&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;,&lt;br&gt;                &lt;span class=&#34;hljs-string&#34;&gt;f&amp;quot;choice_&lt;span class=&#34;hljs-subst&#34;&gt;&amp;#123;i&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;,&lt;br&gt;                &lt;span class=&#34;hljs-literal&#34;&gt;False&lt;/span&gt;,&lt;br&gt;            )&lt;br&gt;            type_hints.append(type_hint)&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-type&#34;&gt;Union&lt;/span&gt;[&lt;span class=&#34;hljs-built_in&#34;&gt;tuple&lt;/span&gt;(type_hints)], pydantic_field&lt;br&gt;&lt;br&gt;    &lt;span class=&#34;hljs-comment&#34;&gt;# Handle the case where prop_type is a list of types, e.g. [&amp;#x27;string&amp;#x27;, &amp;#x27;number&amp;#x27;]&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;hljs-built_in&#34;&gt;isinstance&lt;/span&gt;(prop_type, &lt;span class=&#34;hljs-built_in&#34;&gt;list&lt;/span&gt;):&lt;br&gt;        &lt;span class=&#34;hljs-comment&#34;&gt;# Create a Union of all the types&lt;/span&gt;&lt;br&gt;        type_hints = []&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;for&lt;/span&gt; type_option &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; prop_type:&lt;br&gt;            &lt;span class=&#34;hljs-comment&#34;&gt;# Create a temporary schema with the single type and process it&lt;/span&gt;&lt;br&gt;            temp_schema = &lt;span class=&#34;hljs-built_in&#34;&gt;dict&lt;/span&gt;(prop_schema)&lt;br&gt;            temp_schema[&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;] = type_option&lt;br&gt;            type_hint, _ = _process_schema_property(&lt;br&gt;                _model_cache, temp_schema, model_name_prefix, prop_name, &lt;span class=&#34;hljs-literal&#34;&gt;False&lt;/span&gt;&lt;br&gt;            )&lt;br&gt;            type_hints.append(type_hint)&lt;br&gt;&lt;br&gt;        &lt;span class=&#34;hljs-comment&#34;&gt;# Return a Union of all possible types&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-type&#34;&gt;Union&lt;/span&gt;[&lt;span class=&#34;hljs-built_in&#34;&gt;tuple&lt;/span&gt;(type_hints)], pydantic_field&lt;br&gt;&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; prop_type == &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;object&amp;quot;&lt;/span&gt;:&lt;br&gt;        nested_properties = prop_schema.get(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;properties&amp;quot;&lt;/span&gt;, &amp;#123;&amp;#125;)&lt;br&gt;        nested_required = prop_schema.get(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;required&amp;quot;&lt;/span&gt;, [])&lt;br&gt;        nested_fields = &amp;#123;&amp;#125;&lt;br&gt;&lt;br&gt;        nested_model_name = &lt;span class=&#34;hljs-string&#34;&gt;f&amp;quot;&lt;span class=&#34;hljs-subst&#34;&gt;&amp;#123;model_name_prefix&amp;#125;&lt;/span&gt;_&lt;span class=&#34;hljs-subst&#34;&gt;&amp;#123;prop_name&amp;#125;&lt;/span&gt;_model&amp;quot;&lt;/span&gt;.replace(&lt;br&gt;            &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;__&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;_&amp;quot;&lt;/span&gt;&lt;br&gt;        ).rstrip(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;_&amp;quot;&lt;/span&gt;)&lt;br&gt;&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; nested_model_name &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; _model_cache:&lt;br&gt;            &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; _model_cache[nested_model_name], pydantic_field&lt;br&gt;&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;for&lt;/span&gt; name, schema &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; nested_properties.items():&lt;br&gt;            is_nested_required = name &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; nested_required&lt;br&gt;            nested_type_hint, nested_pydantic_field = _process_schema_property(&lt;br&gt;                _model_cache,&lt;br&gt;                schema,&lt;br&gt;                nested_model_name,&lt;br&gt;                name,&lt;br&gt;                is_nested_required,&lt;br&gt;                schema_defs,&lt;br&gt;            )&lt;br&gt;&lt;br&gt;            &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; name_needs_alias(name):&lt;br&gt;                other_names = &lt;span class=&#34;hljs-built_in&#34;&gt;set&lt;/span&gt;().union(nested_properties, nested_fields, _model_cache)&lt;br&gt;                alias_name = generate_alias_name(name, other_names)&lt;br&gt;                aliased_field = Field(&lt;br&gt;                    default=nested_pydantic_field.default,&lt;br&gt;                    description=nested_pydantic_field.description,&lt;br&gt;                    alias=name&lt;br&gt;                )&lt;br&gt;                nested_fields[alias_name] = (nested_type_hint, aliased_field)&lt;br&gt;            &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;:&lt;br&gt;                nested_fields[name] = (nested_type_hint, nested_pydantic_field)&lt;br&gt;&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;not&lt;/span&gt; nested_fields:&lt;br&gt;            &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-type&#34;&gt;Dict&lt;/span&gt;[&lt;span class=&#34;hljs-built_in&#34;&gt;str&lt;/span&gt;, &lt;span class=&#34;hljs-type&#34;&gt;Any&lt;/span&gt;], pydantic_field&lt;br&gt;&lt;br&gt;        NestedModel = create_model(nested_model_name, **nested_fields)&lt;br&gt;        _model_cache[nested_model_name] = NestedModel&lt;br&gt;&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; NestedModel, pydantic_field&lt;br&gt;&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;elif&lt;/span&gt; prop_type == &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;array&amp;quot;&lt;/span&gt;:&lt;br&gt;        items_schema = prop_schema.get(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;items&amp;quot;&lt;/span&gt;)&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;not&lt;/span&gt; items_schema:&lt;br&gt;            &lt;span class=&#34;hljs-comment&#34;&gt;# Default to list of anything if items schema is missing&lt;/span&gt;&lt;br&gt;            &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-type&#34;&gt;List&lt;/span&gt;[&lt;span class=&#34;hljs-type&#34;&gt;Any&lt;/span&gt;], pydantic_field&lt;br&gt;&lt;br&gt;        &lt;span class=&#34;hljs-comment&#34;&gt;# Recursively determine the type of items in the array&lt;/span&gt;&lt;br&gt;        item_type_hint, _ = _process_schema_property(&lt;br&gt;            _model_cache,&lt;br&gt;            items_schema,&lt;br&gt;            &lt;span class=&#34;hljs-string&#34;&gt;f&amp;quot;&lt;span class=&#34;hljs-subst&#34;&gt;&amp;#123;model_name_prefix&amp;#125;&lt;/span&gt;_&lt;span class=&#34;hljs-subst&#34;&gt;&amp;#123;prop_name&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;,&lt;br&gt;            &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;item&amp;quot;&lt;/span&gt;,&lt;br&gt;            &lt;span class=&#34;hljs-literal&#34;&gt;False&lt;/span&gt;,  &lt;span class=&#34;hljs-comment&#34;&gt;# Items aren&amp;#x27;t required at this level,&lt;/span&gt;&lt;br&gt;            schema_defs,&lt;br&gt;        )&lt;br&gt;        list_type_hint = &lt;span class=&#34;hljs-type&#34;&gt;List&lt;/span&gt;[item_type_hint]&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; list_type_hint, pydantic_field&lt;br&gt;&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;elif&lt;/span&gt; prop_type == &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;string&amp;quot;&lt;/span&gt;:&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-built_in&#34;&gt;str&lt;/span&gt;, pydantic_field&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;elif&lt;/span&gt; prop_type == &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;integer&amp;quot;&lt;/span&gt;:&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-built_in&#34;&gt;int&lt;/span&gt;, pydantic_field&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;elif&lt;/span&gt; prop_type == &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;boolean&amp;quot;&lt;/span&gt;:&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-built_in&#34;&gt;bool&lt;/span&gt;, pydantic_field&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;elif&lt;/span&gt; prop_type == &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;number&amp;quot;&lt;/span&gt;:&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-built_in&#34;&gt;float&lt;/span&gt;, pydantic_field&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;elif&lt;/span&gt; prop_type == &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;null&amp;quot;&lt;/span&gt;:&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;None&lt;/span&gt;, pydantic_field&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;:&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-type&#34;&gt;Any&lt;/span&gt;, pydantic_field&lt;br&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;这是一个可以被递归调用的函数，用来处理schema结构里的递归结构，我们可以对照一个schema的例子来理解，这是我从&lt;a href=&#34;https://github.com/antvis/mcp-server-chart&#34;&gt;mcp-server-chart&lt;/a&gt;项目里捞的&lt;a href=&#34;https://github.com/antvis/mcp-server-chart/blob/3ec6d0893f7c0bbf09b8e6776a75dd92595ce934/__tests__/charts/fishbone-diagram.json&#34;&gt;一个工具的input schema&lt;/a&gt;：&lt;/p&gt;
&lt;figure class=&#34;highlight json&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;48&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;49&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;50&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;51&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;code class=&#34;hljs json&#34;&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;  &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;generate_fishbone_diagram&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;  &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;description&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Generate a fishbone diagram chart to uses a fish skeleton, like structure to display the causes or effects of a core problem, with the problem as the fish head and the causes/effects as the fish bones. It suits problems that can be split into multiple related factors.&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;  &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;inputSchema&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;$schema&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;http://json-schema.org/draft-07/schema#&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;object&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;properties&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;      &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;data&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;object&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;properties&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;          &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;string&amp;quot;&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;          &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;children&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;            &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;array&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;            &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;items&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;              &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;properties&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;                &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;string&amp;quot;&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;                &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;children&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;                  &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;array&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;                  &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;items&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;                    &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;$ref&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;#/properties/data/properties/children/items&amp;quot;&lt;/span&gt;&lt;br&gt;                  &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;                &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;              &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;              &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;required&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;              &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;object&amp;quot;&lt;/span&gt;&lt;br&gt;            &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;          &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;required&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;description&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Data for fishbone diagram chart, such as, &amp;#123; name: &amp;#x27;main topic&amp;#x27;, children: [&amp;#123; name: &amp;#x27;topic 1&amp;#x27;, children: [&amp;#123; name: &amp;#x27;subtopic 1-1&amp;#x27; &amp;#125;] &amp;#125;.&amp;quot;&lt;/span&gt;&lt;br&gt;      &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;      &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;theme&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;default&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;default&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;description&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Set the theme for the chart, optional, default is &amp;#x27;default&amp;#x27;.&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;enum&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;default&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;academy&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;string&amp;quot;&lt;/span&gt;&lt;br&gt;      &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;      &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;width&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;number&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;description&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Set the width of chart, default is 600.&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;default&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;600&lt;/span&gt;&lt;br&gt;      &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;      &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;height&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;number&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;description&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Set the height of chart, default is 400.&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;default&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;400&lt;/span&gt;&lt;br&gt;      &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;,&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-attr&#34;&gt;&amp;quot;required&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;hljs-punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;data&amp;quot;&lt;/span&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;]&lt;/span&gt;&lt;br&gt;  &lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;hljs-punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;我们高效点，别浪费时间去理解问题全貌的每个细节，围绕引发报错的地方分析：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;assert ref in schema_defs, &amp;quot;Custom field not found&amp;quot;&lt;/code&gt;这个断言是针对”$ref”字段的，而这个字段的值长这样：”#&amp;#x2F;properties&amp;#x2F;data&amp;#x2F;properties&amp;#x2F;children&amp;#x2F;items”。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;properties -&amp;gt; data -&amp;gt; properties -&amp;gt; children -&amp;gt; items&lt;/code&gt;，这看起来是一条路径，指向这个input schema中的一个节点，而”$ref”就在这个节点内部。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;函数中，断言前先取了”$ref”字段的最后一节也就是”items”，然后似乎打算在schema根节点上找到这个”items”，如果找不到就无法通过assert，没错我跟你们一样看不懂这操作，但我可以猜测。看起来这个if代码逻辑是假设了一个很窄的场景，很鸵鸟地打算出了问题再说，然而实际上真的遇到了假设之外的情况：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;code class=&#34;hljs python&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;$ref&amp;quot;&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; prop_schema:&lt;br&gt;    ref = prop_schema[&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;$ref&amp;quot;&lt;/span&gt;]&lt;br&gt;    ref = ref.split(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/&amp;quot;&lt;/span&gt;)[-&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;]&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;assert&lt;/span&gt; ref &lt;span class=&#34;hljs-keyword&#34;&gt;in&lt;/span&gt; schema_defs, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Custom field not found&amp;quot;&lt;/span&gt;&lt;br&gt;    prop_schema = schema_defs[ref]&lt;br&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;OK，大致搞清了状况，我们看看需要怎么让这个函数在这个场景能正常工作。函数主要包含了一堆ifelse逻辑分支，大致上是利用一个深度优先搜索来遍历schema节点树，完成这棵树的结构化的同时给每个节点分配两个东西：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;python_type_hint：大概是接口文档需要展示的入参出参值类型。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;pydantic_field：是一个pydantic包的”字段”对象，看起来能定义一个字段的默认值、描述、别名。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;我们来看看type_hint和pydantic_field都是怎么来的吧，给大家节省时间快速翻译一下：看起来原作者基本上是把整个schema当做一个有向无环图，有”$ref”时只象征性检查引用schema根节点一级子节点的情况，处理很有限的一种环的场景。深度优先搜索到底，获得每个叶子节点的type，然后往上回溯组合出一些复合类型，比如Dict[str, Dict[str, str]]。至于schema_defs，默认值是&lt;code&gt;Field(default=None, description=&amp;quot;&amp;quot;)&lt;/code&gt;。原来有兜底返回值的啊，那有救了。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;我们挣扎一下看能不能给”$ref”一个很好看的真实字段信息，嗯需要给&lt;code&gt;properties.data.properties.children.items&lt;/code&gt;造出一个复合类型，可是”$ref”造成循环引用了，递归个没完，总会有一个”$ref”拿不到类型。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;既然这样，就放弃挣扎吧，我们缩小影响面，解决case先。具体case是一个造成循环引用的”$ref”字段”#&amp;#x2F;properties&amp;#x2F;data&amp;#x2F;properties&amp;#x2F;children&amp;#x2F;items”，让我们看看手头还有什么，啊有个&lt;code&gt;model_name_prefix&lt;/code&gt;一眼就是用来记深度优先节点路径的，用来当&lt;code&gt;_model_cache&lt;/code&gt;的key，这个cache里面就放那些字段信息。好说，&lt;code&gt;model_name_prefix&lt;/code&gt;跟”$ref”字段的含义基本等价，可以互相翻译。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;debug一下，把断言失败时的”$ref”和&lt;code&gt;model_name_prefix&lt;/code&gt;打印出来看看：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;“$ref”: “#&amp;#x2F;properties&amp;#x2F;data&amp;#x2F;properties&amp;#x2F;children&amp;#x2F;items”&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;model_name_prefix&lt;/code&gt;: “generate_fishbone_diagram_form_model_data_model_children_item_model_children”&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;追了下调用链，”generate_fishbone_diagram_form_model”这个前缀是工具名称决定的，跟schema无关，剩下的对应关系其实很明显：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;_model_&lt;/code&gt;对应&lt;code&gt;/properties/&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;code&gt;_item&lt;/code&gt;对应&lt;code&gt;/items&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;这些是函数中的固有字段映射，分别用于处理object类节点和array成员节点。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;我们把”$ref”翻译成prefix风格看看，”data_model_children_item”，&lt;code&gt;model_name_prefix&lt;/code&gt;去掉固定前缀是”data_model_children_item_model_children”，足够了，前缀关系。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;解法出来了：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;code class=&#34;hljs python&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ref.startswith(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;#/properties/&amp;quot;&lt;/span&gt;):&lt;br&gt;    &lt;span class=&#34;hljs-comment&#34;&gt;# Remove common prefix in pathes.&lt;/span&gt;&lt;br&gt;    prefix_path = model_name_prefix.split(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;_form_model_&amp;quot;&lt;/span&gt;)[-&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;]&lt;br&gt;    ref_path = ref.split(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;#/properties/&amp;quot;&lt;/span&gt;)[-&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;]&lt;br&gt;    &lt;span class=&#34;hljs-comment&#34;&gt;# Translate $ref path to model_name_prefix style.&lt;/span&gt;&lt;br&gt;    ref_path = ref_path.replace(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/properties/&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;_model_&amp;quot;&lt;/span&gt;)&lt;br&gt;    ref_path = ref_path.replace(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;/items&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;_item&amp;quot;&lt;/span&gt;)&lt;br&gt;    &lt;span class=&#34;hljs-comment&#34;&gt;# If $ref path is a prefix substring of model_name_prefix path,&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-comment&#34;&gt;# there exists a circular reference.&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-comment&#34;&gt;# The loop should be broke with a return to avoid exception.&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; prefix_path.startswith(ref_path):&lt;br&gt;        &lt;span class=&#34;hljs-comment&#34;&gt;# &lt;span class=&#34;hljs-doctag&#34;&gt;TODO:&lt;/span&gt; Find the exact type hint for the $ref.&lt;/span&gt;&lt;br&gt;        &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-type&#34;&gt;Any&lt;/span&gt;, Field(default=&lt;span class=&#34;hljs-literal&#34;&gt;None&lt;/span&gt;, description=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;)&lt;br&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;我们给人把注释写清楚，有遗憾的地方也把TODO写好，相信后来人的智慧。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Be nice，补个单测，跟历史单测风格保持一致（乐，这项目存量单测全是给_process_schema_property函数写的）：&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&#34;highlight python&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;code class=&#34;hljs python&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;test_ref_to_parent_node&lt;/span&gt;():&lt;br&gt;    schema = &amp;#123;&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;$ref&amp;#x27;&lt;/span&gt;: &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;#/properties/data/properties/children/items&amp;#x27;&lt;/span&gt;&amp;#125;&lt;br&gt;    result_type, result_field = _process_schema_property(&lt;br&gt;        _model_cache,&lt;br&gt;        schema,&lt;br&gt;        &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;generate_fishbone_diagram_form_model_data_model_children_item_model_children&amp;quot;&lt;/span&gt;,&lt;br&gt;        &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;item&amp;quot;&lt;/span&gt;,&lt;br&gt;        &lt;span class=&#34;hljs-literal&#34;&gt;False&lt;/span&gt;,&lt;br&gt;        &amp;#123;&amp;#125;&lt;br&gt;    )&lt;br&gt;&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;assert&lt;/span&gt; result_type == &lt;span class=&#34;hljs-type&#34;&gt;Any&lt;/span&gt;&lt;br&gt;    &lt;span class=&#34;hljs-keyword&#34;&gt;assert&lt;/span&gt; result_field.description == &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;pytest&lt;/code&gt;自测通过，交代码。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;提交pr&#34;&gt;&lt;a href=&#34;#提交pr&#34; class=&#34;headerlink&#34; title=&#34;提交pr&#34;&gt;&lt;/a&gt;提交pr&lt;/h2&gt;&lt;p&gt;如果你fork了当前项目，github项目主页能看到提pr（Pull Request）的提示，万一没看见，也可以点进”Pull requests”标签页，再点击”New pull request”按钮。&lt;/p&gt;
&lt;p&gt;选择来源仓库、分支和目标仓库、分支后，就可以点击”Create pull request”按钮，自动给你创建一个issue，用来自述你的pr，具体怎么写可以参考仓库里的历史pr issue，我的是这个：&lt;a href=&#34;https://github.com/open-webui/mcpo/pull/174&#34;&gt;#174&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;pr issue里需要说清你解决的问题场景和你的代码对当前项目的影响面，带上自测结果会更让人放心。&lt;/p&gt;
&lt;p&gt;能看到我在自己的fork项目里新建了一个feature分支：&lt;a href=&#34;https://github.com/bipedalBit/mcpo/tree/fix-circular-schema-ref-exception&#34;&gt;fix-circular-schema-ref-exception&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;review&#34;&gt;&lt;a href=&#34;#review&#34; class=&#34;headerlink&#34; title=&#34;review&#34;&gt;&lt;/a&gt;review&lt;/h2&gt;&lt;p&gt;等待你的目标分支的代码评审人评审你的代码，在你的pr review中给出评审意见。&lt;/p&gt;
&lt;p&gt;我的pr评审人是仓库主Tim Jaeryang Baek，很客气，没challenge我，一个thanks后就给我一口气合了dev、main分支，甚至单开了一个release tag装我的pr。&lt;/p&gt;
&lt;p&gt;于是我没有被challenge和返工的流程示例可以展示了┑(￣Д ￣)┍&lt;/p&gt;
&lt;p&gt;close掉的pr issue里会提示代码已合，你可以删掉feature分支和fork项目。&lt;/p&gt;
 ]]></description>
        </item>
    </channel>
</rss>
