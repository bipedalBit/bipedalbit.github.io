{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hacking to the gate! • All posts by \"dns污染\" tag",
    "description": "Bipedal Bit's blog",
    "home_page_url": "https://bipedalbit.net",
    "items": [
        {
            "id": "https://bipedalbit.net/2025/06/11/%E8%AE%B0%E4%B8%80%E6%AC%A1DNS%E6%B1%A1%E6%9F%93%E5%BA%94%E5%AF%B9/",
            "url": "https://bipedalbit.net/2025/06/11/%E8%AE%B0%E4%B8%80%E6%AC%A1DNS%E6%B1%A1%E6%9F%93%E5%BA%94%E5%AF%B9/",
            "title": "记一次DNS污染应对",
            "date_published": "2025-06-11T12:22:04.000Z",
            "content_html": "<p>静态站的waline评论插件服务的二级域名被ISP DNS做了污染封禁导致评论插件和访问计数不可用。记录一下我排查和解决问题的过程与思考。</p>\n<span id=\"more\"></span>\n<h1 id=\"现象\"><a href=\"#现象\" class=\"headerlink\" title=\"现象\"></a>现象</h1><ul>\n<li><p>特定条件下，从客户端访问我的静态站时，客户端请求我的自建waline服务失败，看响应头发现remote ip是(::1)，ipv6回环地址。</p>\n</li>\n<li><p>ping对应域名证实DNS结果确实为(::1)。</p>\n</li>\n<li><p>为了明确问题，我用不同网络环境做了测试：</p>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>网络</th>\n<th>代理</th>\n<th>DNS</th>\n<th>结果</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>中国移动蜂巢5G</td>\n<td>关闭</td>\n<td>自动</td>\n<td>fail</td>\n</tr>\n<tr>\n<td>中国移动蜂巢5G</td>\n<td>全局</td>\n<td>等同于8.8.8.8</td>\n<td>success</td>\n</tr>\n<tr>\n<td>中国移动蜂巢5G</td>\n<td>关闭</td>\n<td>114.114.114.114</td>\n<td>success</td>\n</tr>\n<tr>\n<td>中国移动光纤宽带</td>\n<td>关闭</td>\n<td>自动</td>\n<td>fail</td>\n</tr>\n<tr>\n<td>中国移动光纤宽带</td>\n<td>全局</td>\n<td>等同于8.8.8.8</td>\n<td>success</td>\n</tr>\n<tr>\n<td>中国移动光纤宽带</td>\n<td>关闭</td>\n<td>114.114.114.114</td>\n<td>success</td>\n</tr>\n</tbody></table>\n<p>我手头只有移动的5G网络和宽带网络，还不好排除ISP本身状态的影响，但绕过中国移动网络的ISP DNS，就能成功。</p>\n<p>初步判断是DNS的问题。上<a href=\"https://dnschecker.org/\">DNSChecker</a>验证一下非ISP DNS，用当前的中国移动ISP+各种全球非ISP DNS做测试，结果是域名解析全部正确。那么看起来真的很可能是ISP DNS主动做了污染。</p>\n<p>搜搜有前科吗？有的，国内ISP偶现用回环地址做DNS污染来针对性封禁域名的情况。</p>\n<p>捞个本地的移动ISP DNS试试，<code>dig @211.137.64.163 &lt;domain&gt;</code>：</p>\n<figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nix\">; <span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">&gt;</span><span class=\"hljs-operator\">&gt;</span> DiG <span class=\"hljs-number\">9.18</span>.<span class=\"hljs-number\">3</span>0-<span class=\"hljs-number\">0</span>ubuntu0.<span class=\"hljs-number\">24.04</span>.<span class=\"hljs-number\">2</span><span class=\"hljs-operator\">-</span>Ubuntu <span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">&gt;</span><span class=\"hljs-operator\">&gt;</span> @<span class=\"hljs-number\">211.137</span>.<span class=\"hljs-number\">64.163</span> <span class=\"hljs-symbol\">&lt;domain&gt;</span><br>; (<span class=\"hljs-number\">1</span> server found)<br>;; global <span class=\"hljs-params\">options:</span> <span class=\"hljs-operator\">+</span>cmd<br>;; Got <span class=\"hljs-params\">answer:</span><br>;; <span class=\"hljs-operator\">-&gt;</span><span class=\"hljs-operator\">&gt;</span>HEADER<span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">-</span> <span class=\"hljs-params\">opcode:</span> QUERY, <span class=\"hljs-params\">status:</span> NOERROR, <span class=\"hljs-params\">id:</span> <span class=\"hljs-number\">48130</span><br>;; <span class=\"hljs-params\">flags:</span> qr rd ra; <span class=\"hljs-params\">QUERY:</span> <span class=\"hljs-number\">1</span>, <span class=\"hljs-params\">ANSWER:</span> <span class=\"hljs-number\">1</span>, <span class=\"hljs-params\">AUTHORITY:</span> <span class=\"hljs-number\">0</span>, <span class=\"hljs-params\">ADDITIONAL:</span> <span class=\"hljs-number\">0</span><br><br>;; QUESTION <span class=\"hljs-params\">SECTION:</span><br>;<span class=\"hljs-symbol\">&lt;domain&gt;</span>.\t\tIN\tA<br><br>;; ANSWER <span class=\"hljs-params\">SECTION:</span><br><span class=\"hljs-symbol\">&lt;domain&gt;</span>.\t<span class=\"hljs-number\">3600</span>\tIN\tA\t<span class=\"hljs-number\">127.0</span>.<span class=\"hljs-number\">0.1</span><br><br>;; Query <span class=\"hljs-params\">time:</span> <span class=\"hljs-number\">5</span> msec<br>;; <span class=\"hljs-params\">SERVER:</span> <span class=\"hljs-number\">211.137</span>.<span class=\"hljs-number\">64.163</span><span class=\"hljs-comment\">#53(211.137.64.163) (UDP)</span><br>;; <span class=\"hljs-params\">WHEN:</span> Wed Jun <span class=\"hljs-number\">11</span> <span class=\"hljs-number\">20</span>:<span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">16</span> CST <span class=\"hljs-number\">2025</span><br>;; MSG SIZE  <span class=\"hljs-params\">rcvd:</span> <span class=\"hljs-number\">55</span><br></code></pre></td></tr></table></figure>\n\n<p>真的给我解成了回环地址。</p>\n<p>上班时也试了下电信的ISP DNS，<code>dig @202.103.24.68 &lt;domain&gt;</code>：</p>\n<figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nix\">; <span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">&gt;</span><span class=\"hljs-operator\">&gt;</span> DiG <span class=\"hljs-number\">9.11</span>.<span class=\"hljs-number\">5</span><span class=\"hljs-operator\">-</span>P4-<span class=\"hljs-number\">5.1</span><span class=\"hljs-operator\">+</span>deb10u11-Debian <span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">&gt;</span><span class=\"hljs-operator\">&gt;</span> @<span class=\"hljs-number\">202.103</span>.<span class=\"hljs-number\">24.68</span> <span class=\"hljs-symbol\">&lt;domain&gt;</span><br>; (<span class=\"hljs-number\">1</span> server found)<br>;; global <span class=\"hljs-params\">options:</span> <span class=\"hljs-operator\">+</span>cmd<br>;; Got <span class=\"hljs-params\">answer:</span><br>;; <span class=\"hljs-operator\">-&gt;</span><span class=\"hljs-operator\">&gt;</span>HEADER<span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">&lt;</span><span class=\"hljs-operator\">-</span> <span class=\"hljs-params\">opcode:</span> QUERY, <span class=\"hljs-params\">status:</span> NOERROR, <span class=\"hljs-params\">id:</span> <span class=\"hljs-number\">17701</span><br>;; <span class=\"hljs-params\">flags:</span> qr aa rd; <span class=\"hljs-params\">QUERY:</span> <span class=\"hljs-number\">1</span>, <span class=\"hljs-params\">ANSWER:</span> <span class=\"hljs-number\">1</span>, <span class=\"hljs-params\">AUTHORITY:</span> <span class=\"hljs-number\">0</span>, <span class=\"hljs-params\">ADDITIONAL:</span> <span class=\"hljs-number\">0</span><br>;; <span class=\"hljs-params\">WARNING:</span> recursion requested but not available<br><br>;; QUESTION <span class=\"hljs-params\">SECTION:</span><br>;<span class=\"hljs-symbol\">&lt;domain&gt;</span>.\t\tIN\tA<br><br>;; ANSWER <span class=\"hljs-params\">SECTION:</span><br><span class=\"hljs-symbol\">&lt;domain&gt;</span>.\t<span class=\"hljs-number\">300</span>\tIN\tA\t<span class=\"hljs-number\">127.0</span>.<span class=\"hljs-number\">0.1</span><br><br>;; Query <span class=\"hljs-params\">time:</span> <span class=\"hljs-number\">5</span> msec<br>;; <span class=\"hljs-params\">SERVER:</span> <span class=\"hljs-number\">202.103</span>.<span class=\"hljs-number\">24.68</span><span class=\"hljs-comment\">#53(202.103.24.68)</span><br>;; <span class=\"hljs-params\">WHEN:</span> 三 <span class=\"hljs-number\">6</span>月 <span class=\"hljs-number\">11</span> <span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">16</span>:<span class=\"hljs-number\">34</span> CST <span class=\"hljs-number\">2025</span><br>;; MSG SIZE  <span class=\"hljs-params\">rcvd:</span> <span class=\"hljs-number\">55</span><br></code></pre></td></tr></table></figure>\n\n<p>看来还不止被一个ISP做了DNS污染，都给我解成回环地址。</p>\n<h1 id=\"DNS劫持与DNS污染\"><a href=\"#DNS劫持与DNS污染\" class=\"headerlink\" title=\"DNS劫持与DNS污染\"></a>DNS劫持与DNS污染</h1><table>\n<thead>\n<tr>\n<th><strong>对比维度</strong></th>\n<th><strong>DNS劫持</strong></th>\n<th><strong>DNS污染</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>攻击方式</strong></td>\n<td>篡改DNS解析结果</td>\n<td>伪造DNS响应数据</td>\n</tr>\n<tr>\n<td><strong>影响范围</strong></td>\n<td>个体或小范围</td>\n<td>大范围或区域</td>\n</tr>\n<tr>\n<td><strong>目的</strong></td>\n<td>诱导用户访问恶意网站</td>\n<td>干扰用户访问特定服务</td>\n</tr>\n<tr>\n<td><strong>典型场景</strong></td>\n<td>钓鱼、恶意软件传播</td>\n<td>网络封锁、广告注入</td>\n</tr>\n</tbody></table>\n<p>DNS劫持通常在客户端完成，DNS污染通常在网关或DNS服务上操作。</p>\n<h1 id=\"分析原因\"><a href=\"#分析原因\" class=\"headerlink\" title=\"分析原因\"></a>分析原因</h1><ul>\n<li>捞了下waline服务的日志，发现有不少”&#x2F;robots.txt not found”，还在80、443口都来了一遍。有搜索引擎爬虫或者模拟搜索引擎的爬虫试图抓取我waline服务端的响应内容，那么可能有人在收录或分析我的waline服务。其实应该也分析不出什么，这服务没过鉴权的情况下响应体里甚至不包含文字。</li>\n<li>其实也可能是二级域名本身的关键词命中了什么政策类的域名筛选规则，大家给二级域名起名也要谨慎点。</li>\n</ul>\n<h1 id=\"应对\"><a href=\"#应对\" class=\"headerlink\" title=\"应对\"></a>应对</h1><ul>\n<li><p>除了用于展示内容的静态站域名，其他功能性二级域名都用nginx配置加上禁爬声明先：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nginx\"><span class=\"hljs-comment\"># HTTP server block</span><br><span class=\"hljs-section\">server</span> &#123;<br>    <span class=\"hljs-attribute\">listen</span> <span class=\"hljs-number\">80</span>;<br>    <span class=\"hljs-attribute\">server_name</span> example.com;<br><br>    <span class=\"hljs-comment\"># 禁止爬虫访问所有内容</span><br>    <span class=\"hljs-section\">location</span> = /robots.txt &#123;<br>        <span class=\"hljs-attribute\">return</span> <span class=\"hljs-number\">200</span> <span class=\"hljs-string\">&quot;User-agent: *\\&quot;\\nDisallow: /&quot;</span>;<br>        <span class=\"hljs-attribute\">add_header</span> Content-Type text/plain;<br>        <span class=\"hljs-attribute\">add_header</span> Cache-Control <span class=\"hljs-string\">&quot;public, max-age=3600&quot;</span>;<br>        <span class=\"hljs-attribute\">if</span> (<span class=\"hljs-variable\">$request_method</span> !<span class=\"hljs-regexp\">~ ^(GET|HEAD)$</span> ) &#123;<br>            <span class=\"hljs-attribute\">return</span> <span class=\"hljs-number\">405</span>;<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-comment\"># 其他请求重定向到 HTTPS</span><br>    <span class=\"hljs-section\">location</span> / &#123;<br>        <span class=\"hljs-attribute\">return</span> <span class=\"hljs-number\">301</span> https://<span class=\"hljs-variable\">$host</span><span class=\"hljs-variable\">$request_uri</span>;<br>    &#125;<br>&#125;<br><br><span class=\"hljs-comment\"># HTTPS server block</span><br><span class=\"hljs-section\">server</span> &#123;<br>    <span class=\"hljs-attribute\">listen</span> <span class=\"hljs-number\">443</span> ssl;<br>    <span class=\"hljs-attribute\">server_name</span> example.com;<br><br>    <span class=\"hljs-attribute\">ssl_certificate</span> /path/to/cert.pem;<br>    <span class=\"hljs-attribute\">ssl_certificate_key</span> /path/to/privkey.pem;<br><br>    <span class=\"hljs-comment\"># 禁止爬虫访问所有内容</span><br>    <span class=\"hljs-section\">location</span> = /robots.txt &#123;<br>        <span class=\"hljs-attribute\">return</span> <span class=\"hljs-number\">200</span> <span class=\"hljs-string\">&quot;User-agent: *\\&quot;\\nDisallow: /&quot;</span>;<br>        <span class=\"hljs-attribute\">add_header</span> Content-Type text/plain;<br>        <span class=\"hljs-attribute\">add_header</span> Cache-Control <span class=\"hljs-string\">&quot;public, max-age=3600&quot;</span>;<br>        <span class=\"hljs-attribute\">if</span> (<span class=\"hljs-variable\">$request_method</span> !<span class=\"hljs-regexp\">~ ^(GET|HEAD)$</span> ) &#123;<br>            <span class=\"hljs-attribute\">return</span> <span class=\"hljs-number\">405</span>;<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-comment\"># 其他请求处理（如 root、proxy_pass 等）</span><br>    <span class=\"hljs-section\">location</span> / &#123;<br>        <span class=\"hljs-comment\"># 你的其他配置，如 proxy_pass 或 root</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>再给二级域名换成个更烂大街的抽象名称躲封禁规则，配好对应DNS记录和nginx路由。</p>\n</li>\n<li><p>用certbot更新下SSL证书：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\">certbot certonly ----cert-name &lt;cert_name&gt; --manual --preferred-challenges http --webroot-path /root/Dropbox/&lt;homepage_dir&gt; -m me@bipedalbit.net -d &lt;domain1&gt; -d &lt;domain2&gt; -d &lt;domain3&gt;<br></code></pre></td></tr></table></figure>\n</li>\n<li><p>我不爱用<code>certbot run</code>自动改nginx配置文件更新SSL证书，会把我写好的nginx配置格式搞乱。用<code>certbot certonly</code>命令需要按命令行提示在指定域名下指定位置放个指定内容的文本文件证明你是指定域名内容的控制方，然后回车下一步。麻烦点，但低频操作，不自动化也负担不大。</p>\n</li>\n<li><p>改改waline服务的部署配置，把里面的服务二级域名更新下，重启服务。</p>\n</li>\n<li><p>OK这下通了，观察一天看看，还是通的，大概是妥了。</p>\n</li>\n</ul>\n",
            "tags": [
                "DNS",
                "DNS劫持",
                "DNS污染"
            ]
        }
    ]
}