{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hacking to the gate! • All posts by \"模拟登录\" tag",
    "description": "Bipedal Bit's blog",
    "home_page_url": "https://blog.bipedalbit.net",
    "items": [
        {
            "id": "https://blog.bipedalbit.net/2016/01/02/weibo-cn%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E5%99%A8%E7%9A%84python%E9%87%8D%E6%9E%84/",
            "url": "https://blog.bipedalbit.net/2016/01/02/weibo-cn%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E5%99%A8%E7%9A%84python%E9%87%8D%E6%9E%84/",
            "title": "weibo.cn模拟登录器的python重构",
            "date_published": "2016-01-02T04:47:05.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 之前封装过一个完整的微博爬虫工具包，但是在我查找python多进程爬虫的相关资料时发现，其实使用urllib2写网络爬虫已经是陈年往事，如今大家都用requests包，就像明明有.NET和Qt框架偏偏要用MFC框架，我是自找麻烦了。在使用requests包逐个重构网络爬虫部件的时候，对weibo.cn的模拟登录过程有了一些新的理解，于是来写篇文介绍一下。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 我们再来重新分析一遍weibo.cn的登录过程。出发前先来检查一下装备：</p>\n<ul>\n<li>firefox浏览器</li>\n<li>一个firefox浏览器下的HTTP报文记录分析插件——httpfox</li>\n<li>python2语言环境——python 2.7</li>\n<li>一个python HTTP包——requests</li>\n<li>一个python XML解析包——BueatifulSoup4</li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 妥，先来用httpfox记录一下手工登录的过程：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E5%BE%AE%E5%8D%9A%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95/%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%80%BB%E8%A7%88.png\" alt=\"图１ weibo.cn模拟登录过程总览\" title=\"weibo.cn模拟登录过程总览\"><br>&nbsp;&nbsp;&nbsp; 无视掉第二条失败的图片请求，剩下的就是weibo.cn登录的全过程。我们逐条分析：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E5%BE%AE%E5%8D%9A%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95/%E8%AF%B7%E6%B1%82%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2.png\" alt=\"图２ 请求登录页面\" title=\"请求登录页面\"><br>&nbsp;&nbsp;&nbsp; 上图中是第一条请求的报文头部分，第一条请求是在访问weibo.cn的登录页面。请求到的页面源码中，掐头去尾，比较关键的部分如下：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">form</span> <span class=\"hljs-attr\">action</span>=<span class=\"hljs-string\">&quot;?backURL=http%3A%2F%2Fweibo.cn%2F<span class=\"hljs-symbol\">&amp;amp;</span>backTitle=%E5%BE%AE%E5%8D%9A<span class=\"hljs-symbol\">&amp;amp;</span>vt=1<span class=\"hljs-symbol\">&amp;amp;</span>revalid=2<span class=\"hljs-symbol\">&amp;amp;</span>ns=1&quot;</span> <span class=\"hljs-attr\">method</span>=<span class=\"hljs-string\">&quot;post&quot;</span>&gt;</span><br>\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span><br>\t\t手机号/电子邮箱/会员帐号:<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">br</span>/&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;text&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;mobile&quot;</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">&quot;30&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;&quot;</span> /&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">br</span>/&gt;</span><br>\t\t密码:<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">br</span>/&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;password&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;password_3523&quot;</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">&quot;30&quot;</span> /&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">br</span>/&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;checkbox&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;remember&quot;</span> <span class=\"hljs-attr\">checked</span>=<span class=\"hljs-string\">&quot;checked&quot;</span> /&gt;</span>记住登录状态，需支持并打开手机的cookie功能。<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">br</span>/&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;hidden&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;backURL&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;http%3A%2F%2Fweibo.cn%2F&quot;</span> /&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;hidden&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;backTitle&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;微博&quot;</span> /&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;hidden&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;tryCount&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;&quot;</span> /&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;hidden&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;vk&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;3523_4ea5_1803939589&quot;</span> /&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;submit&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;submit&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;登录&quot;</span> /&gt;</span><br>\t<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">form</span>&gt;</span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 可以看到表单的action地址、密码输入框的name、隐藏变量vk的值都是变动的，这三样东西正是我们在模拟登录时需要从登录页面解析获得的。对应的python代码如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-comment\"># 尽管不设置报文头也不会被新浪服务器阻拦，还是做一些必要的伪装与配置比较保险</span><br>headers = &#123;<br>\t<span class=\"hljs-string\">&#x27;User-Agent&#x27;</span>: <span class=\"hljs-string\">&#x27;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0&#x27;</span>,<br>\t<span class=\"hljs-string\">&#x27;DNT&#x27;</span>: <span class=\"hljs-string\">&#x27;1&#x27;</span>,<br>\t<span class=\"hljs-string\">&#x27;Connection&#x27;</span>: <span class=\"hljs-string\">&#x27;keep-alive&#x27;</span>,<br>\t<span class=\"hljs-string\">&#x27;Cache-Control&#x27;</span>: <span class=\"hljs-string\">&#x27;max-age=0&#x27;</span>,<br>&#125;<br><br><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_post_needs</span>():<br>\turl = <span class=\"hljs-string\">&#x27;http://login.weibo.cn/login/?ns=1&amp;revalid=2&amp;backURL=http://weibo.cn/&amp;backTitle=微博&amp;vt=&#x27;</span><br>\ttext = requests.get(url, headers=headers).text<br>\tsoup = BeautifulSoup(text, <span class=\"hljs-string\">&#x27;lxml&#x27;</span>)<br>\taction_url = <span class=\"hljs-string\">&#x27;http://login.weibo.cn/login/&#x27;</span> + soup.form[<span class=\"hljs-string\">&#x27;action&#x27;</span>]<br>\tpassword_tag = soup.find(<span class=\"hljs-string\">&#x27;input&#x27;</span>, <span class=\"hljs-built_in\">type</span> = <span class=\"hljs-string\">&#x27;password&#x27;</span>)<br>\tpassword_name = re.search(<span class=\"hljs-string\">&#x27;(?&lt;=name=&quot;)\\w+(?=&quot;)&#x27;</span>, <span class=\"hljs-built_in\">str</span>(password_tag)).group(<span class=\"hljs-number\">0</span>)<br>\tvk_tag = soup.find(<span class=\"hljs-string\">&#x27;input&#x27;</span>, attrs = &#123;<span class=\"hljs-string\">&#x27;name&#x27;</span>: <span class=\"hljs-string\">&#x27;vk&#x27;</span>&#125;)<br>\tvk = re.search(<span class=\"hljs-string\">&#x27;(?&lt;=value=&quot;)\\w+(?=&quot;)&#x27;</span>, <span class=\"hljs-built_in\">str</span>(vk_tag)).group(<span class=\"hljs-number\">0</span>)<br>\t<span class=\"hljs-keyword\">return</span> action_url, password_name, vk<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 页面解析完毕还需要填充表单，对应的python代码如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_post_data</span>(<span class=\"hljs-params\">username, password, password_name, vk</span>):<br>\tform_data = &#123;<br>\t\t<span class=\"hljs-string\">&#x27;mobile&#x27;</span>: username,<br>\t\tpassword_name: password,<br>\t\t<span class=\"hljs-string\">&#x27;remeber&#x27;</span>: <span class=\"hljs-string\">&#x27;on&#x27;</span>,<br>\t\t<span class=\"hljs-string\">&#x27;backURL&#x27;</span>: <span class=\"hljs-string\">&#x27;http://weibo.cn/&#x27;</span>,<br>\t\t<span class=\"hljs-string\">&#x27;backTitle&#x27;</span>: <span class=\"hljs-string\">&#x27;微博&#x27;</span>,<br>\t\t<span class=\"hljs-string\">&#x27;tryCount&#x27;</span>: <span class=\"hljs-string\">&#x27;&#x27;</span>,<br>\t\t<span class=\"hljs-string\">&#x27;vk&#x27;</span>: vk,<br>\t\t<span class=\"hljs-string\">&#x27;submit&#x27;</span>: <span class=\"hljs-string\">&#x27;登录&#x27;</span><br>\t&#125;<br>\t<span class=\"hljs-keyword\">return</span> form_data<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 填充完登录表单，就该post出去了，由４个连续的状态码为302的请求不难看出，发送的post请求随后被进行了足足４次重定向。<br>&nbsp;&nbsp;&nbsp; 可以看到，第一次重定向后，请求访问了newlogin.sina.cn，此时新浪服务器已经给我们的请求加上了两个cookie字段（httpfox可以以字典的形式查看每个请求的cookie字段，这里我就不上图了），一个叫“_T_WM”另一个叫“SUB”，虽然不明白这两个字段的含义，但是经过实验得知，其实这个“SUB”字段就可以用来做登录验证了。<br>&nbsp;&nbsp;&nbsp; 第二次重定向请求访问了passport.weibo.com，这次新浪服务器给请求重新填充了许多cookie字段，但是仍然包含一个“SUB”字段，没错，这此的“SUB”也可以拿来做登录验证。<br>&nbsp;&nbsp;&nbsp; 类似的，第三次访问weibo.cn的重定向也填充了新cookie字段，我们又获得了一个可用的“SUB”字段。<br>&nbsp;&nbsp;&nbsp; 至于最后一次重定向，只是通过一个几乎纯JavaScript组成的页面让我们以已登录的状态跳转到前面表单参数中的backURL指向的页面。<br>&nbsp;&nbsp;&nbsp; 在使用python记录cookie字段时需要注意，这种经过若干次重定向的”长会话“不能直接使用Request对象来发送最初的post请求，而是需要一个能处理”长会话“的Session对象的帮助，获得cookie字段的对应python代码如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">wap_login</span>(<span class=\"hljs-params\">username, password</span>):<br>\turl, password_name, vk = get_post_needs()<br>\tdata = get_post_data(username, password, password_name, vk)<br>\tsession = requests.Session()<br>\tresponse = session.post(url, headers=headers, data=data)<br>\t<span class=\"hljs-comment\"># 以下三种来自不同domain的名为SUB的cookie字段都可以用来验证登录状态</span><br>\t<span class=\"hljs-comment\"># return session.cookies.get(&#x27;SUB&#x27;, domain=&#x27;.sina.cn&#x27;)</span><br>\t<span class=\"hljs-comment\"># return session.cookies.get(&#x27;SUB&#x27;, domain=&#x27;.weibo.com&#x27;)</span><br>\t<span class=\"hljs-keyword\">return</span> session.cookies.get(<span class=\"hljs-string\">&#x27;SUB&#x27;</span>, domain=<span class=\"hljs-string\">&#x27;.weibo.cn&#x27;</span>)<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 拿到了必要的cookie字段，模拟登录过程其实就已经完成了，接下来我们也可以用下面的代码测试一下cookie字段是否管用：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\">url = <span class=\"hljs-string\">&#x27;http://weibo.cn/moegirlwiki&#x27;</span><br>username = raw_input(<span class=\"hljs-string\">&#x27;请输入新浪通行证用户名：&#x27;</span>)<br>password = getpass(<span class=\"hljs-string\">&#x27;请输入新浪通行证密码：&#x27;</span>)<br>cookies = &#123;<span class=\"hljs-string\">&#x27;SUB&#x27;</span>: wap_login(username, password)&#125;<br>response = requests.get(url, cookies=cookies)<br><span class=\"hljs-built_in\">print</span> <span class=\"hljs-string\">&#x27;登录成功！&#x27;</span> <span class=\"hljs-keyword\">if</span> response.url == url <span class=\"hljs-keyword\">else</span> <span class=\"hljs-string\">&#x27;登录失败！&#x27;</span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 如果读者接触过weibo.com的模拟登录过程想必明白，weibo.cn的登录过程简单多了，更重要的是，必要cookie字段在weibo.cn和weibo.com是通用的，那我们又何必选择更麻烦的模拟登录途径呢？</p>\n",
            "tags": [
                "python",
                "网络爬虫",
                "模拟登录"
            ]
        }
    ]
}