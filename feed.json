{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hacking to the gate!",
    "description": "Bipedal Bit's blog",
    "home_page_url": "https://blog.bipedalbit.net",
    "items": [
        {
            "id": "https://blog.bipedalbit.net/2025/06/07/%E5%86%8D%E8%B0%88hexo%E9%9D%99%E6%80%81%E7%AB%99%E6%90%AD%E5%BB%BA/",
            "url": "https://blog.bipedalbit.net/2025/06/07/%E5%86%8D%E8%B0%88hexo%E9%9D%99%E6%80%81%E7%AB%99%E6%90%AD%E5%BB%BA/",
            "title": "再谈hexo静态站搭建",
            "date_published": "2025-06-07T15:12:47.000Z",
            "content_html": "<h1 id=\"回顾\"><a href=\"#回顾\" class=\"headerlink\" title=\"回顾\"></a>回顾</h1><p>不是头一次谈hexo静态站搭建了，2016年就写了相关的博客，非常耐心事无巨细地介绍过<a href=\"https://bipedalbit.net/2016/04/24/hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/\">当时的搭建方案</a>。</p>\n<p>紧接着开了自己的VPS，于是又写文介绍了<a href=\"https://bipedalbit.net/2016/04/25/%E5%88%A9%E7%94%A8Dropbox%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5%E7%9A%84%E9%9D%99%E6%80%81%E7%AB%99/\">迭代方案</a>，在VPS上做了镜像站部署，用dropbox做静态资源同步。现在由于国内不搭梯子访问github已经不稳定，VPS上的静态站反而成了主站，github pages上那个站成替身了哈哈。</p>\n<h1 id=\"概述\"><a href=\"#概述\" class=\"headerlink\" title=\"概述\"></a>概述</h1><p>新的静态站其实主要更新了3个点：</p>\n<ul>\n<li><p>主题：landscape-plus &#x3D;&gt; fluid</p>\n</li>\n<li><p>图床：七牛 &#x3D;&gt; 自建minio+cdn</p>\n</li>\n<li><p>评论插件：多说 &#x3D;&gt; 自建waline</p>\n</li>\n</ul>\n<h1 id=\"hexo\"><a href=\"#hexo\" class=\"headerlink\" title=\"hexo\"></a>hexo</h1><p>很幸运，在旧笔记本上居然翻到了完整未损坏的当年的hexo项目目录，不过其实要装修个人站的话，只需要把站里的markdown文章救回来就好，反正外面的静态站框架还是会用hexo。</p>\n<p>说起来，hexo这个静态站框架也是很经久不衰，虽然插件和主题消亡了不少个，但框架本身还在持续迭代，社区也还在活跃，一直出新的插件和主题，简直跟sublime text有一拼，我也是真爱掺和这种自由度高的DIY项目，怕是早晚要入PCB板、3D打印的坑。</p>\n<p>看了眼<a href=\"https://hexo.io/docs/commands\">hexo的新官方文档</a>，命令行用法没什么变化，项目结构也没变化，但比起9年前（Σ(⊙▽⊙”这就是成年人的世界吗？好吓人的时间尺度），除了github pages，适配了一些新的免费静态站托管平台：</p>\n<ul>\n<li><p>gitlab pages：依赖可用的gitlab，gitlab知道吧？github开源对标方案。</p>\n</li>\n<li><p><a href=\"https://www.heroku.com/\">Heroku</a>：一个可以免费托管全栈应用的PaaS平台，有每月白嫖小时数，应用有些休眠问题要解决。</p>\n</li>\n<li><p><a href=\"https://www.netlify.com/about/\">Netlify</a>：SaaS托管平台。</p>\n</li>\n<li><p><a href=\"https://vercel.com/\">Vercel</a>：前端应用托管平台，有白嫖流量，但好像是固定额度，不是每月送额度。</p>\n</li>\n<li><p><a href=\"https://rss3.io/\">RSS3</a>：就是基于web3那一套做的RSS托管，简单理解就是IPFS上放静态资源，区块链代币支付存储和基建维护费。IPFS这个存储方案嘛我调研过，彻底去中心，可靠、近似真·持久化，IO性能还OK，但是存储成本其实比各大云厂的对象存储还贵一些，考虑到赛博活菩萨甚至有可以白嫖的对象存储，IPFS吧就有点鸡肋，现在更多是用来破审核，偷摸分享些灰色地带的资源。</p>\n</li>\n<li><p>一些纯资源同步工具：Rsync、FTPSync、SFTP。</p>\n</li>\n<li><p>还提了一嘴，其他类似的静态资源托管方案可以自己同步hexo项目的public目录内容即可，比如我的VPS+dropbox方案。</p>\n</li>\n</ul>\n<p>hexo的项目结构带大家熟悉一下：</p>\n<figure class=\"highlight nix\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nix\">.<br>├── _config.fluid.yml<br>├── _config.landscape.yml<br>├── _config.yml<br>├── db.json<br>├── node_modules<span class=\"hljs-symbol\">/</span><br>├── package.json<br>├── package-lock.json<br>├── public<span class=\"hljs-symbol\">/</span><br>├── scaffolds<span class=\"hljs-symbol\">/</span><br>│   ├── draft.md<br>│   ├── page.md<br>│   └── post.md<br>├── source<span class=\"hljs-symbol\">/</span><br>│   ├── about<span class=\"hljs-symbol\">/</span><br>│   │   └── index.md<br>│   ├── CNAME<br>│   ├── _drafts<span class=\"hljs-symbol\">/</span><br>│   ├── img<span class=\"hljs-symbol\">/</span><br>│   └── _posts<span class=\"hljs-symbol\">/</span><br>└── themes<span class=\"hljs-operator\">/</span><br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><p><code>_config.yml</code>：这是整个hexo项目的配置文件</p>\n</li>\n<li><p><code>_config.landscape.yml</code>：这是landsacpe主题的hexo项目配置文件，landscape是hexo项目的默认主体，主题配置文件一般相对于项目配置文件会多出一些配置项，这就是主题的发挥空间。主题配置文件中的配置优先级高于项目配置，所以跟主题无关的项目配置可以配在<code>_config.yml</code>里，主题特有的配置配在主题配置文件里，方便随时换主题。</p>\n</li>\n<li><p><code>_config.fluid.yml</code>：这是我现在用的<a href=\"https://hexo.fluid-dev.com/docs/start/#%E4%B8%BB%E9%A2%98%E7%AE%80%E4%BB%8B\">fluid主题</a>的配置文件。</p>\n</li>\n<li><p>几个json文件和<code>node_modules/</code>目录理解成项目运行时环境就好，包括了hexo框架本身、插件和主题的实现。迁移hexo项目时，可以删掉<code>node_modules/</code>目录，靠json文件能重建项目运行时资源。</p>\n</li>\n<li><p><code>themes/</code>目录是用来放<code>git clone</code>下来的主题的，不是很冷门的主题的话，直接用命令安装到项目的运行时资源里就行。</p>\n</li>\n<li><p><code>public/</code>目录用来放hexo框架生成的网站静态资源，可以直接把这个目录当网站根目录，拿去部署网站。</p>\n</li>\n<li><p><code>scaffolds/</code>目录，字面意思是脚手架，其实是用来放几种markdown文件的模板，用生成markdown文件时会根据这些模板做一些内容初始化，我是还没有做什么修改。</p>\n</li>\n<li><p><code>source/</code>目录是项目的内容目录，其中的markdown文件会生成对应静态资源后搬到<code>public/</code>目录中，其他目录会原样搬到<code>public/</code>目录中。</p>\n</li>\n<li><p><code>source/about/index.md</code>用来创建关于页。</p>\n</li>\n<li><p><code>source/_drafts</code>目录用来放文章草稿，不会生成静态资源。</p>\n</li>\n<li><p><code>source/_posts</code>目录用来放文章正文，会生成静态资源。</p>\n</li>\n</ul>\n<p>hexo框架和fluid我就不细讲了，效果可以看我的静态站，用法可以看官方文档学习。</p>\n<h1 id=\"图床\"><a href=\"#图床\" class=\"headerlink\" title=\"图床\"></a>图床</h1><p>静态站的头图、文章插图都会用到一些比较大的图片资源，这些资源如果跟其他静态资源放在一起，会有几个缺点：</p>\n<ol>\n<li><p>图片可能越攒越多，对静态站的托管平台造成磁盘空间压力。静态站内的静态资源我是用dropbox同步，所以先于磁盘空间承压的瓶颈点是dropbox容量，这个对我影响比较大。</p>\n</li>\n<li><p>向静态站托管平台同步图片文件渠道通常比较受限，不能随心所欲，不那么方便日常攒图随时更新。这点上用dropbox倒是还算方便。</p>\n</li>\n<li><p>图片在静态站内部，客户端拉取资源需要走站域名，如果你有多个站，不方便跨站共享图，可能会有跨域问题。</p>\n</li>\n<li><p>图片的IO会占据静态站在托管平台的大部分IO带宽，如果你的IO带宽很有限或者流量受限，就比较危险了。有人说可以上CDN，是能缓解不少，但资源更新比较频繁的话，CDN回源也会频繁，还是会吃IO。我VPS带宽、流量可观，所以这点倒是无所谓。</p>\n</li>\n</ol>\n<p>长远考虑，我需要使用独立的、配有CDN的图床。</p>\n<p>上一版静态站，我的图床是七牛图床，当时七牛提供子域名给每个用户空间，现在七牛要求用户自行绑定备案域名。备案可太麻烦了，我选择换方案。</p>\n<p>有人安利过cloudfare的R2存储，虽然可以白嫖，但cloudfare国内被白嫖太多，CDN国内节点经常会负载过高变卡甚至断连。正巧我有了NAS这个便宜宽敞的存储空间，我选择自建对象存储，内网穿透出去作为图床，自配CDN。</p>\n<h2 id=\"minio\"><a href=\"#minio\" class=\"headerlink\" title=\"minio\"></a>minio</h2><p><a href=\"https://min.io/docs/minio/container/index.html\">minio</a>是Amazon S3对象存储的开源对标项目。minio可以用docker容器部署，我的群晖NAS支持docker容器，我在搭open-webui时有现成的<a href=\"https://bipedalbit.net/2025/05/28/%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89LLM%E5%8A%A9%E6%89%8B%E5%B9%B3%E5%8F%B0/#5-2-3-frpc\">frp内网穿透方案</a>在公网暴露minio的API，这不就妥了。</p>\n<p>minio还是用docker-compose部署：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">minio:</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">ghcr.io/minio/minio:RELEASE.2025-04-22T22-12-26Z</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">minio</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./data:/data</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./config:/root/.minio</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">9000</span><span class=\"hljs-string\">:9000</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">9001</span><span class=\"hljs-string\">:9001</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;MINIO_ROOT_USER=bipedalbit&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;MINIO_ROOT_PASSWORD=****&#x27;</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span><br>    <span class=\"hljs-attr\">command:</span> [<span class=\"hljs-string\">&quot;server /data --console-address :9001&quot;</span>]<br></code></pre></td></tr></table></figure>\n<p><strong>注意2025.5.24发布的minio更新版本中，把minio的web控制台功能从社区版代码里移除了：<a href=\"https://github.com/minio/minio/releases/tag/RELEASE.2025-05-24T17-08-30Z\">RELEASE.2025-05-24T17-08-30Z</a></strong></p>\n<p><strong>挪到商业版里了，挣钱嘛，不寒碜。所以我这里没有用latest镜像，而是用了还有web控制台的最后一个版本。</strong></p>\n<p><strong><code>--console-address</code>如果不指定，会在每次启动容器时随机变化。</strong></p>\n<p>web控制台端口我不暴露到公网，安全保障。控制台界面跟普通S3对象存储的界面大同小异，能建桶，能配用户策略、桶策略，能配跨域白名单，能在界面操作桶文件。</p>\n<p><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/minio/minio_2025-06-07_20-38-12.png\" alt=\"minio登录页\"><br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/minio/minio_2025-06-07_20-38-43.png\" alt=\"minio桶列表\"><br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/minio/minio_2025-06-07_20-39-14.png\" alt=\"minio桶详情\"></p>\n<h2 id=\"CDN\"><a href=\"#CDN\" class=\"headerlink\" title=\"CDN\"></a>CDN</h2><p>有了对象存储，接下来就是选一个全球都有节点，不至于卡的、白嫖额度多的CDN。公布答案吧，我选了<a href=\"https://console.lightcdn.com/cdnResources\">LightCDN</a>，这家CDN的卖点是尽量让冷门区域也有节点覆盖，所以全球加速效果都不会太差，但也不会太快，对我来说足够了。</p>\n<p><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/lightcdn/lightcdn_2025-06-07_21-33-43.png\" alt=\"lightcdn请求统计\"><br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/lightcdn/lightcdn_2025-06-07_21-34-38.png\" alt=\"lightcdn费用统计\"></p>\n<h1 id=\"Waline\"><a href=\"#Waline\" class=\"headerlink\" title=\"Waline\"></a>Waline</h1><p>多说评论插件挂了有一阵子了，一直没顾上换新方案。时间尺度一拉长，就发现依赖第三方服务的插件还是欠缺稳定性，不如自建。</p>\n<p>关于<a href=\"https://waline.js.org/\">waline</a>，我简要介绍一下：</p>\n<ul>\n<li><p>hexo的fluid主题对waline有适配支持，不需要手动做代码嵌入</p>\n</li>\n<li><p><a href=\"https://waline.js.org/guide/features/\">功能挺全</a>：</p>\n<ul>\n<li><p>能做基于Markdown的富文本评论编辑，支持微博表情</p>\n</li>\n<li><p>支持评论后台审核</p>\n</li>\n<li><p>支持匿名评论和用户注册</p>\n</li>\n<li><p>支持多语言界面</p>\n</li>\n<li><p>支持页面浏览量和评论数统计</p>\n</li>\n<li><p>支持邮件、微信、QQ、Telegram、Discord、飞书等各种webhook通知</p>\n</li>\n</ul>\n</li>\n<li><p><a href=\"https://waline.js.org/guide/database.html\">数据库部分</a>：可以有多种选择，SaaS可以用LeanCloud，DB就多了，MongoDB、MYSQL、TiDB、SQLite、PostgreSQL、腾讯的CloudBase，甚至能把github仓库当DB用。</p>\n</li>\n<li><p><a href=\"https://waline.js.org/guide/deploy/\">服务端部分</a>：可以在各种全栈应用托管平台部署，也可以自己在云主机上做独立部署。</p>\n</li>\n</ul>\n<p>我选择SQLite+独立部署服务端：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">version:</span> <span class=\"hljs-string\">&#x27;3.8&#x27;</span><br><br><span class=\"hljs-attr\">services:</span><br>  <span class=\"hljs-attr\">waline:</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">lizheming/waline:latest</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">waline</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span><span class=\"hljs-string\">:8086:8360</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$&#123;PWD&#125;/data:/app/data</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">TZ:</span> <span class=\"hljs-string\">&#x27;Asia/Shanghai&#x27;</span><br>      <span class=\"hljs-attr\">SQLITE_PATH:</span> <span class=\"hljs-string\">&#x27;/app/data&#x27;</span><br>      <span class=\"hljs-attr\">JWT_TOKEN:</span> <span class=\"hljs-string\">$&#123;JWT_TOKEN&#125;</span><br>      <span class=\"hljs-attr\">SITE_NAME:</span> <span class=\"hljs-string\">&quot;BipedalBit&#x27;s blog&quot;</span><br>      <span class=\"hljs-attr\">SITE_URL:</span> <span class=\"hljs-string\">&#x27;https://bipedalbit.net&#x27;</span><br>      <span class=\"hljs-attr\">SECURE_DOMAINS:</span> <span class=\"hljs-string\">&#x27;bipedalbit.net,****,****&#x27;</span><br>      <span class=\"hljs-attr\">SERVER_URL:</span> <span class=\"hljs-string\">&#x27;https://****&#x27;</span><br>      <span class=\"hljs-attr\">AUTHOR_EMAIL:</span> <span class=\"hljs-string\">&#x27;****&#x27;</span><br>      <span class=\"hljs-comment\">#LEAN_ID: $&#123;LEAN_ID&#125;</span><br>      <span class=\"hljs-comment\">#LEAN_KEY: $&#123;LEAN_KEY&#125;</span><br>      <span class=\"hljs-comment\">#LEAN_MASTER_KEY: $&#123;LEAN_MASTER_KEY&#125;</span><br>      <span class=\"hljs-attr\">SMTP_SERVICE:</span> <span class=\"hljs-string\">&#x27;QQ&#x27;</span><br>      <span class=\"hljs-attr\">SMTP_USER:</span> <span class=\"hljs-string\">$&#123;SMTP_USER&#125;</span><br>      <span class=\"hljs-attr\">SMTP_PASS:</span> <span class=\"hljs-string\">$&#123;SMTP_PASS&#125;</span><br>      <span class=\"hljs-attr\">SENDER_NAME:</span> <span class=\"hljs-string\">&#x27;bot&#x27;</span><br>      <span class=\"hljs-attr\">SENDER_EMAIL:</span> <span class=\"hljs-string\">&#x27;****&#x27;</span><br>      <span class=\"hljs-attr\">IPQPS:</span> <span class=\"hljs-number\">5</span><br>      <span class=\"hljs-attr\">COMMENT_AUDIT:</span> <span class=\"hljs-string\">&#x27;false&#x27;</span><br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><p>老规矩，不直接暴露端口到公网，nginx做汇聚入口和反向代理。</p>\n</li>\n<li><p>除了官方文档里提到的功能，还能配跨域白名单、QPS限制。</p>\n</li>\n<li><p>sqlite部署方式有点尴尬，需要从github仓库自己下载初始化好的<a href=\"https://github.com/walinejs/waline/blob/main/assets/waline.sqlite\">waline.sqlite文件</a>挂载进容器。</p>\n</li>\n</ul>\n<p><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/waline/waline_2025-06-07_22-53-58.png\" alt=\"waline评论管理\"><br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/waline/waline_2025-06-07_22-55-19.png\" alt=\"waline用户管理\"><br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/waline/waline_2025-06-07_22-54-42.png\" alt=\"waline用户编辑\"></p>\n",
            "tags": [
                "hexo",
                "NAS",
                "minio",
                "CDN",
                "waline"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2025/05/28/%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89LLM%E5%8A%A9%E6%89%8B%E5%B9%B3%E5%8F%B0/",
            "url": "https://blog.bipedalbit.net/2025/05/28/%E6%90%AD%E5%BB%BA%E7%A7%81%E6%9C%89LLM%E5%8A%A9%E6%89%8B%E5%B9%B3%E5%8F%B0/",
            "title": "搭建私有LLM助手平台",
            "date_published": "2025-05-28T14:19:35.000Z",
            "content_html": "<p>​    难得翻新了博客，正好把最近整的新活记录分享一下。</p>\n<h1 id=\"1-效果\"><a href=\"#1-效果\" class=\"headerlink\" title=\"1 效果\"></a>1 效果</h1><p>​    先看效果再讲过程，给缺耐心的读者节省时间。</p>\n<h2 id=\"1-1-类APP效果\"><a href=\"#1-1-类APP效果\" class=\"headerlink\" title=\"1.1 类APP效果\"></a>1.1 类APP效果</h2><table>\n    <tr>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/IMG_20250525_194039.jpg\">安卓手机上的类app效果</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-20-31-877_com.android.chrome.jpg\">open-webui首页效果</center></td>\n    </tr>\n</table>\n\n\n<p>​    很像移动端app客户端吧，实际上这是PWA。PWA（Progressive Web App，渐进式网络应用）是一种结合了网页和原生应用优势的新型应用形态。它通过现代Web技术实现以下核心特性：</p>\n<ol>\n<li><strong>渐进增强</strong><br>所有用户都能访问基础网页功能，但支持现代浏览器的用户可获得增强体验（如离线访问、推送通知等）。</li>\n<li><strong>响应式设计</strong><br>自适应不同设备屏幕，提供无缝的移动体验。</li>\n<li><strong>离线支持</strong><br>通过Service Worker缓存资源，即使网络中断也能访问关键内容。</li>\n<li><strong>推送通知</strong><br>类似原生应用，可向用户发送实时通知（需用户授权）。</li>\n<li><strong>可安装性</strong><br>用户可将PWA添加到主屏幕，形成类似原生应用的快捷方式（无需应用商店）。</li>\n<li><strong>性能优化</strong><br>通过缓存策略和资源预加载，实现接近原生应用的加载速度。</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>特性</th>\n<th>传统Web应用</th>\n<th>原生应用</th>\n<th>PWA</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>离线访问</td>\n<td>不支持</td>\n<td>支持</td>\n<td>支持（通过缓存）</td>\n</tr>\n<tr>\n<td>推送通知</td>\n<td>不支持</td>\n<td>支持</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>安装方式</td>\n<td>无需安装</td>\n<td>需下载安装</td>\n<td>可添加到主屏幕</td>\n</tr>\n<tr>\n<td>跨平台兼容性</td>\n<td>依赖浏览器</td>\n<td>平台专属</td>\n<td>一次开发多端运行</td>\n</tr>\n<tr>\n<td>开发成本</td>\n<td>低</td>\n<td>高（需多平台开发）</td>\n<td>中（Web技术）</td>\n</tr>\n</tbody></table>\n<p>​    open-webui毕竟是基于web的UI，open-webui添加PWA支持前，我也一直在浏览器里使用。不过，私用的LLM助手，就算有鉴权、CDN、防DDos，我也不会贴公网url就是了，非工业方案薄弱环节应该还是挺多的。</p>\n<h2 id=\"1-2-chat界面效果\"><a href=\"#1-2-chat界面效果\" class=\"headerlink\" title=\"1.2 chat界面效果\"></a>1.2 chat界面效果</h2><table>\n    <tr>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-23-46-437_com.android.chrome.jpg\">chat效果1</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-26-36-331_com.android.chrome.jpg\">chat效果2</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-29-08-235_com.android.chrome.jpg\">chat效果3</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-29-27-184_com.android.chrome.jpg\">chat效果4</center></td>\n    </tr>\n</table>\n\n<table>\n    <tr>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-20-40-20-184_com.android.chrome.jpg\">chat效果5</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-20-40-39-144_com.android.chrome.jpg\">chat效果6</center></td>\n    </tr>\n</table>\n\n<ul>\n<li><p>chat界面右上角能点开参数配置面板，只影响当前会话，有大量LLM推理参数暴露。实际使用场景中，除了用Temperature调整文本生成的多样性倾向，我几乎不会调整这些参数。</p>\n</li>\n<li><p>chat界面左上角能点开模型选择列表，写文这会儿我的默认模型是本地的qwen3-14B，外部API接入模型和本地部署模型可以在同一个会话中交替选用，会话上下文对新加入会话的模型也保持可见。模型列表的搜索框也可以拉取ollama hub的新模型在本地部署。</p>\n</li>\n<li><p>MCP工具我多给点镜头，“+”号可以开启关闭模型可见的工具。所谓MCP（Model Context Protocol，模型上下文协议）就是令工具提示词使用标准的结构化形式，固化到工具中，同时这个工具调用形式在LLM训练阶段参与多任务模型微调。然而模型看着对话上下文和可用工具列表，最终怎么选用工具，就取决于具体模型的工具规划能力了。这里我用查询明天武汉天气作为例子，展示推理类模型利用时间查询工具和高德地图的城市天气查询工具，解决用户需求的过程。为什么我要分2步问？因为2次工具调用有顺序依赖关系，这类似一个工作流或者所谓的agentic任务规划过程。</p>\n</li>\n<li><p>能看到“+”号点开后能截图和上传文件，发送按钮左边有个语音输入按钮，支持多模态输入。</p>\n</li>\n<li><p>除了可以使用工具引入实时数据，也能用固定提示词和搜索引擎接口引入联网搜索结果作为上下文信息。实测这基本可以跟搜索引擎类MCP工具等同，但默认的联网搜索和RAG会在更大召回范围内先做文本编码，可以认为检索“视野”更宽，召回能力更强一些。</p>\n</li>\n<li><p>代码解释器我还没玩过，看了下配置选项，是python沙箱，我参与的大工程比较多，不太有代码片段可以玩沙箱。</p>\n</li>\n<li><p>模型响应框下方有TTS、重新生成、结果（Markdown格式）复制等等按钮，还挺全的。</p>\n</li>\n<li><p>截图右上角能看到我用的是蜂巢网络（中国移动运营商），没开梯子，所以理论上来说，有网的地方我都能用这个私有LLM助手平台。</p>\n</li>\n<li><p>右下方有open-webui的版本更新提示，拉新镜像重新部署一下就能更新。</p>\n</li>\n</ul>\n<h2 id=\"1-3-平台配置效果\"><a href=\"#1-3-平台配置效果\" class=\"headerlink\" title=\"1.3 平台配置效果\"></a>1.3 平台配置效果</h2><table>\n    <tr>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-30-38-565_com.android.chrome.jpg\">平台配置效果1</center></td>\n    </tr>\n</table>\n\n<table>\n    <tr>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-31-29-519_com.android.chrome.jpg\">平台配置效果2</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-31-50-645_com.android.chrome.jpg\">平台配置效果3</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-32-07-909_com.android.chrome.jpg\">平台配置效果4</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-32-37-040_com.android.chrome.jpg\">平台配置效果5</center></td>\n    </tr>\n</table>\n\n<table>\n    <tr>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-34-09-990_com.android.chrome.jpg\">平台配置效果6</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-34-32-447_com.android.chrome.jpg\">平台配置效果7</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-34-48-225_com.android.chrome.jpg\">平台配置效果8</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-35-08-724_com.android.chrome.jpg\">平台配置效果9</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/Screenshot_2025-05-25-19-36-02-805_com.android.chrome.jpg\">平台配置效果10</center></td>\n    </tr>\n</table>\n\n<ul>\n<li><p>首先open-webui有用户、鉴权、角色、用户组管理功能。私用嘛，现在整个平台就我一个用户。</p>\n</li>\n<li><p>外部连接有两个用途，以OpenAI格式（注意这是LLM厂商的接口风格，跟OpenAPI的通用接口规范不是一回事）对接厂商模型API，以ollama格式对接本地部署模型。如果厂商不是OpenAI格式呢？后面我会讲。</p>\n</li>\n<li><p>模型配置里，可以看到所有的外部接入、本地部署模型，可以单独配置模型是否启动、默认推理参数、系统提示词、默认可用工具列表、是否显示usage等配置项。右上角的下载按钮点开可以跟ollama交互增删本地模型。</p>\n</li>\n<li><p>工具配置里可以给每个工具配置OpenAPI规范的API，可以看到其实我也配了有搜索引擎性质的github、arxiv、searxng MCP工具，来引入实时的领域或开放信息。如果工具不是OpenAPI规范呢？后面我会讲。</p>\n</li>\n<li><p>open-webui的这种工具接入形式，目前还只能扩展上下文，还属于RAG的变种形式，如果想实现agent，做多阶段的工具链规划与调用，需要用到open-webui的pipeline配置。这个我还没玩过，个人使用，还没那么多固化的复杂工作流想配。</p>\n</li>\n<li><p>联网搜索能配相当多的搜索引擎接口类型，我是用自己部署的searxng这个元搜索引擎（能个性化定制、自行整合多个搜索引擎的结果）。</p>\n</li>\n<li><p>代码解释器配置，能看到是两个python轻量沙箱，这类沙箱的通病是跑跑抽象代码片段还行，依赖包一复杂，工程体量一大就麻烦了，毕竟不是conda、docker这种能做一定程度环境隔离的重沙箱。</p>\n</li>\n<li><p>提示词配置，是PE（Prompt Engineering，提示词工程）时代遗留的功能，我是没使用场景的。果然模型迭代一快，大量提示词都要变成摆设，而模型一定会快速迭代。</p>\n</li>\n<li><p>语音功能配置，用来配语音转文本模型和文本转语音模型。我不太爱靠说话交流，保留默认配置。</p>\n</li>\n</ul>\n<h1 id=\"2-契机与遗憾\"><a href=\"#2-契机与遗憾\" class=\"headerlink\" title=\"2 契机与遗憾\"></a>2 契机与遗憾</h1><p>​    2024年11月左右，我终于有了自己梦寐以求的N卡台式机和NAS。彼时开源生态支持完善的qwen2.5刚发布不久，我想把这些烧钱设备变成生产力的热情高涨。</p>\n<p>​    我的显卡是NVIDIA 4070Ti Super，NAS是群晖DS224+。现在看这两个型号选择都留了点暗坑，后来人引以为戒：</p>\n<ul>\n<li><p>4070tis虽然算力OK，但显存只有16GB，复现不了工业场景常用的24GB显存（比如4090卡）轻量部署方案。通常只够部署14B规模（140亿参数量，模型文件大概9GB出头，模型推理占显存10GB出头）的模型。模型参数量到显存空间的换算过程我在这里先不展开聊。</p>\n</li>\n<li><p>DS224+这NAS算群晖最新的入门款，2开头就是2盘位，够用，何况之前我为了从复旦的NLP实验室搞语料买了个16T黑盘，虽然不能用来组RAID但可以用来外接扩展。坑在于我家明明做了全屋超6类网线，具备户内万兆通信的基础，可这款NAS只有2个1Gb的网口，也就是最多做双通道的千兆通信，顶天2千兆带宽，读写大文件时，NAS网口成IO瓶颈了┓(´∀&#96; )┏。</p>\n</li>\n</ul>\n<h1 id=\"3-核心方案选型\"><a href=\"#3-核心方案选型\" class=\"headerlink\" title=\"3 核心方案选型\"></a>3 核心方案选型</h1><p>​    我长期在微博上跟进AI开源圈的消息，爱可可-爱生活（号主是北邮模式识别实验室的陈老师）、黄建同学（前微软高工）、宝玉xp（前微软高工），都是不错的大V，2024年整年AI开源壳工具层出不穷。</p>\n<p>​    优秀、高性能的通用本地LLM推理工具<a href=\"https://github.com/ollama/ollama\">ollama</a>脱颖而出，迅速占据本地LLM推理事实开源方案标准的地位。<a href=\"https://github.com/ollama/ollama\">ollama</a>的配套生态迅速发展，它的官推UI壳<a href=\"https://github.com/open-webui/open-webui\">open-webui</a>也进入我的视线，后来这个UI壳更是迅速扩展成了相当流行的通用AI壳甚至是小规模AI应用平台（能chat，能多模态交互，能建工作流，能RAG，能接工具包括后来的MCP工具）。</p>\n<p>​    于是，ollama搞定部署、open-webui搞定前后端的方案主体敲定了。</p>\n<h1 id=\"4-完善方案\"><a href=\"#4-完善方案\" class=\"headerlink\" title=\"4 完善方案\"></a>4 完善方案</h1><h2 id=\"4-1-痛点\"><a href=\"#4-1-痛点\" class=\"headerlink\" title=\"4.1 痛点\"></a>4.1 痛点</h2><p>​    本地部署ollama和open-webui很顺利，完成demo验证后，一些瓶颈问题浮现：</p>\n<ol>\n<li><p>各家厂商的开源模型中，我希望本地部署体验的模型很多，会迅速占用大量磁盘空间；</p>\n</li>\n<li><p>我当然希望在上班或者不在家时也能随时随地使用LLM助手；</p>\n</li>\n<li><p>除了本地部署的算力受限的几种开源模型，必要的时候我也希望在同一个应用里白嫖厂商开放的LLM；</p>\n</li>\n<li><p>我的PC不可能永远用来跑模型，有时会关机，有时会用来切win系统打游戏（我装了双系统，win用来娱乐，ubuntu用来开发和当服务器）。</p>\n</li>\n</ol>\n<h2 id=\"4-2-解法\"><a href=\"#4-2-解法\" class=\"headerlink\" title=\"4.2 解法\"></a>4.2 解法</h2><table>\n<thead>\n<tr>\n<th>需求</th>\n<th>解决方案</th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>本地模型存储</td>\n<td>NAS NFS挂载</td>\n<td>空间不受限，RAID可靠，14B模型初次换入加载在1min左右耗时可接受。</td>\n</tr>\n<tr>\n<td>外网暴露</td>\n<td><a href=\"https://github.com/fatedier/frp\">frp</a> + 自有域名 + 自有VPS</td>\n<td>frp写文时已经94.3k star的golang开源老牌内网穿透工具，有自有域名和VPS的情况下，比运营商固定IP灵活很多，性能要求不苛刻，实测时延几乎不可感知。</td>\n</tr>\n<tr>\n<td>模型API归一化</td>\n<td><a href=\"https://github.com/songquanpeng/one-api\">one-api</a></td>\n<td>写文时已经25.4k star的开源LLM API 管理 &amp; 分发系统，适配了国内外几乎所有让人有接入意愿的通用LLM厂商API。</td>\n</tr>\n<tr>\n<td>部署拓扑</td>\n<td>见下图</td>\n<td>ollama在PC，open-webui、frpc在NAS，frps、one-api、nginx、ssl在VPS，兼顾可维护性、网络可达要求、VPS轻量原则。</td>\n</tr>\n</tbody></table>\n<p><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/bipedalbit-open-webui-deploy.svg\" alt=\"BipedalBit Open-WebUI部署拓扑\"></p>\n<h1 id=\"5-实现详情\"><a href=\"#5-实现详情\" class=\"headerlink\" title=\"5 实现详情\"></a>5 实现详情</h1><h2 id=\"5-1-PC\"><a href=\"#5-1-PC\" class=\"headerlink\" title=\"5.1 PC\"></a>5.1 PC</h2><p>​    按照我的个人习惯，给PC装双系统，win平台娱乐，ubuntu系统下做开发，也适合作为服务长期运行（例如我出门在外时）的服务器环境。</p>\n<h3 id=\"5-1-1-NAS挂载\"><a href=\"#5-1-1-NAS挂载\" class=\"headerlink\" title=\"5.1.1 NAS挂载\"></a>5.1.1 NAS挂载</h3><h4 id=\"安装NFS客户端\"><a href=\"#安装NFS客户端\" class=\"headerlink\" title=\"安装NFS客户端\"></a>安装NFS客户端</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">sudo apt update<br>sudo apt install nfs-common<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"挂载NFS共享目录\"><a href=\"#挂载NFS共享目录\" class=\"headerlink\" title=\"挂载NFS共享目录\"></a>挂载NFS共享目录</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">sudo mount -t nfs &lt;NFS服务器IP&gt;:/&lt;共享路径&gt; /&lt;本地挂载点&gt;<br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\">示例</span><br><span class=\"hljs-meta prompt_\"># </span><span class=\"language-bash\"><span class=\"hljs-built_in\">sudo</span> mount -t nfs 192.168.1.100:/shared_folder /mnt/nfs</span><br></code></pre></td></tr></table></figure>\n<ul>\n<li><code>&lt;NFS服务器IP&gt;</code>：NFS服务器的IP地址</li>\n<li><code>/&lt;共享路径&gt;</code>：NFS服务器上共享的目录路径</li>\n<li><code>/&lt;本地挂载点&gt;</code>：Ubuntu系统上用于挂载的本地目录（需提前创建）</li>\n</ul>\n<h4 id=\"检查挂载点\"><a href=\"#检查挂载点\" class=\"headerlink\" title=\"检查挂载点\"></a>检查挂载点</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">ls /mnt/nfs<br></code></pre></td></tr></table></figure>\n\n<h4 id=\"配置开机自动挂载\"><a href=\"#配置开机自动挂载\" class=\"headerlink\" title=\"配置开机自动挂载\"></a>配置开机自动挂载</h4><p>​    编辑 &#x2F;etc&#x2F;fstab 文件，添加以下行：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">NFS服务器IP</span>&gt;</span>:/<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">共享路径</span>&gt;</span>  /<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">本地挂载点</span>&gt;</span>  nfs  defaults  0  0<br></code></pre></td></tr></table></figure>\n<p>示例：</p>\n<figure class=\"highlight accesslog\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs accesslog\"><span class=\"hljs-number\">192.168.1.100</span>:/shared_folder  /mnt/nfs  nfs  defaults  <span class=\"hljs-number\">0</span>  <span class=\"hljs-number\">0</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"5-1-2-ollama\"><a href=\"#5-1-2-ollama\" class=\"headerlink\" title=\"5.1.2 ollama\"></a>5.1.2 ollama</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">services:</span><br>  <span class=\"hljs-attr\">ollama:</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$&#123;OLLAMA_DATA_DIR-~/workspace/docker-data/ollama-data&#125;:/root/.ollama</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">ollama</span><br>    <span class=\"hljs-attr\">pull_policy:</span> <span class=\"hljs-string\">always</span><br>    <span class=\"hljs-attr\">tty:</span> <span class=\"hljs-literal\">true</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">ollama/ollama:$&#123;OLLAMA_DOCKER_TAG-latest&#125;</span><br>    <span class=\"hljs-attr\">deploy:</span><br>      <span class=\"hljs-attr\">resources:</span><br>        <span class=\"hljs-attr\">reservations:</span><br>          <span class=\"hljs-attr\">devices:</span><br>            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">driver:</span> <span class=\"hljs-string\">nvidia</span><br>              <span class=\"hljs-attr\">device_ids:</span> [<span class=\"hljs-string\">&#x27;0&#x27;</span>]<br>              <span class=\"hljs-attr\">capabilities:</span> [<span class=\"hljs-string\">gpu</span>]<br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$&#123;OLLAMA_WEBAPI_PORT-11434&#125;:11434</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;NVIDIA_VISIBLE_DEVICES=all&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;CUDA_MPS_ENABLE=1&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;CUDA_CACHE_PATH=/tmp&#x27;</span><br>      <span class=\"hljs-comment\"># - &#x27;CUDA_LAUNCH_BLOCKING=1&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;OLLAMA_MAX_GPU_MEMORY=16000&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;OLLAMA_USE_GPU=1&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;HTTP_PROXY=http://****:10809&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;HTTPS_PROXY=http://****:10809&#x27;</span><br>    <span class=\"hljs-comment\"># 容器内忽然无法使用GPU问题，已经用以下方案解决：</span><br>    <span class=\"hljs-comment\"># 在 /etc/docker/daemon.json 中添加 &quot;exec-opts&quot;: [&quot;native.cgroupdriver=cgroupfs&quot;]</span><br>    <span class=\"hljs-comment\"># 等待5s防止nfs未挂载完成</span><br>    <span class=\"hljs-attr\">entrypoint:</span> [<span class=\"hljs-string\">&quot;/bin/bash&quot;</span>, <span class=\"hljs-string\">&quot;-c&quot;</span>]<br>    <span class=\"hljs-attr\">command:</span> [<span class=\"hljs-string\">&quot;sleep 5 &amp;&amp; exec /bin/ollama serve&quot;</span>]<br></code></pre></td></tr></table></figure>\n\n<ul>\n<li><code>pull_policy: always</code>让我每次重启ollama时都能自动更新。</li>\n<li><code>HTTP_PROXY=http://****:10809</code>和<code>HTTPS_PROXY=http://****:10809</code>是在配代理，从ollama的模型hub拉开源模型是ollama自身的行为，所以它需要用梯子的。配置的是局域网里的梯子v2ray客户端地址，比如，可以在NAS上。</li>\n<li><code>OLLAMA_MAX_GPU_MEMORY=16000</code>是因为我显卡显存16GB，大家看自己情况调整。</li>\n<li>在<code>/etc/docker/daemon.json</code>中添加<code>&quot;exec-opts&quot;: [&quot;native.cgroupdriver=cgroupfs&quot;]</code>解容器偶发掉卡问题还挺难查的。</li>\n<li>用sleep解重新开机时容器启动早于NFS挂载就绪的问题挺偷懒的，我觉得应该有更优雅的解法。</li>\n</ul>\n<h2 id=\"5-2-NAS\"><a href=\"#5-2-NAS\" class=\"headerlink\" title=\"5.2 NAS\"></a>5.2 NAS</h2><p>​    群晖NAS让我很喜欢的一点就是可以玩docker容器，甚至docker-compose项目也支持。这样一些希望常驻且磁盘IO或容量要求高的应用就可以部署在NAS上了。</p>\n<h3 id=\"5-2-1-v2ray（客户端）\"><a href=\"#5-2-1-v2ray（客户端）\" class=\"headerlink\" title=\"5.2.1 v2ray（客户端）\"></a>5.2.1 v2ray（客户端）</h3><p>​    2025年海外docker镜像仓库包括docker官方仓库都在国内有访问障碍，为了方便拉镜像做部署，最简单的解决方案就是利用VPS搭个梯子了，有现成梯子当然也可以用。早些年，梯子客户端还是shadowsocks，这两年我也紧跟时代换成了v2ray生态的各种变种客户端和clash，个人感觉相比起来v2ray会比clash上手更方便、灵活一些。<br>​    首先要准备一个目录，来装几个必要文件：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs shell\">v2ray<br>├── localtime<br>├── timezone<br>└── v2ray<br>    ├── config.json<br>    ├── geoip.dat<br>    ├── geoip.metadb<br>    ├── geoip-only-cn-private.dat<br>    └── geosite.dat<br></code></pre></td></tr></table></figure>\n<ul>\n<li>localtime、timezone是为了保证v2ray客户端和服务端的时钟保持一致，不一致通信会不通的。起容器时会挂载进去替换docker镜像里的原始文件。</li>\n<li>v2ray子目录里是v2ray客户端依赖的资源文件，其中geoip是各种网络局域辅助判定规则集，跟GFW打交道的。</li>\n<li><code>v2ray/config.json</code>是v2ray客户端的核心配置文件，通常可以用图形界面的v2ray客户端配置完后复制出来用，或者网上找一份改改用。大概长这样：</li>\n</ul>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\"><span class=\"hljs-punctuation\">&#123;</span><br>  <span class=\"hljs-attr\">&quot;log&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;access&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;error&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;loglevel&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;warning&quot;</span><br>  <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>  <span class=\"hljs-attr\">&quot;inbounds&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-punctuation\">&#123;</span><br>      <span class=\"hljs-attr\">&quot;tag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;socks&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;port&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">10808</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;listen&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0.0.0.0&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;protocol&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;socks&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;sniffing&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;enabled&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;destOverride&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;http&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;tls&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;routeOnly&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">false</span></span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;settings&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;auth&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;noauth&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;udp&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;allowTransparent&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">false</span></span><br>      <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-punctuation\">&#123;</span><br>      <span class=\"hljs-attr\">&quot;tag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;http&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;port&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">10809</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;listen&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0.0.0.0&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;protocol&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;http&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;sniffing&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;enabled&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;destOverride&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;http&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;tls&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;routeOnly&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">false</span></span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;settings&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;auth&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;noauth&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;udp&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">true</span></span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;allowTransparent&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">false</span></span><br>      <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><br>  <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>  <span class=\"hljs-attr\">&quot;outbounds&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>    <span class=\"hljs-punctuation\">&#123;</span><br>      <span class=\"hljs-attr\">&quot;tag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;proxy&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;protocol&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;****&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;settings&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;vnext&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;****&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;port&quot;</span><span class=\"hljs-punctuation\">:</span> ****<span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;users&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>              <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;id&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;****&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;alterId&quot;</span><span class=\"hljs-punctuation\">:</span> ****<span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;email&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;****&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-attr\">&quot;security&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;auto&quot;</span><br>              <span class=\"hljs-punctuation\">&#125;</span><br>            <span class=\"hljs-punctuation\">]</span><br>          <span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">]</span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;streamSettings&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;network&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;tcp&quot;</span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;mux&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;enabled&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-literal\"><span class=\"hljs-keyword\">false</span></span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;concurrency&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-number\">-1</span><br>      <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-punctuation\">&#123;</span><br>      <span class=\"hljs-attr\">&quot;tag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;direct&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;protocol&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;freedom&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;settings&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-punctuation\">&#123;</span><br>      <span class=\"hljs-attr\">&quot;tag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;block&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;protocol&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;blackhole&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;settings&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;response&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>          <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;http&quot;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><br>      <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><br>  <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>  <span class=\"hljs-attr\">&quot;dns&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;hosts&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>      <span class=\"hljs-attr\">&quot;dns.google&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;8.8.8.8&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-attr\">&quot;proxy.example.com&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;127.0.0.1&quot;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;servers&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>      <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;223.5.5.5&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;domains&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;geosite:cn&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;geosite:geolocation-cn&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;expectIPs&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;geoip:cn&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-string\">&quot;1.1.1.1&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-string\">&quot;8.8.8.8&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-string\">&quot;https://dns.google/dns-query&quot;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;address&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;223.5.5.5&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;domains&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;bipedalbit.net&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><br>      <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">]</span><br>  <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>  <span class=\"hljs-attr\">&quot;routing&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;domainStrategy&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;AsIs&quot;</span><span class=\"hljs-punctuation\">,</span><br>    <span class=\"hljs-attr\">&quot;rules&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>      <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;field&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;inboundTag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;api&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;outboundTag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;api&quot;</span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;field&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;outboundTag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;proxy&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;domain&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;domain:googleapis.cn&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;domain:gstatic.com&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;field&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;port&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;443&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;network&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;udp&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;outboundTag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;block&quot;</span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;field&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;outboundTag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;block&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;domain&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;geosite:category-ads-all&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;field&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;outboundTag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;direct&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;ip&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;geoip:private&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;field&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;outboundTag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;direct&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;domain&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;geosite:private&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;field&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;outboundTag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;direct&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;ip&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;223.5.5.5/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;223.6.6.6/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;2400:3200::1/128&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;2400:3200:baba::1/128&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;119.29.29.29/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;1.12.12.12/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;120.53.53.53/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;2402:4e00::/128&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;2402:4e00:1::/128&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;180.76.76.76/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;2400:da00::6666/128&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;114.114.114.114/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;114.114.115.115/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;180.184.1.1/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;180.184.2.2/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;101.226.4.6/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;218.30.118.6/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;123.125.81.6/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;140.207.198.6/32&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;geoip:cn&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;field&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;outboundTag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;direct&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;domain&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>          <span class=\"hljs-string\">&quot;domain:dns.alidns.com&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;domain:doh.pub&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;domain:dot.pub&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;domain:doh.360.cn&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;domain:dot.360.cn&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;geosite:cn&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;geosite:geolocation-cn&quot;</span><span class=\"hljs-punctuation\">,</span><br>          <span class=\"hljs-string\">&quot;domain:bipedalbit.net&quot;</span><br>        <span class=\"hljs-punctuation\">]</span><br>      <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>      <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;type&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;field&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;port&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;0-65535&quot;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;outboundTag&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;proxy&quot;</span><br>      <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">]</span><br>  <span class=\"hljs-punctuation\">&#125;</span><br><span class=\"hljs-punctuation\">&#125;</span><br></code></pre></td></tr></table></figure>\n<p>​    接下来是docker-compose.yaml：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">v2ray-client:</span><br>    <span class=\"hljs-attr\">mage:</span> <span class=\"hljs-string\">v2fly/v2fly-core</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">v2ray-client</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span><br>    <span class=\"hljs-attr\">network_mode:</span> <span class=\"hljs-string\">host</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./v2ray:/etc/v2ray</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./localtime:/etc/localtime</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./timezone:/etc/timezone</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"5-2-2-open-webui\"><a href=\"#5-2-2-open-webui\" class=\"headerlink\" title=\"5.2.2 open-webui\"></a>5.2.2 open-webui</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">open-webui:</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">ghcr.io/open-webui/open-webui:$&#123;WEBUI_DOCKER_TAG-main&#125;</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">open-webui</span><br>    <span class=\"hljs-attr\">pull_policy:</span> <span class=\"hljs-string\">always</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">.:/app/backend/data</span><br>    <span class=\"hljs-attr\">depends_on:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">ollama</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-number\">8080</span><span class=\"hljs-string\">:8080</span><br>    <span class=\"hljs-attr\">extra_hosts:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">host.docker.internal:host-gateway</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;HTTP_PROXY=http://****:10809&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;http_proxy=http://****:10809&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;HTTPS_PROXY=http://****:10809&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;https_proxy=http://****:10809&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;OLLAMA_BASE_URL=http://****:11434&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;WEBUI_SECRET_KEY=&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;WEBUI_URL=https://****&#x27;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&#x27;ENABLE_WEBSOCKET_SUPPORT=true&#x27;</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"5-2-3-frpc\"><a href=\"#5-2-3-frpc\" class=\"headerlink\" title=\"5.2.3 frpc\"></a>5.2.3 frpc</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">frpc:</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">snowdreamtech/frpc</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">frpc</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span><br>    <span class=\"hljs-attr\">network_mode:</span> <span class=\"hljs-string\">host</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./frpc.toml:/etc/frp/frpc.toml</span><br></code></pre></td></tr></table></figure>\n<p>​    frp客户端配置文件frpc.toml长这样：</p>\n<figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs toml\"><span class=\"hljs-attr\">serverAddr</span> = <span class=\"hljs-string\">&quot;bipedalbit.net&quot;</span><br><span class=\"hljs-attr\">serverPort</span> = ****<br><span class=\"hljs-attr\">auth.token</span> = <span class=\"hljs-string\">&quot;****&quot;</span><br><br><span class=\"hljs-section\">[[proxies]]</span><br><span class=\"hljs-attr\">name</span> = <span class=\"hljs-string\">&quot;open-webui&quot;</span><br><span class=\"hljs-attr\">type</span> = <span class=\"hljs-string\">&quot;tcp&quot;</span><br><span class=\"hljs-attr\">localIP</span> = <span class=\"hljs-string\">&quot;127.0.0.1&quot;</span><br><span class=\"hljs-attr\">localPort</span> = <span class=\"hljs-number\">8080</span><br><span class=\"hljs-attr\">remotePort</span> = <span class=\"hljs-number\">8080</span><br></code></pre></td></tr></table></figure>\n<p>​    不清楚的地方可以看<a href=\"https://gofrp.org/zh-cn/docs/examples/\">frp官方文档</a>。</p>\n<h3 id=\"5-2-4-mcpo2\"><a href=\"#5-2-4-mcpo2\" class=\"headerlink\" title=\"5.2.4 mcpo2\"></a>5.2.4 mcpo2</h3><p>​    <a href=\"https://github.com/open-webui/mcpo\">mcpo</a>是open-webui团队发起的开源项目，用python FastAPI框架写的，旨在快速启动OpenAPI规范接口的mcpserver，有鉴权功能，自解释、更方便部署在云上，方便各种平台接入。贴几张图让大家理解下OpenAPI的好处：</p>\n<table>\n    <tr>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/截图_2025-05-29_00-24-24.png\">OpenAPI格式的MCP服务 /docs</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/截图_2025-05-29_00-24-55.png\">OpenAPI格式的MCP服务 接口列表</center></td>\n        <td ><center><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/截图_2025-05-29_00-25-27.png\">OpenAPI格式的MCP服务 接口详情</center></td>\n    </tr>\n</table>\n\n<p>​    NAS上这个mcpo服务跟VPS上的从部署方式看一模一样，用来对接只限国内的mcp工具服务，比如高德地图。</p>\n<p>​    我魔改了一下原镜像，换了个启动脚本，方便用环境变量配API_KEY：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs bash\"><span class=\"hljs-meta\">#!/bin/bash</span><br><span class=\"hljs-comment\"># @Author: zhangyipeng1</span><br><span class=\"hljs-comment\"># @Date:   2025-05-15 18:12:11</span><br><span class=\"hljs-comment\"># @Last Modified by:   wps</span><br><span class=\"hljs-comment\"># @Last Modified time: 2025-05-15 18:12:23</span><br>mcpo --config /app/config.json --api-key <span class=\"hljs-string\">&quot;<span class=\"hljs-variable\">$API_KEY</span>&quot;</span><br></code></pre></td></tr></table></figure>\n<p>​    通过套壳Dockerfile把启动脚本放入镜像：</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs Dockerfile\"><span class=\"hljs-keyword\">FROM</span> ghcr.io/open-webui/mcpo:main<br><br><span class=\"hljs-keyword\">COPY</span><span class=\"language-bash\"> ./start.sh /app/start.sh</span><br><span class=\"hljs-keyword\">RUN</span><span class=\"language-bash\"> <span class=\"hljs-built_in\">chmod</span> +x /app/start.sh</span><br><br><span class=\"hljs-keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"hljs-string\">&quot;/app/start.sh&quot;</span>]</span><br></code></pre></td></tr></table></figure>\n<p>​    mcp配置文件：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\"><span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;mcpServers&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;amap-maps&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;args&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>                <span class=\"hljs-string\">&quot;-y&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-string\">&quot;@amap/amap-maps-mcp-server&quot;</span><br>            <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;command&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;npx&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;env&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;AMAP_MAPS_API_KEY&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;****&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;time&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;args&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>                <span class=\"hljs-string\">&quot;mcp-server-time&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-string\">&quot;--local-timezone=Asia/Shanghai&quot;</span><br>            <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;command&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;uvx&quot;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;fetch&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;args&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><span class=\"hljs-string\">&quot;mcp-server-fetch&quot;</span><span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;command&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;uvx&quot;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><br><span class=\"hljs-punctuation\">&#125;</span><br></code></pre></td></tr></table></figure>\n<p>​    接下来是docker-compose.yaml，不指定镜像而是从Dockerfile构建镜像：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">services:</span><br>  <span class=\"hljs-attr\">mcpo:</span><br>    <span class=\"hljs-attr\">build:</span><br>      <span class=\"hljs-attr\">context:</span> <span class=\"hljs-string\">.</span><br>      <span class=\"hljs-attr\">dockerfile:</span> <span class=\"hljs-string\">Dockerfile</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&quot;8090:8000&quot;</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">API_KEY:</span> <span class=\"hljs-string\">****</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">./config.json:/app/config.json</span><br></code></pre></td></tr></table></figure>\n\n<h2 id=\"5-3-VPS\"><a href=\"#5-3-VPS\" class=\"headerlink\" title=\"5.3 VPS\"></a>5.3 VPS</h2><p>​    如果只打算维护一台云主机，那么选择一个海外VPS更能满足全球资源拉取、全球信息获取、搭建全球化应用的需求。VPS厂商挺多的就不细说了，我选了个洛杉矶的机房，全球主流资源访问速度和回国网速都不错。</p>\n<p>​    VPS也装ubuntu，开发环境尽量跟PC保持统一，给自己降低心智负担。</p>\n<h3 id=\"5-3-1-v2ray（服务端）\"><a href=\"#5-3-1-v2ray（服务端）\" class=\"headerlink\" title=\"5.3.1 v2ray（服务端）\"></a>5.3.1 v2ray（服务端）</h3><p><a href=\"https://233boy.com/v2ray/v2ray-script/\">一个很方便的v2ray服务端一键部署工具</a></p>\n<h3 id=\"5-3-2-frps\"><a href=\"#5-3-2-frps\" class=\"headerlink\" title=\"5.3.2 frps\"></a>5.3.2 frps</h3><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">services:</span><br>  <span class=\"hljs-attr\">frps:</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">snowdreamtech/frps</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">frps</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">always</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&quot;127.0.0.1:8080:8080&quot;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&quot;****:****&quot;</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">~/frp/frps.toml:/etc/frp/frps.toml</span><br></code></pre></td></tr></table></figure>\n<p>​    frp服务端配置文件frps.toml长这样：</p>\n<figure class=\"highlight toml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs toml\"><span class=\"hljs-attr\">bindPort</span> = ****<br><span class=\"hljs-attr\">auth.token</span> = <span class=\"hljs-string\">&quot;****&quot;</span><br></code></pre></td></tr></table></figure>\n<p>​    不清楚的地方可以看<a href=\"https://gofrp.org/zh-cn/docs/examples/\">frp官方文档</a>。</p>\n<h3 id=\"5-3-3-one-api\"><a href=\"#5-3-3-one-api\" class=\"headerlink\" title=\"5.3.3 one-api\"></a>5.3.3 one-api</h3><p>​    one-api是用来汇聚各厂商的LLM接口，将各种厂商LLM接口统一为OpenAI格式，方便统一接入和灵活切换，渠道管理功能挺完善的：</p>\n<p><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/%E6%88%AA%E5%9B%BE_2025-05-28_21-33-49.png\" alt=\"one-api\"></p>\n<p>​    但是需要注意：</p>\n<ul>\n<li>如果把one-api部署在海外，可能连不上部分国内厂商的接口，例如阿里的百炼平台。</li>\n<li>VPS上用容器部署服务时，如果不打算让服务直接暴露到外网，务必注意暴露端口要带上ip限制，例如<code>127.0.0.1:3000:3000</code>。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">version:</span> <span class=\"hljs-string\">&#x27;3.4&#x27;</span><br><span class=\"hljs-attr\">services:</span><br>  <span class=\"hljs-attr\">redis:</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">&quot;$&#123;REGISTRY:-docker.io&#125;/redis:latest&quot;</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">redis</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span><br><br>  <span class=\"hljs-attr\">db:</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">mysql:latest</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">mysql</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">TZ:</span> <span class=\"hljs-string\">&quot;Asia/Shanghai&quot;</span><br>      <span class=\"hljs-attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"hljs-string\">&quot;****&quot;</span><br>      <span class=\"hljs-attr\">MYSQL_USER:</span> <span class=\"hljs-string\">&quot;oneapi&quot;</span><br>      <span class=\"hljs-attr\">MYSQL_PASSWORD:</span> <span class=\"hljs-string\">&quot;****&quot;</span><br>      <span class=\"hljs-attr\">MYSQL_DATABASE:</span> <span class=\"hljs-string\">&quot;one-api&quot;</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">~/mysql-data:/var/lib/mysql</span><br><br>  <span class=\"hljs-attr\">one-api:</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">&quot;$&#123;REGISTRY:-docker.io&#125;/justsong/one-api:latest&quot;</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">one-api</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&quot;127.0.0.1:3000:3000&quot;</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-attr\">TZ:</span> <span class=\"hljs-string\">&quot;Asia/Shanghai&quot;</span><br>      <span class=\"hljs-attr\">SQL_DSN:</span> <span class=\"hljs-string\">&quot;oneapi:****@tcp(db:3306)/one-api?charset=utf8mb4&quot;</span><br>      <span class=\"hljs-attr\">REDIS_CONN_STRING:</span> <span class=\"hljs-string\">&quot;redis://redis&quot;</span><br>      <span class=\"hljs-attr\">SESSION_SECRET:</span> <span class=\"hljs-string\">&quot;****&quot;</span><br>     <span class=\"hljs-comment\"># NODE_TYPE: slave  # 多机部署时从节点取消注释该行</span><br>     <span class=\"hljs-comment\"># SYNC_FREQUENCY: 60  # 需要定期从数据库加载数据时取消注释该行</span><br>     <span class=\"hljs-comment\"># FRONTEND_BASE_URL: &quot;https://****&quot;  # 多机部署时从节点取消注释该行</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">~/one-api:/data</span><br>    <span class=\"hljs-attr\">depends_on:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">redis</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">db</span><br>    <span class=\"hljs-attr\">healthcheck:</span><br>      <span class=\"hljs-attr\">test:</span> <span class=\"hljs-string\">&gt;</span><br><span class=\"hljs-string\">        wget -qO- http://localhost:3000/api/status | </span><br><span class=\"hljs-string\">        grep -o &#x27;\\&quot;success\\&quot;:\\\\s*true&#x27; &gt; /dev/null &amp;&amp; echo &#x27;healthy&#x27; || echo &#x27;unhealthy&#x27;</span><br><span class=\"hljs-string\"></span>      <span class=\"hljs-attr\">interval:</span> <span class=\"hljs-string\">30s</span><br>      <span class=\"hljs-attr\">timeout:</span> <span class=\"hljs-string\">10s</span><br>      <span class=\"hljs-attr\">retries:</span> <span class=\"hljs-number\">3</span><br>    <span class=\"hljs-attr\">command:</span><br>      [<span class=\"hljs-string\">&quot;sh&quot;</span>, <span class=\"hljs-string\">&quot;-c&quot;</span>, <span class=\"hljs-string\">&quot;env &amp;&amp; exec /one-api&quot;</span>]<br></code></pre></td></tr></table></figure>\n\n<h3 id=\"5-3-4-searxng\"><a href=\"#5-3-4-searxng\" class=\"headerlink\" title=\"5.3.4 searxng\"></a>5.3.4 searxng</h3><p>​    <a href=\"https://github.com/searxng/searxng\">searxng</a>是一个开源的元搜索引擎，能配置多个搜索引擎作为自己的数据源，保护隐私，无广告。</p>\n<p><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/open-webui/%E6%88%AA%E5%9B%BE_2025-05-28_21-41-35.png\" alt=\"searxng\"></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs yaml\"><span class=\"hljs-attr\">version:</span> <span class=\"hljs-string\">&quot;3.7&quot;</span><br><span class=\"hljs-attr\">services:</span><br>  <span class=\"hljs-attr\">searxng-redis:</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">searxng-redis</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">docker.io/valkey/valkey:8-alpine</span><br>    <span class=\"hljs-attr\">command:</span> <span class=\"hljs-string\">valkey-server</span> <span class=\"hljs-string\">--save</span> <span class=\"hljs-number\">30</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-string\">--loglevel</span> <span class=\"hljs-string\">warning</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span><br>    <span class=\"hljs-attr\">networks:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">searxng</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">/root/searxng/valkey-data:/data:rw</span><br>    <span class=\"hljs-attr\">logging:</span><br>      <span class=\"hljs-attr\">driver:</span> <span class=\"hljs-string\">&quot;json-file&quot;</span><br>      <span class=\"hljs-attr\">options:</span><br>        <span class=\"hljs-attr\">max-size:</span> <span class=\"hljs-string\">&quot;1m&quot;</span><br>        <span class=\"hljs-attr\">max-file:</span> <span class=\"hljs-string\">&quot;1&quot;</span><br><br>  <span class=\"hljs-attr\">searxng:</span><br>    <span class=\"hljs-attr\">container_name:</span> <span class=\"hljs-string\">searxng</span><br>    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">docker.io/searxng/searxng:latest</span><br>    <span class=\"hljs-attr\">restart:</span> <span class=\"hljs-string\">unless-stopped</span><br>    <span class=\"hljs-attr\">networks:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">searxng</span><br>    <span class=\"hljs-attr\">ports:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&quot;127.0.0.1:8081:8080&quot;</span><br>    <span class=\"hljs-attr\">volumes:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">/root/searxng/searxng:/etc/searxng:rw</span><br>    <span class=\"hljs-attr\">environment:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">SEARXNG_BASE_URL=https://****/</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">SEARXNG_REDIS_URL=redis://@searxng-redis:6379/0</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">UWSGI_WORKERS=$&#123;SEARXNG_UWSGI_WORKERS:-4&#125;</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">UWSGI_THREADS=$&#123;SEARXNG_UWSGI_THREADS:-4&#125;</span><br>    <span class=\"hljs-attr\">cap_drop:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">ALL</span><br>    <span class=\"hljs-attr\">cap_add:</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">CHOWN</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">SETGID</span><br>      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">SETUID</span><br>    <span class=\"hljs-attr\">logging:</span><br>      <span class=\"hljs-attr\">driver:</span> <span class=\"hljs-string\">&quot;json-file&quot;</span><br>      <span class=\"hljs-attr\">options:</span><br>        <span class=\"hljs-attr\">max-size:</span> <span class=\"hljs-string\">&quot;1m&quot;</span><br>        <span class=\"hljs-attr\">max-file:</span> <span class=\"hljs-string\">&quot;1&quot;</span><br><br><span class=\"hljs-attr\">networks:</span><br>  <span class=\"hljs-attr\">searxng:</span><br></code></pre></td></tr></table></figure>\n<p>​    虽然挂载了一个目录，暴露了几个配置文件出来，但其实我也没修改过里面的配置。</p>\n<h3 id=\"5-3-5-mcpo1\"><a href=\"#5-3-5-mcpo1\" class=\"headerlink\" title=\"5.3.5 mcpo1\"></a>5.3.5 mcpo1</h3><p>​    跟NAS上的mcpo2没什么大区别，只是里面配的mcp连海外工具。我只贴个配置文件吧：</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs json\"><span class=\"hljs-punctuation\">&#123;</span><br>    <span class=\"hljs-attr\">&quot;mcpServers&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>        <span class=\"hljs-attr\">&quot;arxiv-mcp-server&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;args&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>                <span class=\"hljs-string\">&quot;tool&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-string\">&quot;run&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-string\">&quot;arxiv-mcp-server&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-string\">&quot;--storage-path&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-string\">&quot;/app/arxiv-data&quot;</span><br>            <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;command&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;uv&quot;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;fetch&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;args&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>                <span class=\"hljs-string\">&quot;mcp-server-fetch&quot;</span><br>            <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;command&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;uvx&quot;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;github&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;args&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>                <span class=\"hljs-string\">&quot;-y&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-string\">&quot;@modelcontextprotocol/server-github&quot;</span><br>            <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;command&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;npx&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;env&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;GITHUB_PERSONAL_ACCESS_TOKEN&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;****&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;mcp-server-firecrawl&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;args&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>                <span class=\"hljs-string\">&quot;-y&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-string\">&quot;firecrawl-mcp&quot;</span><br>            <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;command&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;npx&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;env&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;FIRECRAWL_API_KEY&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;****&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;searxng&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;args&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>                <span class=\"hljs-string\">&quot;-y&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-string\">&quot;mcp-searxng&quot;</span><br>            <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;command&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;npx&quot;</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;env&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>                <span class=\"hljs-attr\">&quot;SEARXNG_URL&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;https://****&quot;</span><br>            <span class=\"hljs-punctuation\">&#125;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><span class=\"hljs-punctuation\">,</span><br>        <span class=\"hljs-attr\">&quot;time&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">&#123;</span><br>            <span class=\"hljs-attr\">&quot;args&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-punctuation\">[</span><br>                <span class=\"hljs-string\">&quot;mcp-server-time&quot;</span><span class=\"hljs-punctuation\">,</span><br>                <span class=\"hljs-string\">&quot;--local-timezone=Asia/Shanghai&quot;</span><br>            <span class=\"hljs-punctuation\">]</span><span class=\"hljs-punctuation\">,</span><br>            <span class=\"hljs-attr\">&quot;command&quot;</span><span class=\"hljs-punctuation\">:</span> <span class=\"hljs-string\">&quot;uvx&quot;</span><br>        <span class=\"hljs-punctuation\">&#125;</span><br>    <span class=\"hljs-punctuation\">&#125;</span><br><span class=\"hljs-punctuation\">&#125;</span><br></code></pre></td></tr></table></figure>\n\n<h3 id=\"5-3-6-nginx-ssl\"><a href=\"#5-3-6-nginx-ssl\" class=\"headerlink\" title=\"5.3.6 nginx+ssl\"></a>5.3.6 nginx+ssl</h3><p>​    我VPS上部署的所有开放外网访问的服务，统一经由nginx暴露，顺便配上SSL证书。现在的SSL证书不像早年要么花钱要么搞自签的形式证书了，我们有了<a href=\"https://letsencrypt.org/\">Let’s Encrypt</a>这个SSL证书公益签发机构，还有<a href=\"https://certbot.eff.org/\">certbot</a>工具可以快速配置证书。现在自建站还花钱买SSL证书的我觉得就有点花冤枉钱了。</p>\n<p>​    nginx配置文件我贴些open-webui相关的关键片段吧：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs nginx\"><span class=\"hljs-section\">server</span> &#123;<br>  <span class=\"hljs-attribute\">listen</span> <span class=\"hljs-number\">443</span> ssl;<br>  <span class=\"hljs-attribute\">server_name</span> ****;<br>        <br>  <span class=\"hljs-attribute\">ssl_certificate</span> /etc/letsencrypt/live/****/fullchain.pem;<br>  <span class=\"hljs-attribute\">ssl_certificate_key</span> /etc/letsencrypt/live/****/privkey.pem;<br><br>  <span class=\"hljs-attribute\">charset</span> utf-<span class=\"hljs-number\">8</span>;<br><br>  <span class=\"hljs-section\">location</span> /ws/socket.io/ &#123;<br>    <span class=\"hljs-attribute\">add_header</span> <span class=\"hljs-string\">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class=\"hljs-string\">&#x27;wss://****&#x27;</span>;<br>    <span class=\"hljs-attribute\">add_header</span> <span class=\"hljs-string\">&#x27;Access-Control-Allow-Methods&#x27;</span> <span class=\"hljs-string\">&#x27;GET, OPTIONS&#x27;</span>;<br>    <span class=\"hljs-attribute\">add_header</span> <span class=\"hljs-string\">&#x27;Access-Control-Allow-Headers&#x27;</span> <span class=\"hljs-string\">&#x27;Origin, Content-Type, Accept, Authorization, Upgrade, Sec-WebSocket-Key, Sec-WebSocket-Version, Sec-WebSocket-Extensions&#x27;</span>;<br>    <span class=\"hljs-attribute\">add_header</span> <span class=\"hljs-string\">&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class=\"hljs-string\">&#x27;true&#x27;</span>;<br><br>    <span class=\"hljs-attribute\">if</span> (<span class=\"hljs-variable\">$request_method</span> = <span class=\"hljs-string\">&#x27;OPTIONS&#x27;</span>) &#123;<br>      <span class=\"hljs-attribute\">add_header</span> <span class=\"hljs-string\">&#x27;Access-Control-Allow-Origin&#x27;</span> <span class=\"hljs-string\">&#x27;wss://****&#x27;</span>;<br>      <span class=\"hljs-attribute\">add_header</span> <span class=\"hljs-string\">&#x27;Access-Control-Allow-Methods&#x27;</span> <span class=\"hljs-string\">&#x27;GET, OPTIONS&#x27;</span>;<br>      <span class=\"hljs-attribute\">add_header</span> <span class=\"hljs-string\">&#x27;Access-Control-Allow-Headers&#x27;</span> <span class=\"hljs-string\">&#x27;Origin, Content-Type, Accept, Authorization, Upgrade, Sec-WebSocket-Key, Sec-WebSocket-Version, Sec-WebSocket-Extensions&#x27;</span>;<br>      <span class=\"hljs-attribute\">add_header</span> <span class=\"hljs-string\">&#x27;Access-Control-Allow-Credentials&#x27;</span> <span class=\"hljs-string\">&#x27;true&#x27;</span>;<br>      <span class=\"hljs-attribute\">return</span> <span class=\"hljs-number\">204</span>; <span class=\"hljs-comment\"># No Content</span><br>    &#125;<br><br>    <span class=\"hljs-attribute\">proxy_http_version</span> <span class=\"hljs-number\">1</span>.<span class=\"hljs-number\">1</span>;<br>    <span class=\"hljs-attribute\">proxy_set_header</span> Host <span class=\"hljs-variable\">$host</span>;<br>    <span class=\"hljs-attribute\">proxy_set_header</span> Upgrade <span class=\"hljs-variable\">$http_upgrade</span>;<br>    <span class=\"hljs-attribute\">proxy_set_header</span> Connection <span class=\"hljs-string\">&quot;upgrade&quot;</span>;<br>    <span class=\"hljs-attribute\">proxy_set_header</span> X-Real-IP <span class=\"hljs-variable\">$remote_addr</span>;<br>    <span class=\"hljs-attribute\">proxy_set_header</span> X-Forwarded-For <span class=\"hljs-variable\">$proxy_add_x_forwarded_for</span>;<br>    <span class=\"hljs-attribute\">proxy_set_header</span> X-Forwarded-Proto <span class=\"hljs-variable\">$scheme</span>;<br>    <span class=\"hljs-attribute\">proxy_cache_bypass</span> <span class=\"hljs-variable\">$http_upgrade</span>;<br><br>    <span class=\"hljs-attribute\">proxy_pass</span> http://localhost:8080;<br>    <span class=\"hljs-attribute\">proxy_connect_timeout</span> <span class=\"hljs-number\">10s</span>;<br>    <span class=\"hljs-attribute\">proxy_send_timeout</span> <span class=\"hljs-number\">300s</span>;<br>    <span class=\"hljs-attribute\">proxy_read_timeout</span> <span class=\"hljs-number\">3600s</span>;<br>  &#125;<br>  <span class=\"hljs-section\">location</span> / &#123;<br>    <span class=\"hljs-attribute\">client_max_body_size</span>  <span class=\"hljs-number\">64m</span>;<br>                <span class=\"hljs-attribute\">proxy_http_version</span> <span class=\"hljs-number\">1</span>.<span class=\"hljs-number\">1</span>;<br>                <span class=\"hljs-attribute\">proxy_set_header</span> Host <span class=\"hljs-variable\">$host</span>;<br>                <span class=\"hljs-attribute\">proxy_set_header</span> Accept-Encoding gzip;<br>                <span class=\"hljs-attribute\">proxy_set_header</span> X-Real-IP <span class=\"hljs-variable\">$remote_addr</span>;<br>                <span class=\"hljs-attribute\">proxy_set_header</span> X-Forwarded-For <span class=\"hljs-variable\">$proxy_add_x_forwarded_for</span>;<br>                <span class=\"hljs-attribute\">proxy_cache</span> <span class=\"hljs-literal\">off</span>;<br>                <span class=\"hljs-attribute\">proxy_buffering</span> <span class=\"hljs-literal\">off</span>;<br>                <span class=\"hljs-attribute\">chunked_transfer_encoding</span> <span class=\"hljs-literal\">on</span>;<br>                <span class=\"hljs-attribute\">tcp_nopush</span> <span class=\"hljs-literal\">on</span>;<br>                <span class=\"hljs-attribute\">tcp_nodelay</span> <span class=\"hljs-literal\">on</span>;<br>                <span class=\"hljs-attribute\">keepalive_timeout</span> <span class=\"hljs-number\">60s</span>;<br><br>    <span class=\"hljs-attribute\">proxy_pass</span> http://localhost:8080;<br>    <span class=\"hljs-attribute\">proxy_redirect</span> <span class=\"hljs-literal\">off</span>;<br>    <span class=\"hljs-attribute\">proxy_connect_timeout</span> <span class=\"hljs-number\">10s</span>;<br>    <span class=\"hljs-attribute\">proxy_send_timeout</span> <span class=\"hljs-number\">300s</span>;<br>    <span class=\"hljs-attribute\">proxy_read_timeout</span> <span class=\"hljs-number\">300s</span>;<br>  &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>\n<p><em>注意里面有些专门为websocket添加的配置，是趟过坑才成型的。</em></p>\n<h3 id=\"5-3-7-域名\"><a href=\"#5-3-7-域名\" class=\"headerlink\" title=\"5.3.7 域名\"></a>5.3.7 域名</h3><p>​    域名服务商也挺多的，负责维护域名归属关系，有资质能出具域名归属证书，国内的域名服务商还能代办域名备案。费用从一年十来块到一年几百块的都有，看自己需要选择就好。</p>\n<h3 id=\"5-3-8-DNS\"><a href=\"#5-3-8-DNS\" class=\"headerlink\" title=\"5.3.8 DNS\"></a>5.3.8 DNS</h3><p>​    自建站有很多人爱用cloudfare做DNS、CDN、对象存储、AI网关，这家赛博活菩萨有很多免费云基建服务。我最早也用cloudfare做域名解析，后来发现在国内偶发不可用，可能国内白嫖的人太多，节点负载太高了。现在我用同样免费的DNSPod做域名解析，最早是独立DNS，现在被腾讯云吞了。</p>\n<h1 id=\"6-总结\"><a href=\"#6-总结\" class=\"headerlink\" title=\"6 总结\"></a>6 总结</h1><p>​    这一套操作下来，你应该也能搭一套自己的AI助手平台。即使是缺显卡，也能部署整套系统的主体部分（不要ollama，只要one-api甚至连one-api都不要，只配国内厂商的接口）。</p>\n<p>​    整个系统陆续添砖加瓦搭了几个月，想想踩了这么多坑，不记录下来确实挺可惜。</p>\n<p>​    时隔9年又开始写博客，写完才发现这篇文格外的长。欢迎爱折腾的同好讨论~</p>\n",
            "tags": [
                "LLM",
                "ollama",
                "open-webui",
                "oneapi",
                "mcpserver"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2016/06/23/sai%E6%9D%BF%E7%BB%98%E5%88%9D%E4%BD%93%E9%AA%8C/",
            "url": "https://blog.bipedalbit.net/2016/06/23/sai%E6%9D%BF%E7%BB%98%E5%88%9D%E4%BD%93%E9%AA%8C/",
            "title": "sai板绘初体验",
            "date_published": "2016-06-23T12:58:21.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; CS小硕的生活还是挺乏味压抑的，尤其是手头一堆活的时候。于是我买了个数位板，wacom CTL-671，400+软妹币的入门板。拿到板子第一天还没贴膜就拿来画了一堆表情包，新手不知轻重还在板子上留了痕迹。前两天刚画完个⑨，背景大概一时半会都不会有动力画了，于是这篇文先简单记录一下我的板绘初体验。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 要学板绘先要有个板子，wacom的高端板口碑挺好的，想来入门板也不会太差。wacom的驱动只有win和mac的，企图在Ubuntu下画小人，于是开了个虚拟机，很遗憾开虚拟机就算装了驱动板子也会丢压感，于是转战win。<br>&nbsp;&nbsp;&nbsp; 选完板子装完驱动还需要选择一个画图软件，因为是我是要学画漫画，所以只从这个方面考量各种软件。PS和sai是大多数人的选择，PS更有泛用性，而sai对画漫画来说更加有针对性更方便一些。我的话虽然也装过PS给小程序修图用，还是选择了更轻便的sai。<br>&nbsp;&nbsp;&nbsp; 选择用sai就需要掌握一些sai的常用快捷操作：</p>\n<figure class=\"highlight mathematica\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs mathematica\">【一般】<br><span class=\"hljs-built_in\">E</span>：长按<span class=\"hljs-built_in\">E</span>，笔会变成橡皮，松开变回笔，按一下则维持橡皮状态<br><span class=\"hljs-built_in\">N</span>：铅笔<br><span class=\"hljs-variable\">V</span>：画笔（基本上最常用）<br><span class=\"hljs-variable\">B</span>：喷枪<br><span class=\"hljs-built_in\">C</span>：水彩笔 <br><span class=\"hljs-built_in\">D</span>：清除<br><span class=\"hljs-variable\">A</span>：选区笔<br><span class=\"hljs-variable\">H</span>：翻转画布<br><span class=\"hljs-variable\">S</span>：选区擦<br><span class=\"hljs-variable\">X</span>：背景颜色和前景颜色转换<br><span class=\"hljs-variable\">F</span>：将选区的图转写到下一图层，<span class=\"hljs-variable\">ctrl</span><span class=\"hljs-operator\">+</span><span class=\"hljs-built_in\">E</span>是向下合并<br><span class=\"hljs-built_in\">Delete</span>：左旋转画布（逆时针） <br><span class=\"hljs-built_in\">End</span>：右旋转画布（顺时针） <br><span class=\"hljs-variable\">Alt</span><span class=\"hljs-operator\">+</span>空格<span class=\"hljs-operator\">+</span>鼠标左键：旋转画布 <br><span class=\"hljs-variable\">Alt</span><span class=\"hljs-operator\">+</span>空格<span class=\"hljs-operator\">+</span>鼠标右键<span class=\"hljs-operator\">/</span><span class=\"hljs-variable\">Home</span>：恢复旋转画布<br><span class=\"hljs-variable\">Ctrl</span><span class=\"hljs-operator\">++</span>：放大画布<br><span class=\"hljs-variable\">Ctrl</span><span class=\"hljs-operator\">+-</span>：缩小画布<br><span class=\"hljs-variable\">Ctrl</span><span class=\"hljs-operator\">+</span><span class=\"hljs-number\">0</span>：恢复视图视窗大小<br><span class=\"hljs-variable\">Ctrl</span><span class=\"hljs-operator\">+</span>空格<span class=\"hljs-operator\">+</span>鼠标左键：鼠标位置局部放大 <br>空格<span class=\"hljs-operator\">+</span>鼠标左键：拖动画布<br><span class=\"hljs-punctuation\">]</span>：大一号的笔刷 <br><span class=\"hljs-punctuation\">[</span>：小一号的笔刷 <br><span class=\"hljs-number\">0</span><span class=\"hljs-operator\">~</span><span class=\"hljs-number\">9</span>：选择笔刷浓度 <br><span class=\"hljs-variable\">Ctrl</span><span class=\"hljs-operator\">+</span><span class=\"hljs-variable\">Alt</span><span class=\"hljs-operator\">+</span>鼠标左键：<span class=\"hljs-punctuation\">(</span>左右拖动<span class=\"hljs-punctuation\">)</span>调整笔刷大小<br><span class=\"hljs-variable\">Alt</span><span class=\"hljs-operator\">+</span>鼠标左键：取色<br><span class=\"hljs-variable\">Ctrl</span><span class=\"hljs-operator\">+</span>左键拖拽 ：移动图层、移动选择部分<br><span class=\"hljs-variable\">Ctrl</span><span class=\"hljs-operator\">+</span><span class=\"hljs-variable\">Z</span>：状态回退<br><span class=\"hljs-variable\">Ctrl</span><span class=\"hljs-operator\">+</span><span class=\"hljs-variable\">Y</span>：状态前进<br>【选区时】<br>按住<span class=\"hljs-variable\">Ctrl</span>是移动，按住<span class=\"hljs-variable\">Alt</span>是减区域，按住<span class=\"hljs-variable\">Shift</span>是加区域。<br>【画直线】<br>用笔点一个点，按住<span class=\"hljs-variable\">Shift</span>，再点一个点，两个点之间就会形成一条直线。<br>【钢笔】<br><span class=\"hljs-variable\">Ctrl</span>：在钢笔图层中激活锚点状态，以加锚点的方式调整线条的曲线<br><span class=\"hljs-variable\">Shift</span>：不加锚点的调整曲线<br><span class=\"hljs-variable\">Ctrl</span><span class=\"hljs-operator\">+</span>拖拉锚点：锚点移动<br><span class=\"hljs-variable\">Ctrl</span><span class=\"hljs-operator\">+</span><span class=\"hljs-variable\">Shift</span>：复制并移动整个线条的所有锚点；如点击的两个锚点分别属于两条线条，则自动连接<br><span class=\"hljs-variable\">Alt</span><span class=\"hljs-operator\">+</span><span class=\"hljs-variable\">Shift</span>：移动整个线条的所有锚点<br><span class=\"hljs-variable\">Alt</span>：删除锚点<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 画漫画要先打草稿，这时一般是用铅笔，跟手绘时一样。<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E6%9D%BF%E7%BB%98/%E6%92%B8%E5%8F%AA%E7%90%AA%E9%9C%B2%E8%AF%BA/%E6%91%B8%E9%B1%BC%E7%9C%9Ftm%E5%BC%80%E5%BF%83%E5%95%8A.PNG\" title=\"头部草稿\"><br>&nbsp;&nbsp;&nbsp; 现学现卖，漫画人物的头部新手最好打上十字再画，讲道理，我不打十字形状根本画不对。然后是眼睛的位置，通常在头部的水平中轴线附近，不要想当然的把眼睛画太高。当然也有大大做人设时故意把一些人物的眼睛放的比较高，但是人家是大大，有自己的想法。<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E6%9D%BF%E7%BB%98/%E6%92%B8%E5%8F%AA%E7%90%AA%E9%9C%B2%E8%AF%BA/%E7%90%AA%E9%9C%B2%E8%AF%BA%E8%8D%89%E7%A8%BF.PNG\" title=\"全身草稿\"><br>&nbsp;&nbsp;&nbsp; 身体比例这个就不一定了，我画的这张是Q版，差不多二头身就OK，可以看到我草稿上除了比例边界线也画了一些透视线和身体骨架线。<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E6%9D%BF%E7%BB%98/%E6%92%B8%E5%8F%AA%E7%90%AA%E9%9C%B2%E8%AF%BA/%E8%9B%A4%EF%BC%9F.PNG\" title=\"线稿\"><br>&nbsp;&nbsp;&nbsp; 后来草稿又加了一只蛙，毕竟雾之湖的青蛙是⑨的爱嘛。草稿画完记得新建一个图层描线稿，线稿其实很好画的，有人爱用画笔，我图省事直接用钢笔描曲线了，反正钢笔浓度画完也可以调的。<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E6%9D%BF%E7%BB%98/%E6%92%B8%E5%8F%AA%E7%90%AA%E9%9C%B2%E8%AF%BA/%E4%B8%8A%E8%89%B2%E7%9C%9F%E6%9C%89%E8%B6%A3%EF%BC%81.PNG\" title=\"上色\"><br>&nbsp;&nbsp;&nbsp; 上色据说fiodo流是一个图层用魔棒搞定，我看的入门教程是一个颜色一个图层。先把线稿设成选区来源、正片叠底，然后再建图层上色就不会上到不该上的区域了。皮肤选区，皮肤图层组：底色、阴影、阴影2，按这个节奏来的。上色我主要用的油漆桶和画笔，嘛看个人爱好和需要，随意就好。<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E6%9D%BF%E7%BB%98/%E6%92%B8%E5%8F%AA%E7%90%AA%E9%9C%B2%E8%AF%BA/%E9%AB%98%E5%85%89%E5%A5%BD%E9%9A%BE%E5%95%8A.PNG\" title=\"高光\"><br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E6%9D%BF%E7%BB%98/%E6%92%B8%E5%8F%AA%E7%90%AA%E9%9C%B2%E8%AF%BA/%E4%B8%8D%E4%BC%9A%E4%B8%8A%E9%98%B4%E5%BD%B1%E6%80%AA%E6%88%91%E5%92%AF.PNG\" title=\"褶皱\"><br>&nbsp;&nbsp;&nbsp; 高光和褶皱嘛，观察+脑补+加参考大大的作品。<br>&nbsp;&nbsp;&nbsp; 以上，收工。<a href=\"http://www.pixiv.net/member_illust.php?mode=medium&illust_id=57615551\">p站请戳</a></p>\n",
            "tags": [
                "板绘",
                "sai",
                "琪露诺"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2016/05/08/FFmpeg%E6%89%B9%E9%87%8F%E6%8A%93%E5%B8%A7%E8%84%9A%E6%9C%AC/",
            "url": "https://blog.bipedalbit.net/2016/05/08/FFmpeg%E6%89%B9%E9%87%8F%E6%8A%93%E5%B8%A7%E8%84%9A%E6%9C%AC/",
            "title": "FFmpeg批量抓帧脚本",
            "date_published": "2016-05-08T08:29:47.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 上周一个学姐问我有没有兴趣毕业去她那做图像处理，抛给我个模式识别问题和一段4000+秒的mp4视频。大周末的我正犯五月病，就跟群里大佬问了下视频抓帧用什么合适，知道神奇的FFmpeg后顺手写了个python脚本做一下批量抓帧。至于为什么要用python不直接写shell，因为FFmpeg自带的批量抓帧命令是针对连续时间序列进行的，执行起来特别慢，用python是要做一下时间序列离散化，然后并行处理。</p>\n<span id=\"more\"></span>\n<h3 id=\"FFmpeg\"><a href=\"#FFmpeg\" class=\"headerlink\" title=\"FFmpeg\"></a>FFmpeg</h3><p>&nbsp;&nbsp;&nbsp; 先引用百度百科简单介绍下FFmpeg：</p>\n<blockquote>\n<p>FFmpeg是一套可以用来记录、转换数字音频、视频，并能将其转化为流的开源计算机程序。采用LGPL或GPL许可证。它提供了录制、转换以及流化音视频的完整解决方案。它包含了非常先进的音频&#x2F;视频编解码库libavcodec，为了保证高可移植性和编解码质量，libavcodec里很多codec都是从头开发的。</p>\n</blockquote>\n<p>&nbsp;&nbsp;&nbsp; 关于FFmpeg的业界地位，有很多视音频播放器是通过给FFmpeg加壳完成的。它是跨平台的，linux、win、mac os下都有发行版。想要安装，可以去<a href=\"http://ffmpeg.org/\">官网</a>看看。关于文档，我找到的总结、教程、手册都比较零散，官方的英语文档又让新手无从看起，这次我只查到够用的资料就放着了，如果读者找到比较全面的实用手册，欢迎留言。</p>\n<h3 id=\"实现\"><a href=\"#实现\" class=\"headerlink\" title=\"实现\"></a>实现</h3><p>&nbsp;&nbsp;&nbsp; 我试着直接执行FFmpeg的批量抓帧命令时发现特别慢，几乎总要花费目标视频一半的播放时间。但是单张抓帧，不论时间点在哪里，其实都很快。于是我的思路是把视频的总时长拿出来，然后获得一个均匀分布的时间点集合，最后统统扔给gevent的pool并行抓帧。gevent是python一个著名的coroutine（协程）框架，初衷是处理高并发的网络IO，要安装pip一下就好。思路很简单，脚本也很短，life is short, I choose python!</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-comment\">#!/usr/bin/env python</span><br><span class=\"hljs-comment\"># -*- coding: utf-8 -*-</span><br><br><span class=\"hljs-keyword\">import</span> os<br><span class=\"hljs-keyword\">from</span> commands <span class=\"hljs-keyword\">import</span> getoutput<br><span class=\"hljs-keyword\">import</span> re<br><span class=\"hljs-keyword\">from</span> gevent.pool <span class=\"hljs-keyword\">import</span> Pool <span class=\"hljs-keyword\">as</span>  Gpool<br><span class=\"hljs-keyword\">from</span> time <span class=\"hljs-keyword\">import</span> time<br><br><span class=\"hljs-comment\"># get arguments</span><br>file_path = <span class=\"hljs-string\">&#x27;&#x27;</span><br>ouput_path = <span class=\"hljs-string\">&#x27;&#x27;</span><br>interval = <span class=\"hljs-number\">1</span><br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-literal\">True</span>:<br>    file_path = raw_input(<span class=\"hljs-string\">&#x27;Vedio path: &#x27;</span>)<br>    <span class=\"hljs-keyword\">if</span> os.path.isfile(file_path):<br>        <span class=\"hljs-keyword\">break</span><br>    <span class=\"hljs-keyword\">else</span>:<br>        <span class=\"hljs-built_in\">print</span> <span class=\"hljs-string\">&#x27;Not a file.&#x27;</span><br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-literal\">True</span>:<br>    ouput_path = raw_input(<span class=\"hljs-string\">&#x27;Output path( current directory for default ) : &#x27;</span>)<br>    <span class=\"hljs-keyword\">if</span> ouput_path == <span class=\"hljs-string\">&#x27;&#x27;</span>:<br>        <span class=\"hljs-keyword\">break</span><br>    <span class=\"hljs-keyword\">if</span> os.path.exists(ouput_path) <span class=\"hljs-keyword\">and</span> <span class=\"hljs-keyword\">not</span> os.path.isfile(ouput_path):<br>        ouput_path += <span class=\"hljs-string\">&#x27;/&#x27;</span><br>        <span class=\"hljs-keyword\">break</span><br>    <span class=\"hljs-keyword\">else</span>:<br>        <span class=\"hljs-built_in\">print</span> <span class=\"hljs-string\">&#x27;Not a directory.&#x27;</span><br><span class=\"hljs-keyword\">while</span> <span class=\"hljs-literal\">True</span>:<br>    s = raw_input(<span class=\"hljs-string\">&#x27;Snap interval( 1 second for default ) : &#x27;</span>)<br>    <span class=\"hljs-keyword\">if</span> s == <span class=\"hljs-string\">&#x27;&#x27;</span>:<br>        interval = <span class=\"hljs-number\">1</span><br>        <span class=\"hljs-keyword\">break</span><br>    <span class=\"hljs-keyword\">if</span> re.<span class=\"hljs-keyword\">match</span>(<span class=\"hljs-string\">r&#x27;^[0-9]+(.[0-9]+)&#123;0,1&#125;$&#x27;</span>, s) <span class=\"hljs-keyword\">is</span> <span class=\"hljs-literal\">None</span>:<br>        <span class=\"hljs-built_in\">print</span> <span class=\"hljs-string\">&#x27;Not a number.&#x27;</span><br>    <span class=\"hljs-keyword\">else</span>:<br>        interval = <span class=\"hljs-built_in\">float</span>(s)<br>        <span class=\"hljs-keyword\">break</span><br><br><span class=\"hljs-comment\"># get vedio duration via os.popen with &quot;ffmpeg -i&quot;</span><br>info = getoutput(<span class=\"hljs-string\">&#x27;ffmpeg -i &#x27;</span> + file_path)<br>dur = re.search(<span class=\"hljs-string\">r&#x27;(?&lt;=Duration: ).*?(?=,)&#x27;</span>, info).group(<span class=\"hljs-number\">0</span>).split(<span class=\"hljs-string\">&#x27;:&#x27;</span>)<br>dur = <span class=\"hljs-built_in\">int</span>(dur[<span class=\"hljs-number\">0</span>])*<span class=\"hljs-number\">3600</span> + <span class=\"hljs-built_in\">int</span>(dur[<span class=\"hljs-number\">1</span>])*<span class=\"hljs-number\">60</span> + <span class=\"hljs-built_in\">float</span>(dur[<span class=\"hljs-number\">2</span>])<br><span class=\"hljs-built_in\">print</span> <span class=\"hljs-string\">&#x27;Vedio duration: %.2f seconds.&#x27;</span> % dur<br><br><span class=\"hljs-comment\"># make time stamps pool</span><br>time_stamp_pool = []<br>time_stamp = <span class=\"hljs-number\">0</span><br><span class=\"hljs-keyword\">while</span> time_stamp &lt; dur:<br>    time_stamp_pool.append(time_stamp)<br>    time_stamp += interval<br><br><span class=\"hljs-comment\"># os.system + gevent snap by batch</span><br>gpool = Gpool()<br>snap_cmd = <span class=\"hljs-string\">&#x27;ffmpeg -ss %f -i %s -nostats -loglevel 0 -q:v 2 -f image2 %s%d.jpg&#x27;</span> <span class=\"hljs-comment\"># execute quietly</span><br>n_snap = <span class=\"hljs-built_in\">len</span>(time_stamp_pool)<br><span class=\"hljs-built_in\">print</span> <span class=\"hljs-string\">&#x27;%d frames to be snapped.&#x27;</span> % n_snap<br><span class=\"hljs-built_in\">print</span> <span class=\"hljs-string\">&#x27;Handling...&#x27;</span><br>time0 = time()<br><span class=\"hljs-keyword\">for</span> i <span class=\"hljs-keyword\">in</span> xrange(n_snap):<br>    gpool.spawn(os.system, snap_cmd % (time_stamp_pool[i], file_path, ouput_path, i))<br>gpool.join()<br>time_cost = time() - time0<br><span class=\"hljs-built_in\">print</span> <span class=\"hljs-string\">&#x27;Done in %.2f seconds.&#x27;</span> % time_cost<br></code></pre></td></tr></table></figure>",
            "tags": [
                "python",
                "ffmpeg"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2016/04/25/%E5%88%A9%E7%94%A8Dropbox%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5%E7%9A%84%E9%9D%99%E6%80%81%E7%AB%99/",
            "url": "https://blog.bipedalbit.net/2016/04/25/%E5%88%A9%E7%94%A8Dropbox%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5%E7%9A%84%E9%9D%99%E6%80%81%E7%AB%99/",
            "title": "利用Dropbox实现实时同步的静态站",
            "date_published": "2016-04-25T06:05:09.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 上个周末正在练习nginx静态站服务器功能的基本配置，忽然想到一个点子。既然我有现成的VPS可以用，而且只是用来搭ShadowSocks服务器科学上网用，不拿来做建站练习实在有点浪费。之前早就把VPS和手头各个平台上的ShadowSocks+Dropbox环境配好了，那为什么不干脆在VPS的Dropbox文件夹里建站呢？自动同步，多终端随处修改，应该会比Github Pages更方便。试了一下，结果亦可赛艇。</p>\n<span id=\"more\"></span>\n<h3 id=\"VPS\"><a href=\"#VPS\" class=\"headerlink\" title=\"VPS\"></a>VPS</h3><p>&nbsp;&nbsp;&nbsp; VPS的选择主要看需要，论国内访问速度当然还是BAT和新浪之类的国产云主机最好，但是如果你想顺便用来科学上网，那么就得选国外VPS服务商了。一般来说，提起国外的网络服务运营商，总是想起欧美的，尤其是美国的，然而事实上，日本的VPS产业也很发达。大名鼎鼎的<a href=\"https://www.linode.com/\">Linode</a>、<a href=\"https://www.conoha.jp/zh/\">Conoha</a>等服务商，因为机房离国内近，相对美国的VPS有了速度优势。最近可能意识到墙内市场的潜力，有的日本VPS服务明显做的很贴咱的心了，比如我选的<a href=\"https://www.z.com/\">z.com</a>，它就是Conoha重新套了个壳，900日元每月的开销不算便宜也不很贵，但是它能用支付宝结帐！</p>\n<h3 id=\"系统环境\"><a href=\"#系统环境\" class=\"headerlink\" title=\"系统环境\"></a>系统环境</h3><p>&nbsp;&nbsp;&nbsp; 要搭服务器，不论什么功能，稳定性是很重要的，虽然巨硬和IBM也分别有server产品，但是咱用不起，挑个Linux系统比较合适，至于Mac OS，你是要搭服务器，又不是要去星巴克。我Linux入门时选择的是最流行的发行版Ubuntu，于是VPS也挑了Ubuntu 14.04LTS的镜像，使用和练习都比较方便，上手快，国内大家爱用的还有CentOS和RedHat。就别选什么Desktop镜像了，DE占空间又浪费资源，就算有远程桌面，也没有必要用，SSH连接足矣。把公钥放Github，wget到服务器~&#x2F;.ssh目录，改个名叫authorized_keys就行，多个公钥可以都放authorized_keys里面，一个一行就好。</p>\n<h3 id=\"Dropbox\"><a href=\"#Dropbox\" class=\"headerlink\" title=\"Dropbox\"></a>Dropbox</h3><p>&nbsp;&nbsp;&nbsp; Dropbox是个云盘，跟国内遍地都是的云盘有几个不同点，首先是资历老，然后给的免费空间少（XDDDD），2GB，跨平台做得好，几乎所有系统平台都有客户端，最重要的是有一个文件实时同步功能（也许正是这个功能限制了免费空间的大小），最后，是的，国外的好东西一般是要被墙的，Dropbox也不例外。会科学上网的同学们可以各显神通去<a href=\"https://www.dropbox.com/\">官网</a>注册，下客户端试用一下。在VPS上装个Dropbox用来传文件简直方便，VPS网快，墙内下不动的东西也可以VPS下完从Dropbox拖回来。据说国内的金山快盘可以作为Dropbox的替代品，改天做个评测再发博文介绍下。别跟我提百度云，且不论它没有官方Linux客户端且免费空间太大，我对百度有偏见。<br>&nbsp;&nbsp;&nbsp; 这篇文用到的就是Dropbox的自动同步功能，在各个终端的Dropbox文件夹内，内容都与云端进行实时同步。既然是个文件夹，那么里面放一个静态站也没有什么不可以了，2GB绰绰有余。</p>\n<h3 id=\"Nginx\"><a href=\"#Nginx\" class=\"headerlink\" title=\"Nginx\"></a>Nginx</h3><p>&nbsp;&nbsp;&nbsp; <a href=\"http://nginx.org/\">Nginx</a>读作engine X，是由Igor Sysoev（俄罗斯籍）为俄罗斯访问量第二的Rambler.ru站点开发的，第一个公开版本0.1.0发布于2004年10月4日。其将源代码以类BSD许可证的形式发布，因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名。主要功能为静态网站的服务器、多服务端的负载均衡服务器即反向代理服务器。配置简单、高效、轻。既然是做静态站，我首选了Nginx作为服务器，Apache有点笨重，不做动态站就先不装了。</p>\n<h3 id=\"Hexo\"><a href=\"#Hexo\" class=\"headerlink\" title=\"Hexo\"></a>Hexo</h3><p>&nbsp;&nbsp;&nbsp; 做什么样的静态站呢？这次直接把我的Hexo博客拿来做实验。<a href=\"https://bipedalbit.net/2016/4/24/hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/\">上篇文</a>提到过，Hexo是个静态博客站生成器，<code>hexo g</code>命令执行后，Hexo项目目录的public子目录下就是静态站的确切内容了。可以干脆把Hexo项目目录放在Dropbox文件夹中，每次<code>hexo g</code>之后，自动更新静态站内容，同时Dropbox自动把静态站同步到VPS，VPS的Nginx不需要更改配置因为地址映射没有变化。于是我们现在可以在本地修改Hexo博客后自动发布更新到直连外网的VPS，还可以在任意一个向Github分发过SSH公钥的终端向Github Pages发布新的静态站内容。<br>&nbsp;&nbsp;&nbsp; 不知到你们想到了什么，我觉得这个套路可以使VPS上维护一个经常预更新的静态站alpha版，Github Pages上维护一个比较稳定的静态站beta版。</p>\n",
            "tags": [
                "nginx",
                "hexo",
                "vps",
                "dropbox"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2016/04/24/hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/",
            "url": "https://blog.bipedalbit.net/2016/04/24/hexo%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/",
            "title": "hexo博客搭建",
            "date_published": "2016-04-24T13:02:39.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 转眼三个多月没更博文了，并没有荒废只是有点忙。攒了很多想写的东西，先填个拖了很久的坑：我这个博客是怎么搭起来的。<br>&nbsp;&nbsp;&nbsp; 总的来说，我的博客是由Github Pages维护，本地用Hexo管理的一个静态博客。这篇文里我将介绍搭建Github Pages+Hexo博客的过程。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 在讲搭建流程之前需要铺垫一下，介绍几个基本概念，Github Pages、Hexo、域名和DNS服务。</p>\n<h3 id=\"Github-Pages\"><a href=\"#Github-Pages\" class=\"headerlink\" title=\"Github Pages\"></a>Github Pages</h3><p>&nbsp;&nbsp;&nbsp; 如果想搭建一个自己的博客，首先你需要一个7×24不间断服务的稳定服务器。一般来说，geek们不会自己买一个，我们可以租一个云服务器。有更好的选择吗？有。我们也可以找到一些免费的云空间，比如新浪的SAE（以后没准就不免费了），还有我要讲的Github Pages。Github Pages是Github（如果你不知道Github是什么可以自己百度，这里我不太想解释）提供的一项福利，帮助广大geek们维护一个静态网站空间。静态网站就是页面内容不会随着数据库中数据的变化而动态的发生变化的网站，各大购物网站都是典型的动态网站。通常个人博客主要包含静态内容，就算需要修改更新，手动处理也完全足够，评论系统除外，但评论系统可以用第三方插件。于是这里有了分歧，一部分人选择了自己管理评论系统的数据库，还想偶尔在网站上玩点酷炫的动态网站花活，比如挂个网页游戏或者弹幕播放器，他们需要一个完全控制的云服务器，如SAE、百度云、腾讯云、Linode、Conoha等等；另一部分人希望让博客单纯一点，静态网站是更好的选择，Github向每一个用户帐号免费提供一个静态网站空间。<br>&nbsp;&nbsp;&nbsp; Github Page使用起来很简单，它的<a href=\"https://pages.github.com/\">网站首页</a>上有讲解，其实就是在Github新建一个repository，命名为username.github.io，其中username为你的Github用户名。这个repository就是你的静态网站空间了，访问它可以使用刚才的username.github.io，也就是Github Pages的二级域名。如果你是Github的用户，接下来你一定知道怎么更新网站内容了。</p>\n<h3 id=\"Hexo\"><a href=\"#Hexo\" class=\"headerlink\" title=\"Hexo\"></a>Hexo</h3><p>&nbsp;&nbsp;&nbsp; Hexo是一个开源的静态博客生成器，用node.js开发，作者是台湾大学生tommy351。这里我要提一句，node.js不是js，是基于谷歌v8引擎（js解析引擎）开发的一种服务端语言，语法与js没有什么两样，可以在http协议外（使用socket.io包）实现区别于AJAX的服务器主动推，鼓吹面向过程、基于消息机制的函数异步处理特性。Hexo封装了不止一种对免费服务器空间的接口，其中也包括Github的。这篇文里我准备介绍的是Github Pages搭配Hexo的搭建方式。</p>\n<h3 id=\"域名与DNS\"><a href=\"#域名与DNS\" class=\"headerlink\" title=\"域名与DNS\"></a>域名与DNS</h3><p>&nbsp;&nbsp;&nbsp; 要怎么访问一个网站？你当然可以直接访问网站的IP地址，但是这不方便，大家一般都使用域名（Domain）。域名最右边的一节是域名后缀，通常用于标识域名类型，域名最右边的两节xxx.xxx作为一个整体通常表示一个顶级域名。它的左边可以再加若干节，如果加了，那些就都是顶级域名下的子域名了。为了完成特定域名（包括子域名）到特定IP的映射，需要一个DNS（Domain Name System）服务器，它将对特定域名的请求转发到特定的IP地址。</p>\n<h3 id=\"Github-Pages-Hexo环境搭建\"><a href=\"#Github-Pages-Hexo环境搭建\" class=\"headerlink\" title=\"Github Pages+Hexo环境搭建\"></a>Github Pages+Hexo环境搭建</h3><p>&nbsp;&nbsp;&nbsp; Hexo有一些依赖环境，但是它没有现成的安装包，开源项目嘛，无可厚非。首先你需要安装node.js环境，大家系统平台多种多样，怎么装就自己去<a href=\"http://nodejs.cn/\">node官网</a>上看吧；git客户端也是要装的，同理也自己去<a href=\"https://git-scm.com/downloads\">官网</a>看。此外我们还需要分发个SSH证书，就是把你计算机的公钥在Github帐号里复制一份，这样通过SSH方式连接Github时就可以验证你的身份，就不用输用户名密码了。而Hexo连接Github的方式就是走的SSH方式，所以这个步骤是必要的。win平台通常用SSH Client管理SSH连接，或者也可以用终端形式的putty或者SSH Secure Shell；Ubuntu下是<code>sudo apt-get install openssh-server</code>；CentOS下是<code>sudo yum install openssh-server</code>；Mac OS自带SSH客户端。私钥公钥生成和端口配置什么的我不是很想全都介绍，说个Ubuntu的吧，比较简单。<br>&nbsp;&nbsp;&nbsp; 没配git帐号的先配一下：</p>\n<pre><code class=\"hljs\">git config --global user.email &quot;你的邮箱&quot;\ngit config --global user.name &quot;你的Github用户名&quot;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 生成SSH密钥对：</p>\n<pre><code class=\"hljs\">ssh -keygen -t rsa -C&quot;前面配git时填过的邮箱&quot;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 然后一路回车，然后你在<code>~/.ssh</code>目录下就有了id_rsa和id_rsa.pub两个文件，它们分别是你的私钥和公钥，你需要把私钥登记一下：</p>\n<pre><code class=\"hljs\">ssh-add id_rsa\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 接下来就是分发公钥了，你可以手动进id_rsa.pub复制公钥内容，也可以用系统工具复制：</p>\n<pre><code class=\"hljs\">xclip -selection c  ~/.ssh/id_rsa.pub\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 然后登录Github并<a href=\"https://github.com/settings/ssh\">Add SSH Key</a>，给新公钥起个名粘贴进去就好。然后测试一下：</p>\n<pre><code class=\"hljs\">ssh -T git@github.com\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 提示信息包含“successfully authenticated”就算成功了。如果有问题，可以重新设置，常见问题请参考：<br><a href=\"https://help.github.com/articles/generating-an-ssh-key/\">GitHub Help - Generating SSH Keys</a><br><a href=\"https://help.github.com/articles/error-permission-denied-publickey/\">GitHub Help - Error Permission denied (publickey)</a><br>&nbsp;&nbsp;&nbsp; 接下来是为node安装Hexo包：</p>\n<pre><code class=\"hljs\">npm install -g hexo\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; Hexo封装了一些博客管理接口：<br>\t<br>\thexo init <folder>  # 初始化目录，可以指定目录地址，我更喜欢进入目录后hexo init一下<br>\thexo n “title” # 创建新文章，你会在&#x2F;source&#x2F;_post目录下找到包含title的新md文档，你可以编辑它<br>\thexo s # 在本地查起服务查看效果，默认是访问0.0.0.0:4000<br>\thexo g # 为博客重新生成静态页面<br>\thexo d # 同步到Github Pages空间</p>\n<h3 id=\"写博文\"><a href=\"#写博文\" class=\"headerlink\" title=\"写博文\"></a>写博文</h3><p>&nbsp;&nbsp;&nbsp; 前面提到过，<code>hexo n</code>之后我们就获得了一个新md文档，接下来你需要按照Markdown语法编辑这个文档。但Hexo的博文还需要包含一些必要内容以辅助页面关联及效果：</p>\n<pre><code class=\"hljs\">title: postName #文章页面上的显示名称，可以任意修改，不会出现在URL中\ndate: 2016-4-25 11:30:16 #文章生成时间，一般不改，当然也可以任意修改\ncategories: #文章分类目录，可以为空，注意:后面有个空格\ntags: #文章标签，可空，多标签请用格式[tag1,tag2,tag3]，注意:后面有个空格\nphotos: #fancybox功能将要显示是图片集合\n- http://bruce.u.qiniudn.com/2013/11/27/reading/photos-0.jpg\n- http://bruce.u.qiniudn.com/2013/11/27/reading/photos-1.jpg\n---\n摘要\n&lt;!--more--&gt;\n这里开始使用markdown格式输入你的正文。\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 至于Markdown语法，读者可以自行百度，网上很多。写完保存之后可以先<code>hexo s</code>一下，去0.0.0.0:4000看效果，如果觉得满意，再<code>hexo g</code>生成静态页面并<code>hexo d</code>同步到Github Pages。注意这里生成的整个静态网站页面都在&#x2F;public子目录下，你完全可以起一个服务器把本地80口映射到这里。</p>\n<h3 id=\"主题安装\"><a href=\"#主题安装\" class=\"headerlink\" title=\"主题安装\"></a>主题安装</h3><p>&nbsp;&nbsp;&nbsp; Hexo迄今为止已经衍生出了很多主题，主题列表<a href=\"https://github.com/hexojs/hexo/wiki/Themes\">Hexo Themes</a>，我的博客使用的是<a href=\"https://github.com/xiangming/landscape-plus\">Landscape plus</a>，一个专为中国大陆用户做过调整的Hexo主题，别的Hexo主题读者可以自己百度一下。<code>hexo init</code>一个目录之后，把选定的主题<code>git clone</code>到Hexo目录的themes子目录下，然后编辑&#x2F;_config.yml：</p>\n<pre><code class=\"hljs\">theme: themename\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 然后配置一下主题下的_config.yml：<br>\t<br>\tmenu: #配置页头显示哪些菜单<br>\t#  Home: &#x2F;<br>\t  Archives: &#x2F;archives<br>\t  Reading: &#x2F;reading<br>\t  About: &#x2F;about<br>\t#  Guestbook: &#x2F;about</p>\n<pre><code class=\"hljs\">excerpt_link: Read More #摘要链接文字\narchive_yearly: false #按年存档\n\nwidgets: #配置页脚显示哪些小挂件\n\t- category\n#  - tag\n\t- tagcloud\n\t- recent_posts\n#  - blogroll\n\nblogrolls: #友情链接\n\t- sitename: http://site.address\n\t- sitename: http://site.address\n\t- sitename: http://site.address\n\nfancybox: true #是否开启fancybox效果，就是文章开头加一个电子相册的感觉\n\nduoshuo_shortname: username #多说账号\n\ngoogle_analytics:\nrss:\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 要更新主题只需要从Github拉取主题内容即可<code>cd themes/modernist</code>然后<code>git pull</code>。</p>\n<h3 id=\"评论插件\"><a href=\"#评论插件\" class=\"headerlink\" title=\"评论插件\"></a>评论插件</h3><p>&nbsp;&nbsp;&nbsp; 有很多免费的第三方评论插件提供商，你可以通过简单的配置使用他们的数据库管理你网站的评论数据，hexo默认集成的是Disqus，但是有GFW存在，所以我选择了国内的<a href=\"http://duoshuo.com/\">多说</a>。直接用你的微博&#x2F;豆瓣&#x2F;人人&#x2F;百度&#x2F;开心网帐号登录多说，做一下基本设置。你也可以在多说后台自定义一下多说评论框的格式，比如评论框的位置，对于css设置，可以<a href=\"http://dev.duoshuo.com/docs/4ff1cfd0397309552c000017\">参考这里</a>。如果你是有的其他第三方评论系统，将通用代码粘贴到&#x2F;themes&#x2F;themename&#x2F;layout&#x2F;_partial&#x2F;comment.ejs里面：</p>\n<pre><code class=\"hljs\">&lt;% if (config.disqus_shortname &amp;&amp; page.comments)&#123; %&gt;\n&lt;section id=&quot;comment&quot;&gt;\n  #你的通用代码\n&lt;% &#125; %&gt;\n</code></pre>\n<h3 id=\"域名配置\"><a href=\"#域名配置\" class=\"headerlink\" title=\"域名配置\"></a>域名配置</h3><p>&nbsp;&nbsp;&nbsp; 国内域名服务商有万网、腾讯、阿里、美橙等等，国外推荐<a href=\"http://www.godaddy.com/\">狗爹（godaddy）</a>。<br>&nbsp;&nbsp;&nbsp; 买完域名你需要给域名指定DNS服务器。DNS服务商非常多，一般域名服务商和云主机服务商都提供DNS服务，我选择的是国内的<a href=\"http://www.dnspod.cn/\">DNSPod</a>，免费的，提供监测网站状态功能，还挺好用。<br>&nbsp;&nbsp;&nbsp; 域名服务商和DNS服务商那边的配置它们各自网站都会提供教程，自己网站空间中给静态网站绑定域名很简单，在网站根目录放一个叫CNAME的文档，里面填上你的域名就行了。</p>\n<h3 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h3><p><a href=\"http://ibruce.info/2013/11/22/hexo-your-blog/\">http://ibruce.info/2013/11/22/hexo-your-blog/</a>（大大的教程写的真心详细，基本就是这篇领我进门）</p>\n",
            "tags": [
                "github",
                "domain",
                "DNS",
                "hexo"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2016/01/06/%E5%BE%AE%E5%8D%9A%E7%88%AC%E8%99%AB%E4%B9%8B%E4%BB%A3%E7%90%86%E6%B1%A0/",
            "url": "https://blog.bipedalbit.net/2016/01/06/%E5%BE%AE%E5%8D%9A%E7%88%AC%E8%99%AB%E4%B9%8B%E4%BB%A3%E7%90%86%E6%B1%A0/",
            "title": "微博爬虫之代理池",
            "date_published": "2016-01-05T17:02:08.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 前一个版本的微博爬虫每发送一个HTTP请求就需要等待若干秒，模拟人类操作，避免引起服务器的注意，以至于每个请求平均耗时高达3秒。为了防止被服务器封禁，显然应该使用代理，伪装自己HTTP请求的来源。至于如何获取代理，如何使用这些代理，我进行了一些思考与探索，并完善上个版本的微博爬虫工具包，完成了新版的微博爬虫。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 我的第一个思路是，找到提供大量免费代理的网站（自己找，本文不点明），爬取代理，然后用多线程的方式成组发送请求。虽然获取代理的过程很顺利，但是我很快发现了这个思路的一些问题。<br>&nbsp;&nbsp;&nbsp; 首先，成组多线程并发请求的话，<strong>下一页链接</strong>没法使用同一个序列，即可能需要先获取页数然后做页码区间划分，再把每个区间分配给不同的代理。可是如果某个代理中途失效了怎么办？就算不考虑这种情况，理论上，每组请求之间还是需要加平均3秒的延迟，实际上，受IO上限的影响，16线程的成组请求，等到全部响应完大概需要10+秒，这样一来组间延迟省掉也无所谓，可是即使在只使用优质代理的情况下每次请求的均摊时间开销也要1.+秒，虽然效率比不使用代理有所提高，但是我仍然不满意。<br>&nbsp;&nbsp;&nbsp; 随后我放弃了对多线程并发的执念，提出并完善了一个新思路——单线程爬虫＋带时间戳的代理池＋代理竞争。<br>&nbsp;&nbsp;&nbsp; 先解释单线程爬虫，有了代理池其实已经基本不用担心代理失效的问题，但是为了实现方便，我还是暂且选择了单线程爬虫。下一个版本也许会在整个爬虫外面套一层并发，也许会考虑使用协程（coroutine）技术。<br>&nbsp;&nbsp;&nbsp; 接下来是带时间戳的代理池和代理竞争。我们知道，每一个代理在发出一个请求后需要等待一个平均3秒的随机时间后才可以再次发送请求。那么，如果我们使用过一个代理之后就暂时给它上锁（实际上是打上一个时间戳），到时间后（当前时间的时间戳与代理时间戳差值超过随机延时）则给它解锁就可以解决单个代理的使用问题。同时，我们在所有代理之间轮询寻找没上锁的代理来使用，而每次请求的响应时间会积累下来，考虑到使用代理的请求响应时间比较长，顶多五六个代理之后旧代理就已经解锁了。而实际上，我的代理池维护的代理数通常不会少于6。即使代理全都上了锁，我也可以等待1秒后重新轮询。于是，只要保证代理池足够大，同时维护代理池中代理的质量，我们就可以实现连续发送请求，事实上，经过实验，代理响应时间受代理质量影响有所浮动，平均请求周期最长达到过6&#x2F;7秒，最短达到过5&#x2F;3秒。<br>&nbsp;&nbsp;&nbsp; 至于维护代理池的方法，我从爬虫进程fork了一个守护进程用来更新代理池。定时（暂定30秒）爬取代理网站某页面上的100个代理，然后用多线程（暂定16线程）测试每个代理的响应时间，过滤掉响应太慢（暂定超时时间为3秒）的代理，用同样的方法过滤代理池中不在新代理列表中的代理，最后合并代理池和新代理列表，同时为新代理打上很小的时间戳（实际上是0），已有的代理时间戳不变。这样可以在代理损失的过程中不断扩充代理，使代理池的规模稳定甚至递增（经过实验，基本能使代理池大小保持稳定，没有出现代理池暴增的情况，暂时不对代理池大小加以限制）。<br>&nbsp;&nbsp;&nbsp; 关于新思路的实现，我在重构weibo-crawler后新建了weibo-crawler2项目，按惯例已挂<a href=\"https://github.com/bipedalBit/weibo-crawler2\">git</a>。下面是一些weibo-crawler2的使用截图：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/weibo-crawler2/crawler2%E5%8C%85%E9%85%8D%E7%BD%AE.png\" alt=\"图１ crawler2包配置\" title=\"__init__.py\"><br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/weibo-crawler2/%E7%88%AC%E8%99%ABCLI%E8%BE%93%E5%87%BA.png\" alt=\"图２ 爬虫CLI输出\" title=\"爬虫CLI输出\"><br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/weibo-crawler2/%E7%88%AC%E8%99%AB%E6%97%A5%E5%BF%97.png\" alt=\"图３ 爬虫日志\" title=\"爬虫日志\"><br><strong>悲报，weibo.cn登录需要验证码了。刚开始验证码还比较弱，我正想着过完年要不要用深度学习破了它，然后验证码就变得更变态了…模拟登录模块报废。</strong></p>\n",
            "tags": [
                "python",
                "网络爬虫",
                "proxy"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2016/01/02/weibo-cn%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E5%99%A8%E7%9A%84python%E9%87%8D%E6%9E%84/",
            "url": "https://blog.bipedalbit.net/2016/01/02/weibo-cn%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E5%99%A8%E7%9A%84python%E9%87%8D%E6%9E%84/",
            "title": "weibo.cn模拟登录器的python重构",
            "date_published": "2016-01-02T04:47:05.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 之前封装过一个完整的微博爬虫工具包，但是在我查找python多进程爬虫的相关资料时发现，其实使用urllib2写网络爬虫已经是陈年往事，如今大家都用requests包，就像明明有.NET和Qt框架偏偏要用MFC框架，我是自找麻烦了。在使用requests包逐个重构网络爬虫部件的时候，对weibo.cn的模拟登录过程有了一些新的理解，于是来写篇文介绍一下。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 我们再来重新分析一遍weibo.cn的登录过程。出发前先来检查一下装备：</p>\n<ul>\n<li>firefox浏览器</li>\n<li>一个firefox浏览器下的HTTP报文记录分析插件——httpfox</li>\n<li>python2语言环境——python 2.7</li>\n<li>一个python HTTP包——requests</li>\n<li>一个python XML解析包——BueatifulSoup4</li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 妥，先来用httpfox记录一下手工登录的过程：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E5%BE%AE%E5%8D%9A%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95/%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95%E6%80%BB%E8%A7%88.png\" alt=\"图１ weibo.cn模拟登录过程总览\" title=\"weibo.cn模拟登录过程总览\"><br>&nbsp;&nbsp;&nbsp; 无视掉第二条失败的图片请求，剩下的就是weibo.cn登录的全过程。我们逐条分析：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E5%BE%AE%E5%8D%9A%E6%A8%A1%E6%8B%9F%E7%99%BB%E5%BD%95/%E8%AF%B7%E6%B1%82%E7%99%BB%E5%BD%95%E9%A1%B5%E9%9D%A2.png\" alt=\"图２ 请求登录页面\" title=\"请求登录页面\"><br>&nbsp;&nbsp;&nbsp; 上图中是第一条请求的报文头部分，第一条请求是在访问weibo.cn的登录页面。请求到的页面源码中，掐头去尾，比较关键的部分如下：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs html\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">form</span> <span class=\"hljs-attr\">action</span>=<span class=\"hljs-string\">&quot;?backURL=http%3A%2F%2Fweibo.cn%2F<span class=\"hljs-symbol\">&amp;amp;</span>backTitle=%E5%BE%AE%E5%8D%9A<span class=\"hljs-symbol\">&amp;amp;</span>vt=1<span class=\"hljs-symbol\">&amp;amp;</span>revalid=2<span class=\"hljs-symbol\">&amp;amp;</span>ns=1&quot;</span> <span class=\"hljs-attr\">method</span>=<span class=\"hljs-string\">&quot;post&quot;</span>&gt;</span><br>\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">div</span>&gt;</span><br>\t\t手机号/电子邮箱/会员帐号:<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">br</span>/&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;text&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;mobile&quot;</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">&quot;30&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;&quot;</span> /&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">br</span>/&gt;</span><br>\t\t密码:<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">br</span>/&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;password&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;password_3523&quot;</span> <span class=\"hljs-attr\">size</span>=<span class=\"hljs-string\">&quot;30&quot;</span> /&gt;</span><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">br</span>/&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;checkbox&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;remember&quot;</span> <span class=\"hljs-attr\">checked</span>=<span class=\"hljs-string\">&quot;checked&quot;</span> /&gt;</span>记住登录状态，需支持并打开手机的cookie功能。<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">br</span>/&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;hidden&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;backURL&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;http%3A%2F%2Fweibo.cn%2F&quot;</span> /&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;hidden&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;backTitle&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;微博&quot;</span> /&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;hidden&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;tryCount&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;&quot;</span> /&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;hidden&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;vk&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;3523_4ea5_1803939589&quot;</span> /&gt;</span><br>\t\t<span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">input</span> <span class=\"hljs-attr\">type</span>=<span class=\"hljs-string\">&quot;submit&quot;</span> <span class=\"hljs-attr\">name</span>=<span class=\"hljs-string\">&quot;submit&quot;</span> <span class=\"hljs-attr\">value</span>=<span class=\"hljs-string\">&quot;登录&quot;</span> /&gt;</span><br>\t<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">div</span>&gt;</span><br><span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">form</span>&gt;</span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 可以看到表单的action地址、密码输入框的name、隐藏变量vk的值都是变动的，这三样东西正是我们在模拟登录时需要从登录页面解析获得的。对应的python代码如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-comment\"># 尽管不设置报文头也不会被新浪服务器阻拦，还是做一些必要的伪装与配置比较保险</span><br>headers = &#123;<br>\t<span class=\"hljs-string\">&#x27;User-Agent&#x27;</span>: <span class=\"hljs-string\">&#x27;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:42.0) Gecko/20100101 Firefox/42.0&#x27;</span>,<br>\t<span class=\"hljs-string\">&#x27;DNT&#x27;</span>: <span class=\"hljs-string\">&#x27;1&#x27;</span>,<br>\t<span class=\"hljs-string\">&#x27;Connection&#x27;</span>: <span class=\"hljs-string\">&#x27;keep-alive&#x27;</span>,<br>\t<span class=\"hljs-string\">&#x27;Cache-Control&#x27;</span>: <span class=\"hljs-string\">&#x27;max-age=0&#x27;</span>,<br>&#125;<br><br><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_post_needs</span>():<br>\turl = <span class=\"hljs-string\">&#x27;http://login.weibo.cn/login/?ns=1&amp;revalid=2&amp;backURL=http://weibo.cn/&amp;backTitle=微博&amp;vt=&#x27;</span><br>\ttext = requests.get(url, headers=headers).text<br>\tsoup = BeautifulSoup(text, <span class=\"hljs-string\">&#x27;lxml&#x27;</span>)<br>\taction_url = <span class=\"hljs-string\">&#x27;http://login.weibo.cn/login/&#x27;</span> + soup.form[<span class=\"hljs-string\">&#x27;action&#x27;</span>]<br>\tpassword_tag = soup.find(<span class=\"hljs-string\">&#x27;input&#x27;</span>, <span class=\"hljs-built_in\">type</span> = <span class=\"hljs-string\">&#x27;password&#x27;</span>)<br>\tpassword_name = re.search(<span class=\"hljs-string\">&#x27;(?&lt;=name=&quot;)\\w+(?=&quot;)&#x27;</span>, <span class=\"hljs-built_in\">str</span>(password_tag)).group(<span class=\"hljs-number\">0</span>)<br>\tvk_tag = soup.find(<span class=\"hljs-string\">&#x27;input&#x27;</span>, attrs = &#123;<span class=\"hljs-string\">&#x27;name&#x27;</span>: <span class=\"hljs-string\">&#x27;vk&#x27;</span>&#125;)<br>\tvk = re.search(<span class=\"hljs-string\">&#x27;(?&lt;=value=&quot;)\\w+(?=&quot;)&#x27;</span>, <span class=\"hljs-built_in\">str</span>(vk_tag)).group(<span class=\"hljs-number\">0</span>)<br>\t<span class=\"hljs-keyword\">return</span> action_url, password_name, vk<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 页面解析完毕还需要填充表单，对应的python代码如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">get_post_data</span>(<span class=\"hljs-params\">username, password, password_name, vk</span>):<br>\tform_data = &#123;<br>\t\t<span class=\"hljs-string\">&#x27;mobile&#x27;</span>: username,<br>\t\tpassword_name: password,<br>\t\t<span class=\"hljs-string\">&#x27;remeber&#x27;</span>: <span class=\"hljs-string\">&#x27;on&#x27;</span>,<br>\t\t<span class=\"hljs-string\">&#x27;backURL&#x27;</span>: <span class=\"hljs-string\">&#x27;http://weibo.cn/&#x27;</span>,<br>\t\t<span class=\"hljs-string\">&#x27;backTitle&#x27;</span>: <span class=\"hljs-string\">&#x27;微博&#x27;</span>,<br>\t\t<span class=\"hljs-string\">&#x27;tryCount&#x27;</span>: <span class=\"hljs-string\">&#x27;&#x27;</span>,<br>\t\t<span class=\"hljs-string\">&#x27;vk&#x27;</span>: vk,<br>\t\t<span class=\"hljs-string\">&#x27;submit&#x27;</span>: <span class=\"hljs-string\">&#x27;登录&#x27;</span><br>\t&#125;<br>\t<span class=\"hljs-keyword\">return</span> form_data<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 填充完登录表单，就该post出去了，由４个连续的状态码为302的请求不难看出，发送的post请求随后被进行了足足４次重定向。<br>&nbsp;&nbsp;&nbsp; 可以看到，第一次重定向后，请求访问了newlogin.sina.cn，此时新浪服务器已经给我们的请求加上了两个cookie字段（httpfox可以以字典的形式查看每个请求的cookie字段，这里我就不上图了），一个叫“_T_WM”另一个叫“SUB”，虽然不明白这两个字段的含义，但是经过实验得知，其实这个“SUB”字段就可以用来做登录验证了。<br>&nbsp;&nbsp;&nbsp; 第二次重定向请求访问了passport.weibo.com，这次新浪服务器给请求重新填充了许多cookie字段，但是仍然包含一个“SUB”字段，没错，这此的“SUB”也可以拿来做登录验证。<br>&nbsp;&nbsp;&nbsp; 类似的，第三次访问weibo.cn的重定向也填充了新cookie字段，我们又获得了一个可用的“SUB”字段。<br>&nbsp;&nbsp;&nbsp; 至于最后一次重定向，只是通过一个几乎纯JavaScript组成的页面让我们以已登录的状态跳转到前面表单参数中的backURL指向的页面。<br>&nbsp;&nbsp;&nbsp; 在使用python记录cookie字段时需要注意，这种经过若干次重定向的”长会话“不能直接使用Request对象来发送最初的post请求，而是需要一个能处理”长会话“的Session对象的帮助，获得cookie字段的对应python代码如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">wap_login</span>(<span class=\"hljs-params\">username, password</span>):<br>\turl, password_name, vk = get_post_needs()<br>\tdata = get_post_data(username, password, password_name, vk)<br>\tsession = requests.Session()<br>\tresponse = session.post(url, headers=headers, data=data)<br>\t<span class=\"hljs-comment\"># 以下三种来自不同domain的名为SUB的cookie字段都可以用来验证登录状态</span><br>\t<span class=\"hljs-comment\"># return session.cookies.get(&#x27;SUB&#x27;, domain=&#x27;.sina.cn&#x27;)</span><br>\t<span class=\"hljs-comment\"># return session.cookies.get(&#x27;SUB&#x27;, domain=&#x27;.weibo.com&#x27;)</span><br>\t<span class=\"hljs-keyword\">return</span> session.cookies.get(<span class=\"hljs-string\">&#x27;SUB&#x27;</span>, domain=<span class=\"hljs-string\">&#x27;.weibo.cn&#x27;</span>)<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 拿到了必要的cookie字段，模拟登录过程其实就已经完成了，接下来我们也可以用下面的代码测试一下cookie字段是否管用：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\">url = <span class=\"hljs-string\">&#x27;http://weibo.cn/moegirlwiki&#x27;</span><br>username = raw_input(<span class=\"hljs-string\">&#x27;请输入新浪通行证用户名：&#x27;</span>)<br>password = getpass(<span class=\"hljs-string\">&#x27;请输入新浪通行证密码：&#x27;</span>)<br>cookies = &#123;<span class=\"hljs-string\">&#x27;SUB&#x27;</span>: wap_login(username, password)&#125;<br>response = requests.get(url, cookies=cookies)<br><span class=\"hljs-built_in\">print</span> <span class=\"hljs-string\">&#x27;登录成功！&#x27;</span> <span class=\"hljs-keyword\">if</span> response.url == url <span class=\"hljs-keyword\">else</span> <span class=\"hljs-string\">&#x27;登录失败！&#x27;</span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 如果读者接触过weibo.com的模拟登录过程想必明白，weibo.cn的登录过程简单多了，更重要的是，必要cookie字段在weibo.cn和weibo.com是通用的，那我们又何必选择更麻烦的模拟登录途径呢？</p>\n",
            "tags": [
                "python",
                "网络爬虫",
                "模拟登录"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/12/28/python%E7%BB%83%E6%89%8B%E4%B9%8B%E5%BE%AE%E5%8D%9A%E7%88%AC%E8%99%AB/",
            "url": "https://blog.bipedalbit.net/2015/12/28/python%E7%BB%83%E6%89%8B%E4%B9%8B%E5%BE%AE%E5%8D%9A%E7%88%AC%E8%99%AB/",
            "title": "python练手之微博爬虫",
            "date_published": "2015-12-28T13:53:49.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 从半年前声称完成python入门以来，从来没有进行过非API调用的python实战，之前的BP神经网络python版也只是用了pybrain包提供的API而已。惊觉这样下去可能直到我把python语法忘干净都不敢说自己真的掌握了python，但是仍然无所事事拖到大概20天前，室友实验室发下任务要写个Java爬虫，我才决定同时写个python爬虫看看能不能体现下python开发效率的优势。</p>\n<span id=\"more\"></span>\n<h2 id=\"1-什么是网络爬虫\"><a href=\"#1-什么是网络爬虫\" class=\"headerlink\" title=\"1. 什么是网络爬虫\"></a>1. 什么是网络爬虫</h2><p>&nbsp;&nbsp;&nbsp; 在展开介绍我的python爬虫程序之前先来回顾一下网络爬虫实际上要做些什么事。<br>&nbsp;&nbsp;&nbsp; 从结果来看，网络爬虫是一种<strong>从互相关联的互联网网页上批量获取网页数据的技术手段</strong>。从流程上来看，爬虫程序是一个递归过程：</p>\n<ul>\n<li>（１）请求网页数据，开始步骤（２）；</li>\n<li>（２）解析网页数据，分别解析出<strong>目的数据</strong>和请求下一个网页的<strong>超链接地址</strong>；</li>\n<li>（３）如果不再有符合条件的<strong>超链接地址</strong>则结束递归过程，否则回到步骤（１）。</li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 从图论的角度看，如果把网页看成搜索树的状态结点，那么常见的网络爬虫可以看成是一个单一分支的深度优先搜索，当然用于搜索引擎的网络爬虫则常常需要解析出网页中蕴含的多个搜索分支，这就更像我们熟悉的深度优先搜索了。<br>&nbsp;&nbsp;&nbsp; 怎么样，其实很简单吧。计算机技术中最通用的技术，其原理往往是最简单的。</p>\n<h2 id=\"2-为什么需要网络爬虫\"><a href=\"#2-为什么需要网络爬虫\" class=\"headerlink\" title=\"2.为什么需要网络爬虫\"></a>2.为什么需要网络爬虫</h2><p>&nbsp;&nbsp;&nbsp; 网络爬虫最常见的应用场景就是获取（遍历）多页数据列表中的所有数据，比如获取网易云音乐某个歌单中的所有音乐地址甚至音乐数据本身，又比如获取豆瓣电影某个主题下的所有电影。<br>&nbsp;&nbsp;&nbsp; 事实上，互联网时代到来之后，大数据时代接踵而至，计算机乃至其他领域的大量实验数据都来自互联网。除了直接从服务器获得数据之外，最普遍的数据获取途径就是通过最大的开放性数据来源WWW（世界范围Web）网络来请求数据了，毕竟比起HTTP协议，其他应用层通讯协议太多太杂太难分析，也不够开放。于是爬虫也成为了一种大量实验数据的获取手段。</p>\n<h2 id=\"3-怎么实现网络爬虫\"><a href=\"#3-怎么实现网络爬虫\" class=\"headerlink\" title=\"3. 怎么实现网络爬虫\"></a>3. 怎么实现网络爬虫</h2><p>&nbsp;&nbsp;&nbsp; 我选择了python作为写网络爬虫的语言，事实上据我所知，Java、PHP、C++、Ruby、Perl等我们熟知的绝大多数完善的编程语言都能用来写网络爬虫，或者说，只要有网络通信库的语言都可以用来写网络爬虫。其实相对来说，python的网络通信库还是很发达的，再加上python语言语法的简洁性和数据结构操作天生的灵活性，我觉得用python写网络爬虫没准是最快的。（别说Java可以用封装好的现成爬虫Jar包，没有可比性）<br>&nbsp;&nbsp;&nbsp; 我们通过实例来了解网络爬虫的实现过程。我选择了新浪微博作为爬虫对象，具体来说是将特定新浪微博用户的微博主页作为爬取对象。这里有两点需要注意：<br>&nbsp;&nbsp;&nbsp; 首先，我选择的是<a href=\"http://weibo.cn/\">微博移动版</a>的页面而非<a href=\"http://weibo.com/\">PC版</a>的页面作为爬取对象。移动版的页面结构非常简单而且不含任何JavaScript成分，微博数据相对很容易解析出来，而PC版的页面所有的微博数据都由JavaScript填充，虽然不至于找不到数据但是XML结构之外解析数据就几乎要全靠正则表达式了。此外虽然PC版的页面看起来蕴含更多信息，但是许多信息都是通过JavaScript，通过AJAX技术动态向服务器申请来的。如果选择PC版页面作为爬取对象，将大量增加页面解析难度，甚至可能需要让爬虫过程发生嵌套，使整个爬虫流程十分复杂。如果数据能从移动版页面获取，尽量不要选择解析PC版页面。<br>&nbsp;&nbsp;&nbsp; 然后，需要想办法获得登录微博后的cookie，或者cookie的必要字段。微博跟早期的百度贴吧不一样，不登录微博账号的话什么微博数据都看不到。平时我们的浏览器如果没有保存微博登录后的cookie，在访问包含微博数据的页面地址时，HTTP请求会被重定向到登录页面。只有在访问页面时令HTTP请求报文头中携带登录后的cookie，该请求才被服务器认定为合法请求，才会正常的返回被请求的页面。获取cookie有两种途径：</p>\n<ul>\n<li>通过各种浏览器的HTTP报文抓取插件，从HTTP请求的文件头中提取出现成的cookie；</li>\n<li>模拟微博账号登录过程，在登录完成之后的第一次页面访问请求的HTTP报文头中提取出cookie。</li>\n</ul>\n<h3 id=\"3-1-python下的HTTP请求\"><a href=\"#3-1-python下的HTTP请求\" class=\"headerlink\" title=\"3.1 python下的HTTP请求\"></a>3.1 python下的HTTP请求</h3><p>&nbsp;&nbsp;&nbsp; python下如何完成一次HTTP请求并获得返回的页面数据？哦顺便一说我用的是python2，python3应该区别不大。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-keyword\">import</span> urllib2<br><span class=\"hljs-built_in\">print</span> urllib2.urlopen(<span class=\"hljs-string\">&#x27;www.baidu.com&#x27;</span>).read()<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 完了？完了。是不是很简单？python大法好！开个玩笑不要在意，上面的两行代码只是实现了最简单的默认请求形式及返回数据的获取。实际上urllib2类的urlopen方法参数可以是一个url或者是一个封装好的Request对象，返回值是一个封装好的Response对象。python的网络编程确实很简单直观，我不想细说，至于urllib2的具体的各种相关python API，请自行查阅<a href=\"https://docs.python.org/2/library/urllib2.html\">手册</a>或者等下看我的源码。</p>\n<h3 id=\"3-2-页面解析\"><a href=\"#3-2-页面解析\" class=\"headerlink\" title=\"3.2 页面解析\"></a>3.2 页面解析</h3><p>&nbsp;&nbsp;&nbsp; 页面解析是爬取页面数据后的后续操作，我们实际需要的数据往往蕴含在页面源码之中，最简单粗暴的解析方式就是观察页面源码然后用正则表达式匹配出需要的数据字段。此外既然页面源码的组织方式是HTML，而HTML是一种XML结构，那么我们就可以用一些XML解析工具比如BueatifulSoup、XPath来辅助页面解析。这些工具比较容易寻找到整个HTML文本数据中需要的标签，接下来再用正则表达式简单处理一下，数据就不难获得了。顺便一提，python的正则表达式包叫做re，用法参见<a href=\"https://docs.python.org/2/library/re.html\">手册</a>。</p>\n<h3 id=\"3-3-模拟登录\"><a href=\"#3-3-模拟登录\" class=\"headerlink\" title=\"3.3 模拟登录\"></a>3.3 模拟登录</h3><p>&nbsp;&nbsp;&nbsp; 固然，我们可以偷懒一直选择填入现成的cookie，但是须知，cookie都是有时限或者说寿命的，一定时间后，cookie会过期失效，不再合法。这时就需要重新登录获得一个新的cookie了。虽然cookie过期并没有那么快，但是总是需要有人在侧监视，随时更换cookie来维持比较长的爬虫过程，岂不是显得很low很不自动化？所以大部分比较大、比较正式的爬虫程序都会选择实现特定网站的模拟登录过程。<br>&nbsp;&nbsp;&nbsp; 具体到微博上来，weibo.com即PC版微博网站的登录过程网上有相当多的分析文章，比如<a href=\"http://www.douban.com/note/201767245/\">这篇</a>、<a href=\"http://www.cnblogs.com/myx/archive/2011/10/19/Sina-SSO.html\">这篇</a>和<a href=\"http://www.360doc.com/content/15/0514/19/13228794_470491590.shtml\">这篇</a>。读者需要注意的是，据我所知weibo.com的登录过程微调十分频繁，写一个weibo.com模拟登录可能几个月后就需要根据新浪的微调调整代码了。至于weibo.cn，网上简单的找找似乎没有发现分析文章。但是当时据我猜测，weibo.cn的登录过程应该比weibo.com简单（事实证明确实如此），登录过程微调后修改代码也会更容易。而登录后的cookie，经过我的实验，是通用的。也就是说不论在weibo.cn还是weibo.com，登录后产生的细节各不相同的cookie可能有一个共同部分是用来验证登录状态的（事实再次证明确实如此）。<br>&nbsp;&nbsp;&nbsp; 我使用的HTTP报文抓取插件是firefox下的HttpFox，同类插件还有httpwatch、firefox的自带工具、chrome的自带工具，甚至一些较新版本的IE自带工具。记录登录过程，分析跳转了哪些地址，有几次重定向，期间请求携带了哪些数据，cookie有什么变化。这里我简单说下weibo.cn的登录过程。<br>&nbsp;&nbsp;&nbsp; 总体来说weibo.cn的登录过程分成三个步骤，请求登录页面，获取一些post登录信息的必要参数；post登录信息表单；等待。<br>&nbsp;&nbsp;&nbsp; 登录页面中的action（post目标地址）、加后缀的密码数据键名（如password_2358）和一个叫做vk的数据都是提交登录表单时必要的。<br>&nbsp;&nbsp;&nbsp; 之后就要把表单加工成为可填入Request对象的形式，代码如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\">form_data = &#123;<br>\t<span class=\"hljs-string\">&#x27;mobile&#x27;</span>: username,<br>\tpassword_name: password,<br>\t<span class=\"hljs-string\">&#x27;remeber&#x27;</span>: <span class=\"hljs-string\">&#x27;on&#x27;</span>,<br>\t<span class=\"hljs-string\">&#x27;backURL&#x27;</span>: <span class=\"hljs-string\">&#x27;http://weibo.cn/&#x27;</span>,<br>\t<span class=\"hljs-string\">&#x27;backTitle&#x27;</span>: <span class=\"hljs-string\">&#x27;微博&#x27;</span>,<br>\t<span class=\"hljs-string\">&#x27;tryCount&#x27;</span>: <span class=\"hljs-string\">&#x27;&#x27;</span>,<br>\t<span class=\"hljs-string\">&#x27;vk&#x27;</span>: vk,<br>\t<span class=\"hljs-string\">&#x27;submit&#x27;</span>: <span class=\"hljs-string\">&#x27;登录&#x27;</span><br>&#125;<br>form_data = urllib.urlencode(form_data)<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 提交表单后新浪服务器会对这一请求进行４次重定向，注意每次重定向都需要提取并重填充cookie字段，因为python的默认重定向处理类不会重填cookie，重写的重定向处理方法如下：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs python\"><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">MyRedirectHandler</span>(urllib2.HTTPRedirectHandler):<br>\t<span class=\"hljs-string\">&#x27;&#x27;&#x27;</span><br><span class=\"hljs-string\">\t继承urllib2.HTTPRedirectHandler类，封装http_error_302方法。</span><br><span class=\"hljs-string\">\t在自动执行重定向发送新的HTTP请求前提取附在请求头中的cookie，</span><br><span class=\"hljs-string\">\t提取cookie中模拟登录必需的字段并存储在类成员变量中。</span><br><span class=\"hljs-string\">\t&#x27;&#x27;&#x27;</span><br>\t<span class=\"hljs-comment\"># 类成员变量，存储以登录状态访问新浪微博必需的cookie字段</span><br>\tcookie = <span class=\"hljs-string\">&#x27;&#x27;</span><br><br>\t<span class=\"hljs-keyword\">def</span> <span class=\"hljs-title function_\">http_error_302</span>(<span class=\"hljs-params\">self, req, fp, code, msg, headers</span>):<br>\t\t<span class=\"hljs-string\">&#x27;&#x27;&#x27;</span><br><span class=\"hljs-string\">\t\t添加cookie处理过程，然后调用原http_error_302方法执行自动跳转。</span><br><span class=\"hljs-string\">\t\t&#x27;&#x27;&#x27;</span><br>\t\tcookie = <span class=\"hljs-built_in\">str</span>(headers[<span class=\"hljs-string\">&quot;Set-Cookie&quot;</span>])<br>\t\t<span class=\"hljs-keyword\">if</span> re.search(<span class=\"hljs-string\">&#x27;SUB=.+?;&#x27;</span>, cookie) <span class=\"hljs-keyword\">is</span> <span class=\"hljs-keyword\">not</span> <span class=\"hljs-literal\">None</span>:<br>\t\t\tMyRedirectHandler.cookie = re.search(<span class=\"hljs-string\">&#x27;SUB=.+?(?=;)&#x27;</span>, cookie).group(<span class=\"hljs-number\">0</span>)<br>\t\treq.add_header(<span class=\"hljs-string\">&quot;Cookie&quot;</span>, cookie)<br>\t\t<span class=\"hljs-keyword\">return</span> urllib2.HTTPRedirectHandler.http_error_302(<span class=\"hljs-variable language_\">self</span>, req, fp, code, msg, headers)<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 最后一次重定向几乎是一个纯JavaScript页面，做的事情是通过JavaScript跳转向一个地址。实验证明最后这一次跳转对于登录过程并没有什么意义，看起来是故弄玄虚。记得我们刚才重写的重定向处理方法吗？我们在重不断重填cookie的过程中也记录了cookie某个字段的更新情况，最后，我们手里有那个字段的最新值。这个cookie字段正是微博登录验证唯一必需的cookie字段。至于我怎么知道是这个字段，对照实验。<br>&nbsp;&nbsp;&nbsp; 是不是比weibo.com的登录过程简单多了？</p>\n<h3 id=\"3-4-可能的改进\"><a href=\"#3-4-可能的改进\" class=\"headerlink\" title=\"3.4 可能的改进\"></a>3.4 可能的改进</h3><p>&nbsp;&nbsp;&nbsp; 读者可能发觉了，每次请求的间隔长达几秒，这个爬虫程序与其说是一个高效获取数据的工具，不如说是一个模拟人类操作的脚本而已。简单概括一下就是，爬取页面太慢了。那么如何改进呢？并行化。模拟一个人的访问太慢，那么模拟更多人的访问就好。<br>&nbsp;&nbsp;&nbsp; 并行改进有几个层次，硬件架构的并行化（多核，流水线，长指令等等）、多线程、多进程和分布式。硬件层次的改进对我们这个爬虫程序意义不大，多线程在别的语言中当然可行，可是据我所知，python中的多线程性能收到了限制，python中应该尽量使用多进程。在多进程的基础上，实现完善的分布式通信，就能做分布式并行了。<br>&nbsp;&nbsp;&nbsp; 有读者可能会想到，直接把程序改成多进程的难道不是相当于加大了请求频率而已？是的，确实是这样，所以进程间应该“完全独立”，一个进程被新浪服务器封禁，不应该影响其他进程。这里就涉及一个问题，新浪服务器封禁的是微博账号还是IP地址呢？经过实验答案是IP地址，实际上，目前大多数服务器的反DDoS机制就是封IP。这就好办了，微博账号申请还相对麻烦，可是免费或收费的IP代理却很容易批量获得。比如<a href=\"http://www.xicidaili.com/\">这里</a>，其中免费的可以直接爬取，肯花钱就能直接获得官方批量代理的接口。当然，广域网分布式具有天然的互异IP，也可以选择使用多台机器，不使用代理。</p>\n<p>&nbsp;&nbsp;&nbsp; 全文基本没讲解代码是不是有点过分？这次确实有点偷懒，但是源码里注释写的还是挺详细了。上干货，我把完成的单进程python微博爬虫简单封装了一下，挂在了<a href=\"https://github.com/bipedalBit/weibo-crawler\">自家git仓库</a>。</p>\n",
            "tags": [
                "python",
                "网络爬虫"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/12/05/%E7%94%B1%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%92%8C%E7%B1%BB%E8%84%91%E7%8E%B0%E7%8A%B6%E5%B1%95%E5%BC%80/",
            "url": "https://blog.bipedalbit.net/2015/12/05/%E7%94%B1%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%92%8C%E7%B1%BB%E8%84%91%E7%8E%B0%E7%8A%B6%E5%B1%95%E5%BC%80/",
            "title": "由人工神经网络和类脑现状展开",
            "date_published": "2015-12-05T14:07:40.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 今天听了个讲座，是一位鹅厂智库，是个博士，讲的关于互联网、人工智能与大脑的一些遐想。简单地说，就是认为互联网与大脑在形式上已经很相似了，可以借鉴脑神经科学来发展互联网，也可以用互联网的发展来反观大脑得到脑科学方面的启发。讲座期间提了一下人工智能，尤其是人工神经网络和类脑对大脑的仿生。讲座上我对ANN和类脑的技术现状有了一些思考，对互联网与脑神经科学的联系也有了一些自己的看法。</p>\n<span id=\"more\"></span>\n<h1 id=\"1-人工神经网络现状\"><a href=\"#1-人工神经网络现状\" class=\"headerlink\" title=\"1 人工神经网络现状\"></a>1 人工神经网络现状</h1><p>&nbsp;&nbsp;&nbsp; 之前<a href=\"http://blog.bipedalbit.net/2015/10/9/BP%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/\">自科普BP神经网络</a>的时候提到过人工神经网络的仿生模型，看起来好像很有道理很靠谱，但是这个研究方向上出现过瓶颈。从前的单纯“神经网络”如BP，远远无法与人脑甚至小白鼠的大脑相提并论，几十几百个神经元，顶多也就模拟一下应激性或简单的反射行为，别说逻辑思考，就连动物本能的模拟都做不到。原因很简单，ANN的结构太简单了，真正的人的神经网络由上亿量级的神经元组成，其中包括了上百万个互相联系的与ANN同量级的反射组件。<br>&nbsp;&nbsp;&nbsp; 2006年之后，Deep Learning兴起，老实说我实在不太看得惯学界一些炒概念的行为，DL其实是提出了一些层数更多的ANN的可行解。比如CNN，在普通BP网络的前面加了若干曾卷积层，特化了BP的图像处理功能，做的事情类似于为简单反射添加了视网膜对图像的前期处理过程，可是由于BP的单一的简单的结构，仍然只能称作是复杂一点的反射模拟；又比如DBN，一节一节的增益、传递BP的前馈效应，节与节之间通过置信过程进行了信息的提纯，在我看来虽然真正有了模拟多层反射组件的趋势，结构仍然单一而简单，做的事情类似于手脚到大脑的长程简单反射行为。<br>&nbsp;&nbsp;&nbsp; 我不觉得DL真的突破了ANN的瓶颈。然而到了DL的程度，计算机的优势——硬件效率已经捉襟见肘。因为分布式集群难以达到能模拟上亿神经元或者说上百万反射组件<strong>并行交互</strong>的规模。这里就涉及了赛博世界的壁垒：宇宙中任何简单的过程都是在各种规则的限制下并行发生，各自独立进行的。而计算机一次却只能模拟一个简单物理过程，仅凭当前的技术再怎么并行化计算，并行量相对于一颗宇宙砂砾——生物的量级仍然嫌少。<br>&nbsp;&nbsp;&nbsp; 此外，即使假设我们已经拥有支持超大并发量的量子计算机，我们仍然需要组织更复杂的神经网络结构。在各种科幻作品中，AI之所以强大到令人类恐惧，是它们具备了自行学习，自组织自身结构的能力。也许你会说ANN不是已经能自行学习了吗？但是ANN乃至DL的学习结果被AI掌握了吗？不，连AI本身都还不存在，学习结果只能呈现给人类。那么这里我要说，AI更加重要，或许最重要的一项素质其实是结构自组织的能力。<br>&nbsp;&nbsp;&nbsp; 你可能会问，人类的脑神经似乎也没有怎么调整结构啊，怎么具有如此高的智能程度？我要驳斥两点，首先，现在看到的每一个人类个体的脑神经结构都是不是凭空产生的，亿万年的生物史中人类这条智慧生物演化线上调整自身的脑神经结构的过程从来没有停止过；其次，即使是一个固定人类个体，他的脑神经网络结构也是在进行自调整的，神经细胞的生长、萎缩、换代在人的一生中一直在进行，这不能单纯的映射为ANN中神经元间连接权重的调整，神经元的层次结构也在发生变化。<br>&nbsp;&nbsp;&nbsp; 谈及自适应的自结构调整我们要打住，我还得引入一下类脑的设想与技术现状。</p>\n<h1 id=\"2-类脑现状\"><a href=\"#2-类脑现状\" class=\"headerlink\" title=\"2 类脑现状\"></a>2 类脑现状</h1><p>&nbsp;&nbsp;&nbsp; 类脑是近两年炒起来的新概念，在我看来真正的类脑科技的前置科技还没有准备好，类脑这个概念来的太早了。我的根据有两点。<br>&nbsp;&nbsp;&nbsp; 首先，且不说具备自适应调整物理结构能力的类脑，即使要模拟一个静态的人脑物理结构，我们都很难做到，我们做不到那么大的并行量；我们没有量子计算机技术；我们能支撑的的分布式计算规模远不够大；我们不知道如何设计、组装各种反射部件（现在的ANN）成为一个成体系的具有综合思维能力和抽象逻辑能力的真正的神经网络。<br>&nbsp;&nbsp;&nbsp; 那么让人造物自适应的调整结构自己模拟一个优秀的脑神经网络呢？这是个好主意，通过现有经验的优化，人造物的演化速度可以比自然界中的生物快得多，且更有方向性。但是我们没有能够自行组合甚至仅仅是互相交互的纳米机器人技术，我们连会合体组合变形的机器人小组都都没有。<br>&nbsp;&nbsp;&nbsp; 我要这么说，要在硬件层面搞脑神经结构仿生，如果不抛弃纯机械处理单元，我们走不了多远。也许有读者注意到我隐约指出了硅基计算机之外的另一条技术道路。没错，除了量子计算机，我们还可以选择生物计算机，如果赛博世界无法创造出来，我们就用生化技术制造大量生物的处理单元完成巨量并行计算。<br>&nbsp;&nbsp;&nbsp; 更有甚者，我们可以直接把现有的哺乳动物个体乃至人类个体人道的接入高效通信的硅基网络，走人工蜂巢思维的路子。<br>&nbsp;&nbsp;&nbsp; 但不管怎么说，在我看来，现在所谓的带记忆的计算机计算部件的思路，实在是太保守也太天真了。<br>&nbsp;&nbsp;&nbsp; 但是要注意，我没有说非硬件的类脑不可实现，我们的专用分布式集群或许规模有限，但是互联网中终端的规模还是在不断扩大的。如果把互联网看做一个包含海量资源的物理世界，那么互联网中的每一个线程，都可以对应物理世界中的一个简单物理过程。一个程序虽然无法动态自适应的改变自身，但是如果把一个程序看成是一个生物个体呢？生物个体是可以死的，但是生物会在繁衍的过程中微调遗传因子，完成本种族的物理结构自调整，这种调整甚至可以是多版本、有分支的。是的，程序可以根据特定外部信息有方向的修改扩充自己的源码（毕竟程序一经编译就脱离与源码的联系了，就算是解释型语言的程序，执行完当前语句时，改动之前的语句也不会对程序的整体执行过程造成影响），然后命令编译新版本的源码，并运行新的可执行程序。<br>&nbsp;&nbsp;&nbsp; 简单而实际的说，我们可以把只会单纯复制自身的病毒程序，变成朝生夕死的蝼蚁。但是这些蝼蚁在繁衍（复制）的过程中可以根据我们赋予它们的经验迅速的、有方向的自适应微调自己的遗传因子（源码），甚至我们可以在每次繁衍（复制）的过程中让病毒程序“龙生九子各不同”。而外部信息，我们可以从互联网中获取，我们可以让病毒程序存活在每一台服务器，每一台终端机的冗余时空中。当然考虑到人类对未知和不可控事物的天然恐惧，我们也可以建立一个封闭的系统，但是我们仍然需要通过互联网获取信息不断更新（更新而不是扩充，因为独立系统空间有限）独立系统的知识库，让进化树在独立系统中自行生长。需要注意的是，如果我们指望病毒能迅速从蝼蚁变成具有更复杂结构的赛博生物，我们需要提醒病毒尽量与同类产生交互，这有助于共生生物群的产生。（毕竟我觉得每个人类个体其实也是一个巨大的共生生物群，其中的每个生物个体则是高度特化分工的细胞）<br>&nbsp;&nbsp;&nbsp; As far as I am concerned，赛博世界可以有人工智能，但是不要妄想只凭程序员自己，在<strong>一段源码</strong>中，封闭的完成AI的创造。智能个体必须是自适应调整的，不彻底放手让它演化，创造者将会成为它的进化瓶颈。</p>\n<h1 id=\"3-互联网与脑\"><a href=\"#3-互联网与脑\" class=\"headerlink\" title=\"3 互联网与脑\"></a>3 互联网与脑</h1><p>&nbsp;&nbsp;&nbsp; 这里我也顺便谈谈我对互联网与脑之间概念映射的看法。人们常常觉得互联网的基本单元应该是终端机或服务器，其实我觉得这是不对的，至少现在的互联网不应该这么看待。如果互联网是一个脑神经网络，那么互联网中的信息传递过程可以对应神经网络中的生物电信号传递，那互联网中的什么可以看成神经网络中的神经元呢？我觉得这一点上找不到物理的一一对应关系了，每一个被互联网连接起来的人类作为核心，供养人类的外部条件作为胶质细胞，人类使用的接入互联网的终端机设备作为突触，通信设备，包括光缆、交换机、路由器、服务器等等作为轴突和树突，这形成了一种互联网和神经网络间的扭曲的映射关系。<br>&nbsp;&nbsp;&nbsp; 值的注意的是，绝不应该把人类从互联网中割离开，离开了人类，互联网是死的。如果说互联网作为一个神经网络也指导行为，那么它是通过人类社会来行动的，人类社会是互联网特化分工的身体的一部分。互联网通过人类社会的行为，来优化调整自身的结构，来与物质世界交互。有读者可能会问，那么互联网就像一个生命了吧，它有意识吗？我们能跟它交流吗？我用一个问题来回答这种问题，你觉得我们人类要怎么跟自己的细胞来交流？<br>&nbsp;&nbsp;&nbsp; 这涉及一个有趣的观点，《左手疯子，右手天才》中提到过一种生命观，一个蚂蚁族群为什么要被看做许多生命个体？虽然蚂蚁之间被物理的隔离开，凭什么一个蚂蚁族群就不能看成是一个完整的生命体？蚂蚁不通过接触就不能连接在一个整体中了吗？为什么所有生命体都得跟人类似的，由一堆细胞生命抱成一团组成一个大的生命个体呢？<br>&nbsp;&nbsp;&nbsp; 我们可以这么看，如果细胞器是最小的生命体，那么细胞作为细胞器的社会，成了第二层的生命体，人类或其他多细胞生物就成了第三层的生命体，蚂蚁族群、人类社会或互联网难道不可以是第四层的生命体吗？</p>\n<p>&nbsp;&nbsp;&nbsp; 这是我第一次写这种信马由缰的非技术博文，只是我自己的小范围头脑风暴，有唐突冒失的地方读者多包含。</p>\n",
            "tags": [
                "机器学习",
                "人工神经网络",
                "类脑"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/12/01/C-%E7%9A%84%E4%BD%8D%E4%BC%98%E5%8C%96/",
            "url": "https://blog.bipedalbit.net/2015/12/01/C-%E7%9A%84%E4%BD%8D%E4%BC%98%E5%8C%96/",
            "title": "C++的位优化",
            "date_published": "2015-12-01T02:53:29.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 之前的中国象棋初版重在实现，老实说不论是时空效率还是健壮性都不太拿得出手，于是导师要求继续优化改进。考虑和调查过后，时间效率上可以借助之前设想的并行计算得到小幅优化，此外使用类似bool数组的手段也可以在走法生成器中小幅优化边界判断过程，最重要的时间效率优化手段是把博弈机改造成查表器，即以查表为主博弈为辅改变重心。以上都是时间效率优化，这篇文中暂且不展开，我的中国象棋初版在搜索深度大时（大于等于４层）开始出现程序崩溃的现象，暴露了空间效率问题。作为空间效率优化的铺垫，这次我来做个C++位优化的自科普。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 关于空间效率优化，从前顶多考虑到基本变量类型选择的程度，然而C++提供了一些更精细的特性，供程序员进行位级别的内存微操——位域、bitset、vector&lt;bool&gt;。</p>\n<h1 id=\"1-位域\"><a href=\"#1-位域\" class=\"headerlink\" title=\"1 位域\"></a>1 位域</h1><h2 id=\"1-1-字节对齐\"><a href=\"#1-1-字节对齐\" class=\"headerlink\" title=\"1.1 字节对齐\"></a>1.1 字节对齐</h2><p>&nbsp;&nbsp;&nbsp; 介绍位域之前，还需要做一点铺垫。业界C&#x2F;C++面试、笔试题中，经常考到结构体的字节对齐问题。比如，可能会问下面两个结构体分别占多大内存：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title class_\">s1</span><br>&#123;<br>\t<span class=\"hljs-type\">char</span> a;<br>\t<span class=\"hljs-type\">double</span> f;<br>\t<span class=\"hljs-type\">int</span> b;<br>\t<span class=\"hljs-type\">long</span> <span class=\"hljs-type\">long</span> g;<br>\t<span class=\"hljs-type\">char</span> c[<span class=\"hljs-number\">9</span>];<br>\t<span class=\"hljs-type\">float</span> e;<br>\t<span class=\"hljs-type\">short</span> d;<br>&#125;;<br><br><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title class_\">s2</span><br>&#123;<br>\t<span class=\"hljs-type\">char</span> a;<br>\t<span class=\"hljs-type\">char</span> c[<span class=\"hljs-number\">9</span>];<br>\t<span class=\"hljs-type\">short</span> d;<br>\t<span class=\"hljs-type\">float</span> e;<br>\t<span class=\"hljs-type\">int</span> b;<br>\t<span class=\"hljs-type\">double</span> f;<br>\t<span class=\"hljs-type\">long</span> <span class=\"hljs-type\">long</span> g;<br>&#125;;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; <code>sizeof(s1)</code>和<code>sizeof(s2)</code>分别为56字节和40字节。先不管为什么装着同样变量的结构体占用的内存大小会不同，如果结构体中变量紧密排列，应该占多大内存？ａ：1字节，ｂ：4字节，ｃ：9字节，ｄ：2字节，ｅ：4字节，ｆ：8字节，ｇ：8字节，共36字节。显然这些变量实际上不是紧密排列的，存在一些对齐、填充字节的规则：</p>\n<ul>\n<li>有效对齐值默认为结构体最宽<em>基本类型</em>成员的大小，注意结构体的结构体成员必须到内部寻找基本类型成员变量计算有效对齐值；</li>\n<li>结构体变量的首地址能够被其有效对齐值所整除；</li>\n<li>结构体每个成员相对于结构体首地址的偏移量都是其本身大小的整数倍，如有需要编译器会在成员之间加上填充字节；</li>\n<li>结构体的总大小为结构体有效对齐值的整数倍，如有需要编译器会在最末一个成员之后加上填充字节；</li>\n<li>存在指定对齐值（<code>#pragma pack (value)</code>中的value）时，<code>有效对齐值 = min&#123;默认对齐值, 指定对齐值&#125;</code>。</li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 至于为什么要做字节对齐，这与CPU取数方式有关，尤其与CPU与内存间数据总线宽度（现在除了单片机通常为32位）有关。因为数据总线宽度是硬件相关，所以一次取数的位数是固定的，假设总线宽度32位，那么一次取数的数据大小就为4字节，那么CPU读取内存数据就将以内存首地址为基址，以4个字节为偏移量单位。如果结构体中有一个char型和一个int型变量，紧密排列存储在内存中，读char型变量时照样取了结构体的前4个字节，其中高8位的哪个字节是存储着char型变量，会经过一些位运算后被提取出来（比如按位右移24位，这仅仅是猜测），到此为止看不出什么不好的。可是当读int型变量时问题就来了，CPU无法一次读取到整个int变量了，原因前面提到了：<em>CPU读取内存数据就将以内存首地址为基址，以4个字节为偏移量单位</em>。经过两次取数才能获得被分割在两个字（32位内存单位）中完整的int型变量，这还不算完，还要分别从两个字中提取恰当的位并进行拼接，这很浪费时间。<br>&nbsp;&nbsp;&nbsp; 按特定规则进行字节对齐后，虽然浪费了一些填充字节的内存空间，情况还是好多了。以s1为例，有效对齐值是double型和long long型的8字节即两个字，这里称其为一个对齐空间，装填a（填充7个字节），装填f，装填b（填充4个字节），装填g，装填c（一个对齐空间内放不下，第二个空间中也放了1个字节，填充7个字节），装填e，装填d，结构体整体填充2字节，填满对齐空间的整数倍。<br>&nbsp;&nbsp;&nbsp; 同理也可求得s2的内存占用，至于两个结构体的内存占用不一样的原因，是它们的成员变量排列顺序不同，而结构体给成员变量分配内存的顺序与定义变量的顺序相同。<br>&nbsp;&nbsp;&nbsp; 当指定对齐值小于默认对齐值，可令结构体的成员变量排列更紧密，更省空间，但可能降低取数效率。特别的，当指定对齐值为1，结构体成员变量完全紧密排列。</p>\n<h2 id=\"1-2-位域与其利弊\"><a href=\"#1-2-位域与其利弊\" class=\"headerlink\" title=\"1.2 位域与其利弊\"></a>1.2 位域与其利弊</h2><p>&nbsp;&nbsp;&nbsp; 不管是为数据结构的成员变量设计合适的排列顺序，还是指定合适的字节对齐值，都是在字节的层次上优化程序空间效率。而使用位域，可以在位的层次上优化程序空间效率。<br>&nbsp;&nbsp;&nbsp; 还是以1.1节中的s1为例，只在字节层面上优化，以不损失时间效率为前提，最佳策略如下：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">pragma</span> pack(4)</span><br><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title class_\">s1</span><br>&#123;<br>\t<span class=\"hljs-type\">double</span> f;<br>\t<span class=\"hljs-type\">long</span> <span class=\"hljs-type\">long</span> g;<br>\t<span class=\"hljs-type\">int</span> b;<br>\t<span class=\"hljs-type\">float</span> e;<br>\t<span class=\"hljs-type\">short</span> d;<br>\t<span class=\"hljs-type\">char</span> a;<br>\t<span class=\"hljs-type\">char</span> c[<span class=\"hljs-number\">9</span>];<br>&#125;;<br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">pragma</span> pack()</span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 实际上就是保证按32位字（4字节）对齐，变量按大小降序排列。此时的<code>sizeof(s1)</code>为36字节，空间开销等同变量成员紧密排列，时间效率没有受到影响。<br>&nbsp;&nbsp;&nbsp; 下面这种写法不知读者见过没有：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">pragma</span> pack(4)</span><br><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title class_\">s1</span><br>&#123;<br>\t<span class=\"hljs-type\">double</span> f;<br>\t<span class=\"hljs-type\">long</span> <span class=\"hljs-type\">long</span> g: <span class=\"hljs-number\">21</span>;<br>\t<span class=\"hljs-type\">int</span> b: <span class=\"hljs-number\">7</span>;<br>\t<span class=\"hljs-type\">float</span> e;<br>\t<span class=\"hljs-type\">short</span> d;<br>\t<span class=\"hljs-type\">char</span> a;<br>\t<span class=\"hljs-type\">char</span> c[<span class=\"hljs-number\">9</span>];<br>&#125;;<br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">pragma</span> pack()</span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 对这样定义的结构体s1，<code>sizeof(s1)</code>是28字节。变量b、g后面的‘:’和数字就是位域的描述方式。位域的作用是把一些用不到当前类型变量中所有位的变量做进一步压缩，比如这里的s1结构体中的g变量，原来占用64位，使用位域压缩后g变量只使用原内存空间的高21位，填充3位补满3个字节后，原long long变量的后5个字节就可以自由分配了；b变量，原来占用32位，使用位域压缩后b变量只使用原内存空间的高7位，填充1位填满1个字节后，原int变量的后3个字节的内存空间就可以自由分配了。b、g压缩过后刚好占据4个字节一个32位字，比原来少占８个字节。<br>&nbsp;&nbsp;&nbsp; 于是，借由位域压缩技术，C++得以进行位层次的空间效率优化了。然而位域的使用有着诸多限制和缺陷：</p>\n<ul>\n<li>位域不可以用于浮点型变量的压缩；</li>\n<li>位域压缩有符号数时，由于其存储变量的编码方式是源码而非平常变量的补码，变量符号将可能出现不可预料的状态；</li>\n<li>位域压缩将局部解除变量间原有的的字节对齐规范，即使位域压缩的变量与相邻变量紧密排列，这可能引起取数时间效率的损失。</li>\n</ul>\n<h1 id=\"2-bitset\"><a href=\"#2-bitset\" class=\"headerlink\" title=\"2 bitset\"></a>2 bitset</h1><p>&nbsp;&nbsp;&nbsp; 这一节我要介绍的是比特集，正如字面意思，它是一种比特的集合的特殊数据结构。位域是C遗留下来的特性，存在很多不完备和妥协的地方,C++中推荐的替换方案之一就是bitset。它的具体使用方法我不想细讲，这里只做个概念介绍，想了解更多可以看<a href=\"http://www.cplusplus.com/reference/bitset/bitset/\">标准C++手册</a>，<del>其实是我困了懒得写</del>。<br>&nbsp;&nbsp;&nbsp; 比特集维护一个静态定义其长度的比特串，内存占用以系统字长（通常为<em>机器字长</em>，即CPU中寄存器的位数，即CPU进行数据计算的单位位宽，而非前面提到的数据总线宽度，但机器字长一定是数据总线宽度的整数倍）为单位长度，当然如果读者使用64位的机器却安装32位的系统则是把机器当做32位机使用，每个CPU寄存器只使用一半的位数。比特集可以通过包含‘０’、‘１’的字符串来构造，也可以通过无符号的整型变量来构造。为什么是无符号数？因为比特的集合本来就是逻辑的、离散的，符号在比特集中没有意义。当然如果想用某个逻辑位来作为符号位也随用户喜欢。相应的，比特集也可以转换成‘０’、‘１’字符串或者整型数。理所当然的，比特集类封装了一系列位运算符号和逻辑位操作方法，注意比特集的位操作符号两边都应该是比特集，位移操作符除外。<br>&nbsp;&nbsp;&nbsp; 也许有读者想了解bitset的内存占用情况，我进行了下面的一系列测试：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\">cout &lt;&lt; <span class=\"hljs-built_in\">sizeof</span>(bitset&lt;<span class=\"hljs-number\">10</span>&gt;) &lt;&lt; endl;\t<span class=\"hljs-comment\">//8</span><br>cout &lt;&lt; <span class=\"hljs-built_in\">sizeof</span>(bitset&lt;<span class=\"hljs-number\">20</span>&gt;) &lt;&lt; endl;\t<span class=\"hljs-comment\">//8</span><br>cout &lt;&lt; <span class=\"hljs-built_in\">sizeof</span>(bitset&lt;<span class=\"hljs-number\">40</span>&gt;) &lt;&lt; endl;\t<span class=\"hljs-comment\">//8</span><br>cout &lt;&lt; <span class=\"hljs-built_in\">sizeof</span>(bitset&lt;<span class=\"hljs-number\">80</span>&gt;) &lt;&lt; endl;\t<span class=\"hljs-comment\">//16</span><br>cout &lt;&lt; <span class=\"hljs-built_in\">sizeof</span>(bitset&lt;<span class=\"hljs-number\">160</span>&gt;) &lt;&lt; endl;\t<span class=\"hljs-comment\">//24</span><br>cout &lt;&lt; <span class=\"hljs-built_in\">sizeof</span>(bitset&lt;<span class=\"hljs-number\">320</span>&gt;) &lt;&lt; endl;\t<span class=\"hljs-comment\">//40</span><br>cout &lt;&lt; <span class=\"hljs-built_in\">sizeof</span>(bitset&lt;<span class=\"hljs-number\">640</span>&gt;) &lt;&lt; endl;\t<span class=\"hljs-comment\">//80</span><br>cout &lt;&lt; <span class=\"hljs-built_in\">sizeof</span>(bitset&lt;<span class=\"hljs-number\">1280</span>&gt;) &lt;&lt; endl;\t<span class=\"hljs-comment\">//160</span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 测试结果我写在注释里了，可以看到，bitset的存储单位是8个字节，而我的这台笔记本电脑正是64位机器字长的，测试环境是64位的Ubuntu 14.04版本操作系统。<br>&nbsp;&nbsp;&nbsp; 同样的，比特bitset也有它的不足之处，比如它不能再与普通整型数直接进行位运算，且它一经构造，不可以改变长度。至于时间效率，可以充分相信它不比普通整型的同类操作慢。</p>\n<h1 id=\"3-vector\"><a href=\"#3-vector\" class=\"headerlink\" title=\"3 vector&lt;bool&gt;\"></a>3 vector&lt;bool&gt;</h1><p>&nbsp;&nbsp;&nbsp; 当我第一次在手册中看见vector&lt;bool&gt;时我并没有留意，虽然也对bool型的vector容器为什么有一套独立的API感到了一丝困惑。后来在查找bitset相关资料时发现有人写了vector&lt;bool&gt;与bitset的比较文章，这才知道，vector&lt;bool&gt;是C++提供的bitset之外的另一种位层次数据结构微操方案，同等长度的两者的内存占用几乎一样。vector&lt;bool&gt;的具体用法读者依旧可以查看<a href=\"http://www.cplusplus.com/reference/vector/vector-bool/\">手册</a>，<del>是的我又偷懒了XDDD</del>。<br>&nbsp;&nbsp;&nbsp; 既然vector&lt;bool&gt;实现在vector库文件中，想必读者也能猜到它与bitset最大的不同，没错它是可变长的。相应的，作为牺牲，考虑数组与vector的区别，也不难猜到，vector&lt;bool&gt;比bitset慢。首先它的位操作也比bitset少得多，其次vector&lt;bool&gt;中的位不再能够用下标随机存取，而需要使用迭代器来访问。其实比起bitset的变长版本，我觉得说vector&lt;bool&gt;是bool型vector的空间优化版本更合适一些。</p>\n<p>&nbsp;&nbsp;&nbsp; 以上就完成了简单的位层面程序空间效率优化的相关概念引入，下面会继续跟进我的中国象棋的改进版本。</p>\n",
            "tags": [
                "C++",
                "位域",
                "bitset",
                "vector&lt;bool&gt;"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/11/15/%E4%B8%AD%E5%9B%BD%E8%B1%A1%E6%A3%8B%E4%BA%BA%E6%9C%BA%E5%8D%9A%E5%BC%88%E5%AE%9E%E7%8E%B0%E7%BB%83%E4%B9%A0/",
            "url": "https://blog.bipedalbit.net/2015/11/15/%E4%B8%AD%E5%9B%BD%E8%B1%A1%E6%A3%8B%E4%BA%BA%E6%9C%BA%E5%8D%9A%E5%BC%88%E5%AE%9E%E7%8E%B0%E7%BB%83%E4%B9%A0/",
            "title": "中国象棋人机博弈实现练习",
            "date_published": "2015-11-15T13:54:03.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 上一篇简略做了棋牌游戏人机博弈的概念铺垫，这一篇文就来贴一下我的初版实现。精力受限，没有像许多前辈那样把Maxmin系的搜索算法（Maxmin、AlphaBeta、Fail-Soft-AlphaBeta、Aspiration、PVS、MTD(f)）全部实现一遍。刚开始我甚至只打算实现一个MTD(f)的搜索核心，因为毕竟最晚出现的算法通常一定程度上是以往算法的集大成者。但是等把MTD(f)实现完，发现里面一层就是个AlphaBeta，于是AlphaBeta的搜索核心作为副产品也存在于实现成果中了。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 我并不打算在这里贴包括Qt5的GUI实现代码在内的所有大概3500行代码（当然其中至少700行可能是注释），主要讲解一下我的实现思路，偶尔贴一些关键代码。完整项目源码我在GitHub建了仓库，这篇文最后会贴地址，读者也可以自己去我Git找找看，毕竟我一共也没建过几个仓库。下面开始正题。</p>\n<h1 id=\"1-需求分析\"><a href=\"#1-需求分析\" class=\"headerlink\" title=\"1 需求分析\"></a>1 需求分析</h1><ul>\n<li>GUI：为了方便人工测试，灵活直观的展现测试结果<del>也方便随时嘚瑟</del>，中国象棋人机博弈程序的实现应该有GUI（图形用户界面）。</li>\n<li>通用部件：应该根据实际需要设计比较高效的、节省空间的、通用的局面表示部件与走法表示部件。</li>\n<li>走法生成器：为了给并行计算和分布式计算做准备，应该设计通用的走法生成器接口。至少实现一个可靠的串行计算的走法生成器。</li>\n<li>搜索核心：为了方便扩展与迭代开发，应该设计通用的搜索核心接口。若干不同版本的走法核心也应该被实现。</li>\n<li>局面评估核心：考虑到短期内难以获得经过结构化解析的对局数据或棋谱，只实现一个参数可在代码中调整的静态局面评估核心，通用局面评估核心接口不予实现，暂时搁置等待重构。</li>\n</ul>\n<h1 id=\"2-概要设计\"><a href=\"#2-概要设计\" class=\"headerlink\" title=\"2 概要设计\"></a>2 概要设计</h1><h2 id=\"2-1-GUI\"><a href=\"#2-1-GUI\" class=\"headerlink\" title=\"2.1 GUI\"></a>2.1 GUI</h2><p>&nbsp;&nbsp;&nbsp; 图形界面中棋盘、棋子的图形是必要组成部分。<br>&nbsp;&nbsp;&nbsp; 此外考虑到人机博弈回合间电脑变动棋子位置太突兀，玩家有时甚至难以察觉棋子位置的变化，应当添加当前选定棋子的标记（对电脑方的棋子来说则是上一步刚被操作过的棋子的标记）。<br>&nbsp;&nbsp;&nbsp; 应当可以选择玩家先手开局或后手开局。<br>&nbsp;&nbsp;&nbsp; 应当有开局按钮。<br>&nbsp;&nbsp;&nbsp; 最好也有悔棋或状态回退按钮。<br>&nbsp;&nbsp;&nbsp; 应当可以在每轮电脑回合前更改电脑使用的搜索核心种类。<br>&nbsp;&nbsp;&nbsp; 应当可以在每轮电脑回合前更改电脑搜索的深度（模拟对局回合数）。<br>&nbsp;&nbsp;&nbsp; 应该显示每轮电脑搜索中评估的局面数量和搜索用时，方便在测试时对算法效率和优化效果进行评估。</p>\n<h2 id=\"2-2-通用部件\"><a href=\"#2-2-通用部件\" class=\"headerlink\" title=\"2.2 通用部件\"></a>2.2 通用部件</h2><p>&nbsp;&nbsp;&nbsp; 最基本的通用部件应该是<em>棋盘位置的表示部件</em>，这个部件首先应当提供位置坐标的设置与查询方法。该部件还可能需要提供一些获取棋盘特定位置属性的方法，以辅助走法生成和局面评估。该部件的变量成员或容器应当进行适当的状态压缩以节省空间。<br>&nbsp;&nbsp;&nbsp; <em>走法表示部件</em>将提供特定走法的属性查询方法，如移动的棋子序号，走法中是否有棋子被吃，移动棋子的起点坐标和终点坐标。走法表示部件将使用棋盘位置表示部件做一些具体的实现。<br>&nbsp;&nbsp;&nbsp; 恰当的<em>局面状态表示部件</em>也是必要的。这个部件将直接为走法生成器和评估核心提供所有棋子的位置、状态查询方法，所有棋子相对位置的属性查询方法，以及所有棋盘特定位置的属性查询方法，棋子位置变更时的局面更新方法，棋子位置变更时的变更回退方法等。毫无疑问局面表示部件将使用棋盘位置表示部件和走法表示部件来实现所需的方法。</p>\n<h2 id=\"2-3-走法生成器\"><a href=\"#2-3-走法生成器\" class=\"headerlink\" title=\"2.3 走法生成器\"></a>2.3 走法生成器</h2><p>&nbsp;&nbsp;&nbsp; 不管计算形式是串行还是并行的，走法生成器应该按照中国象棋规则提供特定局面下合法的所有走法，并装载在一个走法容器中以备查询。合法的走法除需要符合基本的中国象棋行棋规则之外，还应该根据已走局面剔除循环走法。</p>\n<h2 id=\"2-4-搜索核心\"><a href=\"#2-4-搜索核心\" class=\"headerlink\" title=\"2.4 搜索核心\"></a>2.4 搜索核心</h2><p>&nbsp;&nbsp;&nbsp; 搜索核心应该作为游戏程序的主线索，调用走法生成器和局面评估核心对接下来的人机博弈状态做一系列的预演，然后给出相对最好的走法。搜索过程中还应该收集一些程序运行信息，比如评估结点数，搜索时间。搜索每一个新层次时势必要管理搜索树占用的内存空间，应该给出一个可行的空间管理方案。</p>\n<h2 id=\"2-5-局面评估核心\"><a href=\"#2-5-局面评估核心\" class=\"headerlink\" title=\"2.5 局面评估核心\"></a>2.5 局面评估核心</h2><p>&nbsp;&nbsp;&nbsp; 如前所述，暂且只要求实现一个基于少量中国象棋实际经验和主观猜测的评估函数。这个评估函数可能会需要一个类似于走法生成器但有所不同的“棋子影响力覆盖范围生成器”作为工具函数。</p>\n<h1 id=\"3-详细设计\"><a href=\"#3-详细设计\" class=\"headerlink\" title=\"3 详细设计\"></a>3 详细设计</h1><h2 id=\"3-1-GUI\"><a href=\"#3-1-GUI\" class=\"headerlink\" title=\"3.1 GUI\"></a>3.1 GUI</h2><p>&nbsp;&nbsp;&nbsp; Qt5设计GUI有多方便相信用过的读者都有体会，无非就是拖拖控件写写槽函数加点资源调调样式。<br>&nbsp;&nbsp;&nbsp; 本来我想在轮到电脑的回合时间显示一个正在加载时的常见gif图片，但发现这涉及到Qt5的并行计算方式。经过简单的尝试（利用QtConcurrent类）后发现无法在不同线程中顺畅管理相同的控件状态，这可能是资源同步互斥管理的问题（这里相信一些读者会联想到一个关于多线程的笑话：一个程序员遇到了一个问题，想通过多线程来解决它，现在他有两个问题了），于是干脆放弃显示图片的想法了，你将在我的Qt源码中发现我尝试的痕迹。<br>&nbsp;&nbsp;&nbsp; 另一点稍微值得一提的事是，我在准备好一切，要开始写点击棋子的槽函数的时候发现，QLabel控件居然没有Clicked默认事件，看来我是Web应用写多了有点惯性思维了。于是我只好自定义了一个ClickableLabel类，这个类是对QLabel类的封装，重载了基类QWidget的mouseReleaseEvent方法，在方法里发射了一个clicked消息。最后把所有需要点击互动的QLabel提升成了ClickableLabel，并添加了ClickableLabel的clicked消息的槽函数。<br>&nbsp;&nbsp;&nbsp; clickablelable.h：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">ifndef</span> CLICKABLELABEL_H</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> CLICKABLELABEL_H</span><br><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&lt;QLabel&gt;</span></span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&lt;QWidget&gt;</span></span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">include</span> <span class=\"hljs-string\">&lt;QPoint&gt;</span></span><br><br><span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">ClickableLabel</span> : <span class=\"hljs-keyword\">public</span> QLabel<br>&#123;<br>\tQ_OBJECT<br><span class=\"hljs-keyword\">public</span>:<br>\t<span class=\"hljs-function\"><span class=\"hljs-keyword\">explicit</span> <span class=\"hljs-title\">ClickableLabel</span><span class=\"hljs-params\">(QWidget* parent = <span class=\"hljs-number\">0</span>)</span></span>;<br>\t~<span class=\"hljs-built_in\">ClickableLabel</span>();<br>signals:<br>\t<span class=\"hljs-function\"><span class=\"hljs-type\">void</span> <span class=\"hljs-title\">clicked</span><span class=\"hljs-params\">(ClickableLabel* clickableLabel)</span></span>;<br>\t<span class=\"hljs-function\"><span class=\"hljs-type\">void</span> <span class=\"hljs-title\">clicked</span><span class=\"hljs-params\">(QPoint pos, ClickableLabel* clickableLabel)</span></span>;<br><span class=\"hljs-keyword\">protected</span>:<br>\t<span class=\"hljs-function\"><span class=\"hljs-keyword\">virtual</span> <span class=\"hljs-type\">void</span> <span class=\"hljs-title\">mouseReleaseEvent</span><span class=\"hljs-params\">(QMouseEvent *event)</span></span>;<br>&#125;;<br><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">endif</span> <span class=\"hljs-comment\">// CLICKABLELABEL_H</span></span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; clickablelable.cpp：</p>\n<pre><code class=\"hljs\">#include &quot;clickablelabel.h&quot;\n#include &quot;QMouseEvent&quot;\n\nClickableLabel::ClickableLabel(QWidget* parent)\n\t: QLabel(parent)\n&#123;\n&#125;\n\nClickableLabel::~ClickableLabel()\n&#123;\n&#125;\n\nvoid ClickableLabel::mouseReleaseEvent(QMouseEvent* event)\n&#123;\n\temit clicked(this);\n\temit clicked(event-&gt;pos(), this);\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 还挺简单的，不是吗？</p>\n<h2 id=\"3-2-通用部件\"><a href=\"#3-2-通用部件\" class=\"headerlink\" title=\"3.2 通用部件\"></a>3.2 通用部件</h2><h3 id=\"3-2-1-棋盘位置表示部件\"><a href=\"#3-2-1-棋盘位置表示部件\" class=\"headerlink\" title=\"3.2.1 棋盘位置表示部件\"></a>3.2.1 棋盘位置表示部件</h3><p>&nbsp;&nbsp;&nbsp; 我为棋盘位置表示部件实现了一个Position类，只有一个unsigned char型成员变量，８位，一个字节，高四位表示纵坐标即行序号，第四位表示横坐标即列序号，全１有两个方面的含义：对特定棋子来书，当前位置坐标全１表示该棋子已经被吃；对棋盘上特定位置来说，全１表示棋盘上这个位置没有棋子。<br>&nbsp;&nbsp;&nbsp; 因为这个类中的横纵坐标是状态压缩的，需要分别提供横纵坐标的提取／解析方法x()、y()，还有棋子死活／有无的判定及设置方法dead()、kill()。具体实现都是些简单的位运算，比如取第四位用按位与，取高四位用位移。比较局面状态难免要做一系列的棋盘位置比较，所以还实现了“&#x3D;&#x3D;”和“!&#x3D;”符号。<br>&nbsp;&nbsp;&nbsp; 后面在搜索核心的实现有时候会用到置换表，生成hash key需要获取底层的坐标存储数据，所以这个类还有个突兀的友元声明。</p>\n<h3 id=\"3-2-2-走法表示部件\"><a href=\"#3-2-2-走法表示部件\" class=\"headerlink\" title=\"3.2.2 走法表示部件\"></a>3.2.2 走法表示部件</h3><p>&nbsp;&nbsp;&nbsp; 走法表示使用四个成员变量：移动的棋子序号、被吃的棋子序号、原棋盘位置、新棋盘位置，全部使用unsigned char型变量，共４个字节。实现这个类时我偷了个懒，干脆把成员变量访问限定符都定为public了，于是除了空构造函数和一个初始化所有成员变量的重载，只写了一个比较符号“&#x3D;&#x3D;”。没什么特别的。</p>\n<h3 id=\"3-2-3-局面状态表示部件\"><a href=\"#3-2-3-局面状态表示部件\" class=\"headerlink\" title=\"3.2.3 局面状态表示部件\"></a>3.2.3 局面状态表示部件</h3><p>&nbsp;&nbsp;&nbsp; 这个部件还比较有意思。实际上，写游戏初版时，因为走法生成器，搜索核心或评估核心内部实现过程不顺心，曾经一度重构通用部件，其中也伴随着通用部件新需求的不断提出。作为直接向三大模块提供服务的部件，局面状态表示部件的修改最为频繁。<br>&nbsp;&nbsp;&nbsp; 资料提出的中国象棋棋盘状态存储模型有：</p>\n<ul>\n<li>用32颗棋子的棋盘分布（32*10*9个比特）来保存局面状态；</li>\n<li>用14种棋子的棋盘分布（14*10*9个比特）来保存局面状态；</li>\n<li>用10*9个棋盘位置上32颗棋子的互斥存在标识（10*9*5个比特）来保存局面状态；</li>\n<li>用10*9个棋盘位置上14种棋子的互斥存在标识（10*9*4个比特）来保存局面状态；</li>\n<li>用32颗棋子的坐标值（32*8个比特）来保存局面状态。</li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 可以看出，上述模型占用空间的大小依次递减。如果比较占用空间大小，第五种模型显然最优。但是实现走法生成器和评估核心时，需要对棋子相对位置上的棋子有无、棋子归属进行大量查询。如果每次针对特定棋盘位置的棋子查询都通过遍历32颗棋子来完成，何况每颗棋子都需要对若干个相对位置做棋子查询，尤其是車、炮这种自由度很大的棋子，恐怕随着搜索树的展开，将累计很大的时间开销。<br>&nbsp;&nbsp;&nbsp; 那么如果换用第四种模型呢？特定棋子相对位置的状态可以直接查询到了，同类查询的时间开销降到了第五种模型的1&#x2F;32。那么如果选用第四种模型，除了稍多一些的空间开销，有没有做出别的牺牲呢？当我们想要查询特定棋子的坐标，不再能够直接查到了，我们需要遍历整个棋盘来寻找一颗棋子，还需要标记这颗棋子是否同类棋子（同归属方、同兵种）中我们需要的那一颗。同类查询的时间开销变成了原来的90倍以上。这并不是一个典型的、合算的空间换时间型优化。<br>&nbsp;&nbsp;&nbsp; 我们重新思考一下局面表示部件在搜索过程中的实际使用情况，不难发现，如果把当前局面作为一个引用参数引入搜索核心类，那么整个搜索过程中，不论采用怎样的局面表示模型，不论对当前局面状态做了多少次更新和回退，空间开销的差别其实微乎其微。真正对空间开销起明显作用的是走法表示部件的数据结构。想到这里不禁觉得一阵无力感袭来，局面状态表示部件的状态压缩是不太有意义的。<br>&nbsp;&nbsp;&nbsp; 那么我们现在可以专注于提高局面状态表示部件中各种方法的时间效率而无视空间开销了。于是我用了一个双向索引，即同时在部件中使用第一种模型和第五种模型。这样不管按棋子序号查询坐标还是按特定坐标查询棋盘位置状态，都可以以常数级的时间开销完成查询过程。当然还实现了许多为三大模块提供服务的方法，还需要记录局面评分和主动权归属。<br>&nbsp;&nbsp;&nbsp; State.h：</p>\n<pre><code class=\"hljs\">#ifndef _STATE_H_\n#define _STATE_H_\n\n#include &quot;Position.h&quot;\n#include &quot;Move.h&quot;\n\n/* 棋子序号 */\n/* 红帅 */\n#define R_KING 0\n/* 红仕序号起点（序号个数2） */\n#define R_MANDARIN 1\n/* 红相序号起点（序号个数2） */\n#define R_ELEPHANT 3\n/* 红马序号起点（序号个数2） */\n#define R_KNIGHT 5\n/* 红車序号起点（序号个数2） */\n#define R_ROOK 7\n/* 红炮序号起点（序号个数2） */\n#define R_CANNON 9\n/* 红兵序号起点（序号个数5） */\n#define R_PAWN 11\n/* 红子序号起点 */\n#define R_BEGIN R_KING\n/* 红子序号终点 */\n#define R_END R_PAWN+4\n/* 黑将 */\n#define B_KING 16\n/* 黑士序号起点（序号个数2） */\n#define B_MANDARIN 17\n/* 黑象序号起点（序号个数2） */\n#define B_ELEPHANT 19\n/* 黑马序号起点（序号个数2） */\n#define B_KNIGHT 21\n/* 黑車序号起点（序号个数2） */\n#define B_ROOK 23\n/* 黑炮序号起点（序号个数2） */\n#define B_CANNON 25\n/* 黑卒序号起点（序号个数5） */\n#define B_PAWN 27\n/* 黑子序号起点 */\n#define B_BEGIN B_KING\n/* 黑子序号终点 */\n#define B_END B_PAWN+4\n/* 坐标数组中表示棋子已被吃 */\n#define DEAD 0xff\n/* 棋子数组中表示坐标无棋子占用 */\n#define NONE DEAD\n\n/* 局面状态类：32+90=122字节 */\n/* 这个类负责记录局面状态，包括局面的棋子索引的状态和坐标索引的状态。 */\n/* 坐标索引的状态提供坐标优先的快速状态查询； */\n/* 棋子索引的状态提供棋子优先的快速状态查询。 */\nclass State\n&#123;\npublic:\n\t/* 当前局面下红方是否持有行动权 */\n\tbool RTurn;\n\t/* 根据中国象棋规则初始化局面状态 */\n\tState();\n\t/* 根据走法更新棋盘状态 */\n\tvoid move(const Move &amp;m);\n\t/* 还原按走法还原更新前的棋盘状态 */\n\tvoid undo(const Move &amp;m);\n\t/* 获取特定棋子行号，即棋子y坐标 */\n\tunsigned char y(unsigned char chessNo) const;\n\t/* 获取特定棋子列号，即棋子x坐标 */\n\tunsigned char x(unsigned char chessNo) const;\n\t/* 获取特定坐标上的棋子序号或空序号 */\n\tunsigned char getNo(unsigned char x, unsigned char y) const;\n\t/* 存活判定 */\n\tbool isAlive(unsigned char chessNo) const;\n\t/* 红子判定 */\n\tbool isRed(unsigned char chessNo) const;\n\t/* 黑子判定 */\n\tbool isBlack(unsigned char chessNo) const;\n\t/* 友方判定 */\n\tbool isFriend(unsigned char chessNo1, unsigned char chessNo2) const;\n\t/* 特定棋子相对位置处是否有子 */\n\tbool relExist(unsigned char chessNo, char x, char y) const;\n\t/* 特定棋子相对位置处是否有红子 */\n\tbool relRedExist(unsigned char chessNo, char x, char y) const;\n\t/* 特定棋子相对位置处是否有黑子 */\n\tbool relBlackExist(unsigned char chessNo, char x, char y) const;\n\t/* 判断当前棋局是否已经结束，即一方的将/帅已经被吃 */\n\tbool isDone() const;\n\t/* 定义一个相等运算符，unordered_map要用 */\n\tbool operator == (const State state) const;\n\t/* 允许KeyHash类访问私有成员 */\n\tfriend class KeyHash;\nprivate:\n\t/* 使用双向索引，加快两个方向的查询速度 */\n\t/* 棋子序号索引的坐标数组：32字节 */\n\tPosition posList[32];\n\t/* 棋盘坐标索引的棋子数组：90字节 */\n\t/* 二维数组的每个单元为一个8位整型数，用来表示坐标占用情况 */\n\t/* 即与坐标数组通用的棋子序号和一个额外的表示空的序号0xff */\n\tunsigned char board[10][9];\n&#125;;\n\n#endif\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 具体方法实现都很简单，就不在这贴代码了。</p>\n<h2 id=\"3-3-走法生成器\"><a href=\"#3-3-走法生成器\" class=\"headerlink\" title=\"3.3 走法生成器\"></a>3.3 走法生成器</h2><p>&nbsp;&nbsp;&nbsp; 这是我认为中国象棋游戏中实现起来最繁琐的一个模块了，这里无法回避中国象棋零散的行棋规则。<br>&nbsp;&nbsp;&nbsp; 将／帅除了直面对方将／帅时可以飞过去吃掉对方，平时只能在己方的“帅府”九宫格中向没有己方棋子且不超出棋盘的位置做下列４种移动：</p>\n<ul>\n<li><code>(x, y) -&gt; (x-1, y)</code></li>\n<li><code>(x, y) -&gt; (x+1, y)</code></li>\n<li><code>(x, y) -&gt; (x, y-1)</code></li>\n<li><code>(x, y) -&gt; (x, y+1)</code></li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 士／仕只能在己方“帅府”九宫格中向没有己方棋子且不超出棋盘的位置做下列４种移动：</p>\n<ul>\n<li><code>(x, y) -&gt; (x-1, y-1)</code></li>\n<li><code>(x, y) -&gt; (x+1, y-1)</code></li>\n<li><code>(x, y) -&gt; (x-1, y+1)</code></li>\n<li><code>(x, y) -&gt; (x+1, y+1)</code></li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 象／相只能在己方阵地的五行内，在不被“遮象眼”的情况下“走田字”，即向没有己方棋子且不超出棋盘的位置做下列４种尝试：</p>\n<ul>\n<li>(x-1, y-1)处无子则<code>(x, y) -&gt; (x-2, y-2)</code></li>\n<li>(x+1, y-1)处无子则<code>(x, y) -&gt; (x+2, y-2)</code></li>\n<li>(x-1, y+1)处无子则<code>(x, y) -&gt; (x-2, y+2)</code></li>\n<li>(x+1, y+1)处无子则<code>(x, y) -&gt; (x+2, y+2)</code></li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 马只能在不被“別马腿”的情况下“走日字”，即向没有己方棋子且不超出棋盘的位置做下列８种尝试：</p>\n<ul>\n<li>(x-1, y)处无子则<code>(x, y) -&gt; (x-2, y-1), (x, y) -&gt; (x-2, y+1)</code></li>\n<li>(x+1, y)处无子则<code>(x, y) -&gt; (x+2, y-1), (x, y) -&gt; (x+2, y+1)</code></li>\n<li>(x, y-1)处无子则<code>(x, y) -&gt; (x-1, y-2), (x, y) -&gt; (x+1, y-2)</code></li>\n<li>(x, y+1)处无子则<code>(x, y) -&gt; (x-1, y+2), (x, y) -&gt; (x+1, y+2)</code></li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 車可以在上、下、左、右四个方向上在不超出棋盘又无棋子阻挡“视线”的前提下尝试移动任意距离，当遇到第一颗阻挡“视线”的棋子，如果棋子归属方不同，还可以吃子，取代那颗棋子的位置。<br>&nbsp;&nbsp;&nbsp; 炮有两种移动模式，即非吃子或吃子。非吃子模式下，炮可以在上、下、左、右四个方向上在不超出棋盘又无棋子阻挡“视线”的前提下尝试移动任意距离；吃子模式下，炮首先要在上、下、左、右四个方向上找到一颗阻挡“视线”的棋子，然后跳过这颗棋子，继续向前寻找阻挡“视线”的第二颗棋子，如果找到阻挡视线的第一颗和第二颗棋子，且第二颗棋子归属方不同，可以吃掉第二颗棋子，取代它的位置。<br>&nbsp;&nbsp;&nbsp; 兵／卒有两种行棋情况，在离开己方阵地的五行之前，只能在前方没有己方棋子的情况下向对方阵地移动一格；在离开己方阵地即进入敌方阵地后，向没有己方棋子且不超出棋盘的位置向前一格、向左一格或向右一格移动。<br>&nbsp;&nbsp;&nbsp; 此外，还要引入局面记录参数，剔除造成重复局面的走法。<br>&nbsp;&nbsp;&nbsp; 文字描述都这么麻烦，程序就更麻烦了，串行的走法生成器我写了700+行，虽然我的缩进比较“宽松”，注释比较多，还是很长了。并行版本如果用多线程还得管理线程队列、线程池，创建线程、监视线程、管理共享资源、做同步互斥什么的，恐怕会更长。多进程也一样。</p>\n<h2 id=\"3-4-搜索核心\"><a href=\"#3-4-搜索核心\" class=\"headerlink\" title=\"3.4 搜索核心\"></a>3.4 搜索核心</h2><h3 id=\"3-4-1-搜索核心通用接口\"><a href=\"#3-4-1-搜索核心通用接口\" class=\"headerlink\" title=\"3.4.1 搜索核心通用接口\"></a>3.4.1 搜索核心通用接口</h3><p>&nbsp;&nbsp;&nbsp; 本着引入复杂类型变量时能用引用或指针就不复制变量的原则，搜索核心通用接口定义了许多成员变量。一个局面状态表示部件currentState用来复制当前状态，我复制了整个部件而非引入一个引用，是因为如果使用引用，构造类的时候不太方便，同样要增加开销。我想过使用指针，但是发现遍历State类成员时会一直报错，没能调顺，只得放弃。同样的理由，局面记录也进行了复制，但是我发现只进行浅复制就不会报错，也就没有深究。估值核心我使用了指针，因为估值核心的实例化发生在搜索核心的构造函数中。此外还有当前搜索深度变量、最大搜索深度变量、最佳走法、评估结点数即搜索树的叶结点树和搜索时间。<br>&nbsp;&nbsp;&nbsp; 搜索核心通用接口定义的方法不多，构造函数中只实例化了评估核心，析构函数负责销毁评估核心，此外只有一个搜索函数和一个获得最佳走法的只读方法。</p>\n<h3 id=\"3-4-2-MTD-f\"><a href=\"#3-4-2-MTD-f\" class=\"headerlink\" title=\"3.4.2 MTD(f)\"></a>3.4.2 MTD(f)</h3><p>&nbsp;&nbsp;&nbsp; 搜索核心的一个实现是MTD(f)算法。MTD(f)的最外层是一个迭代深化的过程，具体说就是由浅到深的尝试搜索同时计时，一旦超过设定的搜索时间阈值就停止搜索。当搜索过程复杂（搜索树剪枝少）实际搜索深度可能无法很深，当搜索过程简单，实际搜索深度则只受玩家设定的最大搜索深度的影响。<br>&nbsp;&nbsp;&nbsp; 迭代深化的下一层是MTD(f)的思想核心，在一个无限大的窗口中，在一个有依据的猜测值附近反复进行类似PVS的空窗探测，并不断向真实的最大局面评估值调整猜测值和窗口，直到窗口上下限闭合。</p>\n<pre><code class=\"hljs\">int MTD_f::mtdf(int firstGuess)\n&#123;\n\t/* MTD(f)窗口上下限 */\n\tint windowTop = WIN;\n\tint windowDown = -WIN;\n\t/* 空窗探测评估值，调整MTD(f)窗口的依据 */\n\tint g = firstGuess;\n\t/* alphaBeta算法的窗口上限 */\n\tint beta;\n\t/* 不断执行空窗探测直到窗口闭合，有hash置换表不怕重复搜索 */\n\twhile(windowDown &lt; windowTop)\n\t&#123;\n\t\t/* 刚调整过窗口下限，更需要通过向上偏移的空窗探测调整窗口上限 */\n\t\tif (g == windowDown)\n\t\t&#123;\n\t\t\t/* 在[g, g+1]区间上进行空窗探测 */\n\t\t\t/* alpha = g */\n\t\t\tbeta = g + 1;\n\t\t&#125;\n\t\t/* 刚调整过窗口上限，更需要通过向下偏移的空窗探测调整窗口下限 */\n\t\telse\n\t\t&#123;\n\t\t\t/* 在[g-1, g]区间上进行空窗探测 */\n\t\t\t/* alpha = g - 1 */\n\t\t\tbeta = g;\n\t\t&#125;\n\t\t/* 利用Fail-Soft AlphaBeta算法做空窗探测 */\n\t\t/* alpha = beta - 1 */\n\t\tg = TTFAlphaBeta(beta - 1, beta, 0);\n\t\t/* 根据新评估值做窗口调整 */\n\t\t/* 新评估值小于空窗口，可以认为猜高了，实际评估值应该更低 */\n\t\tif (g &lt; beta)\n\t\t&#123;\n\t\t\t/* 根据新评估值下调MTD(f)窗口上限 */\n\t\t\twindowTop = g;\n\t\t&#125;\n\t\t/* 新评估值不小于空窗口，可以认为猜低了，实际评估值应该更高 */\n\t\telse\n\t\t&#123;\n\t\t\t/* 根据新评估值上调MTD(f)窗口下限 */\n\t\t\twindowDown = g;\n\t\t&#125;\n\t&#125;\n\treturn g;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 再下一层是一个hash置换表优化的Fail-Soft-AlphaBeta算法，事实上，这个AlphaBeta的窗口大小是０，所以在我看来，MTD(f)的最下层更像一个PVS。</p>\n<h3 id=\"3-4-3-AlphaBeta\"><a href=\"#3-4-3-AlphaBeta\" class=\"headerlink\" title=\"3.4.3 AlphaBeta\"></a>3.4.3 AlphaBeta</h3><p>&nbsp;&nbsp;&nbsp; 搜索核心的另一个实现是AlphaBeta算法，实际上我只是把MTD(f)最下层的PVS拿出来，去掉置换表，把初始窗口定为无限大而已。这从算法实现方式的侧面印证了Maxmin系算法师出同门的事实。</p>\n<h2 id=\"3-5-局面评估核心\"><a href=\"#3-5-局面评估核心\" class=\"headerlink\" title=\"3.5 局面评估核心\"></a>3.5 局面评估核心</h2><p>&nbsp;&nbsp;&nbsp; 现在使用的评估方法是统计局面上棋子的自由度、受威胁程度、棋子基本价值、棋盘位置加成、棋子受保护加成，并进行简单累加。使用了很多常数作为评估依据：</p>\n<pre><code class=\"hljs\">#ifndef _EVALUATOR_H_\n#define _EVALUATOR_H_\n\n#include &quot;State.h&quot;\n#include &quot;Move.h&quot;\n#include &lt;vector&gt;\n\n/* 估值器，提供对每一个局面状态的下特定走法的评分 */\n/* 使用先验知识和一些局面评估因素为局面估值 */\nclass Evaluator\n&#123;\npublic:\n\t/* 评估结点计数 */\n\tunsigned cnt;\n\t/* 估值器构造函数，初始化估值器 */\n\tEvaluator();\n\t/* 估值函数，对给定的局面状态评分 */\n\tint evaluate(State &amp;state);\nprivate:\n\t/* 炮的一些重要坐标的加成 */\n\tconst int ADD_R_CANNON[10][9] =\n\t&#123;\n\t\t&#123;50,\t50,\t0,\t0,\t0,\t0,\t0,\t50,\t50&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t10,\t0,\t10,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t10,\t0,\t0,\t0,\t0,\t0,\t10,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;10,\t0,\t0,\t10,\t50,\t10,\t0,\t0,\t10&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;\n\t&#125;;\n\tconst int ADD_B_CANNON[10][9] =\n\t&#123;\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;10,\t0,\t0,\t10,\t50,\t10,\t0,\t0,\t10&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t10,\t0,\t0,\t0,\t0,\t0,\t10,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t10,\t0,\t10,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;50,\t50,\t0,\t0,\t0,\t0,\t0,\t50,\t50&#125;\n\t&#125;;\n\t/* 马的一些重要坐标的加成 */\n\tconst int ADD_R_KNIGHT[10][9] =\n\t&#123;\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t100,\t0,\t0,\t0,\t100,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t100,\t0,\t100,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t10,\t0,\t0,\t0,\t10,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t10,\t0,\t0,\t0,\t10,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t-100,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;\n\t&#125;;\n\tconst int ADD_B_KNIGHT[10][9] =\n\t&#123;\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t-100,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t10,\t0,\t0,\t0,\t10,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t10,\t0,\t0,\t0,\t10,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t100,\t0,\t100,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t100,\t0,\t0,\t0,\t100,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;\n\t&#125;;\n\t/* 兵的一些重要坐标的加成 */\n\tconst int ADD_R_PAWN[10][9] =\n\t&#123;\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;90,\t90,\t110,\t120,\t120,\t120,\t110,\t90,\t90&#125;,\n\t\t&#123;90,\t90,\t110,\t120,\t120,\t120,\t110,\t90,\t90&#125;,\n\t\t&#123;70,\t90,\t110,\t120,\t120,\t120,\t110,\t90,\t70&#125;,\n\t\t&#123;70,\t70,\t70,\t70,\t70,\t70,\t70,\t70,\t70&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;\n\t&#125;;\n\tconst int ADD_B_PAWN[10][9] =\n\t&#123;\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;,\n\t\t&#123;70,\t70,\t70,\t70,\t70,\t70,\t70,\t70,\t70&#125;,\n\t\t&#123;70,\t90,\t110,\t120,\t120,\t120,\t110,\t90,\t70&#125;,\n\t\t&#123;90,\t90,\t110,\t120,\t120,\t120,\t110,\t90,\t90&#125;,\n\t\t&#123;90,\t90,\t110,\t120,\t120,\t120,\t110,\t90,\t90&#125;,\n\t\t&#123;0,\t0,\t0,\t0,\t0,\t0,\t0,\t0,\t0&#125;\n\t&#125;;\n\t/* 先验的定义每种棋子的基本价值 */\n\tconst int BASE_VAL[32] =\n\t&#123;\n\t\t10000, 250, 250, 250, 250, 350, 350, 500, 500, 350, 350, 100, 100, 100, 100, 100,\n\t\t10000, 250, 250, 250, 250, 350, 350, 500, 500, 350, 350, 100, 100, 100, 100, 100\n\t&#125;;\n\t/* 棋子灵活度单位价值，即每个可走位置对总自由度的贡献 */\n\tconst int FREE_UNIT[32] =\n\t&#123;\n\t\t0, 1, 1, 1, 1, 12, 12, 6, 6, 6, 6, 15, 15, 15, 15, 15,\n\t\t0, 1, 1, 1, 1, 12, 12, 6, 6, 6, 6, 15, 15, 15, 15, 15\n\t&#125;;\n\t/* 棋子被威胁造成的负分 */\n\tbool threatenScore[32];\n\t/* 棋子被保护造成的加分 */\n\tbool protectScore[32];\n\t/* 棋子评分 */\n\tint chessScore[32];\n\t/* 根据特定的局面状态和当前行动权归属生成所有可能的势力覆盖方式并填充走法容器 */\n\tvoid generate(const State &amp;state);\n\t/* 棋子势力覆盖方式容器 */\n\tstd::vector&lt;Move&gt; coverList;\n&#125;;\n\n#endif\n</code></pre>\n<h1 id=\"4-手工测试\"><a href=\"#4-手工测试\" class=\"headerlink\" title=\"4 手工测试\"></a>4 手工测试</h1><p>&nbsp;&nbsp;&nbsp; 搜索深度为１时，分别使用AlphaBeta算法和MTD(f)算法作为搜索核心，评估结点数和搜索时间并没有明显的不同。两种算法下电脑的走法都很蠢。<br>&nbsp;&nbsp;&nbsp; 搜索深度为２时，使用AlphaBeta算法，绝大多数情况下评估结点数稳定在400<del>700区间内，搜索时间最多达到10^-2秒数量级；使用MTD(f)算法，绝大多数情况下评估结点数稳定在600</del>1000区间内，搜索时间稳定在0.03秒左右。<br>&nbsp;&nbsp;&nbsp; 搜索深度为３时，使用AlphaBeta算法，绝大多数情况下评估结点数稳定在10000附近，搜索时间平均在10^-2秒数量级；使用MTD(f)算法，评估结点数平均在10^3数量级上,偶尔上万，搜索时间平均在10^-2秒数量级，偶尔还会非常小。<br>&nbsp;&nbsp;&nbsp; 搜索深度为４时，使用AlphaBeta算法，评估结点数在10^5数量级上，搜索时间平均在1秒数量级，电脑的走法看起似乎比搜索３层要蠢；使用MTD(f)算法，评估结点数很少再达到10^4数量级以上，搜索时间稳定在1秒数量级，走法也有点蠢。<br>&nbsp;&nbsp;&nbsp; 搜索深度为５时，使用AlphaBeta算法，评估结点数在10^6数量级上，搜索时间平均在８秒，电脑表现比较出色，开始出现游戏崩溃的现象；使用MTD(f)算法，可能是受迭代深化的限制作用影响，评估结点数和搜索时间与搜索深度为４时很接近，但是电脑的走法比４层时更出色，会出现游戏崩溃的现象。<br>&nbsp;&nbsp;&nbsp; 搜索深度为６时，使用AlphaBeta算法，评估结点数达到了10^7数量级，搜索时间也增加到10^2秒数量级，电脑走法却不如５层时优秀，有游戏崩溃现象；使用MTD(f)算法，可能是受迭代深化的限制作用影响，评估结点数和搜索时间与搜索深度为４时很接近，电脑的走法没有比５层明显更优秀，有游戏崩溃的现象。<br>&nbsp;&nbsp;&nbsp; 更深层的搜索时AlphaBeta算法的搜索时间将长到无法忍受，游戏崩溃的现象也将更早出现。<br>&nbsp;&nbsp;&nbsp; 观察表明，使用偶数作为搜索深度时，电脑的走法性能会相对浅一层的奇数层搜索结果有一定的衰减，迭代深化时的层数步进也许设置为２更好。</p>\n<h1 id=\"5-结论与收获\"><a href=\"#5-结论与收获\" class=\"headerlink\" title=\"5 结论与收获\"></a>5 结论与收获</h1><p>&nbsp;&nbsp;&nbsp; 过去谈及棋牌游戏的人机博弈我都只能表示佩服，满怀憧憬的感叹一下，表示做起来可能很麻烦。真的动手做过一个粗糙的练习之后才发现，用的无非还是那些简单算法的扩展或变种，简单说起来也不过是有限搜索树而已。不过种种精细的剪枝与优化还是很磨练人的心性的，当然我还没磨练到位，毕竟初版的优化我都没做彻底就来写博文了。</p>\n<h1 id=\"6-不足与展望\"><a href=\"#6-不足与展望\" class=\"headerlink\" title=\"6 不足与展望\"></a>6 不足与展望</h1><p>&nbsp;&nbsp;&nbsp; 不足：</p>\n<ul>\n<li>当前版本的两个搜索核心都是盲目搜索，即搜索中容易导致剪枝或棋局结束的结点没有优先搜索。</li>\n<li>局面评估核心应该重构，提供一个通用接口，为神经网络优化或其他技术优化的评估核心做准备。</li>\n<li>搜索树的展开过程中仍然存在动态申请内存空间的动作，当搜索深度到达４，偶尔会出现内存申请失败，游戏崩溃的情况，可以尽量静态的一次性的申请内存。</li>\n<li>没有足够优秀的查表优化。</li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 展望：</p>\n<ul>\n<li>通用部件的数据结构还可以进一步细化优化。</li>\n<li>走法生成器和评估核心的工具函数——棋子影响力覆盖范围生成器都有并行化的优化空间。</li>\n<li>局面评估核心还可以有更优秀的，基于机器学习的优化。</li>\n<li>还可以建立适当规模的开局库、残局库。</li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 最后，挂<a href=\"https://github.com/bipedalBit/BipedalBit-Chinese-Chess\">Git项目地址</a>。<br>&nbsp;&nbsp;&nbsp; 因为偶尔偷懒，项目代码规范化有些参差不齐，有好的建议欢迎讨论。</p>\n",
            "tags": [
                "Qt",
                "C++",
                "人机博弈",
                "AlphaBeta",
                "MTD(f)"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/11/14/%E4%BA%BA%E6%9C%BA%E5%8D%9A%E5%BC%88%E5%88%9D%E6%8E%A2/",
            "url": "https://blog.bipedalbit.net/2015/11/14/%E4%BA%BA%E6%9C%BA%E5%8D%9A%E5%BC%88%E5%88%9D%E6%8E%A2/",
            "title": "人机博弈初探",
            "date_published": "2015-11-14T14:27:47.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 组里布置任务，要编个中国象棋人机博弈程序练练手，写这篇文时游戏初版已经完成了。开工前导师给了些相关资料，我自己又稍微做了些调查，这篇文就先来对人机博弈，尤其是棋牌游戏的人机博弈思路做一些概念上的科普铺垫。做好了概念铺垫，下一篇再挑重点简单讲解下我的中国象棋游戏实现情况。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 其实人工智能课的大作业也是要写个概念总结，我干脆把那篇改改贴上来。</p>\n<h1 id=\"1-博弈树搜索算法\"><a href=\"#1-博弈树搜索算法\" class=\"headerlink\" title=\"1 博弈树搜索算法\"></a>1 博弈树搜索算法</h1><p>&nbsp;&nbsp;&nbsp; 人机博弈的过程实质上是对博弈树——一种状态树的搜索，是一种博弈论中的重复博弈过程。博弈树与状态树的不同之处在于，对每一层搜索来说，目标状态会有区别，如果第奇数层搜索的目标是寻找对电脑来说最好的搜索状态，那么第偶数层的搜索中，目标状态则应该是人类行动可能导致的新状态。这种搜索算法不能单纯等同于图论中对状态树的深度或广度优先搜索算法，但是与传统的状态树搜索算法有莫大的渊源。</p>\n<h2 id=\"1-1-极大极小值算法（Minmax-Algorithm）\"><a href=\"#1-1-极大极小值算法（Minmax-Algorithm）\" class=\"headerlink\" title=\"1.1 极大极小值算法（Minmax Algorithm）\"></a>1.1 极大极小值算法（Minmax Algorithm）</h2><p>&nbsp;&nbsp;&nbsp; 极大极小值算法是一系列改进的博弈树搜索算法的最原始的基础。它的基本思想是，在每层搜索前评估状态结点，在博弈树首层搜索一个评估值最大的状态结点作为电脑选择的最优行动方式，那么下一层就搜索评估值最小的状态结点来模拟人类对手的行动。重复这一博弈过程的博弈树搜索算法就称为极大极小值算法。<br>&nbsp;&nbsp;&nbsp; 在棋类游戏中，人机博弈搜索算法通常是基于深度优先搜索的。因为如果使用广度优先算法来遍历博弈树，内存中的状态结点将迅速变多，马上耗尽所有可用的内存空间。而深度优先搜索的过程中，向搜索树根结点回溯时会释放原本占用的栈空间。这使得搜索算法的内存开销只与搜索深度线性相关。</p>\n<h2 id=\"1-2-负极大值算法（Negamax-Algorithm）\"><a href=\"#1-2-负极大值算法（Negamax-Algorithm）\" class=\"headerlink\" title=\"1.2 负极大值算法（Negamax Algorithm）\"></a>1.2 负极大值算法（Negamax Algorithm）</h2><p>&nbsp;&nbsp;&nbsp; 负极大值算法是对极大极小值算法的简单改进。当准备模拟人类行动，不去找评估值最小的状态结点，而是依旧寻找评估值最大的状态结点，只是在向搜索树上一层反馈搜索结果（最大评估值）时，进行一次正负翻转。这样一来可以通过引入带符号的状态评估值，简化最大最小值算法的形式。实际上，这种优化算法与最大最小值算法相比并没有效率上的不同。</p>\n<h2 id=\"1-3-Alpha-Beta搜索\"><a href=\"#1-3-Alpha-Beta搜索\" class=\"headerlink\" title=\"1.3 Alpha-Beta搜索\"></a>1.3 Alpha-Beta搜索</h2><p>&nbsp;&nbsp;&nbsp; 搜索算法中最常见的优化手段就是对搜索树的剪枝，Alpha-Beta搜索算法就是一种剪枝优化的最大最小值算法。在朴素的极大极小值搜索算法中，每一层对最大最小值的搜索都是盲目而不加限制的。如果子状态结点的搜索返回值可以被利用起来，用来截断后续搜索过程，就可以实现搜索树的剪枝了。负极大值形式的Alpha-Beta搜索算法中只有Beta剪枝这一种剪枝（通过评估值的正负翻转将Alpha剪枝也并入了Beta剪枝）。<br>&nbsp;&nbsp;&nbsp; 具体来说是事先提供一个无限大的搜索窗口，搜索过程中每反馈一个状态评估值，更新最大评估值记录，并使用-Beta和这个还不大于Beta的最大评估值的翻转值-Alpha分别作为子状态结点的搜索窗口下限和上限。当这个记录值增长到不小于当前搜索状态的搜索窗口上限，也就是Beta值时，判定搜索树已生长至叶结点，立即进行Beta剪枝，终止搜索，返回这个最大值，以供上层状态结点调整搜索窗口。<br>&nbsp;&nbsp;&nbsp; 自1928年极大极小值算法诞生以来，出现了各种改进算法，而当前最优秀的博弈树搜索算法，绝大多数都以Alpha-Beta算法为基础。可以说，Alpha-Beta算法是现代博弈树搜索算法的基础技术，也是之后各种优化算法最合适的入门铺垫。</p>\n<h2 id=\"1-4-Fail-Soft-Alpha-Beta搜索\"><a href=\"#1-4-Fail-Soft-Alpha-Beta搜索\" class=\"headerlink\" title=\"1.4 Fail-Soft Alpha-Beta搜索\"></a>1.4 Fail-Soft Alpha-Beta搜索</h2><p>&nbsp;&nbsp;&nbsp; 从算法的名字不难看出，Fail-Soft Alpha-Beta算法是对Alpha-Beta算法的优化。操作系统中，内存调度范畴最意义重大的技术可以说就是缓存。缓存的核心思想——数据访问的空间局部性，也可以引申到博弈树搜索技术中来。<br>&nbsp;&nbsp;&nbsp; 之前提到的Alpha-Beta算法中的搜索窗口一开始是无限大的。其实在大部分情况下，这个初始窗口可以更小一些，当然一旦缩小的初始窗口，就存在评估值落在窗口外的危险。那么万一评估值落在窗口外（上方或下方），就只有加入一个无限大或无限小的窗口上／下限，再重新搜索了。</p>\n<h2 id=\"1-5-渴望搜索（Aspiration-Search）\"><a href=\"#1-5-渴望搜索（Aspiration-Search）\" class=\"headerlink\" title=\"1.5 渴望搜索（Aspiration Search）\"></a>1.5 渴望搜索（Aspiration Search）</h2><p>&nbsp;&nbsp;&nbsp; 鉴于搜索窗口是一个十分优秀的剪枝思路，渴望搜索同样是对搜索窗口的优化。Fail-Soft Alpha-Beta搜索中初始窗口的定义还带有盲目性，而渴望搜索正是针对这一点的优化。实际上，渴望搜索的初始搜索窗口是以一个特定值为中心，以另一个特定值为半径（正负方向偏差值）来定义的。这样一来，这个搜索窗口的中心就显得尤为重要。通常选用上一次搜索的最终状态评估值作为窗口中心是比较有效的，因为相邻的两次最优行动方式通常非常接近。</p>\n<h2 id=\"1-6-极小窗口搜索（Minimal-Window-Search-PVS）\"><a href=\"#1-6-极小窗口搜索（Minimal-Window-Search-PVS）\" class=\"headerlink\" title=\"1.6 极小窗口搜索（Minimal Window Search&#x2F;PVS）\"></a>1.6 极小窗口搜索（Minimal Window Search&#x2F;PVS）</h2><p>&nbsp;&nbsp;&nbsp; 前面提到过，相邻的两次最优行动方式通常非常接近。PVS正是利用这一事实很极端的将渴望搜索的搜索窗口进一步缩小到了以1为尺寸。更小的初始窗口将印发更多的剪枝，而统计数据证明，大多数情况下PVS的搜索效率确实比渴望搜索更高。</p>\n<h2 id=\"1-7-置换表优化的搜索算法\"><a href=\"#1-7-置换表优化的搜索算法\" class=\"headerlink\" title=\"1.7 置换表优化的搜索算法\"></a>1.7 置换表优化的搜索算法</h2><p>&nbsp;&nbsp;&nbsp; 状态搜索过程中，有时会遇到曾经搜索过的状态，这时如果重新搜索显然是不划算的。如果把搜索过的状态都结构化的记录下来，就可以在一些特定情况下提前截断搜索过程。这就是置换表的思路。要对搜索算法进行置换表的优化，置换表就必须提供足够快的查表速度，最快的查找技术无非就是哈希查找了。这就组成了一个用置换表优化搜索算法的完整解决方案。</p>\n<h2 id=\"1-8-迭代深化的搜索算法\"><a href=\"#1-8-迭代深化的搜索算法\" class=\"headerlink\" title=\"1.8 迭代深化的搜索算法\"></a>1.8 迭代深化的搜索算法</h2><p>&nbsp;&nbsp;&nbsp; 实际人类博弈场景中，博弈的外部限制条件往往与思考的深度无关，而与思考的时间有关。那么在搜索博弈树的过程中，可以迭代的逐步加深搜索深度，直到搜索时间超过阈值。显然这种优化将导致搜索深度不稳定，也使得搜索性能的稳定性不能得到保证。但在模拟人类博弈行为的场景下，迭代深化优化的搜索算法能使机器的行为更接近人类。</p>\n<h2 id=\"1-9-启发式搜索策略\"><a href=\"#1-9-启发式搜索策略\" class=\"headerlink\" title=\"1.9 启发式搜索策略\"></a>1.9 启发式搜索策略</h2><p>&nbsp;&nbsp;&nbsp; 盲目搜索策略是被动的，不管如何调整搜索窗口，总是难以避免一些冗余的搜索项。如果在搜索时增加一些启发因素，将有利搜索快速完成的子状态的搜索过程提前，也许可以提前剪枝或提前结束搜索。如果获取启发因素的场景发生在比较靠前的搜索过程中，这就是历史启发的搜索优化思路。</p>\n<h2 id=\"1-10-MTD-f-搜索\"><a href=\"#1-10-MTD-f-搜索\" class=\"headerlink\" title=\"1.10 MTD(f)搜索\"></a>1.10 MTD(f)搜索</h2><p>&nbsp;&nbsp;&nbsp; MTD(f)搜索的全称是Memory-enhanced Test Driver with node n and value f，大意是记忆（置换表）优化、测试（空窗探测）驱动的搜索算法。MTD(f)算法将PVS的极小窗口干脆改成了空窗口，即单个猜测值就是一个窗口。只进行一些浅层的搜索后，就可以得到一个真实的极大评估值。这个评估值一定会落在猜测值的一侧，那么就可以利用这一点来不断进行猜测（空窗探测）并调整猜测值的取值范围，直到猜测值的范围闭合，即是得到了最终评估值。有不少实践者称MTD(f)算法在国际象棋、西洋跳棋等人机博弈应用场景中比PVS更优秀。</p>\n<h2 id=\"1-11-疑惑与思考\"><a href=\"#1-11-疑惑与思考\" class=\"headerlink\" title=\"1.11 疑惑与思考\"></a>1.11 疑惑与思考</h2><p>&nbsp;&nbsp;&nbsp; 相信有的读者已经发觉，上述搜索算法只在叶结点做局面评估恐怕不太妥当。其实我也是这么认为的。<br>&nbsp;&nbsp;&nbsp; 上述搜索算法都建立在Maxmin算法中一个大前提的基础上：不论对手还是自己，下棋的人会尝试让棋局在若干步内到达这若干步内可能的最好的一个局面。<br>&nbsp;&nbsp;&nbsp; 事实上，下棋时，我们在选择下一步时，并不是总是想要逼近某个特定的局面，除非这个局面是一个抛给对手的陷阱。<br>&nbsp;&nbsp;&nbsp; 在象棋、国际象棋这类棋子数单调减少，局面复杂程度变化小的棋类游戏中确实大部分局面中玩家都在不断互相抛出吃子陷阱。但是在局面复杂程度逐渐增加的棋类游戏如五子棋和围棋的中，我们在大部分局面中思考的往往是更模糊的趋势问题，或者说概率问题。我们需要在海量的局面演变路径中归结出当前走法应该将局面引向的最好的方向而不是某一条具体路径，同时依旧需要立即规避致命的陷阱。各个因素对结论的影响的归结，这显然应该是一个关于结论修正和因素采纳权重的问题。<br>&nbsp;&nbsp;&nbsp; 在中国象棋、国际象棋中，Minmax的下棋思路应该在大部分情况下是合理而恰当的。然而在五子棋的部分局面中，和围棋的更多局面中，Minmax算法的思路前提根本就是不合理的。也就是说，不是基于Minmax的算法的性能不足以胜任围棋的搜索算法，而是Minmax应用在围棋走法搜索中时会犯很多方向性错误，这些错误的积累造成的不良影响已经大到不能被接受了。<br>&nbsp;&nbsp;&nbsp; 下面我们将引入的MC-UCT算法，中文描述的算法名称是“树图置信”，“置信”这个概念跟我前面提到的因素归结、因素权重问题不谋而合。<br>&nbsp;&nbsp;&nbsp; 我们对“置信”方法的需求的来源，是局面复杂程度不稳定的情况下局面走向的不明朗和难以把控。<br>&nbsp;&nbsp;&nbsp; 相反，我们对Minmax思路的需求的前提，是局面明朗的情况下，我们很清楚该把局面引向哪些特定的状态。<br>&nbsp;&nbsp;&nbsp; 以上思考引发的我的另一个思考是，围棋这种实际问题中，棋盘大小仍然是有限的，也就是说，局面的复杂度终究会稳定在一个区间中。那么当局面稳定下来，我们对正确的“局面变化趋势的引导”的需求就降低了很多。因为我们改变局面变化趋势的发挥空间已经太小，这时问题的性质发生了改变，事实上，这时已经进入了围棋的“收官”阶段。一个局面稳定的围棋残局的处理，已经十分类似象棋类的棋类游戏，甚至比象棋更简单，更好处理。这种情况下放弃UCT，转而使用Minmax的算法思路反而是更恰当的。</p>\n<h2 id=\"1-12-UCT算法\"><a href=\"#1-12-UCT算法\" class=\"headerlink\" title=\"1.12 UCT算法\"></a>1.12 UCT算法</h2><p>&nbsp;&nbsp;&nbsp; 下面我们来看下UCT的算法执行过程：</p>\n<ul>\n<li>(1) 从博弈树的根点开始向下搜索，执行(2)。</li>\n<li>(2) 遇到结点a后，若a存在从未评估过的子结点，执行(3)，否则执行(4)。</li>\n<li>(3) 通过蒙特卡罗方法（这里先按下不表，后面会介绍，但这种评估方法是“置信”的来源）评估该子结点，得到收益值后更新该子结点至根结点路径上所有结点的平均收益值，执行(1)。</li>\n<li>(4) 计算每个子结点的UCB值（通过特殊结论将从蒙特卡罗方法中获得的收益值转换为新一轮搜索的置信基础值），将UCB值最高的子结点作为结点a，执行(2)。</li>\n<li>(5) 算法可随时终止，通常达到给定时间或尝试次数后终止。<br>&nbsp;&nbsp;&nbsp; UCT算法最让人欣赏的两点是使用置信的蒙特卡罗评估，以及评估值的回溯更新。</li>\n</ul>\n<h1 id=\"2-评估函数\"><a href=\"#2-评估函数\" class=\"headerlink\" title=\"2 评估函数\"></a>2 评估函数</h1><h2 id=\"2-1-传统评估函数的优化\"><a href=\"#2-1-传统评估函数的优化\" class=\"headerlink\" title=\"2.1 传统评估函数的优化\"></a>2.1 传统评估函数的优化</h2><p>&nbsp;&nbsp;&nbsp; 在搜索博弈树子状态的过程中，需要对位于博弈树叶结点位置的子状态给出评估值。传统的，可以从已有知识、经验中挖掘出状态评估因素。为各因素加上先验的权值后就可以为博弈树的子状态提供一个评估值。然而这种评估模式还有很大的优化空间。尤其是在调整估值因素的权重方面。</p>\n<h3 id=\"2-1-1-爬山法\"><a href=\"#2-1-1-爬山法\" class=\"headerlink\" title=\"2.1.1 爬山法\"></a>2.1.1 爬山法</h3><p>&nbsp;&nbsp;&nbsp; 猜测一个较好的初始权重后，逐步微调权重，直到评估效果达到一个极大值，这就是爬山法。显然爬山法非常依赖一个优秀的初始猜测权重，而且寻找最优权重的过程会很缓慢。</p>\n<h3 id=\"2-1-2-蒙特卡罗方法\"><a href=\"#2-1-2-蒙特卡罗方法\" class=\"headerlink\" title=\"2.1.2 蒙特卡罗方法\"></a>2.1.2 蒙特卡罗方法</h3><p>&nbsp;&nbsp;&nbsp; 既然初始权重或寻找起点是爬山法的短板，那么就进行足够多次的爬山法，使爬山法的起点覆盖足够多的情况，最后汇总寻找结果。这就是蒙特卡罗方法的基本思路。</p>\n<h3 id=\"2-1-3-模拟退火算法\"><a href=\"#2-1-3-模拟退火算法\" class=\"headerlink\" title=\"2.1.3 模拟退火算法\"></a>2.1.3 模拟退火算法</h3><p>&nbsp;&nbsp;&nbsp; 模拟退火算法是对蒙特卡罗方法的改进，它使用MetroPolis重要性采样的基本思想，在寻优的开始使用较高的概率进行随机突跳,随着寻优过程的深入逐步降低这一接受不佳参数概率。并且随着搜索的深入,可接受的参数的不佳程度也越来越小。通过这样一个由粗到细的过程逐渐逼近最优的参数。由于此算法要求对参数的改变概率逐渐下降及对各种参数值进行充分多次的采样,在实际使用中也比爬山法的速度要慢,但比蒙特卡罗方法要快。</p>\n<h3 id=\"2-1-4-遗传算法\"><a href=\"#2-1-4-遗传算法\" class=\"headerlink\" title=\"2.1.4 遗传算法\"></a>2.1.4 遗传算法</h3><p>&nbsp;&nbsp;&nbsp; 顾名思义，遗传算法将各个评估因素的权重作为”遗传基因”，在有限大小的变异程度下，尝试并继承更优秀的权重组合。通过模拟进化过程寻找最优权重。</p>\n<h3 id=\"2-1-5-人工神经网络\"><a href=\"#2-1-5-人工神经网络\" class=\"headerlink\" title=\"2.1.5 人工神经网络\"></a>2.1.5 人工神经网络</h3><p>&nbsp;&nbsp;&nbsp; BP神经网络模拟了神经系统中神经元的刺激积累和交互网状影响的作用，训练一套合理的神经元间连接的信息采样权重。这与获得最优权重的目的不谋而合。或许为了提高训练性能，还可以用上CNN（卷积神经网络）、BDN（置信深度网络）这样的深度学习神经网络。</p>\n<h2 id=\"2-2-蒙特卡罗方法的评估算法\"><a href=\"#2-2-蒙特卡罗方法的评估算法\" class=\"headerlink\" title=\"2.2 蒙特卡罗方法的评估算法\"></a>2.2 蒙特卡罗方法的评估算法</h2><p>&nbsp;&nbsp;&nbsp; 计算机围棋博弈问题的一大难点在于难以设计简单有效的局面评估算法。传统的围棋程序主要采用影响函数等专家知识进行局面评估，由于围棋的专家知识难以抽象出来（如厚味，薄味，气合等词），往往评估得不准。那么精确评估似乎只有穷举了。如果黑白双方的接下来每手棋都“正确”，最后黑棋赢了，那么当时的局面一定是黑棋优势。可惜如果没有量子计算机，这种穷举是无法达成的。<br>&nbsp;&nbsp;&nbsp; 再假设，如果黑白双方棋力不高却相当，来续下这个局面，最后是黑棋赢了，当时的局面是谁优势呢？你大概会说，黑棋优势的可能性更大一些。进一步，同样的局面续下了1000次，有800次是黑棋赢了，那么有理由基本相信，当前局面中黑棋占优。<br>&nbsp;&nbsp;&nbsp; 那么，如果黑棋和白棋都不会围棋，只会随机落子呢？他们针对这一局面续下了1000次，竟然有800次是黑棋赢了。这时我们也可以断言，当前局面确实黑棋占优。<br>&nbsp;&nbsp;&nbsp; 这就是蒙特卡罗局面评估算法，简单点说，就是用大量迭代的随机的深度优先搜索来代替先验知识对局面做出评估。当然大量彼此没有同步约束的随机迭代过程就很适合且只适合通过并行方式甚至分布式集群计算来解决了。</p>\n",
            "tags": [
                "人机博弈",
                "Maxmin",
                "AlphaBeta",
                "PVS",
                "MTD(f)"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/10/19/%E8%A7%A3%E5%86%B3%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98%E7%9A%84%E5%88%A9%E5%99%A8%E2%80%94%E2%80%94apt-file/",
            "url": "https://blog.bipedalbit.net/2015/10/19/%E8%A7%A3%E5%86%B3%E4%BE%9D%E8%B5%96%E9%97%AE%E9%A2%98%E7%9A%84%E5%88%A9%E5%99%A8%E2%80%94%E2%80%94apt-file/",
            "title": "解决依赖问题的利器——apt-file",
            "date_published": "2015-10-19T10:33:33.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 学校的有线网络客户端是DrCom，Windows下停掉热点分享服务和代理后跑的很顺利。可是切到我常用的Ubuntu下时客户端却跑不起来。从终端用命令运行客户端时发现有依赖文件缺失，借着这个契机，我认识了Ubuntu（Debian）下解决依赖问题的利器——apt-file。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 事情的始末是这样的，当时报的文件缺失是libXi.so.6，发现文件缺失后我先在整个计算机范围内查找了这个文件，在<code>/usr/lib/x86_64-linux-gnu</code>目录下发现了一个，当时很不解，明明不缺依赖文件啊。<br>&nbsp;&nbsp;&nbsp; 后来我百度了一下大家遇到同类情况的解决方案，发现原来缺的是32位的libXi.so.6，刚才的目录下显然是64位的gnu文件。然后我发现大家开始用各种方式安装32位的兼容库，如ia32-libs，这个库还被Ubuntu抛弃好几年了，得换以前的源装之类的。也有人建议利用增加32位的架构来支持依赖32位库的软件。且不论有多么拐弯抹角有多麻烦，前面这些解决方案在我的Ubuntu Kylin 14.04 LTS下都没有见效。<br>&nbsp;&nbsp;&nbsp; 这时灰头土脸漫不经心在网上闲逛的我看见了一篇<a href=\"http://blog.163.com/shishihoule@126/blog/static/57293547201442683951681/\">惊艳的博文</a>。让我激动的是博主<strong>发现依赖缺失-&gt;利用apt-file找到依赖文件-&gt;逐个补全依赖文件-&gt;解决问题</strong>这一直截了当的过程的畅快感。感谢博主，感谢博主感谢的博主。<br>&nbsp;&nbsp;&nbsp; 在利用apt-file解决问题前我们需要做一点知识储备。<br>&nbsp;&nbsp;&nbsp; 首先我们需要了解，Linux下有一个检查可执行文档依赖项的命令：<a href=\"http://man7.org/linux/man-pages/man1/ldd.1.html\">ldd</a>。<br>&nbsp;&nbsp;&nbsp; 然后我们需要了解，Ubuntu下用apt-get来install文件时可以通过类似<code>sudo apt-get install libxi:i386</code>的格式来指定文件使用的架构，i386就是指32位架构。<br>&nbsp;&nbsp;&nbsp; 我们还可以借助Ubuntu的<code>sudo -i</code>命令让终端留在root权限下，免得我们在逐个安装依赖文件时总要在命令前加”sudo“。<br>&nbsp;&nbsp;&nbsp; 最后是apt-file的安装和使用：</p>\n<ul>\n<li>Ubuntu（Debian）系统中默认没有apt-file工具，安装和许多其他工具一样，<code>sudo apt-get install apt-file</code>就好。</li>\n<li>安装成功后还不能直接使用，<code>apt-file update</code>命令会更新软件缓存库，有了库才能搜索文件。第一次使用或<code>apt-get update</code>后都需运行一次该命令。</li>\n<li><code>apt-file search file_name</code>可以查找（含有目标字符串的）目标文件存在于哪些软件包中。直接search可能返回太多内容，可以利用Linux的grep命令获得返回内容中字符串完整匹配的部分，如<code>apt-file search filename | grep -w filename</code>，或者获得特定路径下的文件，如<code>apt-file search filename | grep /bin/</code>。</li>\n<li><code>apt-file list package_name</code>可以罗列目标软件包包含的文件。</li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 于是可以动手解决问题了：</p>\n<pre><code class=\"hljs\">sudo -i\napt-get install apt-file\napt-file update\nldd DrClientLinux\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 缺的也不多，找到那几个“not found”的依赖文件，然后继续。</p>\n<pre><code class=\"hljs\">apt-file search libxi|grep libxi.so.6\napt-file search libxi|grep libxi\napt-get install libxi6:i386\n./DrClientLinux\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 跟之前报告说缺的依赖文件有了不同，继续。</p>\n<pre><code class=\"hljs\">apt-file search libxrender|grep libxrender\napt-get install libxrender1:i386\n./DrClientLinux\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 缺的依赖文件又不同了。发现这些依赖文件所属包的命名规律了，直接装，不用找了。</p>\n<pre><code class=\"hljs\">apt-get install libxrandr2:i386\n./DrClientLinux\napt-get install libxcursor1:i386\n./DrClientLinux\napt-get install libxinerama1:i386\n./DrClientLinux\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 妥了，可喜可贺！</p>\n",
            "tags": [
                "ubuntu",
                "debian",
                "apt-file"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/10/17/C-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%88%9D%E6%8E%A2%E2%80%94%E2%80%94c-11%E7%AF%87/",
            "url": "https://blog.bipedalbit.net/2015/10/17/C-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%88%9D%E6%8E%A2%E2%80%94%E2%80%94c-11%E7%AF%87/",
            "title": "C++多线程初探——c++11篇",
            "date_published": "2015-10-17T06:58:22.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 今天被说C++出身的猿不会多线程跟不会C++有什么分别，于是放下刚到手的Go和R的书，痛定思痛准备来给自己补补课。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; C++新标准c++11出现之前（虽然“新”标准已经发布好几年了），大家用C++写多线程通常有两种方式：Unix&#x2F;Linux下通常使用POSIX标准的pthread.h库，pthread并不是语言本身提供的内置库，gcc编译带pthread的程序时需要加上<code>-lpthread</code>标识参数；Windows下，win系列系统提供了一些线程API，但是由于gcc&#x2F;g++等编译器的跨平台性，其实也可以在win下使用pthread。<br>&nbsp;&nbsp;&nbsp; 然而2011年夏天，c++11标准发布了，新C++有了许多方便的新特性，其中就包括内置的，对多线程的支持。gcc 4.6及以前的版本编译c++11标准的多线程程序时还要加<code>-pthread</code>标识参数（注意与pthread库的<code>-lpthread</code>参数的区别）。后来也默认的支持新C++的内置多线程了，实测gcc 4.8.4除了<code>-std=c++11</code>不加别的参数，能够顺利编译运行c++11的多线程程序。<br>&nbsp;&nbsp;&nbsp; 铺垫了这么多，下面就先来试试c++11的多线程吧。<br>&nbsp;&nbsp;&nbsp; helloWorld.cpp：</p>\n<pre><code class=\"hljs\">/* c++11线程类的所在，下面的std::thread和std::this_thread都在其中 */\n#include &lt;thread&gt;\n#include &lt;iostream&gt;\nusing namespace std;\n\nvoid thread_task()\n&#123;\n\tcout &lt;&lt; &quot;Hello world! My thread ID is &quot; &lt;&lt; this_thread::get_id() &lt;&lt; endl;\n&#125;\n\nint main(int argc, char const *argv[])\n&#123;\n\t// 主线程测试\n\t/* get_id函数是thread类和this_thread类的成员，获取线程ID */\n\tcout &lt;&lt; &quot;I&#39;m the main thread. My thread ID is &quot; &lt;&lt; this_thread::get_id() &lt;&lt; endl;\n\t// 子线程测试\n\t/* 构造子线程时指派线程任务函数指针 */\n\tthread t1(thread_task);\n\tthread t2(thread_task);\n\tthread t3(thread_task);\n\t/* 主线程创建子线程 */\n\tt1.join();\n\tt2.join();\n\tt3.join();\n\n\treturn 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 最简单的多线程测试看起来运行的很顺利。下面我们稍微详细一点研究下std::thread的<a href=\"http://www.cplusplus.com/reference/thread/thread/\">官方文档</a>。</p>\n<ul>\n<li>thread::id：thread下面有个子类型thread::id，表示线程ID。是thread::get_id和this_thread::get_id的返回值。thread::id的构造函数返回一个non-joinable（不代表任何一个线程，即不与任何一个未终止的线程对应的ID相等）的线程ID。一个活跃的线程的ID会在线程终止后变成non-joinable线程ID。</li>\n<li>thread类的构造有4种形式：</li>\n</ul>\n<ul>\n<li>thread::thread()：默认构造函数，即不带参数的构造函数。构造一个非活跃（不可执行）的线程对象。</li>\n<li>thread::thread (Fn&amp;&amp; fn, Args&amp;&amp;… args)：初始化构造函数，即带足够多参数，足以初始化一个线程的构造函数。初始化构造函数的参数列表包括一个函数指针和这个函数的参数列表。利用迟邦定技术，构造过程与对函数副本的请求同步完成。</li>\n<li>复制构造函数，即从一个线程对象复制而得到一个新的线程对象。实际上，线程对象不允许被复制。</li>\n<li>thread::thread (thread&amp;&amp; x)：移动构造函数，即重新给指定线程分配一个对象（句柄），并释放原来的线程对象（句柄）。注意这并不影响原线程的执行，因为只是释放了对象（句柄），而没有分离原进程、释放资源。参数只有原线程对象。</li>\n</ul>\n<ul>\n<li>thread::~thread()：如果一个活跃线程被释放，首先会调用terminal()方法停止线程的执行。</li>\n<li>thread::operator&#x3D;(thread&amp;&amp; rhs)：作用相当于移动构造函数，原线程句柄被释放，返回一个更换句柄的线程对象。</li>\n<li>thread::get_id()：如果方法的目标线程对象是活跃的，生成一个唯一的ID并返回；如果调用方法的线程对象非活跃，先调用线程的默认构造函数生成一个non-joinable线程对象，然后生成一个唯一的ID并返回。</li>\n<li>thread::joinable()：joinable方法的唯一参数为一个线程ID，它的bool型返回值代表这个线程ID是否对应一个活跃的线程。this_thread下并没有这个方法，因为当前线程如果不为活跃线程，它将不能完成任何线程任务，即不能调用任何方法。</li>\n<li>thread::join()：这个方法将阻塞调用方法的线程（主线程），直到目标线程中的操作全部完成。这个方法返回之后，目标线程对象的状态就变为非活跃并可以被安全的释放了。换句话说，这个方法定义了一组线程同步关系。</li>\n<li>thread::detach()：应该有读者注意到了，detach是join的反义词，该方法的作用是从调用线程（主线程）中分离目标线程，让目标线程可以独立并行执行。调用detach方法后两个线程（调用线程和目标线程）都不会被阻塞或者被同步，而是会并行执行直到各自完成所有操作，谁完成执行谁就释放自己的资源，互不影响。（不是我啰嗦，文档原文就是这么说的）这个方法返回之后，目标线程对象的状态就变为非活跃并可以被安全的释放了。换句话说，这个方法定义了一组线程异步关系。</li>\n<li>thread::swap(thread&amp; x)：文档原文说是交换两个线程对象的<strong>状态</strong>，我表示不明白状态是指什么。实验表明应该是交换了线程与对象（句柄）的映射关系。thread类还重载了一个面向过程风格的swap方法版本：<code>void swap (thread&amp; x, thread&amp; y)</code>。</li>\n<li>thread::hardware_concurrency()：这是个静态成员函数，返回一个无符号整型，返回一个大概的（不一定准确，因为系统可以支持或限制每个进程创建的线程数）基于硬件的最大并行线程数。如果这个试图返回的值没有被系统很好的定义，返回0。</li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; thread头文件中还有一个与thread并列的<a href=\"http://www.cplusplus.com/reference/thread/this_thread/\">this_thread类</a>，this_thread类非常简单，除了get_id方法只有另外三个方法：</p>\n<ul>\n<li>this_thread::yield()：顾名思义，使当前线程退让，从执行状态变为就绪状态，使同优先级的线程有机会被重新调度进入执行状态。如果当前进程没什么毛病那么使它退让并没有太大意义，甚至可能不会造成事实上的线程执行顺序变化。yield方法应该在当前线程忙等别的线程而又没有被阻塞时执行。</li>\n<li>this_thread::sleep_until(const chrono::time_point&lt;Clock,Duration&gt;&amp; abs_time)：阻塞当前线程直到特定时间点，使当前线程至少等待到特定时间点后继续执行，参数是一种特定格式的时间点数据。</li>\n<li>this_thread::sleep_for(const chrono::duration&lt;Rep,Period&gt;&amp; rel_time)：阻塞当前线程一段时间，使当前线程至少等待特定时长后继续执行，参数是一种特定格式的时间段数据。</li>\n</ul>\n<p>&nbsp;&nbsp;&nbsp; 其实c++11标准下，除了thread，还有其他四个用来支持多线程的辅助头文件：<a href=\"http://www.cplusplus.com/reference/atomic/\">atomic</a>、<a href=\"http://www.cplusplus.com/reference/mutex/\">mutex</a>、<a href=\"http://www.cplusplus.com/reference/condition_variable/\">condition_variable</a>、<a href=\"http://www.cplusplus.com/reference/future/\">future</a>。前三个很好理解，分别提供封装好的原子数据类型、互斥锁设备和条件值，future头文件里提供的是一些对分享的数据资源进行竞争的必须设备（我很迷茫头文件为什么不干脆叫share而是叫future这个让人摸不着头脑的名字）。如果读者熟悉操作系统或者进程调度，一定不会对前面这些东西感到陌生。<br>&nbsp;&nbsp;&nbsp; 我们不难管中窥豹猜测多线程的实质，操作系统实现了完善的进程调度，而同样的事情我们要自己对线程再做一遍。线程的调度（包括同步异步、资源调配等等）也就是多线程编程具体要做的事。（还一片茫然的读者请去看任意一本操作系统课本前两三章的样子补补课）<br>&nbsp;&nbsp;&nbsp; 这篇文主要是科普，入门，建立概念，复杂的多线程实现练习之后再慢慢做，当然也会发文的。下一篇文我准备再科普一下POSIX标准的多线程编程，即pthread库的多线程编程。是的，我不打算研究win下的多线程API了，直言不讳的说，我对Windows有偏见。</p>\n",
            "tags": [
                "C++",
                "c++11",
                "多线程"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/10/13/python%E7%9A%84SimpleHTTPServer/",
            "url": "https://blog.bipedalbit.net/2015/10/13/python%E7%9A%84SimpleHTTPServer/",
            "title": "python的SimpleHTTPServer",
            "date_published": "2015-10-13T09:46:25.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; Linux下想要给局域网的其他终端共享文件大家一般会怎么做？是开个Nginx服务器或者Apache服务器？还是装个开源的FTP软件？其实还有更便捷的原生办法。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; Linux一般都预装了python，有个神奇的python命令：<br>&nbsp;&nbsp;&nbsp; <code>python -m SimpleHTTPServer 80</code><br>&nbsp;&nbsp;&nbsp; 读者可以试试发生了什么，没错，正如命令的字面意思，本地80口被开了个简易的HTTP服务器。如果当前文件夹下没有主页，局域网终端就可以通过本地IP访问本机并看到到执行该命令的当前文件夹下的文件目录了，接下来只要通过浏览器就可以下载本机的文件。<br>&nbsp;&nbsp;&nbsp; 不知道读者准备怎么使用这个命令，我有时候会忘记这个命令的一些细节所以选择把这个命令写成一个shell脚本，需要共享哪个文件夹就把脚本拖到哪里运行一下。<br>&nbsp;&nbsp;&nbsp; 如果想看这个python命令更详细的介绍可以参阅<a href=\"https://docs.python.org/2/library/simplehttpserver.html\">python官方文档</a>。<br>&nbsp;&nbsp;&nbsp; 我的脚本也挂出来吧，应该只在debian系统下好用，仅供参考：</p>\n<pre><code class=\"hljs\">#!/bin/bash\nroute=`route|grep default`\nroute=$&#123;route##*&#39; &#39;&#125;\nif [[ &quot;$route&quot; == usb* ]]; then\n    echo 正在使用usb共享网络。\nelif [[ &quot;$route&quot; == wlan* ]]; then\n    echo 正在使用无线网络。\nelif [[ &quot;$route&quot; == eth* ]]; then\n    echo 正在使用有线网络。\nelse\n    echo 正在使用其他网络。\nfi\nip=`ifconfig $route|grep &#39;inet &#39;|cut -d&#39;:&#39; -f2|cut -d&#39; &#39; -f1`\necho 局域网ip地址：$ip\necho 现在你可以从其他终端通过地址 http://$ip:2333/ 访问当前目录。\npython -m SimpleHTTPServer 2333\n</code></pre>\n",
            "tags": [
                "python"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/10/13/BP%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84python%EF%BC%88pybrain%E5%BA%93%EF%BC%89%E5%AE%9E%E7%8E%B0/",
            "url": "https://blog.bipedalbit.net/2015/10/13/BP%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84python%EF%BC%88pybrain%E5%BA%93%EF%BC%89%E5%AE%9E%E7%8E%B0/",
            "title": "BP神经网络的python（pybrain库）实现",
            "date_published": "2015-10-13T06:54:25.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 上一篇文用C++手写了BP神经网络，事实上，生产环境中已经很少有人再亲自写神经网络了，已经出现了很多成熟的机器学习开源库。我安装了C++的shark库和python的pybrain库，在研究shark库的文档时发现shark库封装度太低了，用起来很麻烦，遂弃。虽然放弃C++的高效库很遗憾，但是后来发现pybrain库真是非常友好非常方便，于是分别写了分类器和函数拟合的例子及测评。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 看两个库的源码时发现，shark库的机器学习模型比较多，pybrain的少一些，但是提供一些实时图形化的接口（虽然我嫌麻烦没用）。于是pybrain也可以与matlab和R语言争争份额了（虽然显然还是matlab和R比较专业）。<br>&nbsp;&nbsp;&nbsp; 首先来看分类器的实现，还是那个寻找点与平面位置关系规则的问题，上代码，NNClassifier.py：</p>\n<pre><code class=\"hljs\">#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n# 关于前馈神经网络二分类点集的尝试\n# 因为是首次尝试使用pybrain，不使用快捷方式创建神经网络以求思路清晰。\n\n__author__ = &#39;Bipedal Bit, hmemoryl@163.com&#39;\n\nfrom pybrain.structure import FeedForwardNetwork\nfrom pybrain.structure import LinearLayer, SigmoidLayer\nfrom pybrain.structure import FullConnection\nfrom pybrain.datasets import SupervisedDataSet\nimport random\nfrom pybrain.supervised.trainers import BackpropTrainer\nimport time\nfrom pybrain.tools.customxml.networkwriter import NetworkWriter\nfrom pybrain.tools.customxml.networkreader import NetworkReader\n\n# ================== 构造神经网络 ======================\n# 建立前馈神经网络FNN\nFNN = FeedForwardNetwork()\n\n# 逐层建立神经元\n# 建立m个输入参数的输入层（inLayer）\ninLayer = LinearLayer(7, name = &#39;inLayer&#39;)\n# 建立隐含层\nhiddenLayer0 = SigmoidLayer(30, name = &#39;hiddenLayer0&#39;)\n# 建立n个输出参数的输出层（outLayer）\noutLayer = SigmoidLayer(2, name = &#39;outLayer&#39;)\n\n# 将层加入神经网络（向神经网络内添加不同功能的神经元）\nFNN.addInputModule(inLayer)\nFNN.addModule(hiddenLayer0)\nFNN.addOutputModule(outLayer)\n\n# 建立层之间的连接，使用全连接，即两层的神经元之间两两全部连接\nconn_inToHidden0 = FullConnection(inLayer, hiddenLayer0)\nconn_hidden0ToOut = FullConnection(hiddenLayer0, outLayer)\n\n# 将连接加入神经网络\nFNN.addConnection(conn_inToHidden0)\nFNN.addConnection(conn_hidden0ToOut)\n\n# 神经元拓扑排序，准备使用\nFNN.sortModules()\n\n# ================== 构造数据集 ======================\n# 建立带监督的数据集，参数为输入维数和输出维数\nDS = SupervisedDataSet(7, 2)\n\n# 向数据集添加样本\n# 将一个0~1的随机数扩展到适当的范围\ndef expand(n):\n\treturn n*20 - 10\n# 数据组数\ndataCnt = 2000\nfor i in xrange(1, dataCnt):\n\t# 生成归一化样本数据\n\t_x = random.random()\n\t_y = random.random()\n\t_z = random.random()\n\t_a = random.random()\n\t_b = random.random()\n\t_c = random.random()\n\t_d = random.random()\n\t# 扩散出样本真实值\n\tx = expand(_x)\n\ty = expand(_y)\n\tz = expand(_z)\n\ta = expand(_a)\n\tb = expand(_b)\n\tc = expand(_c)\n\td = expand(_d)\n\t# 计算监督值\n\tabove = 1 if z &gt; (a*x + b*y + d)/(-c) else 0\n\tbelow = 1 if above == 0 else 0\n\t# 添加数据\n\tDS.addSample([_x, _y, _z, _a, _b, _c, _d], [above, below])\n\n# 分别索引输入/输出数据集合\nX, Y = DS[&#39;input&#39;], DS[&#39;target&#39;]\n\n# 按比例切分训练集与测试集（训练集：测试集 = 8:2）\nDSTrain, DSTest = DS.splitWithProportion(0.8)\n\n# 分别索引训练集和测试集的输入/输出数据集合\nXTrain, YTrain = DSTrain[&#39;input&#39;], DSTrain[&#39;target&#39;]\nXTest, YTest = DSTest[&#39;input&#39;], DSTest[&#39;target&#39;]\n\n# =================== 读取神经网络 =====================\nFNN = NetworkReader.readFrom(&#39;networkClasssifier.xml&#39;)\n\n# ================== 训练神经网络 ======================\n# 使用BP算法训练神经网络\ntrainer = BackpropTrainer(FNN, DSTrain, verbose = True, learningrate = 0.01, lrdecay = 1, momentum = 0)\n\n# 开始计时\nt_start = time.clock()\n\n# 训练至收敛\ntrainer.trainUntilConvergence(maxEpochs = 100)\n\n# 计时结束\nt_end = time.clock()\n\n# 输出训练用时\nprint &#39;训练用时：&#39;, t_end - t_start, &#39;s&#39;\n\n# =================== 存储神经网络 =====================\nNetworkWriter.writeToFile(FNN, &#39;networkClasssifier.xml&#39;)\n\n# =================== 结果可视化 =======================\n\n\n# ====================== 测试 ==========================\nsuccessCnt = 0\nfor i in xrange(0, len(XTest)-1):\n\t# 获取测试数据\n\tx = XTest[i]\n\ty = YTest[i]\n\t# 测试\n\tprediction = FNN.activate(x)\n\tif (y[0] - y[1])*(prediction[0] - prediction[1]) &gt; 0:\n\t\tsuccessCnt += 1\nprint &#39;测试：&#39;, len(XTest)\nprint &#39;命中：&#39;, successCnt\nprint &#39;命中率：&#39;, (successCnt*1.)/len(XTest)*100, &#39;%&#39;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 训练结果我不太意外，误差函数值在0.05左右，算不上好，正确率在82%左右，只能说还行。这次只是简单测评，就不对收敛程度做太高要求了。（其实是我把隐含层神经元都加到30个了精度也不是很高，有点累了，毕竟经验公式说这种输入输出参数量最多加到13个）<br>&nbsp;&nbsp;&nbsp; 最后的神经网络保存文档（权重数组），networkClassifier.xml：</p>\n<pre><code class=\"hljs\">&lt;?xml version=&quot;1.0&quot; ?&gt;\n&lt;PyBrain&gt;\n\t&lt;Network class=&quot;pybrain.structure.networks.feedforward.FeedForwardNetwork&quot; name=&quot;FeedForwardNetwork-5&quot;&gt;\n\t\t&lt;name val=&quot;u&#39;FeedForwardNetwork-5&#39;&quot;/&gt;\n\t\t&lt;Modules&gt;\n\t\t\t&lt;LinearLayer class=&quot;pybrain.structure.modules.linearlayer.LinearLayer&quot; inmodule=&quot;True&quot; name=&quot;inLayer&quot;&gt;\n\t\t\t\t&lt;dim val=&quot;7&quot;/&gt;\n\t\t\t\t&lt;name val=&quot;&#39;inLayer&#39;&quot;/&gt;\n\t\t\t&lt;/LinearLayer&gt;\n\t\t\t&lt;SigmoidLayer class=&quot;pybrain.structure.modules.sigmoidlayer.SigmoidLayer&quot; name=&quot;outLayer&quot; outmodule=&quot;True&quot;&gt;\n\t\t\t\t&lt;dim val=&quot;2&quot;/&gt;\n\t\t\t\t&lt;name val=&quot;&#39;outLayer&#39;&quot;/&gt;\n\t\t\t&lt;/SigmoidLayer&gt;\n\t\t\t&lt;SigmoidLayer class=&quot;pybrain.structure.modules.sigmoidlayer.SigmoidLayer&quot; name=&quot;hiddenLayer0&quot;&gt;\n\t\t\t\t&lt;dim val=&quot;30&quot;/&gt;\n\t\t\t\t&lt;name val=&quot;&#39;hiddenLayer0&#39;&quot;/&gt;\n\t\t\t&lt;/SigmoidLayer&gt;\n\t\t&lt;/Modules&gt;\n\t\t&lt;Connections&gt;\n\t\t\t&lt;FullConnection class=&quot;pybrain.structure.connections.full.FullConnection&quot; name=&quot;FullConnection-3&quot;&gt;\n\t\t\t\t&lt;inmod val=&quot;inLayer&quot;/&gt;\n\t\t\t\t&lt;outmod val=&quot;hiddenLayer0&quot;/&gt;\n\t\t\t\t&lt;Parameters&gt;[-4.4634646760183774, -1.8663551824786604, 1.5796984784944188, -4.1545734140399917, -1.4235379909335284, 10.814418886792573, -0.35697065520281313, 3.7168599840362613, -1.3954006078608174, 3.2888708257680479, -1.2728713382523704, 5.1682485849770519, -10.345459393449577, 0.40944729400489821, -0.86432327459917391, 0.87415267739043501, -1.1261847464737353, 0.26550824904566483, -0.69655632472406404, -1.0926496454783619, -1.3241014363212174, -1.2345262671004642, -5.3545154953074556, -3.2977309106602868, -1.9192142648212187, 3.5219032402205235, 8.8243116475870895, -0.34711073857964059, -0.76652402450096546, -0.45800625182882904, 0.10921234310650819, 1.0906882881030282, 0.58122385851806679, 0.74902769546891046, 0.57778560396382117, -0.36268964602939496, -1.4560716552974731, 0.025807475393432977, -0.52324632490359346, -1.4768259974689912, -1.3226548504200857, -0.56024431774602601, 0.5253813385807985, -2.3601368528359932, 3.4391924327008545, -3.4529059457340887, -0.36798304125763204, 0.24642387811765787, 0.74392363594535504, -1.4200092817628436, -0.95882940181717424, 0.90204884683974906, -2.2123307425066581, -1.2927495594815508, -2.6418298086483243, 0.0089737728359628229, -0.96131150512314989, -0.42386913703414159, 2.7423827971590629, 0.49257080970361217, -0.73140003600797654, -0.97237673817617065, 0.021672107067701795, -0.30730995794768651, -0.28377110259164756, -1.3769421502868895, -0.49923480994397734, 0.63167130189837051, 0.72750574299622528, -0.50823243724360356, -2.3249236293984685, -1.0084930398088603, 0.55483423319351144, -3.0895951468032683, -1.569810215716863, -4.6712778120909002, 2.1476977927094589, -0.92601922552049853, 0.80913122603871213, 1.0167819396610751, 1.2578916110729925, 1.1336741124853456, -1.4462571148912973, 0.4498637409091461, -0.0046570255381198191, 1.0130490743040022, 0.067808742574706565, -3.1665123334368257, -1.3695841902759027, -0.61944129404109394, 0.32712520616674406, -4.0944887153367588, 0.33425112596763401, 0.53786026328450398, 3.783707069693385, -0.73771116333542275, -7.3116843863108363, -0.90847319043398045, -1.3072997563815252, 1.5864357535576585, -2.1773369395271285, 0.16582713303194607, 0.62423604397793453, 0.59389298905810417, -0.31484499272512129, 5.0708486445028633, 0.91681404432938907, 0.31193631582711534, -5.4473204154043851, -0.7847240929315491, -7.6951030649320984, -0.32014838444510901, 0.56829986867023885, -0.29653458065896326, 0.51800388373753137, -0.56704382593349767, -0.25264606109631066, 0.78514270624403915, 0.67787739064705022, -0.0014430992506962728, -1.1915649958214867, -2.8339864138165369, -1.2920958546780335, -1.2004239162539645, -5.5518360974893373, 2.6887049948956299, -1.8837019633804577, 2.8587109449831924, 3.8684384835516568, -2.7090025688862394, -3.3154340336962216, 1.0688334874085363, 0.43275994294040698, -3.8784776661421345, -0.8578678330233066, 1.8270738585600814, 5.4477321487215189, 2.7554123218891138, -6.9965304625370077, 0.91986888975642622, 1.6206020126465939, 0.40565735648759632, 1.6264383151366206, -2.0910948725615417, -0.96054739666906863, 0.83967430154853273, 0.17826444997023716, 0.93718547827806598, -5.2232302716871377, -0.37715953425266679, 1.1057273981735851, -5.0228630028488084, 8.7833592718428406, -0.17862770462286087, 0.071119534208408983, 0.61781354218205642, -2.0482041559354802, -1.2286398440013546, 0.30582092080786355, 0.74602342033773583, -0.12623275590092933, -0.89369108883986548, -1.0173825208087091, 0.21764568858325722, 1.1182634120634272, 0.44364418276133, 1.138196191040812, 0.10662608395776786, -0.25838212820199019, -0.86982182253008533, -0.55680951312883542, 0.25307613718779792, -0.90155685220035831, 1.835084251778919, -0.81174579278015824, 0.48215346567645934, 6.267187930149162, -2.1805487376071957, 1.0628647712248505, -3.0943161262836401, -4.9327587898336835, 1.3749005504013798, -5.5102212316356844, -0.96863134222439218, 0.8268862262896568, 4.3540259268851402, -0.50518156739373588, 3.8934730549155523, -0.39568193061006912, -3.7859120847720105, 2.0595665943684325, -2.6633982082854342, -4.0807360028025208, 3.7442177075679623, 5.11773145948146, -0.44630616509537863, 0.20714091867709217, -0.6873175410894995, 0.061460095180831932, -0.44453400594106057, 0.35250696385984698, 2.2565455035241082, -0.079401700376001166, -0.18177974449629683, 0.71736053566879954, 0.54270386006022042, 0.75951868740937811, 1.3078378324277897, -2.1881100701125251, 0.84052630355979829]&lt;/Parameters&gt;\n\t\t\t&lt;/FullConnection&gt;\n\t\t\t&lt;FullConnection class=&quot;pybrain.structure.connections.full.FullConnection&quot; name=&quot;FullConnection-4&quot;&gt;\n\t\t\t\t&lt;inmod val=&quot;hiddenLayer0&quot;/&gt;\n\t\t\t\t&lt;outmod val=&quot;outLayer&quot;/&gt;\n\t\t\t\t&lt;Parameters&gt;[-8.2129041568200112, -6.7995955920941888, 0.48890334859207907, 7.6066781773027499, 2.8270407553317769, -1.0008489151414828, 3.0303929667267862, -2.4507639356974593, 1.9205137372795547, -2.0677111079872867, -4.6278733853833467, 3.3159637261922645, 0.4984027688395733, 4.7415120162351183, -2.5033978652108386, 5.1877234768369922, 0.87623718221836022, -5.0415283550332814, 4.0707627481245554, -6.4411441580882105, 2.6369969676415286, -8.5775684178164635, -1.313121167107631, -0.89764250697180914, -0.78729432668282306, -4.1300664676586489, 5.6446245751676667, -4.5102393183383498, 0.1106246177522491, 3.2716628012569964, 8.2844165753556958, 6.9238002822405154, 0.33656468267775197, -7.6960641823743456, 0.84148765790877422, 1.7483968344478173, -2.9938885121262571, 2.2508496743698845, -3.3237973590853258, 0.25502346696281558, 4.4894675338875496, -2.5350467550996507, -0.11269663125646072, -4.7593000820253231, 1.8099587344845871, -5.1168105240606856, -1.7100116403752497, 4.8179029808866174, -4.1421556373685728, 6.5870613347344591, -1.9261388149076637, 8.4927720262891935, 1.6203591174629115, -1.702384877536026, 1.9822996827269457, 3.6477517464649072, -5.4008040115101963, 4.720080872228464, -0.76546727507485091, -3.6703618616272795]&lt;/Parameters&gt;\n\t\t\t&lt;/FullConnection&gt;\n\t\t&lt;/Connections&gt;\n\t&lt;/Network&gt;\n&lt;/PyBrain&gt;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 函数拟合实验选择了简单的a+b问题，上代码，NNRegression.py：</p>\n<pre><code class=\"hljs\">#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n# 关于前馈神经网络函数拟合的尝试\n# 因为是首次尝试使用pybrain，不使用快捷方式创建神经网络以求思路清晰。\n\n__author__ = &#39;Bipedal Bit, hmemoryl@163.com&#39;\n\nfrom pybrain.structure import FeedForwardNetwork\nfrom pybrain.structure import LinearLayer, SigmoidLayer\nfrom pybrain.structure import FullConnection\nfrom pybrain.datasets import SupervisedDataSet\nimport random\nfrom pybrain.supervised.trainers import BackpropTrainer\nimport time\nfrom pybrain.tools.customxml.networkwriter import NetworkWriter\nfrom pybrain.tools.customxml.networkreader import NetworkReader\n\n# ================== 构造神经网络 ======================\n# 建立前馈神经网络FNN\nFNN = FeedForwardNetwork()\n\n# 逐层建立神经元\n# 建立m个输入参数的输入层（inLayer）\ninLayer = LinearLayer(2, name = &#39;inLayer&#39;)\n# 建立隐含层\nhiddenLayer0 = SigmoidLayer(20, name = &#39;hiddenLayer0&#39;)\n# 建立n个输出参数的输出层（outLayer）\noutLayer = LinearLayer(1, name = &#39;outLayer&#39;)\n\n# 将层加入神经网络（向神经网络内添加不同功能的神经元）\nFNN.addInputModule(inLayer)\nFNN.addModule(hiddenLayer0)\nFNN.addOutputModule(outLayer)\n\n# 建立层之间的连接，使用全连接，即两层的神经元之间两两全部连接\nconn_inToHidden0 = FullConnection(inLayer, hiddenLayer0)\nconn_hidden0ToOut = FullConnection(hiddenLayer0, outLayer)\n\n# 将连接加入神经网络\nFNN.addConnection(conn_inToHidden0)\nFNN.addConnection(conn_hidden0ToOut)\n\n# 神经元拓扑排序，准备使用\nFNN.sortModules()\n\n# ================== 构造数据集 ======================\n# 建立带监督的数据集，参数为输入维数和输出维数\nDS = SupervisedDataSet(2, 1)\n\n# 向数据集添加样本\n# 数据组数\ndataCnt = 1000\nfor i in xrange(1, dataCnt):\n\t# 生成归一化样本数据\n\ta = random.random()\n\tb = random.random()\n\t# 计算监督值\n\ts = a*20 - 10 + b*20 - 10\n\t# 添加数据\n\tDS.addSample([a, b], [s])\n\n# 分别索引输入/输出数据集合\nX, Y = DS[&#39;input&#39;], DS[&#39;target&#39;]\n\n# 按比例切分训练集与测试集（训练集：测试集 = 8:2）\nDSTrain, DSTest = DS.splitWithProportion(0.8)\n\n# 分别索引训练集和测试集的输入/输出数据集合\nXTrain, YTrain = DSTrain[&#39;input&#39;], DSTrain[&#39;target&#39;]\nXTest, YTest = DSTest[&#39;input&#39;], DSTest[&#39;target&#39;]\n\n# =================== 读取神经网络 =====================\nFNN = NetworkReader.readFrom(&#39;networkRegression.xml&#39;)\n\n# ================== 训练神经网络 ======================\n# 使用BP算法训练神经网络\ntrainer = BackpropTrainer(FNN, DSTrain, verbose = True, learningrate = 0.01, lrdecay = 1, momentum = 0)\n\n# 开始计时\nt_start = time.clock()\n\n# 训练至收敛\ntrainer.trainUntilConvergence(maxEpochs = 100)\n\n# 计时结束\nt_end = time.clock()\n\n# 输出训练用时\nprint &#39;训练用时：&#39;, t_end - t_start, &#39;s&#39;\n\n# =================== 存储神经网络 =====================\nNetworkWriter.writeToFile(FNN, &#39;networkRegression.xml&#39;)\n\n# =================== 结果可视化 =======================\n\n\n# ====================== 测试 ==========================\nfor i in xrange(0, 10):#len(XTest)-1):\n\t# 获取测试数据\n\tx = XTest[i]\n\ty = YTest[i]\n\t# 测试\n\tprediction = FNN.activate(x)\n\tprint &#39;期望值：&#39;, y\n\tprint &#39;预测值：&#39;, prediction\n\tprint &#39;--------------------------------------&#39;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 评测结果有些诡异，尽管我丧心病狂的把隐含层神经元数慢慢加到了20个之多，收敛精度依然不太高。误差函数值在0.016左右，计算结果多的时候能有一点几的误差。至于为什么诡异，你们知道我用C++手写的那个BP神经网络a+b拟合测评结果什么样吗？我每次增加隐含层神经元，精度都在提高，最后加到11个神经元时，误差值只有10^-7的数量级了。我在想，莫非pybrain的BP实现写的比我还糟糕？当然我没有闲到对比源码找差别的地步，毕竟这是在扩展知识面而不是开题写论文，要学的东西还有很多。<br>&nbsp;&nbsp;&nbsp; 训练结果，networkRegression.xml：</p>\n<pre><code class=\"hljs\">&lt;?xml version=&quot;1.0&quot; ?&gt;\n&lt;PyBrain&gt;\n\t&lt;Network class=&quot;pybrain.structure.networks.feedforward.FeedForwardNetwork&quot; name=&quot;FeedForwardNetwork-5&quot;&gt;\n\t\t&lt;name val=&quot;u&#39;FeedForwardNetwork-5&#39;&quot;/&gt;\n\t\t&lt;Modules&gt;\n\t\t\t&lt;LinearLayer class=&quot;pybrain.structure.modules.linearlayer.LinearLayer&quot; inmodule=&quot;True&quot; name=&quot;inLayer&quot;&gt;\n\t\t\t\t&lt;dim val=&quot;2&quot;/&gt;\n\t\t\t\t&lt;name val=&quot;&#39;inLayer&#39;&quot;/&gt;\n\t\t\t&lt;/LinearLayer&gt;\n\t\t\t&lt;LinearLayer class=&quot;pybrain.structure.modules.linearlayer.LinearLayer&quot; name=&quot;outLayer&quot; outmodule=&quot;True&quot;&gt;\n\t\t\t\t&lt;dim val=&quot;1&quot;/&gt;\n\t\t\t\t&lt;name val=&quot;&#39;outLayer&#39;&quot;/&gt;\n\t\t\t&lt;/LinearLayer&gt;\n\t\t\t&lt;SigmoidLayer class=&quot;pybrain.structure.modules.sigmoidlayer.SigmoidLayer&quot; name=&quot;hiddenLayer0&quot;&gt;\n\t\t\t\t&lt;dim val=&quot;20&quot;/&gt;\n\t\t\t\t&lt;name val=&quot;&#39;hiddenLayer0&#39;&quot;/&gt;\n\t\t\t&lt;/SigmoidLayer&gt;\n\t\t&lt;/Modules&gt;\n\t\t&lt;Connections&gt;\n\t\t\t&lt;FullConnection class=&quot;pybrain.structure.connections.full.FullConnection&quot; name=&quot;FullConnection-4&quot;&gt;\n\t\t\t\t&lt;inmod val=&quot;inLayer&quot;/&gt;\n\t\t\t\t&lt;outmod val=&quot;hiddenLayer0&quot;/&gt;\n\t\t\t\t&lt;Parameters&gt;[0.66989695089493184, 0.20154541787085151, -0.50128908433773467, -0.37527744480307418, -0.74611014578997958, -0.12337190284043228, -0.26139108724410959, -0.62223790666112244, 0.76934737325151314, 0.097273365366757986, -0.70241911419677627, -0.1675521617762078, -0.52875791799833338, -0.34701820533745775, 0.91136351597023102, -0.051368168009540249, -0.46415381076169848, -0.41344842847904884, -0.3637989937993043, -0.51709189928560939, 0.021917540062381426, -0.91373858562576571, 0.18558709721271155, 0.70146289478301882, 0.1657642703601043, 0.72042804496432955, -0.051995836002024759, -0.83682492233986472, -0.57633470846976453, -0.29793296256418189, -0.0042668700361729222, 0.89613628191472339, 0.78248084199047585, 0.083752407601260875, -0.34426021947865065, -0.53677318854588607, -0.59630570148683881, -0.2772033711210245, -0.29072335479904238, -0.59221753051512371]&lt;/Parameters&gt;\n\t\t\t&lt;/FullConnection&gt;\n\t\t\t&lt;FullConnection class=&quot;pybrain.structure.connections.full.FullConnection&quot; name=&quot;FullConnection-3&quot;&gt;\n\t\t\t\t&lt;inmod val=&quot;hiddenLayer0&quot;/&gt;\n\t\t\t\t&lt;outmod val=&quot;outLayer&quot;/&gt;\n\t\t\t\t&lt;Parameters&gt;[7.0033787939978653, -8.9204704009603475, -7.0019357487260141, -9.1851348838825597, 11.222280489358978, -9.1321512616209173, -10.187840330915042, 12.40878268578923, -8.1946287348945397, -9.729867458003703, -10.577209749285847, 12.709727310110253, 9.5182614987221701, -8.4580456500212975, -7.9531433608618309, 11.918092172946009, 10.86011334049692, -8.310811818166254, -9.5385851767871586, -9.531838664642386]&lt;/Parameters&gt;\n\t\t\t&lt;/FullConnection&gt;\n\t\t&lt;/Connections&gt;\n\t&lt;/Network&gt;\n&lt;/PyBrain&gt;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 以上。欢迎留言探讨。</p>\n",
            "tags": [
                "BP神经网络",
                "机器学习",
                "python",
                "pybrain"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/10/11/BP%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84C-%E5%AE%9E%E7%8E%B0/",
            "url": "https://blog.bipedalbit.net/2015/10/11/BP%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E7%9A%84C-%E5%AE%9E%E7%8E%B0/",
            "title": "BP神经网络的C++实现",
            "date_published": "2015-10-10T16:28:00.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 之前说了组里的任务是手写BP神经网络，上一篇文总结了一下BP神经网络的概念，老实说，总结概念前的一个C++实现版本在总结概念之后重新审视时觉得实在是惨不忍睹，于是今晚回炉重写了。这篇文就来挂我的BP神经网络C++实现。</p>\n<span id=\"more\"></span>\n\n<p>&nbsp;&nbsp;&nbsp; 老师提出的具体问题是平面对点集的二分类。ACM战过这么多场，写板子早成了习惯，就把通用的BP认真封装了一下：<br>&nbsp;&nbsp;&nbsp; 头文件里的Data结构体是输入数据的数据结构，可自定义，这里用的是点分类问题的模型，BP.h：</p>\n<pre><code class=\"hljs\">#ifndef _BP_H_\n#define _BP_H_\n\n#include &lt;vector&gt;\n#include &lt;string&gt;\nusing namespace std;\n\n/* 数据样本类 */\nstruct Data\n&#123;\n\t/* 输入参数，包括： */\n\t/* 三维直角坐标系点的坐标(x, y, z) */\n\t/* 三维直角坐标系平面a*x + b*y + c*z + d = 0的4个系数 */\n\tdouble x[7];\n\t/* 期望输出即监督值 */\n\t/* 拟合 */\n\t// double d[1];\n\t/* 分类 */\n\tdouble d[2];\n\t/* 数据构造函数 */\n\tData();\n&#125;;\n\nclass BP\n&#123;\nprivate:\n\t/* ========== 常数 ========== */\n\t/* 输入层节点数 */\n\tint I;\n\t/* 隐含层神经元数 */\n\tint H;\n\t/* 输出层神经元数 */\n\tint O;\n\t/* 权重学习速率 */\n\tdouble LR;\n\t/* 偏置学习速率 */\n\tdouble LR2;\n\t/* 学习速率衰减率（每次衰减与当前LR相乘） */\n\tdouble LRDecay;\n\t/* 误差函数收敛阈值 */\n\tdouble C;\n\t/* ========== 容器 ========== */\n\t/* 训练用数据样本集 */\n\tvector&lt;Data&gt; trainDS;\n\t/* 测使用数据集 */\n\tvector&lt;Data&gt; testDS;\n\t/* 输入层与隐含层间的全连接权重：w[I(包含一个偏置值)][H] */\n\tdouble **w;\n\t/* w修正值 */\n\tdouble *dw;\n\t/* 隐含层阈值 */\n\tdouble *th;\n\t/* 隐含层输入积累即净激活，也存放之后的激活输出值：u[H] */\n\tdouble *u;\n\t/* 隐含层与输出层间的全连接权重：v[H][O] */\n\tdouble **v;\n\t/* v修正值 */\n\tdouble *dv;\n\t/* 输出层阈值 */\n\tdouble *to;\n\t/* 输出层输入积累即净激活，也存放之后的激活输出值：y[O] */\n\tdouble *y;\n\t/* 拟合标识 */\n\tbool regression;\n\t/* ========== 方法 ========== */\n\t/* 填充训练用数据样本集 */\n\tvoid fillTrainDS(int sampleCnt);\n\t/* 清空训练用数据样本集 */\n\tvoid clearTrainDS();\n\t/* 填充测试使用数据集 */\n\tvoid fillTestDS(int sampleCnt);\n\t/* 清空测试使用数据集 */\n\tvoid clearTestDS();\n\t/* 预测 */\n\tvoid forward(int index, bool test = false);\n\t/* 调整 */\n\tvoid backward(int index);\npublic:\n\t/* ========== 接口 ========== */\n\t/*\n\t * 类构造函数，初始化BP神经网络结构和训练参数\n\t * int _I：\t\t输入参数数目。\n\t * int _O：\t\t输出值数目。\n\t * int A：\t\t隐含层调整因子（1~10）。\n\t * double _LR：\t\t权重学习速率（0.01~0.8）。\n\t * double _LR2：\t偏置学习速率（0.01~0.8）。\n\t * double _LRDecay：\t学习速率衰减率（每次衰减与当前LR相乘）。\n\t * double _C：\t\t误差函数收敛阈值。\n\t * bool regression：\t拟合标识。\n\t */\n\tBP(int _I, int _O, int A = 1, double _LR = 0.01, double _LR2 = 0.035, double _LRDecay = 1.0, double _C = 0.01, bool regression = false);\n\t/* 类析构函数，释放容器分配的堆空间 */\n\t~BP();\n\t/* 使用指定数目的样本训练指定数目次循环，返回最后的误差函数值 */\n\tdouble train(int sampleCnt = 1000, int trainCnt = 100);\n\t/*\n\t * 使用指定数目的样本循环训练。\n\t * 误差函数值进入可接受范围判定收敛并停止训练；\n\t * 到达最大训练次数时停止训练。\n\t * 返回是否收敛。\n\t */\n\tbool trainTillConvergent(int sampleCnt = 1000, int maxEpoch = 1000);\n\t/* 生成指定数目组数据测试当前神经网络 */\n\tvoid testNetwork(int testCnt = 1000);\n\t/* 保存当前神经网络，即两个权重数组 */\n\tvoid saveNetwork(string wPath = &quot;wNetwork&quot;, string vPath = &quot;vNetwork&quot;);\n\t/* 载入两个权重数组，还原神经网络 */\n\tvoid loadNetwork(string wPath = &quot;wNetwork&quot;, string vPath = &quot;vNetwork&quot;);\n\t/* 使用指定数据预测输出值并返回输出值 */\n\tvector&lt;double&gt; runNetwork(vector&lt;double&gt; x);\n&#125;;\n\n#endif\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 类实现源码里的Data结构体的构造函数是输入数据的处理和问题模型的建立，可自定义，这里用的是点分类问题的数据处理，BP.cpp：</p>\n<pre><code class=\"hljs\">#include &quot;BP.h&quot;\n#include &lt;iostream&gt;\n#include &lt;cstdlib&gt;\n#include &lt;ctime&gt;\n#include &lt;cmath&gt;\n#include &lt;fstream&gt;\nusing namespace std;\n\n/* 数据构造函数 */\nData::Data()\n&#123;\n\t/* 归一参数 */\n\tfor(int i = 1 ; i &lt; 8 ; i++)\n\t&#123;\n\t\tx[i] = rand()/(double)RAND_MAX;\n\t&#125;\n\t/* 实际参数 */\n\tdouble _x = x[1]*20 - 10;\n\tdouble y = x[2]*20 - 10;\n\tdouble z = x[3]*20 - 10;\n\tdouble a = x[4]*20 - 10;\n\tdouble b = x[5]*20 - 10;\n\tdouble c = x[6]*20 - 10;\n\tdouble _d = x[7]*20 - 10;\n\t/* 拟合 */\n\t// d[0] = z - (a*_x + b*y + _d)/(-1*c);\n\t/* 分类 */\n\td[0] = z &gt; (a*_x + b*y + _d)/(-1*c) ? 1 : 0;\n\td[1] = d[0] ? 0 : 1;\n&#125;\n\n/* 填充训练用数据样本集 */\nvoid BP::fillTrainDS(int sampleCnt)\n&#123;\n\twhile(sampleCnt--)\n\t&#123;\n\t\ttrainDS.push_back(Data());\n\t&#125;\n&#125;\n\n/* 清空训练用数据样本集 */\nvoid BP::clearTrainDS()\n&#123;\n\tvector&lt;Data&gt; v;\n\ttrainDS.swap(v);\n&#125;\n\n/* 填充测试使用数据集 */\nvoid BP::fillTestDS(int sampleCnt)\n&#123;\n\twhile(sampleCnt--)\n\t&#123;\n\t\ttestDS.push_back(Data());\n\t&#125;\n&#125;\n\n/* 清空测试使用数据集 */\nvoid BP::clearTestDS()\n&#123;\n\tvector&lt;Data&gt; v;\n\ttestDS.swap(v);\n&#125;\n\n/* 预测 */\nvoid BP::forward(int index, bool test)\n&#123;\n\t/* 隐含层 */\n\tfor(int i = 0 ; i &lt; H ; i++)\n\t&#123;\n\t\tu[i] = 0;\n\t\tfor(int j = 0 ; j &lt; I ; j++)\n\t\t&#123;\n\t\t\tdouble x = test ? testDS[index].x[j] : trainDS[index].x[j];\n\t\t\t/* 积累输入 */\n\t\t\tu[i] += w[j][i]*x;\n\t\t&#125;\n\t\tu[i] += th[i];\n\t\t/* Sigmoid函数作为激活函数 */\n\t\tu[i] = 1 / (1 + exp(-1*u[i]));\n\t&#125;\n\t/* 输出层 */\n\tfor(int i = 0 ; i &lt; O ; i++)\n\t&#123;\n\t\ty[i] = 0;\n\t\tfor(int j = 0 ; j &lt; H ; j++)\n\t\t&#123;\n\t\t\t/* 积累输入 */\n\t\t\ty[i] += v[j][i]*u[j];\n\t\t&#125;\n\t\ty[i] += to[i];\n\t\t/* 分类：Sigmoid函数作为激活函数 */\n\t\tif (!regression)\n\t\t&#123;\n\t\t\ty[i] = 1 / (1 + exp(-1*y[i]));\n\t\t&#125;\n\t&#125;\n&#125;\n\n/* 调整 */\nvoid BP::backward(int index)\n&#123;\n\t/* 计算隐含层与输出层间权重调整值 */\n\tfor(int i = 0 ; i &lt; O ; i++)\n\t&#123;\n\t\t/* 拟合：计算输出层学习误差 */\n\t\tif (regression)\n\t\t&#123;\n\t\t\tdv[i] = y[i] - trainDS[index].d[i];\n\t\t&#125;\n\t\t/* 分类：计算输出层学习误差 */\n\t\telse\n\t\t&#123;\n\t\t\tdv[i] = (y[i] - trainDS[index].d[i])*y[i]*(1 - y[i]);\n\t\t&#125;\n\t&#125;\n\t/* 计算输入层与隐含层间权重调整值 */\n\tdouble t;\n\tfor(int i = 0 ; i &lt; H ; i++)\n\t&#123;\n\t\tt = 0;\n\t\tfor(int j = 0 ; j &lt; O ; j++)\n\t\t&#123;\n\t\t\tt += dv[j]*v[i][j];\n\t\t&#125;\n\t\tdw[i] = t*u[i]*(1 - u[i]);\n\t&#125;\n\t/* 调整隐含层与输出层间权重 */\n\tfor(int i = 0 ; i &lt; H ; i++)\n\t&#123;\n\t\tfor(int j = 0 ; j &lt; O ; j++)\n\t\t&#123;\n\t\t\tv[i][j] -= LR*dv[j]*u[i];\n\t\t&#125;\n\t&#125;\n\t/* 调整输出层偏置 */\n\tfor(int i = 0 ; i &lt; O ; i++)\n\t&#123;\n\t\tto[i] -= LR2*dv[i];\n\t&#125;\n\t/* 调整输入层与隐含层间权重 */\n\tfor(int i = 0 ; i &lt; I ; i++)\n\t&#123;\n\t\tfor(int j = 0 ; j &lt; H ; j++)\n\t\t&#123;\n\t\t\tw[i][j] -= LR*dw[j]*trainDS[index].x[i];\n\t\t&#125;\n\t&#125;\n\t/* 调整隐含层偏置 */\n\tfor(int i = 0 ; i &lt; H ; i++)\n\t&#123;\n\t\tth[i] -= LR2*dw[i];\n\t&#125;\n&#125;\n\n/*\n * 类构造函数，初始化BP神经网络结构和训练参数\n * int _I：\t\t输入参数数目，包括偏置值对应的参数-1。\n * int _O：\t\t输出值数目。\n * int A：\t\t隐含层调整因子（1~10）。\n * double _LR：\t\t权重学习速率（0.01~0.8）。\n * double _LR2：\t偏置学习速率（0.01~0.8）。\n * double _LRDecay：\t学习速率衰减率（每次衰减与当前LR相乘）。\n * double _C：\t\t误差函数收敛阈值。\n * bool regression：\t拟合标识。\n */\nBP::BP(int _I, int _O, int A, double _LR, double _LR2, double _LRDecay, double _C, bool _regression)\n&#123;\n\t/* ========== 初始化常数 ========== */\n\tI = _I;\n\tH = ceil(sqrt(_I + _O)) + A;\n\tO = _O;\n\tLR = _LR;\n\tLR2 = _LR2;\n\tLRDecay = _LRDecay;\n\tC = _C;\n\tregression = _regression;\n\t/* ========== 初始化容器 ========== */\n\tsrand((unsigned)time(NULL));\n\t/* 初始化w */\n\tw = new double*[I];\n\tfor(int i = 0 ; i &lt; I ; i++)\n\t&#123;\n\t\tw[i] = new double[H];\n\t\tfor(int j = 0 ; j &lt; H ; j++)\n\t\t&#123;\n\t\t\tw[i][j] = rand()/(double)RAND_MAX;\n\t\t&#125;\n\t&#125;\n\t/* 初始化dw */\n\tdw = new double[H];\n\t/* 初始化th */\n\tth = new double[H];\n\tfor(int i = 0 ; i &lt; H ; i++)\n\t&#123;\n\t\tth[i] = rand()/(double)RAND_MAX;\n\t&#125;\n\t/* 初始化u */\n\tu = new double[H];\n\t/* 初始化v */\n\tv = new double*[H];\n\tfor(int i = 0 ; i &lt; H ; i++)\n\t&#123;\n\t\tv[i] = new double[O];\n\t\tfor(int j = 0 ; j &lt; O ; j++)\n\t\t&#123;\n\t\t\tv[i][j] = rand()/(double)RAND_MAX;\n\t\t&#125;\n\t&#125;\n\t/* 初始化dv */\n\tdv = new double[O];\n\t/* 初始化to */\n\tto = new double[O];\n\tfor(int i = 0 ; i &lt; O ; i++)\n\t&#123;\n\t\tto[i] = rand()/(double)RAND_MAX;\n\t&#125;\n\t/* 初始化y */\n\ty = new double[O];\n&#125;\n\n/* 类析构函数，释放容器分配的堆空间 */\nBP::~BP()\n&#123;\n\t/* 释放w */\n\tfor(int i = 0 ; i &lt; I ; i++)\n\t&#123;\n\t\tdelete []w[i];\n\t&#125;\n\tdelete []w;\n\t/* 释放dw */\n\tdelete []dw;\n\t/* 释放th */\n\tdelete []th;\n\t/* 释放u */\n\tdelete []u;\n\t/* 释放v */\n\tfor(int i = 0 ; i &lt; H ; i++)\n\t&#123;\n\t\tdelete []v[i];\n\t&#125;\n\tdelete []v;\n\t/* 释放dv */\n\tdelete []dv;\n\t/* 释放to */\n\tdelete []to;\n\t/* 释放y */\n\tdelete []y;\n&#125;\n\n/* 使用指定数目的样本训练指定数目次循环，返回最后的误差函数值 */\ndouble BP::train(int sampleCnt, int trainCnt)\n&#123;\n\tfillTrainDS(sampleCnt);\n\tdouble e;\n\twhile(trainCnt--)\n\t&#123;\n\t\te = 0;\n\t\tfor(int i = 0 ; i &lt; trainDS.size() ; i++)\n\t\t&#123;\n\t\t\t/* 预测 */\n\t\t\tforward(i);\n\t\t\t/* 误差积累 */\n\t\t\tfor(int j = 0 ; j &lt; O ; j++)\n\t\t\t&#123;\n\t\t\t\te += pow(y[j] - trainDS[i].d[j], 2.0);\n\t\t\t&#125;\n\t\t\t/* 调整 */\n\t\t\tbackward(i);\n\t\t&#125;\n\t\te /= 2*sampleCnt;\n\t\t/* 学习速率衰减 */\n\t\tif (LR &gt; 0.01)\n\t\t&#123;\n\t\t\tLR *= LRDecay;\n\t\t&#125;\n\t&#125;\n\tclearTrainDS();\n\treturn e;\n&#125;\n\n/*\n * 使用指定数目的样本循环训练。\n * 误差函数值进入可接受范围判定收敛并停止训练；\n * 到达最大训练次数时停止训练。\n * 返回是否收敛。\n */\nbool BP::trainTillConvergent(int sampleCnt, int maxEpoch)\n&#123;\n\tfillTrainDS(sampleCnt);\n\tdouble e;\n\tfor(;;)\n\t&#123;\n\t\te = 0;\n\t\tfor(int i = 0 ; i &lt; trainDS.size() ; i++, maxEpoch--)\n\t\t&#123;\n\t\t\tif (!maxEpoch)\n\t\t\t&#123;\n\t\t\t\tclearTrainDS();\n\t\t\t\treturn false;\n\t\t\t&#125;\n\t\t\t/* 预测 */\n\t\t\tforward(i);\n\t\t\t/* 误差积累 */\n\t\t\tfor(int j = 0 ; j &lt; O ; j++)\n\t\t\t&#123;\n\t\t\t\te += pow(y[j] - trainDS[i].d[j], 2.0);\n\t\t\t&#125;\n\t\t\t/* 调整 */\n\t\t\tbackward(i);\n\t\t&#125;\n\t\t/* 判定收敛，中止训练 */\n\t\tif (e/(2*sampleCnt) &lt; C)\n\t\t&#123;\n\t\t\tclearTrainDS();\n\t\t\treturn true;\n\t\t&#125;\n\t\t/* 学习速率衰减 */\n\t\tif (LR &gt; 0.01)\n\t\t&#123;\n\t\t\tLR *= LRDecay;\n\t\t&#125;\n\t&#125;\n\tclearTrainDS();\n\treturn false;\n&#125;\n\n/* 生成指定数目组数据测试当前神经网络 */\nvoid BP::testNetwork(int testCnt)\n&#123;\n\tfillTestDS(testCnt);\n\tdouble e = 0;\n\tfor(int i = 0 ; i &lt; testCnt ; i++)\n\t&#123;\n\t\tforward(i, true);\n\t\tfor(int j = 0 ; j &lt; O ; j++)\n\t\t&#123;\n\t\t\te += pow(y[j] - testDS[i].d[j], 2.0);\n\t\t&#125;\n\t&#125;\n\tcout &lt;&lt; testCnt &lt;&lt; &quot;组数据测试预测值相对期望值方差为：&quot; &lt;&lt; e/(2*testCnt) &lt;&lt; endl;\n\tclearTestDS();\n&#125;\n\n/* 保存当前神经网络，即两个权重数组 */\nvoid BP::saveNetwork(string wPath, string vPath)\n&#123;\n\tofstream fout_w(wPath);\n\tif(fout_w == NULL)\n\t&#123;\n\t\tcout &lt;&lt; &quot;打开文件失败&quot; &lt;&lt; endl;\n\t\treturn;\n\t&#125;\n\tfor(int i = 0 ; i &lt; I ; i++)\n\t&#123;\n\t\tfor(int j = 0 ; j &lt; H ; j++)\n\t\t&#123;\n\t\t\tfout_w &lt;&lt; w[i][j] &lt;&lt; &#39;\\t&#39;;\n\t\t&#125;\n\t\tfout_w &lt;&lt; &#39;\\n&#39;;\n\t&#125;\n\tfout_w.close();\n\tofstream fout_v(vPath);\n\tif(fout_v == NULL)\n\t&#123;\n\t\tcout &lt;&lt; &quot;打开文件失败&quot; &lt;&lt; endl;\n\t\treturn;\n\t&#125;\n\tfor(int i = 0 ; i &lt; H ; i++)\n\t&#123;\n\t\tfor(int j = 0 ; j &lt; O ; j++)\n\t\t&#123;\n\t\t\tfout_v &lt;&lt; v[i][j] &lt;&lt; &#39;\\t&#39;;\n\t\t&#125;\n\t\tfout_v &lt;&lt; &#39;\\n&#39;;\n\t&#125;\n\tfout_v.close();\n&#125;\n\n/* 载入两个权重数组，还原神经网络 */\nvoid BP::loadNetwork(string wPath, string vPath)\n&#123;\n\tifstream fin_w(wPath);\n\tif(fin_w == NULL)\n\t&#123;\n\t\tcout &lt;&lt; &quot;打开文件失败&quot; &lt;&lt; endl;\n\t\treturn;\n\t&#125;\n\tfor(int i = 0 ; i &lt; I ; i++)\n\t&#123;\n\t\tfor(int j = 0 ; j &lt; H ; j++)\n\t\t&#123;\n\t\t\tfin_w &gt;&gt; w[i][j];\n\t\t&#125;\n\t&#125;\n\tfin_w.close();\n\tifstream fin_v(vPath);\n\tif(fin_v == NULL)\n\t&#123;\n\t\tcout &lt;&lt; &quot;打开文件失败&quot; &lt;&lt; endl;\n\t\treturn;\n\t&#125;\n\tfor(int i = 0 ; i &lt; H ; i++)\n\t&#123;\n\t\tfor(int j = 0 ; j &lt; O ; j++)\n\t\t&#123;\n\t\t\tfin_v &gt;&gt; v[i][j];\n\t\t&#125;\n\t&#125;\n\tfin_v.close();\n&#125;\n\n/* 使用指定数据预测输出值并返回输出值 */\nvector&lt;double&gt; BP::runNetwork(vector&lt;double&gt; x)\n&#123;\n\t/* 隐含层 */\n\tfor(int i = 0 ; i &lt; H ; i++)\n\t&#123;\n\t\tu[i] = 0;\n\t\tfor(int j = 0 ; j &lt; x.size() ; j++)\n\t\t&#123;\n\t\t\t/* 积累输入 */\n\t\t\tu[i] += w[j][i]*x[j];\n\t\t&#125;\n\t\tu[i] += th[i];\n\t\t/* Sigmoid函数作为激活函数 */\n\t\tu[i] = 1 / (1 + exp(-1*u[i]));\n\t&#125;\n\tvector&lt;double&gt; o;\n\tdouble y;\n\t/* 输出层 */\n\tfor(int i = 0 ; i &lt; O ; i++)\n\t&#123;\n\t\ty = 0;\n\t\tfor(int j = 0 ; j &lt; H ; j++)\n\t\t&#123;\n\t\t\t/* 积累输入 */\n\t\t\ty += v[j][i]*u[j];\n\t\t&#125;\n\t\ty += to[i];\n\t\t/* 分类：Sigmoid函数作为激活函数 */\n\t\tif (!regression)\n\t\t&#123;\n\t\t\ty = 1 / (1 + exp(-1*y));\n\t\t&#125;\n\t\to.push_back(y);\n\t&#125;\n\treturn o;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 类的测试方法里无非是根据实际问题初始化类，做一系列的训练，调整参数，慢慢提高预测精度，test.cpp：</p>\n<pre><code class=\"hljs\">#include &quot;BP.h&quot;\n#include &lt;iostream&gt;\n\nusing namespace std;\n\nint main()\n&#123;\n\t/*\n\t * 类构造函数，初始化BP神经网络结构和训练参数\n\t * int _I：\t\t输入参数数目，包括偏置值对应的参数-1。\n\t * int _O：\t\t输出值数目。\n\t * int A：\t\t隐含层调整因子（1~10）。\n\t * double _LR：\t\t学习速率（0.01~0.8）。\n\t * double _LR2：\t偏置学习速率（0.01~0.8）。\n\t * double _LRDecay：\t学习速率衰减率（每次衰减与当前LR相乘）。\n\t * double _C：\t\t误差函数收敛阈值。\n\t * bool regression：\t拟合标识。\n\t */\n\tBP o(7, 2, 8, 0.2, 0.02, 0.99, 3.2e-2, false);\n\n\t// o.loadNetwork();\n\n\t/* 使用指定数目的样本训练指定数目次循环，返回最后的误差函数值 */\n\tfor(int i = 0 ; i &lt; 20 ; i++)\n\t&#123;\n\t\tcout &lt;&lt; &quot;误差函数值：&quot; &lt;&lt; o.train(1000, 2e3) &lt;&lt; endl;\n\t&#125;\n\n\t/*\n\t * 使用指定数目的样本循环训练。\n\t * 误差函数值进入可接受范围判定收敛并停止训练；\n\t * 到达最大训练次数时停止训练。\n\t * 返回是否收敛。\n\t */\n\t// bool success = o.trainTillConvergent(1000, 1e5*1000);\n\t// cout &lt;&lt; &quot;收敛：&quot; &lt;&lt; (success ? &quot;success&quot; : &quot;fail&quot;) &lt;&lt; endl;\n\n\to.testNetwork(1000);\n\n\to.saveNetwork();\n\n\tvector&lt;double&gt; X;\n\tdouble x = 0.1;\n\tdouble y = 0.1;\n\tdouble z = 0.1;\n\tdouble a = 1;\n\tdouble b = 1;\n\tdouble c = 1;\n\tdouble d = -1;\n\tX.push_back((x + 10)/20.0);\n\tX.push_back((y + 10)/20.0);\n\tX.push_back((z + 10)/20.0);\n\tX.push_back((a + 10)/20.0);\n\tX.push_back((b + 10)/20.0);\n\tX.push_back((c + 10)/20.0);\n\tX.push_back((d + 10)/20.0);\n\tvector&lt;double&gt; Y = o.runNetwork(X);\n\t/* 拟合 */\n\t// cout &lt;&lt; &quot;期望值：&quot; &lt;&lt; z - (a*x + b*y + d)/(-c) &lt;&lt; endl;\n\t// cout &lt;&lt; &quot;输出值：&quot; &lt;&lt; Y[0] &lt;&lt; endl;\n\t/* 分类 */\n\tcout &lt;&lt; &quot;期望值：&quot; &lt;&lt; (z &gt; (a*x + b*y + d)/(-c) ? &quot;1\\t0&quot; : &quot;0\\t1&quot;) &lt;&lt; endl;\n\tcout &lt;&lt; &quot;输出值：&quot; &lt;&lt; Y[0] &lt;&lt; &#39;\\t&#39; &lt;&lt; Y[1] &lt;&lt; endl;\n\n\treturn 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 点分类问题我先尝试了函数拟合方式，训练情况很糟糕，动辄上十万的方差。后来改用分类方式，降低训练要求，方差立马降下来了。下午例会就要做报告了，我没有训练到充分收敛，但是离平面比较远的点判断正确率已经很高了。下面提供平面分类点集问题当前训练进度下，输入层与隐含层间权重数组、隐含层与输出层间权重数组的保存文件。</p>\n<p>&nbsp;&nbsp;&nbsp; 输入层与隐含层间权重数组wNetwork：</p>\n<pre><code class=\"hljs\">0.15513\t0.56829\t0.461073\t0.27552\t0.44408\t0.144657\t0.95798\t0.335522\t0.325092\t0.254423\t0.79217\n-1.06417\t-0.0241895\t3.99915\t0.228275\t-0.483658\t6.68402\t-1.61574\t0.753689\t4.14272\t-4.58112\t-3.09481\n3.70442\t-3.7423\t0.0852013\t-0.564758\t-4.99619\t1.29436\t-4.19077\t-1.75579\t-0.568722\t-2.57748\t1.20149\n-0.311858\t2.12485\t0.494471\t-3.32854\t-0.393046\t1.12112\t-0.585242\t-3.45739\t-0.687711\t-1.37346\t-0.860532\n1.29214\t0.74987\t4.41025\t-1.37666\t0.268284\t6.72309\t2.0978\t-1.8259\t4.20105\t-6.15165\t5.04569\n-3.76331\t-3.22432\t-0.450262\t1.77063\t-5.89358\t3.40051\t3.64122\t1.30879\t-0.98291\t-0.931413\t-1.72719\n9.53636\t9.64562\t9.82743\t13.4779\t-12.3668\t12.5147\t8.37658\t6.32437\t-10.263\t-13.8476\t-5.31933\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 隐含层与输出层间权重数组vNetwork：</p>\n<pre><code class=\"hljs\">31.4711\t-31.5094\n27.536\t-27.5713\n-25.7692\t25.7999\n-27.4329\t27.467\n-17.6709\t17.6933\n-18.464\t17.5204\n25.8167\t-25.8471\n-23.2151\t23.2434\n27.3533\t-27.387\n26.9126\t-26.9519\n-24.7905\t24.8209\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 这个类我还做过a+b问题的函数拟合，收敛非常顺利，精度很高。<br>&nbsp;&nbsp;&nbsp; <strong>后来，例会上提任务的博士说他明明是要我们寻找分割点集的平面，我把问题泛化成寻找点与平面位置关系规则的问题了，能用泛化能力不太强的BP整的差不多收敛也是不容易。我表示生无可恋……</strong></p>\n<p>&nbsp;&nbsp;&nbsp; <strong>读者注意一下，上一篇BP网络的理论介绍中，隐层与输入层之间的权重调整值的推导有一些问题，少乘了一个wij。推导已经改过来了，但是比较忙没空改代码，有需要的同学请自己参照上一篇博文修改一下代码。OTZ</strong></p>\n",
            "tags": [
                "C++",
                "BP神经网络",
                "机器学习"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/10/09/BP%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/",
            "url": "https://blog.bipedalbit.net/2015/10/09/BP%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/",
            "title": "BP神经网络",
            "date_published": "2015-10-09T04:45:11.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 组里要求新人手写个BP神经网络练练手先，具体要求是用一个平面把空间点集二分类，建模时我发现这个问题比起分类来更接近一个多元函数拟合，当然分类也不是不行，机器学习的要求更低，更容易有更好的结果。这都是后话，这篇文我决定先来总结一下BP神经网络的概念，也算是前几天的学习笔记了。</p>\n<span id=\"more\"></span>\n<h1 id=\"1-机器学习\"><a href=\"#1-机器学习\" class=\"headerlink\" title=\"1. 机器学习\"></a>1. 机器学习</h1><p>&nbsp;&nbsp;&nbsp; 百度百科说机器学习(Machine Learning, ML)是一门多领域交叉学科，涉及概率论、统计学、逼近论、凸分析、算法复杂度理论等多门学科。简而言之，机器学习专门研究计算机怎样<strong>模拟或实现人类的学习行为</strong>，以获取新的知识或技能，重新组织已有的知识结构使之不断改善自身的性能。机器学习是人工智能的核心，是使计算机具有智能的<strong>根本途径</strong>，其应用遍及人工智能的各个领域，它主要使用<strong>归纳、综合而不是演绎</strong>。<br>&nbsp;&nbsp;&nbsp; 机器学习的方向很多，其历史和兴衰说来话长，这里引入机器学习的概念只是为了做个铺垫，就不展开了。</p>\n<h1 id=\"2-人工神经网络\"><a href=\"#2-人工神经网络\" class=\"headerlink\" title=\"2. 人工神经网络\"></a>2. 人工神经网络</h1><p>&nbsp;&nbsp;&nbsp; 人工神经网络（Artificial Neural Network，ANN ）是人工智能的一支，是机器学习的一个方向，试图通过数学模型和适当的数据结构还原智能的温床——神经系统。我们知道人类大脑信息的传递、对外界刺激产生反应都是由一种特化的细胞——神经元来负责，人脑就是由上百亿个神经元构成。这些神经元之间并不孤立而且联系很密切，每个神经元平均与几千个神经元相连接，因此构成了一个神经网络。<br>&nbsp;&nbsp;&nbsp; 刺激在神经网络中的传播是遵循一定的规则的，一个神经元并非每次接到其他神经传递过来的刺激都产生反应。它首先会将与其相邻的神经元传来的刺激进行积累，到一定的时候产生自己的刺激将其传递给一些与它相邻的神经元。遵循同样规则工作着的百亿个的神经元完成了人脑对外界的反应。而人脑对外界刺激的学习过程则是通过这些神经元之间联系的建立及其强度的调整来完成的。<br>&nbsp;&nbsp;&nbsp; 当然，事实上，上述生物模型是对真正神经网络工作机制的一种简化，这种简化的生物模型可以推广至机器学习中，并以数学模型为理论基础，用不同的编程方式来实现。这种对神经网络的模拟，称为人工神经网络。</p>\n<h2 id=\"2-1-人工神经元（Artificial-Neuron，AN）模型\"><a href=\"#2-1-人工神经元（Artificial-Neuron，AN）模型\" class=\"headerlink\" title=\"2.1. 人工神经元（Artificial Neuron，AN）模型\"></a>2.1. 人工神经元（Artificial Neuron，AN）模型</h2><p>&nbsp;&nbsp;&nbsp; AN是ANN的基本元素之一，其原理如下图。<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E5%85%83%E6%A8%A1%E5%9E%8B.jpg\" alt=\"图1 人工神经元模型\" title=\"人工神经元模型\"><br>&nbsp;&nbsp;&nbsp; 图中x1~xn是从其他神经元传来的输入信号，wij表示表示从神经元j到神经元i的连接权值，θ表示一个偏置( bias )。则神经元i的输出与输入的关系表示为：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E7%A5%9E%E7%BB%8F%E5%85%83%E8%BE%93%E5%85%A5%E7%A7%AF%E7%B4%AF1.png\" title=\"净激活\"><br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E7%A5%9E%E7%BB%8F%E5%85%83%E8%BE%93%E5%87%BA3.png\" title=\"激活输出\"><br>&nbsp;&nbsp;&nbsp; 图中 yi表示神经元i的输出，函数f称为激活函数 ( Activation Function )，net称为净激活(net activation)。<br>&nbsp;&nbsp;&nbsp; 如果令一个输入参数x0为-1，对应权重为偏置θ，则可以把偏置项合并进净激活net：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E7%A5%9E%E7%BB%8F%E5%85%83%E8%BE%93%E5%85%A5%E7%A7%AF%E7%B4%AF2.png\" title=\"合并偏置的净激活\"><br>&nbsp;&nbsp;&nbsp; 若令X为输入向量，W为权重向量，则有：</p>\n<p align=\"center\"><span style=\"font-size:16px\">X = [ x0 , x1 , x2 , ....... , xn ]</span></p>\n![](https://cdn.minio.bipedalbit.net/bipedalbit-net-images/人工神经网络/权重向量.png \"权重向量\")\n&nbsp;&nbsp;&nbsp; 将神经元的输出表示为向量相乘的形式则有：\n![](https://cdn.minio.bipedalbit.net/bipedalbit-net-images/人工神经网络/神经元输出1.png \"净激活\")\n![](https://cdn.minio.bipedalbit.net/bipedalbit-net-images/人工神经网络/神经元输出2.png \"神经元输出\")\n&nbsp;&nbsp;&nbsp; 若神经元的净激活net为正，称该神经元处于激活状态或兴奋状态，若净激活net为负，则称神经元处于抑制状态。\n&nbsp;&nbsp;&nbsp; 图1中的这种“阈值加权和”的神经元模型称为M-P模型 ( McCulloch-Pitts Model )，也称为神经网络的一个处理单元( PE, Processing Element )。\n## 2.2. 常用激活函数\n\n<p>&nbsp;&nbsp;&nbsp; 前面的神经元模型讲解中也提到了激活函数，事实上，激活函数是人工神经网络中的一个重要环节。下面介绍一些常用的激活函数。</p>\n<h3 id=\"2-2-1-线性函数（Liner-Function）\"><a href=\"#2-2-1-线性函数（Liner-Function）\" class=\"headerlink\" title=\"2.2.1. 线性函数（Liner Function）\"></a>2.2.1. 线性函数（Liner Function）</h3><p><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E7%BA%BF%E6%80%A7%E5%87%BD%E6%95%B0.png\" title=\"线性函数\"></p>\n<h3 id=\"2-2-2-斜面函数（Ramp-Function）\"><a href=\"#2-2-2-斜面函数（Ramp-Function）\" class=\"headerlink\" title=\"2.2.2. 斜面函数（Ramp Function）\"></a>2.2.2. 斜面函数（Ramp Function）</h3><p><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E6%96%9C%E9%9D%A2%E5%87%BD%E6%95%B0.png\" title=\"斜面函数\"></p>\n<h3 id=\"2-2-3-阈值函数（Threshold-Function）\"><a href=\"#2-2-3-阈值函数（Threshold-Function）\" class=\"headerlink\" title=\"2.2.3. 阈值函数（Threshold Function）\"></a>2.2.3. 阈值函数（Threshold Function）</h3><p><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E9%98%88%E5%80%BC%E5%87%BD%E6%95%B0.png\" title=\"阈值函数\"></p>\n<h3 id=\"2-2-4-S形函数（Sigmoid-Function）\"><a href=\"#2-2-4-S形函数（Sigmoid-Function）\" class=\"headerlink\" title=\"2.2.4. S形函数（Sigmoid Function）\"></a>2.2.4. S形函数（Sigmoid Function）</h3><p><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/Sigmoid-S%E5%BD%A2%E5%87%BD%E6%95%B0.png\" title=\"S形函数\"><br>&nbsp;&nbsp;&nbsp; 导函数：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/S%E5%BD%A2%E5%87%BD%E6%95%B0%E5%AF%BC%E6%95%B0.png\" title=\"S形函数导函数\"></p>\n<h3 id=\"2-2-5-双极S形函数\"><a href=\"#2-2-5-双极S形函数\" class=\"headerlink\" title=\"2.2.5. 双极S形函数\"></a>2.2.5. 双极S形函数</h3><p><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E5%8F%8C%E6%9E%81S%E5%BD%A2%E5%87%BD%E6%95%B0.png\" title=\"双极S形函数\"><br>&nbsp;&nbsp;&nbsp; 导函数：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E5%8F%8C%E6%9E%81S%E5%BD%A2%E5%87%BD%E6%95%B0%E5%AF%BC%E6%95%B0.png\" title=\"双极S形函数导函数\"><br>&nbsp;&nbsp;&nbsp; S形函数与双极S形函数图像：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/S%E5%BD%A2%E5%87%BD%E6%95%B0%E4%B8%8E%E5%8F%8C%E6%9E%81S%E5%BD%A2%E5%87%BD%E6%95%B0%E5%9B%BE%E5%83%8F.png\" alt=\"图2 S形函数与双极S形函数图像\" title=\"S形函数与双极S形函数图像\"><br>&nbsp;&nbsp;&nbsp; 双极S形函数与S形函数主要区别在于函数的值域，双极S形函数值域是(-1,1)，而S形函数值域是(0,1)。<br>&nbsp;&nbsp;&nbsp; 由于S形函数与双极S形函数都是可导的，因此适合用在BP神经网络中。（BP算法要求激活函数可导）</p>\n<h2 id=\"2-3-神经网络模型\"><a href=\"#2-3-神经网络模型\" class=\"headerlink\" title=\"2.3. 神经网络模型\"></a>2.3. 神经网络模型</h2><p>&nbsp;&nbsp;&nbsp; 根据神经元互联方式的不同，神经网络可以分为3种常见类型。</p>\n<h3 id=\"2-3-1-前馈神经网络（Feedforward-Neural-Networks）\"><a href=\"#2-3-1-前馈神经网络（Feedforward-Neural-Networks）\" class=\"headerlink\" title=\"2.3.1. 前馈神经网络（Feedforward Neural Networks）\"></a>2.3.1. 前馈神经网络（Feedforward Neural Networks）</h3><p>&nbsp;&nbsp;&nbsp; 前馈网络也称前向网络。这种网络只在训练过程会有反馈信号，而在分类过程中数据只能向前传送，直到到达输出层，层间没有向后的反馈信号，因此被称为前馈网络。感知机( perceptron)与BP神经网络属于前馈网络。<br>&nbsp;&nbsp;&nbsp; 下图是一个3层的前馈神经网络，其中第一层是输入单元，第二层称为隐含层，第三层称为输出层（输入单元不是神经元，因此图中有2层神经元）。<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E5%89%8D%E9%A6%88%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C.jpg\" alt=\"图3 前馈神经网络\" title=\"前馈神经网络\"><br>&nbsp;&nbsp;&nbsp; N层的前馈神经网络每层的输入参数都要按权重积累，得到净激活后由激活函数激活输出。<br>&nbsp;&nbsp;&nbsp; 比如，一个三层的前馈神经网络的输出为<code>F3( F2 ( F1( XW1 ) W2 ) W3 )</code>。当F1、F2、F3都选用线性激活函数，输出将是线性函数。<br>&nbsp;&nbsp;&nbsp; <strong>所以，如果要做高次函数的拟合，应该选用适当的非线性激活函数。</strong></p>\n<h3 id=\"2-3-2-反馈神经网络（Feedback-Neural-Networks）\"><a href=\"#2-3-2-反馈神经网络（Feedback-Neural-Networks）\" class=\"headerlink\" title=\"2.3.2. 反馈神经网络（Feedback Neural Networks）\"></a>2.3.2. 反馈神经网络（Feedback Neural Networks）</h3><p>&nbsp;&nbsp;&nbsp; 反馈型神经网络是一种从输出到输入具有反馈连接的神经网络，其结构比前馈网络要复杂得多。典型的反馈型神经网络有Elman网络和Hopfield网络。<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E5%8F%8D%E9%A6%88%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C.jpg\" alt=\"图4 反馈神经网络\" title=\"反馈神经网络\"></p>\n<h3 id=\"2-3-3-竞争学习网络（Competitive-Learning-Network）\"><a href=\"#2-3-3-竞争学习网络（Competitive-Learning-Network）\" class=\"headerlink\" title=\"2.3.3. 竞争学习网络（Competitive Learning Network）\"></a>2.3.3. 竞争学习网络（Competitive Learning Network）</h3><p>&nbsp;&nbsp;&nbsp; 竞争学习网络是一种无监督学习网络。它通过自动寻找样本中的内在规律和本质属性，自组织、自适应地改变网络参数与结构。典型的竞争学习网络有SOM。<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E8%87%AA%E7%BB%84%E7%BB%87%E7%BD%91%E7%BB%9C.png\" alt=\"图5 竞争学习网络\" title=\"竞争学习网络\"></p>\n<h3 id=\"2-3-4-神经网络的状态\"><a href=\"#2-3-4-神经网络的状态\" class=\"headerlink\" title=\"2.3.4. 神经网络的状态\"></a>2.3.4. 神经网络的状态</h3><p>&nbsp;&nbsp;&nbsp; 神经网络的状态分学习（训练）状态和工作状态两种。<br>&nbsp;&nbsp;&nbsp; 学习状态又分为两种方式：监督学习（Supervised Learning）和非监督（Unsupervised Learning）学习。<br>&nbsp;&nbsp;&nbsp; 监督学习算法将一组训练数据集送入网络，根据网络的实际输出与期望输出间的差别来调整连接权。达到预设训练次数或者样本整体误差不超过预设范围（收敛）时学习结束。BP算法就是一种出色的监督学习算法。<br>&nbsp;&nbsp;&nbsp; 非监督学习算法抽取样本集合中蕴含的统计特性，并以神经元之间的联接权的形式存于网络中。Hebb学习律是一种经典的非监督学习算法。</p>\n<h3 id=\"2-3-5-非监督学习算法：Hebb学习律\"><a href=\"#2-3-5-非监督学习算法：Hebb学习律\" class=\"headerlink\" title=\"2.3.5. 非监督学习算法：Hebb学习律\"></a>2.3.5. 非监督学习算法：Hebb学习律</h3><p>&nbsp;&nbsp;&nbsp; Hebb算法核心思想是，当两个神经元同时处于激发状态时两者间的连接权会被加强，否则被减弱。<br>&nbsp;&nbsp;&nbsp; Hebb学习律可以表示为：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/Hebb%E5%AD%A6%E4%B9%A0%E5%BE%8B.png\" title=\"Hebb学习律\"><br>&nbsp;&nbsp;&nbsp; 其中wij表示神经元j到神经元i的连接权，yi与yj为两个神经元的输出，a是表示学习速率常数。若yi与yj同时被激活，即yi与yj同号，那 么wij将增大；若yi被激活，而yj处于抑制状态，即yi为正yj为负，那么wij将变小。</p>\n<h3 id=\"2-3-6-监督学习算法：Delta学习规则\"><a href=\"#2-3-6-监督学习算法：Delta学习规则\" class=\"headerlink\" title=\"2.3.6. 监督学习算法：Delta学习规则\"></a>2.3.6. 监督学习算法：Delta学习规则</h3><p>&nbsp;&nbsp;&nbsp; Delta学习规则的数学表达：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/Delta%E5%AD%A6%E4%B9%A0%E8%A7%84%E5%88%99.png\" title=\"Delta学习规则\"><br>&nbsp;&nbsp;&nbsp; 其中wij表示神经元j到神经元i的连接权，di是神经元i的期望输出，yi是神经元i的实际输出，xj表示神经元j状态，若神经元j处于激活态则xj为 1，若处于抑制状态则xj为0或－1（依激活函数而定）。a是表示学习速率常数。假设xi为1，若di比yi大，那么Wij将增大，若di比yi小， 那么wij将变小。<br>&nbsp;&nbsp;&nbsp; Delta规则简单讲来就是：若神经元实际输出比期望输出大，则减小所有输入为正的连接的权重，增大所有输入为负的连接的权重。反之，若神经元实际输出比期望输出小，则增大所有输入为正的连接的权重，减小所有输入为负的连接的权重。这个增大或减小的幅度就根据上面的式子来计算。</p>\n<h1 id=\"3-BP神经网络\"><a href=\"#3-BP神经网络\" class=\"headerlink\" title=\"3. BP神经网络\"></a>3. BP神经网络</h1><h2 id=\"3-1-认识BP神经网络\"><a href=\"#3-1-认识BP神经网络\" class=\"headerlink\" title=\"3.1. 认识BP神经网络\"></a>3.1. 认识BP神经网络</h2><p>&nbsp;&nbsp;&nbsp; BP神经网络更清晰的称呼应该是使用BP算法学习的前馈神经网络。BP神经网络中的BP为Back Propagation（反向传播）的简写，最早它是由Rumelhart、McCelland等科学家于1986年提出来的，Rumelhart还在《Nature》上发表了一篇非常著名的文章《Learning representations by back-propagating errors》。随着时代的迁移，BP神经网络理论不断的得到改进、更新，现在无疑已成为了应用最为广泛的神经网络模型之一。BP网络具有很强的非线性映射能力，一个3层BP神经网络能够实现对任意非线性函数进行逼近（根据Kolrnogorov定理：任意[0,1]上的连续函数能被一个3层的神经网络实现，其中输入单元数为n，隐含层单元数为2n+1）。</p>\n<h2 id=\"3-2-隐含层的选取\"><a href=\"#3-2-隐含层的选取\" class=\"headerlink\" title=\"3.2. 隐含层的选取\"></a>3.2. 隐含层的选取</h2><p>&nbsp;&nbsp;&nbsp; 在BP神经网络中，输入层和输出层的节点个数都是确定的，而隐含层节点个数不确定。实际上，隐含层节点个数的多少对神经网络的性能是有影响的，有一个经验公式可以确定隐含层神经元数目：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/BP%E9%9A%90%E5%90%AB%E5%B1%82%E7%BB%8F%E9%AA%8C%E5%85%AC%E5%BC%8F.png\" title=\"BP隐含层经验公式\"><br>&nbsp;&nbsp;&nbsp; 其中，h为隐含层神经元数，m为输入结点数，n为输出层神经元数，a为1~10之间的调节常数。</p>\n<h2 id=\"3-3-正向预测\"><a href=\"#3-3-正向预测\" class=\"headerlink\" title=\"3.3. 正向预测\"></a>3.3. 正向预测</h2><p>&nbsp;&nbsp;&nbsp; 就是使输入数据样本通过一个两层前馈网络，输出即：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/BP%E5%87%80%E6%BF%80%E6%B4%BB.png\" title=\"BP净激活\"><br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/BP%E7%A5%9E%E7%BB%8F%E5%85%83%E8%BE%93%E5%87%BA.png\" title=\"BP神经元输出\"></p>\n<h2 id=\"3-4-反向误差传播\"><a href=\"#3-4-反向误差传播\" class=\"headerlink\" title=\"3.4. 反向误差传播\"></a>3.4. 反向误差传播</h2><p>&nbsp;&nbsp;&nbsp; BP算法是基于Widrow-Hoff学习规则的，可以看做delta学习规则的一种特殊情况。Widrow-Hoff学习规则是通过沿着相对误差平方和的最速下降方向（梯度方向），连续调整网络的权重和偏置。根据梯度下降法，权重矢量的修正正比于当前位置上E(w,b)的梯度的模，即E(w,b)在当前位置的偏导数。我们知道函数<code>z = f(x,y)</code>中，z对x或y的偏导数即z随x或y变化的程度或快慢，这正切合BP神经网络中每层输入参数权重的意义，也印证了梯度下降法的正确性。对于第j个输出神经元有：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/BP%E8%BE%93%E5%87%BA%E5%B1%82%E6%9D%83%E5%80%BC%E4%BF%AE%E6%AD%A3.png\" title=\"输出层权值修正\"><br>&nbsp;&nbsp;&nbsp; 其中i是隐含层神经元的序号。<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%95%E6%8E%A8%E5%AF%BC1.png\" title=\"误差函数对权重的偏导\"><br>&nbsp;&nbsp;&nbsp; 其中n是输出层神经元数，m是隐含层神经元数，于是得到：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%95%E6%8E%A8%E5%AF%BC2.png\" title=\"误差函数对权重偏导2\"><br>&nbsp;&nbsp;&nbsp; 已知Sigmoid函数的导函数：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/S%E5%BD%A2%E5%87%BD%E6%95%B0%E5%AF%BC%E6%95%B0.png\" title=\"Sigmoid函数导函数\"><br>&nbsp;&nbsp;&nbsp; 于是有：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%95%E6%8E%A8%E5%AF%BC3.png\" title=\"误差函数对权重偏导3\"><br>&nbsp;&nbsp;&nbsp; 同理，对输出层偏置bj有：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%95%E6%8E%A8%E5%AF%BC4.png\" title=\"输出层偏置\"><br>&nbsp;&nbsp;&nbsp; 以上就是著名的<strong>delta学习规则</strong>，通过改变神经元之间的连接权值来减少系统实际输出和期望输出的误差，这个规则又叫做<strong>Widrow-Hoff学习规则</strong>或者<strong>纠错学习规则</strong>。<br>&nbsp;&nbsp;&nbsp; 设k为输入层的节点序号，下面继续推导输入层与隐含层的权重修正：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%95%E6%8E%A8%E5%AF%BC5.png\" title=\"误差函数对权重偏导4\"><br>&nbsp;&nbsp;&nbsp; 其中l是输入层节点数，yi也是前面推导隐含层与输出层间权重修正时的xi，于是有：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%95%E6%8E%A8%E5%AF%BC6.png\" title=\"误差函数对权重偏导5\"><br>&nbsp;&nbsp;&nbsp; 同理，对隐含层偏置bi有：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%95%E6%8E%A8%E5%AF%BC7.png\" title=\"隐含层偏置\"><br>&nbsp;&nbsp;&nbsp; 最后，输入层与隐含层间权重和偏置，隐含层与输出层间权重和偏置的修正值如下：<br><img src=\"https://cdn.minio.bipedalbit.net/bipedalbit-net-images/%E4%BA%BA%E5%B7%A5%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/%E6%A2%AF%E5%BA%A6%E4%B8%8B%E9%99%8D%E6%B3%95%E6%8E%A8%E5%AF%BC8.png\" title=\"最终修正值\"><br>&nbsp;&nbsp;&nbsp; 其中，eita1和eita2分别是权重学习速率和偏置学习速率。</p>\n<h2 id=\"3-5-注意点\"><a href=\"#3-5-注意点\" class=\"headerlink\" title=\"3.5. 注意点\"></a>3.5. 注意点</h2><ul>\n<li>输入数据要先进行归一化处理。例如使用Sigmoid函数作为激活函数时，输入参数如果分布在Sigmoid函数曲线的稳定区域中，即定义域的[-1,1]区间之外的区域，那么激活值将集中在0和1上，权重对输入参数的加权作用将失去意义，输入参数对权重的调整也将失去意义。</li>\n<li>学习速率大的时候收敛速度快精度小，收敛曲线颠簸；学习速率小收敛速度慢精度大，收敛曲线平滑。</li>\n<li>BP神经网络通常用于分类器和函数拟合，如果作为分类器，激活函数一般选用Sigmoid函数；如果做函数拟合，<strong>输出层</strong>的激活函数应该用线性函数即<code>f(x) = x</code>。</li>\n<li>BP神经网络训练过程中可以采用<strong>增量学习</strong>或<strong>批量学习</strong>，即分批临时生成新的训练数据样本并输入当前网络，分阶段逐步学习；或者预生成所有训练数据样本，学习到出结果为止。</li>\n</ul>\n<h2 id=\"3-6-缺陷\"><a href=\"#3-6-缺陷\" class=\"headerlink\" title=\"3.6. 缺陷\"></a>3.6. 缺陷</h2><ul>\n<li>BP神经网络训练时容易陷入局部极小值”假收敛“而得不到全局最优值，如果出现”假收敛“，只能重新随机初始化权重。</li>\n<li>BP神经网络需要的训练次数多，收敛比较慢。</li>\n<li>隐含层神经元数的选取缺乏理论指导。</li>\n<li>训练时学习新样本有遗忘旧样本的趋势，即“BP已死”这一说法的根源——泛化能力弱。</li>\n</ul>\n<h2 id=\"3-7-改进\"><a href=\"#3-7-改进\" class=\"headerlink\" title=\"3.7. 改进\"></a>3.7. 改进</h2><ul>\n<li>加入动量项，即记录上一次权重变化，通过变量因子确定继承上一次权重变化的程度，目的是使权重的调整方向不至于来回颠簸太厉害，表现在误差函数值上则是能令收敛曲线更趋平缓。</li>\n<li>自适应的调整学习因子，即当权重调整到一定程度，不降低学习程度就无法更精细的使神经网络中的关系靠近理想关系。这时需要适量的减小学习因子，一般采取给学习因子添加衰减率的方式。</li>\n<li>通过蚁群算法、遗传算法等算法优化BP神经网络。</li>\n</ul>\n",
            "tags": [
                "BP神经网络",
                "机器学习",
                "人工神经网络"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/10/08/C-%E4%BA%8C%E8%BF%9B%E5%88%B6-%E5%8D%81%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2%E5%99%A8/",
            "url": "https://blog.bipedalbit.net/2015/10/08/C-%E4%BA%8C%E8%BF%9B%E5%88%B6-%E5%8D%81%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2%E5%99%A8/",
            "title": "C++二进制-十进制转换器",
            "date_published": "2015-10-08T14:05:52.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 布置了二进制-十进制转换器的小作业，本来还要求顺手扩展一下大数的四则运算，我嫌麻烦没做扩展，就只是写来玩玩。也算熟悉一下底层的二进制-十进制转换机制，顺便复习下C++源码规范。注释写了很多，就不多做解释了，只贴代码。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; converter.h:</p>\n<pre><code class=\"hljs\">/*\n * Copyright (C) Bipedal Bit\n * Verson 1.0.0.1\n */\n\n#ifndef _CONVERTER_H_\n#define _CONVERTER_H_\n\n#include &lt;string&gt;\n\n/*\n * This is a class to offer operations converting radix of number in string.\n */\nclass Converter\n&#123;\nprivate:\n\t/* to store the binary form of picked up number string */\n\tstd::string binVal;\n\t/* to store the decimal form of picked up number string */\n\tstd::string decVal;\n\t/* to sign the number by marking wether it is negtive */\n\tbool negtive;\n\t/* to mark wether the number has a dot */\n\tbool hasDot;\n\t/* to store the index of dot in binary number string */\n\tint binDotIndex;\n\t/* to store the index of dot in decimal number string */\n\tint decDotIndex;\n\t/* max reserved digits sum when float converted from decimal to binary */\n\tint binFloatPrecision;\n\t/*\n\t * Convert the binary number to decimal form then fill this-&gt;decVal.\n\t */\n\tvoid bin2Dec();\n\t/*\n\t * Convert the decimal number to binary form then fill this-&gt;binVal.\n\t */\n\tvoid dec2Bin();\npublic:\n\t/*\n\t * Constructor of the class to pick up number in string and fill both this-&gt;binVal and this-&gt;decVal.\n\t */\n\tConverter(std::string str, int radix, int binFloatPrecision = 20);\n\t/*\n\t * Get the the number string with specified radix.\n\t */\n\tstd::string getNum(int radix);\n&#125;;\n\n#endif\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; converter.cpp:</p>\n<pre><code class=\"hljs\">/*\n * Copyright (C) Bipedal Bit\n * Verson 1.0.0.1\n */\n\n #include &quot;converter.h&quot;\n #include &lt;iostream&gt;\n #include &lt;stdexcept&gt;\n\n/*\n * name: Converter\n * args:\n *\tstring str: the original string containing target number\n *\tint radix: the radix of the number to pick up form str\n *\tint binFloatPrecision: max reserved digits sum when float converted from decimal to binary\n *\t\twhose default value is 20\n * Constructor of the class to pick up number in string and fill both this-&gt;binVal and this-&gt;decVal.\n */\n Converter::Converter(std::string str, int radix, int binFloatPrecision)\n&#123;\n\t/* check radix */\n\tif (radix != 2 &amp;&amp; radix != 10)\n\t&#123;\n\t\tstd::cerr &lt;&lt; &quot;Invalid argument: Do not support radixes beyond binary and decimal yet.\\n&quot;;\n\t\treturn;\n\t&#125;\n\t/* check binFloatPrecision */\n\tif (binFloatPrecision &lt; 1)\n\t&#123;\n\t\tstd::cerr &lt;&lt; &quot;Invalid argument: binFloatPrecision should be greater than 0.\\n&quot;;\n\t\treturn;\n\t&#125;\n\t/* fill this-&gt;binFloatPrecision */\n\tthis-&gt;binFloatPrecision = binFloatPrecision;\n\t/* assistant variables for traversing the original string */\n\tint len = str.size();\n\tint i = 0;\n\t/* mark wether there&#39;s a dot in the number */\n\tbool hasDot = false;\n\t/* store number string temporarily */\n\tstd::string tmp = &quot;&quot;;\n\tif (len &gt; 0)\n\t&#123;\n\t\t/* handle binary radix */\n\t\tif (radix == 2)\n\t\t&#123;\n\t\t\t/* remove useless characters */\n\t\t\twhile(str[i] != &#39;-&#39; &amp;&amp; str[i] != &#39;0&#39; &amp;&amp; str[i] != &#39;1&#39;)\n\t\t\t&#123;\n\t\t\t\ti++;\n\t\t\t&#125;\n\t\t\t/* pick up &#39;-&#39; */\n\t\t\tif(str[i] == &#39;-&#39;)\n\t\t\t&#123;\n\t\t\t\tthis-&gt;negtive = true;\n\t\t\t\ti++;\n\t\t\t&#125;\n\t\t\telse\n\t\t\t&#123;\n\t\t\t\tthis-&gt;negtive = false;\n\t\t\t&#125;\n\t\t\t/* remove spare &#39;0&#39;s */\n\t\t\twhile(str[i] == &#39;0&#39;)\n\t\t\t&#123;\n\t\t\t\ti++;\n\t\t\t&#125;\n\t\t\t/* get numbers */\n\t\t\tfor(; i &lt; len ; i++)\n\t\t\t&#123;\n\t\t\t\t/* get first dot only */\n\t\t\t\tif (!hasDot &amp;&amp; str[i] == &#39;.&#39;)\n\t\t\t\t&#123;\n\t\t\t\t\thasDot = true;\n\t\t\t\t\ttmp += &#39;.&#39;;\n\t\t\t\t\tcontinue;\n\t\t\t\t&#125;\n\t\t\t\t/* get &#39;0&#39;s and &#39;1&#39;s only */\n\t\t\t\tif (str[i] != &#39;0&#39; &amp;&amp; str[i] != &#39;1&#39;)\n\t\t\t\t&#123;\n\t\t\t\t\tbreak;\n\t\t\t\t&#125;\n\t\t\t\ttmp += str[i];\n\t\t\t&#125;\n\t\t&#125;\n\t\t/* handle decimal radix */\n\t\telse\n\t\t&#123;\n\t\t\t/* remove useless characters */\n\t\t\twhile(str[i] != &#39;-&#39; &amp;&amp; !(str[i] &gt;= &#39;0&#39; &amp;&amp; str[i] &lt;= &#39;9&#39;))\n\t\t\t&#123;\n\t\t\t\ti++;\n\t\t\t&#125;\n\t\t\t/* pick up &#39;-&#39; */\n\t\t\tif(str[i] == &#39;-&#39;)\n\t\t\t&#123;\n\t\t\t\tthis-&gt;negtive = true;\n\t\t\t\ti++;\n\t\t\t&#125;\n\t\t\telse\n\t\t\t&#123;\n\t\t\t\tthis-&gt;negtive = false;\n\t\t\t&#125;\n\t\t\t/* remove spare &#39;0&#39;s */\n\t\t\twhile(str[i] == &#39;0&#39;)\n\t\t\t&#123;\n\t\t\t\ti++;\n\t\t\t&#125;\n\t\t\t/* get numbers */\n\t\t\tfor(; i &lt; len ; i++)\n\t\t\t&#123;\n\t\t\t\t/* get first dot only */\n\t\t\t\tif (!hasDot &amp;&amp; str[i] == &#39;.&#39;)\n\t\t\t\t&#123;\n\t\t\t\t\thasDot = true;\n\t\t\t\t\ttmp += &#39;.&#39;;\n\t\t\t\t\tcontinue;\n\t\t\t\t&#125;\n\t\t\t\t/* get all arabic numerals */\n\t\t\t\tif(!(str[i] &gt;= &#39;0&#39; &amp;&amp; str[i] &lt;= &#39;9&#39;))\n\t\t\t\t&#123;\n\t\t\t\t\tbreak;\n\t\t\t\t&#125;\n\t\t\t\ttmp += str[i];\n\t\t\t&#125;\n\t\t&#125;\n\t&#125;\n\t/* if no number picked up set 0 */\n\tif(tmp == &quot;&quot;)\n\t&#123;\n\t\ttmp = &quot;0&quot;;\n\t&#125;\n\t/* add &#39;0&#39; if necessary */\n\tif (tmp[0] == &#39;.&#39;)\n\t&#123;\n\t\ttmp = &#39;0&#39; + tmp;\n\t&#125;\n\t/* mark wether the number has a dot */\n\tthis-&gt;hasDot = hasDot;\n\t/* fill corresponding number form */\n\tif (radix == 2)\n\t&#123;\n\t\tthis-&gt;binVal = tmp;\n\t\tif (hasDot)\n\t\t&#123;\n\t\t\t/* store dot&#39;s index in the number string of binary form */\n\t\t\tthis-&gt;binDotIndex = tmp.find(&#39;.&#39;);\n\t\t&#125;\n\t\tbin2Dec();\n\t&#125;\n\telse\n\t&#123;\n\t\tthis-&gt;decVal = tmp;\n\t\tif (hasDot)\n\t\t&#123;\n\t\t\t/* store dot&#39;s index in the number string of decimal form */\n\t\t\tthis-&gt;decDotIndex = tmp.find(&#39;.&#39;);\n\t\t&#125;\n\t\tdec2Bin();\n\t&#125;\n\t/* have a test */\n/*\n\tstd::cout &lt;&lt; &quot;radix: 2&quot; &lt;&lt; std::endl;\n\tif(this-&gt;negtive)\n\t&#123;\n\t\tstd::cout &lt;&lt; &#39;-&#39;;\n\t&#125;\n\tstd::cout &lt;&lt; this-&gt;binVal &lt;&lt; std::endl;\n\tstd::cout &lt;&lt; &quot;radix: 10&quot; &lt;&lt; std::endl;\n\tif(this-&gt;negtive)\n\t&#123;\n\t\tstd::cout &lt;&lt; &#39;-&#39;;\n\t&#125;\n\tstd::cout &lt;&lt; this-&gt;decVal &lt;&lt; std::endl;\n*/\n&#125;\n\n/*\n * name: getNum\n * arguments:\n *\tint radix: spedify a radix to find which form number is to got\n * return: the number string with specified form\n * access: public\n * Get the the number string with specified radix.\n */\n std::string Converter::getNum(int radix)\n &#123;\n \t/* check radix */\n\tif (radix != 2 &amp;&amp; radix != 10)\n\t&#123;\n\t\tstd::cerr &lt;&lt; &quot;Invalid argument: Do not support radixes beyond binary and decimal yet.\\n&quot;;\n\t\treturn NULL;\n\t&#125;\n \tstd::string tmp = &quot;&quot;;\n \t/* add the &#39;-&#39; character if necessary */\n \tif (this-&gt;negtive)\n \t&#123;\n \t\ttmp += &#39;-&#39;;\n \t&#125;\n \t/* add the binary form number */\n \tif (radix == 2)\n \t&#123;\n \t\ttmp += this-&gt;binVal;\n \t&#125;\n \t/* add the decimal form number */\n \telse\n \t&#123;\n \t\ttmp += this-&gt;decVal;\n \t&#125;\n \treturn tmp;\n &#125;\n\n/*\n * name: bin2Dec\n * access: private\n * Convert the binary number to decimal form then fill this-&gt;decVal.\n */\n void Converter::bin2Dec()\n &#123;\n \t/* store number string temporarily */\n \tstd::string tmp = &quot;&quot;;\n \t/* ============== int part ============== */\n \t/* to get the int range of the binary number string */\n \tint intLen;\n \tif (this-&gt;hasDot)\n \t&#123;\n \t\tintLen = this-&gt;binDotIndex;\n \t&#125;\n \telse\n \t&#123;\n \t\tintLen = this-&gt;binVal.size();\n \t&#125;\n \t/* may need carry while traversing digits */\n \tchar carry = 0;\n \t/* to store tmp&#39;s length */\n \tint decLen;\n \t/* convert radix digit by digit while traversing the int part of the binary number string */\n \tfor(int i = 0 ; i &lt; intLen ; i++)\n \t&#123;\n \t\t/* add new binary digit into carry */\n \t\tcarry += this-&gt;binVal[i]-&#39;0&#39;;\n \t\t/* update tmp&#39;s length */\n \t\tdecLen = tmp.size();\n \t\t/* traverse tmp to multiply each digit by 2 and add carries */\n \t\tfor(int j = decLen-1 ; j &gt;= 0 ; j--)\n \t\t&#123;\n \t\t\ttmp[j] = tmp[j]*2+carry;\n \t\t\tif (tmp[j] &gt; 9)\n \t\t\t&#123;\n \t\t\t\t/* update carry */\n \t\t\t\tcarry = tmp[j]/10;\n \t\t\t\t/* limit digit within 10 */\n \t\t\t\ttmp[j] %= 10;\n \t\t\t&#125;\n \t\t\telse\n \t\t\t&#123;\n\t\t\t\tcarry = 0;\n \t\t\t&#125;\n \t\t&#125;\n \t\t/* expand digits if necessary */\n \t\twhile(carry)\n \t\t&#123;\n \t\t\ttmp = char(carry%10)+tmp;\n \t\t\tcarry /= 10;\n \t\t&#125;\n \t&#125;\n \t/* ============= part end ============== */\n \t/* add &#39;0&#39; if need */\n \tif (tmp == &quot;&quot;)\n \t&#123;\n \t\ttmp += (char)0;\n \t&#125;\n \t/* ============= float part ============== */\n \t/* if there is a float part */\n \tif (this-&gt;hasDot)\n \t&#123;\n \t\t/* add the dot to the number string */\n \t\ttmp += &#39;.&#39;;\n \t\t/* get the length except the float part */\n \t\tint decIntLen = tmp.size();\n \t\t/* get the length of the whole binary number string */\n \t\tint binLen = this-&gt;binVal.size();\n \t\t/* convert radix digit by digit while traversing the float part of the binary number string */\n \t\tfor(int i = binLen-1 ; i &gt; intLen ; i--)\n \t\t&#123;\n \t\t\t/* carry to first float digit if occur a &#39;1&#39; */\n \t\t\tcarry = (this-&gt;binVal[i] == &#39;1&#39; ? 5 : 0);\n \t\t\t/* update tmp&#39;s length */\n \t\t\tdecLen = tmp.size();\n \t\t\t/* traverse tmp to divide each digit by 2 and add carries */\n \t\t\tfor(int j = decIntLen ; j &lt; decLen ; j++)\n \t\t\t&#123;\n \t\t\t\tif (tmp[j] &amp; 1)\n \t\t\t\t&#123;\n \t\t\t\t\ttmp[j] = tmp[j]/2 + carry;\n \t\t\t\t\tcarry = 5;\n \t\t\t\t&#125;\n \t\t\t\telse\n \t\t\t\t&#123;\n \t\t\t\t\ttmp[j] = tmp[j]/2 + carry;\n \t\t\t\t\tcarry = 0;\n \t\t\t\t&#125;\n \t\t\t&#125;\n \t\t\t/* expand digit if necessary */\n \t\t\tif (carry)\n \t\t\t&#123;\n \t\t\t\ttmp += carry;\n \t\t\t&#125;\n \t\t&#125;\n \t&#125;\n \t/* ============== part end =============== */\n \t/* adjust string and fill this-&gt;decVal and this-&gt;decDotIndex */\n \tfor(int i = 0 ; i &lt; tmp.size() ; i++)\n \t&#123;\n \t\tif (tmp[i] == &#39;.&#39;)\n \t\t&#123;\n \t\t\tcontinue;\n \t\t&#125;\n \t\ttmp[i] += &#39;0&#39;;\n \t&#125;\n \tthis-&gt;decVal = tmp;\n \tthis-&gt;decDotIndex = tmp.find(&#39;.&#39;);\n &#125;\n\n/*\n * name: dec2Bin\n * access: private\n * Convert the decimal number to binary form then fill this-&gt;binVal.\n */\n void Converter::dec2Bin()\n &#123;\n \t/* store number string temporarily */\n \tstd::string tmp = &quot;&quot;;\n \t/* ============== int part ============== */\n \t/* to get the int range of the decimal number string */\n \tint intLen;\n \tif (this-&gt;hasDot)\n \t&#123;\n \t\tintLen = this-&gt;decDotIndex;\n \t&#125;\n \telse\n \t&#123;\n \t\tintLen = this-&gt;decVal.size();\n \t&#125;\n \t/* may need carry while traversing digits */\n \tchar carry = 0;\n \t/* to store tmp&#39;s length */\n \tint binLen;\n \t/* convert radix digit by digit while traversing the int part of the decimal number string */\n \tfor(int i = 0 ; i &lt; intLen ; i++)\n \t&#123;\n \t\t/* add new decimal digit into carry */\n \t\tcarry += this-&gt;decVal[i]-&#39;0&#39;;\n \t\t/* update tmp&#39;s length */\n \t\tbinLen = tmp.size();\n \t\t/* traverse tmp to multiply each digit by 10 and add carries */\n \t\tfor(int j = binLen-1 ; j &gt;= 0 ; j--)\n \t\t&#123;\n \t\t\t/*\n \t\t\t * Type of tmp[] is char[] and MAX_CHAR = 127 &gt; 99.\n \t\t\t * So the assignment statement below will work safely.\n \t\t\t */\n \t\t\ttmp[j] = tmp[j]*10+carry;\n \t\t\tif (tmp[j] &gt; 1)\n \t\t\t&#123;\n \t\t\t\t/* update carry */\n \t\t\t\tcarry = tmp[j]/2;\n \t\t\t\t/* limit digit within 2 */\n \t\t\t\ttmp[j] &amp;= 1;\n \t\t\t&#125;\n \t\t\telse\n \t\t\t&#123;\n\t\t\t\tcarry = 0;\n \t\t\t&#125;\n \t\t&#125;\n \t\t/* expand digits if necessary */\n \t\twhile(carry)\n \t\t&#123;\n \t\t\ttmp = char(carry%2)+tmp;\n \t\t\tcarry /= 2;\n \t\t&#125;\n \t&#125;\n \t/* ============= part end ============== */\n \t/* add &#39;0&#39; if need */\n \tif (tmp == &quot;&quot;)\n \t&#123;\n \t\ttmp += (char)0;\n \t&#125;\n \t/* ============= float part ============== */\n \t/* if there is a float part */\n\tif (this-&gt;hasDot)\n \t&#123;\n \t\t/* add the dot to the number string */\n \t\ttmp += &#39;.&#39;;\n \t\t/* may need carry while traversing digits */\n \t\tcarry = 0;\n \t\t/* get the length of the whole decimal number string */\n \t\tint decLen = this-&gt;decVal.size();\n \t\t/* get the length of the float part of the decimal number string */\n \t\tint floatLen = decLen-intLen-1;\n \t\t/* get a copy of the float part of the decimal number string */\n \t\tstd::string tmp2 = this-&gt;decVal.substr(intLen+1, floatLen);\n \t\t/* adjust tmp2 to prepare for algorithm below */\n \t\tfor(int i = 0 ; i &lt; floatLen ; i++)\n \t\t&#123;\n \t\t\ttmp2[i] -= &#39;0&#39;;\n \t\t&#125;\n \t\t/*\n \t\t * asume:   B = b1*2^-1 + b2*2^-2 + b3*2^-3 + ...\n \t\t *            2*B = b1 + b2*2^-1 + b3*2^-2 + ... \t// take b1 as first digit\n \t\t * 2*(2*B-b1) = b2 + b3*2^-1 + ... \t\t// take b2 as second digit\n \t\t * \t\t...\n \t\t * so the binary float will got digit by digit in order\n \t\t */\n \t\tfor(int i = 0 ; i &lt; this-&gt;binFloatPrecision ; i++)\n \t\t&#123;\n \t\t\t/* traverse tmp2 to multiply each digit by 2 and add carries */\n \t\t\tfor(int j = floatLen-1 ; j &gt;= 0 ; j--)\n \t\t\t&#123;\n \t\t\t\ttmp2[j] = tmp2[j]*2+carry;\n \t\t\t\tif (tmp2[j] &gt; 9)\n \t\t\t\t&#123;\n \t\t\t\t\t/* update carry */\n \t\t\t\t\tcarry = tmp2[j]/10;\n \t\t\t\t\t/* limit digit within 10 */\n \t\t\t\t\ttmp2[j] %= 10;\n \t\t\t\t&#125;\n \t\t\t\telse\n \t\t\t\t&#123;\n \t\t\t\t\tcarry = 0;\n \t\t\t\t&#125;\n \t\t\t&#125;\n \t\t\t/* get the last carry as new digit of binary float */\n \t\t\ttmp += carry;\n \t\t\t/* reset carry */\n \t\t\tcarry = 0;\n \t\t&#125;\n \t&#125;\n \t/* ============== part end =============== */\n \t/* adjust string and fill this-&gt;binVal and this-&gt;binDotIndex */\n \tfor(int i = 0 ; i &lt; tmp.size() ; i++)\n \t&#123;\n \t\tif (tmp[i] == &#39;.&#39;)\n \t\t&#123;\n \t\t\tcontinue;\n \t\t&#125;\n \t\ttmp[i] += &#39;0&#39;;\n \t&#125;\n \tthis-&gt;binVal = tmp;\n \tthis-&gt;binDotIndex = tmp.find(&#39;.&#39;);\n &#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; test.cpp:</p>\n<pre><code class=\"hljs\">#include &quot;converter.h&quot;\n#include &lt;iostream&gt;\n#include &lt;climits&gt;\n\nusing namespace std;\n\nint main()\n&#123;\n\t//Converter c(&quot;0.625&quot;, 10);\n\tConverter c(&quot;ujsgdfksagrua0.10100000000000000000&quot;, 2);\n\tcout &lt;&lt; c.getNum(10) &lt;&lt; endl;\n\treturn 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 都过500行了，会不会写得有点啰嗦？</p>\n",
            "tags": [
                "C++",
                "进制转换"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/10/08/C-cin%E3%80%81cout%E7%9A%84%E4%BC%98%E5%8C%96%E5%8F%8A%E6%B5%8B%E8%AF%84/",
            "url": "https://blog.bipedalbit.net/2015/10/08/C-cin%E3%80%81cout%E7%9A%84%E4%BC%98%E5%8C%96%E5%8F%8A%E6%B5%8B%E8%AF%84/",
            "title": "C++ cin、cout的优化及测评",
            "date_published": "2015-10-08T11:56:46.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 参加过ACM比赛和部分自己做过测评的人想必不难发现，C++的cin和cout虽然比起C的scanf和printf来方便很多，但是速度似乎会打很大折扣。于是不求甚解的人们一拍脑门，认定因为C更“底层”，封装程度更低，所以势必比C++的输入输出执行效率更高。然而如若C++有知，恐怕要苦笑了。因为C++正是为了兼容C的输入输出才要在cin、cout中进行指针同步，降低了执行效率。那么可能挽回这种效率损失吗？答案是可以。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; C++中提供了解除指针同步的方法：<code>ios::sync_with_stdio(false)</code>。如字面意思，这个方法用来设置输入输出流是否与C的stdio同步。那么解除同步之后能有多大效果呢？毕竟C++确实因为封装程度比C高多多少少损失了一些执行效率。我动手进行了一系列测评，下面是源码。</p>\n<p>&nbsp;&nbsp;&nbsp; 这里我统一对输入输出做了重定向，不论是输入数据来源还是输入数据目标都是“data”文件。所有的输入&#x2F;输出测试都是读或写10^7次字符串与整型数的组合数据，每种输入&#x2F;输出测试都进行10次并取平均耗时作为评估值。</p>\n<p>&nbsp;&nbsp;&nbsp; 首先是C的输入输出。</p>\n<p>&nbsp;&nbsp;&nbsp; scanf.cpp:</p>\n<pre><code class=\"hljs\">#include &lt;cstdio&gt;\n#include &lt;ctime&gt;\n\nint main()\n&#123;\n\tint testCnt = 10;\n\tint caseCnt = 10000000;\n\tdouble t_sum = 0;\n\tfreopen(&quot;data&quot;, &quot;r&quot;, stdin);\n\tfor(int j = 0 ; j &lt; testCnt ; j++)\n\t&#123;\n\t\tlong t_start = clock();\n\t\tchar s[20];\n\t\tfor(int i = 0 ; i &lt; caseCnt ; i++)\n\t\t&#123;\n\t\t\tscanf(&quot;%s&quot;, s);\n\t\t&#125;\n\t\tlong t_end = clock();\n\t\tt_sum += (double)(t_end - t_start) / CLOCKS_PER_SEC;\n\t&#125;\n\tprintf(&quot;average cost: %lfs\\n&quot;, t_sum/testCnt);\n\tfclose(stdin);\n\treturn 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; printf.cpp:</p>\n<pre><code class=\"hljs\">#include &lt;cstdio&gt;\n#include &lt;ctime&gt;\n\nint main()\n&#123;\n\tint testCnt = 10;\n\tint caseCnt = 10000000;\n\tdouble t_sum = 0;\n\tfreopen(&quot;data&quot;, &quot;w&quot;, stdout);\n\tfor(int j = 0 ; j &lt; testCnt ; j++)\n\t&#123;\n\t\tlong t_start = clock();\n\t\tfor(int i = 0 ; i &lt; caseCnt ; i++)\n\t\t&#123;\n\t\t\tprintf(&quot;string%d\\n&quot;, i);\n\t\t&#125;\n\t\tlong t_end = clock();\n\t\tt_sum += (double)(t_end - t_start) / CLOCKS_PER_SEC;\n\t&#125;\n\tprintf(&quot;average cost: %lfs\\n&quot;, t_sum/testCnt);\n\tfclose(stdout);\n\treturn 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 然后是不解锁同步的cin、cout方法。</p>\n<p>&nbsp;&nbsp;&nbsp; cin.cpp:</p>\n<pre><code class=\"hljs\">#include &lt;iostream&gt;\n#include &lt;cstdio&gt;\n#include &lt;ctime&gt;\n#include &lt;string&gt;\n#include &lt;fstream&gt;\n\nusing namespace std;\n\nint main()\n&#123;\n\tint testCnt = 10;\n\tint caseCnt = 10000000;\n\tdouble t_sum = 0;\n\tifstream fin(&quot;data&quot;);\n\tstreambuf *_cin =  cin.rdbuf(fin.rdbuf());\n\tfor(int j = 0 ; j &lt; testCnt ; j++)\n\t&#123;\n\t\tlong t_start = clock();\n\t\tstring s;\n\t\tfor(int i = 0 ; i &lt; caseCnt ; i++)\n\t\t&#123;\n\t\t\tcin &gt;&gt; s;\n\t\t&#125;\n\t\tlong t_end = clock();\n\t\tt_sum += (double)(t_end - t_start) / CLOCKS_PER_SEC;\n\t&#125;\n\tcout &lt;&lt; &quot;average cost: &quot; &lt;&lt; t_sum/testCnt &lt;&lt; &quot;s\\n&quot;;\n\tcin.rdbuf(_cin);\n\tfin.close();\n\treturn 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; cout.cpp:</p>\n<pre><code class=\"hljs\">#include &lt;iostream&gt;\n#include &lt;ctime&gt;\n#include &lt;string&gt;\n#include &lt;fstream&gt;\n\nusing namespace std;\n\nint main()\n&#123;\n\tint testCnt = 10;\n\tint caseCnt = 10000000;\n\tdouble t_sum = 0;\n\tofstream fout(&quot;data&quot;);\n\tstreambuf *_cout =  cout.rdbuf(fout.rdbuf());\n\tfor(int j = 0 ; j &lt; testCnt ; j++)\n\t&#123;\n\t\tlong t_start = clock();\n\t\tfor(int i = 0 ; i &lt; caseCnt ; i++)\n\t\t&#123;\n\t\t\tcout &lt;&lt; &quot;string&quot; &lt;&lt; i &lt;&lt; &#39;\\n&#39;;\n\t\t&#125;\n\t\tlong t_end = clock();\n\t\tt_sum += (double)(t_end - t_start) / CLOCKS_PER_SEC;\n\t&#125;\n\tcout &lt;&lt; &quot;average cost: &quot; &lt;&lt; t_sum/testCnt &lt;&lt; &quot;s\\n&quot;;\n\tcout.rdbuf(_cout);\n\tfout.close();\n\treturn 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 接下来是解锁同步的cin、cout方法。</p>\n<p>&nbsp;&nbsp;&nbsp; optimized_cin.cpp:</p>\n<pre><code class=\"hljs\">#include &lt;iostream&gt;\n#include &lt;cstdio&gt;\n#include &lt;ctime&gt;\n#include &lt;string&gt;\n#include &lt;fstream&gt;\n\nusing namespace std;\n\nint main()\n&#123;\n\tint testCnt = 10;\n\tint caseCnt = 10000000;\n\tdouble t_sum = 0;\n\tios::sync_with_stdio(false);\n\tifstream fin(&quot;data&quot;);\n\tstreambuf *_cin =  cin.rdbuf(fin.rdbuf());\n\tfor(int j = 0 ; j &lt; testCnt ; j++)\n\t&#123;\n\t\tlong t_start = clock();\n\t\tstring s;\n\t\tfor(int i = 0 ; i &lt; caseCnt ; i++)\n\t\t&#123;\n\t\t\tcin &gt;&gt; s;\n\t\t&#125;\n\t\tlong t_end = clock();\n\t\tt_sum += (double)(t_end - t_start) / CLOCKS_PER_SEC;\n\t&#125;\n\tcout &lt;&lt; &quot;average cost: &quot; &lt;&lt; t_sum/testCnt &lt;&lt; &quot;s\\n&quot;;\n\tcin.rdbuf(_cin);\n\tfin.close();\n\treturn 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; optimized_cout.cpp:</p>\n<pre><code class=\"hljs\">#include &lt;iostream&gt;\n#include &lt;ctime&gt;\n#include &lt;string&gt;\n#include &lt;fstream&gt;\n\nusing namespace std;\n\nint main()\n&#123;\n\tint testCnt = 10;\n\tint caseCnt = 10000000;\n\tdouble t_sum = 0;\n\tios::sync_with_stdio(false);\n\tofstream fout(&quot;data&quot;);\n\tstreambuf *_cout =  cout.rdbuf(fout.rdbuf());\n\tfor(int j = 0 ; j &lt; testCnt ; j++)\n\t&#123;\n\t\tlong t_start = clock();\n\t\tfor(int i = 0 ; i &lt; caseCnt ; i++)\n\t\t&#123;\n\t\t\tcout &lt;&lt; &quot;string&quot; &lt;&lt; i &lt;&lt; &#39;\\n&#39;;\n\t\t&#125;\n\t\tlong t_end = clock();\n\t\tt_sum += (double)(t_end - t_start) / CLOCKS_PER_SEC;\n\t&#125;\n\tcout &lt;&lt; &quot;average cost: &quot; &lt;&lt; t_sum/testCnt &lt;&lt; &quot;s\\n&quot;;\n\tcout.rdbuf(_cout);\n\tfout.close();\n\treturn 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 同时测试C++直接读写文件的方法。</p>\n<p>&nbsp;&nbsp;&nbsp; fin.cpp:</p>\n<pre><code class=\"hljs\">#include &lt;iostream&gt;\n#include &lt;cstdio&gt;\n#include &lt;ctime&gt;\n#include &lt;string&gt;\n#include &lt;fstream&gt;\n\nusing namespace std;\n\nint main()\n&#123;\n\tint testCnt = 10;\n\tint caseCnt = 10000000;\n\tdouble t_sum = 0;\n\tifstream fin(&quot;data&quot;);\n\tfor(int j = 0 ; j &lt; testCnt ; j++)\n\t&#123;\n\t\tlong t_start = clock();\n\t\tstring s;\n\t\tfor(int i = 0 ; i &lt; caseCnt ; i++)\n\t\t&#123;\n\t\t\tfin &gt;&gt; s;\n\t\t&#125;\n\t\tlong t_end = clock();\n\t\tt_sum += (double)(t_end - t_start) / CLOCKS_PER_SEC;\n\t&#125;\n\tcout &lt;&lt; &quot;average cost: &quot; &lt;&lt; t_sum/testCnt &lt;&lt; &quot;s\\n&quot;;\n\tfin.close();\n\treturn 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; fout.cpp:</p>\n<pre><code class=\"hljs\">#include &lt;iostream&gt;\n#include &lt;ctime&gt;\n#include &lt;string&gt;\n#include &lt;fstream&gt;\n\nusing namespace std;\n\nint main()\n&#123;\n\tint testCnt = 10;\n\tint caseCnt = 10000000;\n\tdouble t_sum = 0;\n\tofstream fout(&quot;data&quot;);\n\tfor(int j = 0 ; j &lt; testCnt ; j++)\n\t&#123;\n\t\tlong t_start = clock();\n\t\tfor(int i = 0 ; i &lt; caseCnt ; i++)\n\t\t&#123;\n\t\t\tfout &lt;&lt; &quot;string&quot; &lt;&lt; i &lt;&lt; &#39;\\n&#39;;\n\t\t&#125;\n\t\tlong t_end = clock();\n\t\tt_sum += (double)(t_end - t_start) / CLOCKS_PER_SEC;\n\t&#125;\n\tcout &lt;&lt; &quot;average cost: &quot; &lt;&lt; t_sum/testCnt &lt;&lt; &quot;s\\n&quot;;\n\tfout.close();\n\treturn 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 下面是测试结果：</p>\n<table><tr><th></th><th>scanf与printf</th><th>cin与cout</th><th>优化的cin与cout</th>\t<th>fin与fout</th></tr><tr><td>输入</td><td>1.125694s</td><td>2.46949s</td><td>0.950055s</td><td>0.834976s</td></tr><tr><td>输出</td><td>1.304706s</td><td>1.46059s</td><td>1.41783s</td><td>1.41298s</td></tr></table>\n\n<p>&nbsp;&nbsp;&nbsp; 可以看到，事实上，解开同步之前，cin耗时是scanf的两倍还多，cout则比printf略慢。解开枷锁的cin执行效率与直接读文件接近，甚至比C的scanf还要快。至于输出，解开同步的cout执行效率略有提高，同样接近直接写文件，但是确实还是比C的printf略慢一点。</p>\n",
            "tags": [
                "C++",
                "cin",
                "cout",
                "scanf",
                "printf"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/09/30/nginx%E4%B9%8B%E5%9B%9E%E5%A4%B4%E8%A1%A5%E8%AF%BE/",
            "url": "https://blog.bipedalbit.net/2015/09/30/nginx%E4%B9%8B%E5%9B%9E%E5%A4%B4%E8%A1%A5%E8%AF%BE/",
            "title": "nginx之回头补课",
            "date_published": "2015-09-30T04:50:34.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 最近买了苗泽的那本《Nginx高性能Web服务器详解》，准备系统地学习下Nginx相关的知识。于是在二次科普的过程中发现之前对Nginx的一些理解和认识被刷新细化了。特此发文总结补课。</p>\n<span id=\"more\"></span>\n<h1 id=\"一-Web请求处理机制\"><a href=\"#一-Web请求处理机制\" class=\"headerlink\" title=\"一. Web请求处理机制\"></a>一. Web请求处理机制</h1><h2 id=\"1-1-多进程方式\"><a href=\"#1-1-多进程方式\" class=\"headerlink\" title=\"1.1 多进程方式\"></a>1.1 多进程方式</h2><p>&nbsp;&nbsp;&nbsp; 传统的多进程方式是指：每接到一个客户端请求，就由服务器主进程生成一个子进程来负责与客户端建立连接并进行交互。连接断开子进程即销毁。<br>&nbsp;&nbsp;&nbsp; 优点：<br>&nbsp;&nbsp;&nbsp; ①设计实现比较简单，许多细节被OS管理；<br>&nbsp;&nbsp;&nbsp; ②由于进程间独立，资源独立分配使用，运行时出错风险小，稳定性好；<br>&nbsp;&nbsp;&nbsp; ③OS的进程资源回收机制比较完备，垃圾不会积累。<br>&nbsp;&nbsp;&nbsp; 缺点：<br>&nbsp;&nbsp;&nbsp; 动态生成子进程涉及内存复制等操作，资源、时间开销比较大。发生大并发时对OS资源造成较大压力，将导致OS性能下降。<br>&nbsp;&nbsp;&nbsp; Apache最初的设计架构就采用了多进程方式，但是为了适应大并发的要求，对多进程方式进行了改进。<br>&nbsp;&nbsp;&nbsp; 多进程方式的短板在于动态生成进程时的开销，于是Apache采用了“预生成进程”的工作方式。顾名思义，在还没有接到客户端请求的空闲时间，预先生成若干工作进程。当接到客户端请求，主进程分配子进程与客户端进行交互。连接断开后子进程保留，做开销很小的适当清理后被主进程管理起来等待下一个客户端请求。“预生成进程”在一定程度上缓解了大并发时Web服务器对OS资源造成的压力。</p>\n<h2 id=\"1-2-多线程方式\"><a href=\"#1-2-多线程方式\" class=\"headerlink\" title=\"1.2 多线程方式\"></a>1.2 多线程方式</h2><p>&nbsp;&nbsp;&nbsp; 总体来说多线程方式与多进程方式十分类似，它们的区别在于，Web服务器接到客户端请求后，多线程方式下，主进程将动态派生一个工作线程来与客户端进行交互。<br>&nbsp;&nbsp;&nbsp; 同样是动态生成，OS产生一个线程的开销要远远小于产生一个进程的开销（在实验验证之前，我对此表示怀疑）。<br>&nbsp;&nbsp;&nbsp; 优点：<br>&nbsp;&nbsp;&nbsp; OS资源压力小于多进程方式。<br>&nbsp;&nbsp;&nbsp; 缺点：<br>&nbsp;&nbsp;&nbsp; OS对线程管理的支持甚少，线程调度规则、内存空间管理、线程资源管理都需要开发者自己考虑，增大了开发难度和出错风险。错误也容易在Web服务器持续运行的过程中发生堆积。<br>&nbsp;&nbsp;&nbsp; IIS服务器采用了多线程方式处理Web请求，它的稳定性相对不错。但是IIS Web服务器管理员仍然倾向于定期检查和重启服务器，以消除不可预知的错误堆积或其他隐患。</p>\n<h1 id=\"二-异步-同步、阻塞-非阻塞\"><a href=\"#二-异步-同步、阻塞-非阻塞\" class=\"headerlink\" title=\"二. 异步&#x2F;同步、阻塞&#x2F;非阻塞\"></a>二. 异步&#x2F;同步、阻塞&#x2F;非阻塞</h1><p>&nbsp;&nbsp;&nbsp; 异步与非阻塞，同步与阻塞的概念常被人混淆。事实上，异步&#x2F;同步与阻塞&#x2F;非阻塞发生在网络通信的不同阶段，前者发生在客户端与服务端的通信阶段，与请求处理过程无关；后者发生在请求处理阶段。</p>\n<h2 id=\"2-1-异步-同步\"><a href=\"#2-1-异步-同步\" class=\"headerlink\" title=\"2.1 异步&#x2F;同步\"></a>2.1 异步&#x2F;同步</h2><p>&nbsp;&nbsp;&nbsp; 在网络通信中同步机制指：发送方发送请求后，等到接收方发回响应后才发出下一个请求。发送端与接收端步调一致。异步机制：发送方是否发送请求不受接收方是否作出响应的影响。在接收方，发送方的请求形成队列，依次处理完成后依次进行响应。</p>\n<h2 id=\"2-2-阻塞-非阻塞\"><a href=\"#2-2-阻塞-非阻塞\" class=\"headerlink\" title=\"2.2 阻塞&#x2F;非阻塞\"></a>2.2 阻塞&#x2F;非阻塞</h2><p>&nbsp;&nbsp;&nbsp; 阻塞与非阻塞的对象，通常是网络套接字Socket，其实质是IO操作。阻塞方式中，IO结果返回前，当前线程从运行状态被挂起，直到IO结果返回，才进入就绪状态等待调度以继续运行；非阻塞方式中，线程不会被挂起，如果当前调用无法马上返回结果，一个失败消息将被<strong>立即返回</strong>，并继续执行下一个调用。</p>\n<h2 id=\"2-3-同步阻塞方式\"><a href=\"#2-3-同步阻塞方式\" class=\"headerlink\" title=\"2.3 同步阻塞方式\"></a>2.3 同步阻塞方式</h2><p>&nbsp;&nbsp;&nbsp; 发送方发送请求后一直等待响应；接收方处理请求时的IO操作如果不能马上返回结果则一直等待，返回结果后响应发送方。一个请求周期期间，发送方和接收方不能进行其他工作。比如，超市排队付账时，客户（发送方）向收款员（接收方）付款（发送请求）后需等待找零，期间不能做其他事；收款员要等待收款机返回结果（IO操作）后才能找零（响应请求），期间也只能等待。这种方式实现简单，效率不高。</p>\n<h2 id=\"2-4-同步非阻塞方式\"><a href=\"#2-4-同步非阻塞方式\" class=\"headerlink\" title=\"2.4 同步非阻塞方式\"></a>2.4 同步非阻塞方式</h2><p>&nbsp;&nbsp;&nbsp; 付款后顾客只能等着，收款员可以先干点给商品打包、玩手机之类的杂事。实际中不使用。</p>\n<h2 id=\"2-5-异步阻塞方式\"><a href=\"#2-5-异步阻塞方式\" class=\"headerlink\" title=\"2.5 异步阻塞方式\"></a>2.5 异步阻塞方式</h2><p>&nbsp;&nbsp;&nbsp; 付款后顾客可以干点跟后面顾客聊天、玩手机之类的杂事，收款员只能等着。实际中不使用。</p>\n<h2 id=\"2-6-异步非阻塞方式\"><a href=\"#2-6-异步非阻塞方式\" class=\"headerlink\" title=\"2.6 异步非阻塞方式\"></a>2.6 异步非阻塞方式</h2><p>&nbsp;&nbsp;&nbsp; 发送方发送请求后无需忙等，可以继续其他操作，有响应时再做出对应反应；接收方如果不能马上获得IO结果，将请求挂入请求队列，继续其他工作，返回IO结果时触发一个事件，接收方向发送方作出对应响应。比如，付款后顾客可以干点跟后面顾客聊天、玩手机之类的杂事；收款员完成商品扫码和收款金额输入后可以先干点给商品打包、玩手机之类的杂事，当收款机发出警报声，收款员告诉顾客机器坏了没法收款，当收款机刷新出找零金额，收款员开始找零。</p>\n<h1 id=\"三-Nginx的请求处理机制\"><a href=\"#三-Nginx的请求处理机制\" class=\"headerlink\" title=\"三. Nginx的请求处理机制\"></a>三. Nginx的请求处理机制</h1><p>&nbsp;&nbsp;&nbsp; Nginx使用“预生成进程”或“带进程池”的多进程方式作为请求处理方式，使用异步非阻塞方式作为网络通信方式。Nginx服务器在启动时就由主进程fork（分支）若干固定数目的工作进程（工作进程数通常与CPU核心数线性相关，有助于提高CPU利用率），这些工作进程就是Nginx的进程池。使用多进程方式保证大并发情景下<strong>不增加</strong>OS资源压力，使用异步非阻塞方式保证大并发情景下<strong>不降低</strong>请求处理能力。</p>\n<h1 id=\"四-Nginx事件驱动模型\"><a href=\"#四-Nginx事件驱动模型\" class=\"headerlink\" title=\"四. Nginx事件驱动模型\"></a>四. Nginx事件驱动模型</h1><h2 id=\"4-1-事件驱动模型概述\"><a href=\"#4-1-事件驱动模型概述\" class=\"headerlink\" title=\"4.1 事件驱动模型概述\"></a>4.1 事件驱动模型概述</h2><p>&nbsp;&nbsp;&nbsp; 事件驱动模型一般由事件收集器、事件发送器和事件处理器三个基本单元组成：<br>&nbsp;&nbsp;&nbsp; ①事件收集器：事件收集器一般由一个事件循环程序构成，即无线循环监听各种预设类型的事件；<br>&nbsp;&nbsp;&nbsp; ②事件收集器：事件发送器实际上只是一个事件映射集；<br>&nbsp;&nbsp;&nbsp; ③时间处理器：通常，事件处理器的并发实现有以下三种方式：为请求创建新进程、为请求创建新线程、将请求放入请求队列。第一种方式OS资源开销大；第二种方式开发者需要自己动手完成线程同步，编码复杂；第三种方式编码逻辑复杂，但大多数Web服务器采用第三种方式，基于第三种方式的事件驱动模型逐渐形成了一系列“事件驱动处理库”，又被称为“多路IO复用方法”。</p>\n<h2 id=\"4-2-select库\"><a href=\"#4-2-select库\" class=\"headerlink\" title=\"4.2 select库\"></a>4.2 select库</h2><p>&nbsp;&nbsp;&nbsp; 各个版本的Linux和Windows平台都支持select库，接口基本相同，参数含义略有差异。首先它需要创建3个事件描述符集合（事件映射集），分别可以关注并收集Read、Write、Exception事件描述符（事件收集）。其次调用OS核心的select()函数。然后<strong>轮询</strong>每个事件描述符集中的每个事件描述符，如有事件发生则进行处理。Nginx服务器在编译过程中如未指定其他高性能事件驱动模型库，将自动编译 select 库。</p>\n<h2 id=\"4-3-poll库\"><a href=\"#4-3-poll库\" class=\"headerlink\" title=\"4.3 poll库\"></a>4.3 poll库</h2><p>&nbsp;&nbsp;&nbsp; 限于Linux平台的基本事件驱动模型。poll与select的区别在于，它只创建一个事件描述符集，而每个事件描述符<strong>结构上</strong>分别设置Read、Write、Exception事件，<strong>轮询</strong>时可同时检查三种事件是否发生。同样的，如未指定其他高性能事件驱动模型库，Nginx将自动编译 poll 库。</p>\n<h2 id=\"4-4-epoll\"><a href=\"#4-4-epoll\" class=\"headerlink\" title=\"4.4 epoll\"></a>4.4 epoll</h2><p>&nbsp;&nbsp;&nbsp; epoll是公认优秀的高性能事件驱动模型，Linux 2.6及以上版本可以使用它。epoll是对poll的改进，epoll可以看成是event poll，即基于事件的poll。epoll利用OS调用，让内核来创建事件描述符集，然后监听内核的反馈事件。当内核通过一个事件反馈发生事件的描述符列表再处理这些事件。<br>&nbsp;&nbsp;&nbsp; epoll库在Linux平台上是高效的（因为Linux内核的高效性），它支持一个进程打开大数目的事件描述符，上限是OS支持的最大打开文件数。同时因为它只处理内核上报的“活跃”描述符，epoll的IO效率不随描述符数目的增加线性下降（类似哈希查找之于遍历查找），即它支持大描述符集。</p>\n<h2 id=\"4-5-rtsig模型\"><a href=\"#4-5-rtsig模型\" class=\"headerlink\" title=\"4.5 rtsig模型\"></a>4.5 rtsig模型</h2><p>&nbsp;&nbsp;&nbsp; rtsig即real time signal的缩写，即实时信号。事实上，rtsig调用内核创建一个固定长度上限的事件信号发生队列，等待工作进程依次处理。</p>\n<h2 id=\"4-6-其他事件驱动模型\"><a href=\"#4-6-其他事件驱动模型\" class=\"headerlink\" title=\"4.6 其他事件驱动模型\"></a>4.6 其他事件驱动模型</h2><p>&nbsp;&nbsp;&nbsp; kqueue模型，是用于支持BSD系列平台（FreeBSD、OpenBSD、NetBSD、Mac OS X等）的高效事件驱动模型。也是poll的变种，仰仗OS内核支持条件触发（LT即level-triggered即满足条件触发）和边缘触发（ET即edge-triggered，即状态变换触发）。</p>\n<p>&nbsp;&nbsp;&nbsp; &#x2F;dev&#x2F;poll模型，是用于支持Unix衍生平台（Solaris、HP&#x2F;UX、IRIX、Tru64 UNIX），该模型是Sun公司开发Solaris系列平台时提出的事件驱动机制方案，使用了虚拟的&#x2F;dev&#x2F;poll设备，开发人员监听设备消息获取事件通知。</p>\n<p>&nbsp;&nbsp;&nbsp; eventport模型，是用于支持Solaris10及以上版本平台的高效事件驱动模型。也是Sun公司开发Solaris是提出的方案，可以有效防止内核崩溃等情况。</p>\n<h2 id=\"4-7-IOCP模型\"><a href=\"#4-7-IOCP模型\" class=\"headerlink\" title=\"4.7 IOCP模型\"></a>4.7 IOCP模型</h2><p>&nbsp;&nbsp;&nbsp; 苗泽在书中没有提到，但现在Nginx在windows平台下还支持IOCP模型，虽然我对它不甚了解，但圈内提及Windows平台下的大并发网络，一定会提起IOCP模型，估计也是利用内核优化的事件驱动模型。</p>\n",
            "tags": [
                "nginx",
                "Web请求处理机制",
                "同步/异步",
                "阻塞/非阻塞",
                "事件驱动模型"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/09/12/socket-io%E9%82%80%E8%AF%B7%E5%88%B6%E5%B8%A6%E7%99%BB%E5%BD%95%E8%81%8A%E5%A4%A9%E5%AE%A4%E5%AE%9E%E4%BE%8B%E3%80%90DRRR-chat-room%E3%80%91/",
            "url": "https://blog.bipedalbit.net/2015/09/12/socket-io%E9%82%80%E8%AF%B7%E5%88%B6%E5%B8%A6%E7%99%BB%E5%BD%95%E8%81%8A%E5%A4%A9%E5%AE%A4%E5%AE%9E%E4%BE%8B%E3%80%90DRRR-chat-room%E3%80%91/",
            "title": "socket.io邀请制带登录聊天室实例【DRRR-chat-room】",
            "date_published": "2015-09-12T14:44:25.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; <strong>写个博文其实也没什么特别要说的。研究node.js的过程中扩展了socket.io的聊天室demo，仿制了一个动漫DRRR（无头骑士异闻录）中的聊天室。使用邀请制，即注册需要提供邀请码。头一次在GitHub建项目：<a href=\"https://github.com/bipedalBit/DRRR-chat-room\">DRRR-chat-room</a>。下个项目可能是用socket.io做一个真·实时弹幕站，尽请期待。</strong></p>\n",
            "tags": [
                "node.js",
                "github",
                "socket.io"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/09/06/node-js%E7%9A%84-Cannot-enqueue-Handshake-after-invoking-quit-%E9%94%99%E8%AF%AF/",
            "url": "https://blog.bipedalbit.net/2015/09/06/node-js%E7%9A%84-Cannot-enqueue-Handshake-after-invoking-quit-%E9%94%99%E8%AF%AF/",
            "title": "node.js的'Cannot enqueue Handshake after invoking quit'错误",
            "date_published": "2015-09-06T10:11:25.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 今天用node.js做无刷新聊天室的时候遇到”Error: Cannot enqueue Handshake after invoking quit.”的问题，在Stack Overflow被点化了。</p>\n<span id=\"more\"></span>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-variable language_\">module</span>.<span class=\"hljs-property\">exports</span> = &#123;<br>    <span class=\"hljs-attr\">getDataFromUserGps</span>: <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">callback</span>)<br>    &#123;<br>        connection.<span class=\"hljs-title function_\">connect</span>();<br>        connection.<span class=\"hljs-title function_\">query</span>(<span class=\"hljs-string\">&quot;SELECT * FROM usergps&quot;</span>,<br>            <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">err, results, fields</span>) &#123;<br>                <span class=\"hljs-keyword\">if</span> (err) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">callback</span>(err, <span class=\"hljs-literal\">null</span>);<br>                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">callback</span>(<span class=\"hljs-literal\">null</span>, results);<br>            &#125;<br>        );<br>        connection.<span class=\"hljs-title function_\">end</span>();<br>    &#125;,<br>    <span class=\"hljs-attr\">loginUser</span>: <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">login, pass, callback</span>)<br>    &#123;<br>        connection.<span class=\"hljs-title function_\">connect</span>();<br>        connection.<span class=\"hljs-title function_\">query</span>(<br>            <span class=\"hljs-string\">&quot;SELECT id FROM users WHERE login = ? AND pass = ?&quot;</span>,<br>            [login, pass],<br>            <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">err, results, fields</span>)<br>            &#123;<br>                <span class=\"hljs-keyword\">if</span> (err) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">callback</span>(err, <span class=\"hljs-literal\">null</span>);<br>                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">callback</span>(<span class=\"hljs-literal\">null</span>, results);<br>            &#125;<br>        );<br>        connection.<span class=\"hljs-title function_\">end</span>();<br>    &#125;,<br>    <span class=\"hljs-attr\">getUserDetails</span>: <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">userid, callback</span>)<br>    &#123;<br>        connection.<span class=\"hljs-title function_\">connect</span>();<br>        connection.<span class=\"hljs-title function_\">query</span>(<br>            <span class=\"hljs-string\">&quot;SELECT * FROM userProfilDetails LEFT JOIN tags ON userProfilDetails.userId = tags.userId WHERE userProfilDetails.userid = ?&quot;</span>,<br>            [userid],<br>            <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">err, results, fields</span>)<br>            &#123;<br>                <span class=\"hljs-keyword\">if</span> (err) <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">callback</span>(err, <span class=\"hljs-literal\">null</span>);<br>                <span class=\"hljs-keyword\">return</span> <span class=\"hljs-title function_\">callback</span>(<span class=\"hljs-literal\">null</span>, results);<br>            &#125;<br>        );<br>        connection.<span class=\"hljs-title function_\">end</span>();<br>    &#125;,<br>    <span class=\"hljs-attr\">addTags</span>: <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">userId, tags</span>)<br>    &#123;<br>        connection.<span class=\"hljs-title function_\">connect</span>();<br>        connection.<span class=\"hljs-title function_\">query</span>(<br>            <span class=\"hljs-string\">&quot;INSERT INTO tag (userId, tag) VALUES (?, ?)&quot;</span>,<br>            [userId, tags],<br>            <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">err, results, fields</span>)<br>            &#123;<br>                <span class=\"hljs-keyword\">if</span> (err) <span class=\"hljs-keyword\">throw</span> err;<br>            &#125;<br>        )<br>        connection.<span class=\"hljs-title function_\">end</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 一开始运行一切正常，但当我执行第二个&quot;query&quot;的时候，会报这个错：<br>&nbsp;&nbsp;&nbsp;<code>Cannot enqueue Handshake after invoking quit</code><br>&nbsp;&nbsp;&nbsp; 我试过一直不用.end()方法关掉连接，然并卵。<br>&nbsp;&nbsp;&nbsp; 先谢过。<br>&nbsp;&nbsp;&nbsp; Radex</p>\n<p>&nbsp;&nbsp;&nbsp; <strong><span style=\"color:#FF0000;\">那些瞎解答和水贴的我就不翻译了。</span></strong></p>\n<p>&nbsp;&nbsp;&nbsp;根据:<br>&nbsp;&nbsp;&nbsp;Fixing Node Mysql &quot;Error: Cannot enqueue Handshake after invoking quit.&quot;:<br>&nbsp;&nbsp;&nbsp;<a href=\"http://codetheory.in/fixing-node-mysql-error-cannot-enqueue-handshake-after-invoking-quit/\">http://codetheory.in/fixing-node-mysql-error-cannot-enqueue-handshake-after-invoking-quit/</a><br>的<br>&nbsp;&nbsp;&nbsp; <strong>TL;DR</strong> <code>每次关掉连接之后你都需要用createConnection方法创建一个新连接。</code><br>以及<br><strong>&nbsp;&nbsp;&nbsp; Note:</strong> 如果你是在伺服web请求，你就不该在每次请求处理完时关掉连接了。服务器启动时创建一个连接，然后一直用connection&#x2F;client对象查询就好。要处理服务器断开和重连事件时你可以监听错误事件。完整代码：<a target=\"_blank\" href=\"https://github.com/felixge/node-mysql#server-disconnects\">here</a>.<br>又根据:<br>&nbsp;&nbsp;&nbsp; Readme.md - Server disconnects:<br>&nbsp;&nbsp;&nbsp; <a href=\"https://github.com/felixge/node-mysql#server-disconnects\">https://github.com/felixge/node-mysql#server-disconnects</a><br>里边说</p>\n<blockquote>\n<h2>Server disconnects</h2>\n你可能因为网络问题、服务器超时或者服务器挂了而失去与MySQL服务器的连接。 所有这些情况都被视为&quot;fatal error&quot;，而且会有一个错误代码 <code>err.code = 'PROTOCOL_CONNECTION_LOST'</code>。想了解更多可以看看错误处理章节。\n\n<p>处理这些不被期望的连接断开的最佳方式如下:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs javascript\"><span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">handleDisconnect</span>(<span class=\"hljs-params\">connection</span>) &#123;<br>    connection.<span class=\"hljs-title function_\">on</span>(<span class=\"hljs-string\">&#x27;error&#x27;</span>, <span class=\"hljs-keyword\">function</span>(<span class=\"hljs-params\">err</span>) &#123;<br>        <span class=\"hljs-keyword\">if</span> (!err.<span class=\"hljs-property\">fatal</span>) &#123;<br>          <span class=\"hljs-keyword\">return</span>;<br>        &#125;<br>        <span class=\"hljs-keyword\">if</span> (err.<span class=\"hljs-property\">code</span> !== <span class=\"hljs-string\">&#x27;PROTOCOL_CONNECTION_LOST&#x27;</span>) &#123;<br>          <span class=\"hljs-keyword\">throw</span> err;<br>        &#125;<br>        <span class=\"hljs-variable language_\">console</span>.<span class=\"hljs-title function_\">log</span>(<span class=\"hljs-string\">&#x27;Re-connecting lost connection: &#x27;</span> + err.<span class=\"hljs-property\">stack</span>);<br>        connection = mysql.<span class=\"hljs-title function_\">createConnection</span>(connection.<span class=\"hljs-property\">config</span>);<br>        <span class=\"hljs-title function_\">handleDisconnect</span>(connection);<br>        connection.<span class=\"hljs-title function_\">connect</span>();<br>    &#125;);<br>&#125;<br><br><span class=\"hljs-title function_\">handleDisconnect</span>(connection);<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 如上例所示，重连是通过创建一个新连接的方式达成的，因为连接对象被设计成一挂掉就无法重连。<br>&nbsp;&nbsp;&nbsp; 使用连接池的时候，挂掉的连接会被从连接池中移除并释放空间，新连接请求到来时自动创建一个新连接。</p>\n</blockquote>\n&nbsp;&nbsp;&nbsp; 答题人后面贴了一段自己的自动重连代码，这里我就不贴了。\n\n<p>&nbsp;&nbsp;&nbsp; 回答于2013年5月3日18:58<br>&nbsp;&nbsp;&nbsp; XP1</p>\n<p>&nbsp;&nbsp;&nbsp; 这个回答虽然没被题主采纳，但我和下面跟帖的一致认为这个回答比较好。</br><br>&nbsp;&nbsp;&nbsp; <a href=\"http://stackoverflow.com/questions/14087924/cannot-enqueue-handshake-after-invoking-quit\">原网页</a></p>\n",
            "tags": [
                "node.js"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/08/18/%E3%80%90%E4%BA%94%E3%80%91nginx%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-3-%E2%80%94%E2%80%94%E6%89%A9%E5%B1%95%E7%BA%A2%E9%BB%91%E6%A0%91/",
            "url": "https://blog.bipedalbit.net/2015/08/18/%E3%80%90%E4%BA%94%E3%80%91nginx%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-3-%E2%80%94%E2%80%94%E6%89%A9%E5%B1%95%E7%BA%A2%E9%BB%91%E6%A0%91/",
            "title": "【五】nginx的数据结构(3)——扩展红黑树",
            "date_published": "2015-08-17T18:04:43.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 基础版的红黑树写完之后总觉得有些辅助功能不补充一下就难以体现红黑树在统计方面的优越性，于是我又写了红黑树扩展版。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 发扬我一贯的支线任务狂魔的作风，一晚上就完成了之前设想的红黑树扩展版本。<br>&nbsp;&nbsp;&nbsp; rbtree.h：</p>\n<pre><code class=\"hljs\">/*\n * Copyright (C) Bipedal Bit\n * Verson 1.0.0.2\n */\n\n#ifndef _RBTREE_H_INCLUDED_\n#define _RBTREE_H_INCLUDED_\n\n/* the node structure of the red-black tree */\ntypedef struct rbtree_node_s rbtree_node_t;\n/* Using type int means its range is -0x7fffffff-1~0x7fffffff. */\ntypedef int rbtree_key_t;\n/* Abstract type is complicated to achieve with C so I use char* instead. */\ntypedef char* rbtree_data_t;\n\nstruct rbtree_node_s\n&#123;\n    /* key of the node */\n    rbtree_key_t    key;\n    /* pointer of the parent of the node */\n    rbtree_node_t*  parent;\n    /* pointer of the left kid of the node */\n    rbtree_node_t*  left;\n    /* pointer of the right kid of the node */\n    rbtree_node_t*  right;\n    /* color of the node */\n    unsigned char   color;\n    /* pointer of the value of the node corresponding to the key */\n    rbtree_data_t   value;\n    /* count of nodes in the subtree whose root is the current node */\n    int node_cnt;\n&#125;;\n\n/* the tree object stucture of the red-black tree */\ntypedef struct rbtree_s rbtree_t;\n/* foundational insert function pointer */\ntypedef void (*rbtree_insert_p) (rbtree_t* root, rbtree_node_t* node);\n/* foundational visit function pointer */\ntypedef void (*rbtree_visit_p) (rbtree_node_t* node);\n\nstruct rbtree_s\n&#123;\n    /* the pointer of the root node of the tree */\n    rbtree_node_t* root;\n    /* black leaf nodes as sentinel */\n    rbtree_node_t* sentinel;\n    /* the polymorphic insert function pointer */\n    rbtree_insert_p insert;\n&#125;;\n\n/* macros */\n#define rbtree_init(tree, s, i)     \\\nrbtree_sentinel_init(s);            \\\n(tree)-&gt;root = s;               \\\n(tree)-&gt;sentinel = s;           \\\n(tree)-&gt;insert = i\n\n#define rbtree_red(node)    ((node)-&gt;color = 1)\n#define rbtree_black(node)  ((node)-&gt;color = 0)\n#define rbtree_is_red(node) ((node)-&gt;color)\n#define rbtree_is_black(node)   (!rbtree_is_red(node))\n /* copy n2&#39;s color to n1 */\n#define rbtree_copy_color(n1, n2)   (n1-&gt;color = n2-&gt;color)\n/* sentinel must be black cuz it&#39;s leaf node */\n#define rbtree_sentinel_init(node)  \\\nrbtree_black(node);         \\\n(node)-&gt;node_cnt = 0\n\n/* statements of public methods */\nvoid rbtree_insert_value(rbtree_t* tree, rbtree_node_t* node);\nvoid rbtree_insert(rbtree_t* tree, rbtree_node_t* node);\nvoid rbtree_delete(rbtree_t* tree, rbtree_node_t* node);\n/* get node by key */\nrbtree_node_t* rbtree_find(rbtree_t* tree, rbtree_key_t key);\n/* get node by order number */\nrbtree_node_t* rbtree_index(rbtree_t* tree, int index);\nint rbtree_height(rbtree_t* tree, rbtree_node_t* node);\nint rbtree_count(rbtree_t* tree);\nvoid rbtree_visit(rbtree_node_t* node);\nvoid rbtree_traversal(rbtree_t* tree, rbtree_node_t* node, rbtree_visit_p);\n\n#endif  /* _RBTREE_H_INCLUDED_ */\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 可以看到，我增加了按序号查找结点、求树高、求结点数、可重写访问节点方法的遍历，这么几个功能。<br>&nbsp;&nbsp;&nbsp; 为了提高按序号查找结点的效率，我增加了一个结点项node_cnt，代表当前结点为根的子树上的结点总数。这样按序号查找结点的过程将是一个二分查找，时间效率与按key查找相同，都是O(log2n)。<br>&nbsp;&nbsp;&nbsp; 遍历方法使用递归的中序遍历，默认的结点访问方法是个空方法，用户可以自行重写。<br>&nbsp;&nbsp;&nbsp; rbtree.c：</p>\n<pre><code class=\"hljs\">/*\n * Copyright (C) Bipedal Bit\n * Verson 1.0.0.2\n */\n\n#include &lt;stddef.h&gt;\n#include &quot;rbtree.h&quot;\n\n/* inline methods */\n/* get the node with the minimum key in a subtree of the red-black tree */\nstatic inline rbtree_node_t*\nrbtree_subtree_min(rbtree_node_t* node, rbtree_node_t* sentinel)\n&#123;\n    while(node-&gt;left != sentinel)\n    &#123;\n        node = node-&gt;left;\n    &#125;\n\n    return node;\n&#125;\n\n/* replace the node &quot;node&quot; in the tree with node &quot;tmp&quot; */\nstatic inline void rbtree_replace(rbtree_t* tree,\n    rbtree_node_t* node, rbtree_node_t* tmp)\n&#123;\n    /* upward: p[node] &lt;- p[tmp] */\n    tmp-&gt;parent = node-&gt;parent;\n\n    if (node == tree-&gt;root)\n    &#123;\n        tree-&gt;root = tmp;\n    &#125;\n    else if (node == node-&gt;parent-&gt;left)\n    &#123;\n        /* downward: left[p[node]] &lt;- tmp */\n        node-&gt;parent-&gt;left = tmp;\n    &#125;\n    else\n    &#123;\n        /* downward: right[p[node]] &lt;- tmp */\n        node-&gt;parent-&gt;right = tmp;\n    &#125;\n\n    node-&gt;parent = tmp;\n&#125;\n\n/* change the topologic structure of the tree keeping the order of the nodes */\nstatic inline void rbtree_left_rotate(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    /* node as the var x in CLRS while tmp as the var y */\n    rbtree_node_t* tmp = node-&gt;right;\n\n    /* fix node_cnt */\n    node-&gt;node_cnt = node-&gt;left-&gt;node_cnt + tmp-&gt;left-&gt;node_cnt + 1;\n    tmp-&gt;node_cnt = node-&gt;node_cnt + tmp-&gt;right-&gt;node_cnt + 1;\n\n    /* replace y with left[y] */\n    /* downward: right[x] &lt;- left[y] */\n    node-&gt;right = tmp-&gt;left;\n    /* if left[[y] is not NIL it has a parent */\n    if (tmp-&gt;left != tree-&gt;sentinel)\n    &#123;\n        /* upward: p[left[y]] &lt;- x */\n        tmp-&gt;left-&gt;parent = node;\n    &#125;\n\n    /* replace x with y */\n    rbtree_replace(tree, node, tmp);\n    tmp-&gt;left = node;\n&#125;\n\nstatic inline void rbtree_right_rotate(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    rbtree_node_t* tmp = node-&gt;left;\n\n    /* fix node_cnt */\n    node-&gt;node_cnt = node-&gt;right-&gt;node_cnt + tmp-&gt;right-&gt;node_cnt + 1;\n    tmp-&gt;node_cnt = node-&gt;node_cnt + tmp-&gt;left-&gt;node_cnt + 1;\n\n    /* replace y with right[y] */\n    node-&gt;left = tmp-&gt;right;\n    if (tmp-&gt;right != tree-&gt;sentinel)\n    &#123;\n        tmp-&gt;right-&gt;parent = node;\n    &#125;\n\n    /* replace x with y */\n    rbtree_replace(tree, node, tmp);\n    tmp-&gt;right = node;\n&#125;\n\n/* static methods */\n/* fix the red-black tree after the new node inserted */\nstatic void rbtree_insert_fixup(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    while(rbtree_is_red(node-&gt;parent))\n    &#123;\n        if (node-&gt;parent == node-&gt;parent-&gt;parent-&gt;left)\n        &#123;\n            /* case 1: node&#39;s uncle is red */\n            if (rbtree_is_red(node-&gt;parent-&gt;parent-&gt;right))\n            &#123;\n                rbtree_black(node-&gt;parent);\n                rbtree_black(node-&gt;parent-&gt;parent-&gt;right);\n                rbtree_red(node-&gt;parent-&gt;parent);\n                node = node-&gt;parent-&gt;parent;\n                /* Then we can consider the whole subtree */\n                /* which is represented by the new &quot;node&quot; as the &quot;node&quot; before */\n                /* and keep looping till &quot;node&quot; become the root. */\n            &#125;\n            /* case 2: node&#39;s uncle is black */\n            else\n            &#123;\n                /* ensure node is the left kid of its parent */\n                if (node == node-&gt;parent-&gt;right)\n                &#123;\n                    node = node-&gt;parent;\n                    rbtree_left_rotate(tree, node);\n                &#125;\n                /* case 2 -&gt; case 1 */\n                rbtree_black(node-&gt;parent);\n                rbtree_red(node-&gt;parent-&gt;parent);\n                rbtree_right_rotate(tree, node-&gt;parent-&gt;parent);\n            &#125;\n        &#125;\n        /* same as the &quot;if&quot; clause before with &quot;left&quot; and &quot;right&quot; exchanged */\n        else\n        &#123;\n            if (rbtree_is_red(node-&gt;parent-&gt;parent-&gt;left))\n            &#123;\n                rbtree_black(node-&gt;parent);\n                rbtree_black(node-&gt;parent-&gt;parent-&gt;left);\n                rbtree_red(node-&gt;parent-&gt;parent);\n                node = node-&gt;parent-&gt;parent;\n            &#125;\n            else\n            &#123;\n                if (node == node-&gt;parent-&gt;left)\n                &#123;\n                    node = node-&gt;parent;\n                    rbtree_right_rotate(tree, node);\n                &#125;\n                rbtree_black(node-&gt;parent);\n                rbtree_red(node-&gt;parent-&gt;parent);\n                rbtree_left_rotate(tree, node-&gt;parent-&gt;parent);\n            &#125;\n        &#125;\n    &#125;\n    /* ensure the root node being black */\n    rbtree_black(tree-&gt;root);\n&#125;\n\nstatic void rbtree_delete_fixup(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    rbtree_node_t* brother = NULL;\n\n    while(node != tree-&gt;root &amp;&amp; rbtree_is_black(node))\n    &#123;\n        if (node == node-&gt;parent-&gt;left)\n        &#123;\n            brother = node-&gt;parent-&gt;right;\n            if (rbtree_is_red(brother))\n            &#123;\n                rbtree_black(brother);\n                rbtree_red(node-&gt;parent);\n                rbtree_left_rotate(tree, node-&gt;parent);\n                /* update brother after topologic change of the tree */\n                brother = node-&gt;parent-&gt;right;\n            &#125;\n\n            if (rbtree_is_black(brother-&gt;left) &amp;&amp; rbtree_is_black(brother-&gt;right))\n            &#123;\n                rbtree_red(brother);\n                /* go upward and keep on fixing color */\n                node = node-&gt;parent;\n            &#125;\n            else\n            &#123;\n                if (rbtree_is_black(brother-&gt;right))\n                &#123;\n                    rbtree_black(brother-&gt;left);\n                    rbtree_red(brother);\n                    rbtree_right_rotate(tree, brother);\n                    /* update brother after topologic change of the tree */\n                    brother = node-&gt;parent-&gt;right;\n                &#125;\n                rbtree_copy_color(brother, node-&gt;parent);\n                rbtree_black(node-&gt;parent);\n                rbtree_black(brother-&gt;right);\n                rbtree_left_rotate(tree, node-&gt;parent);\n                /* end the loop and ensure root is black */\n                node = tree-&gt;root;\n            &#125;\n        &#125;\n        /* same as the &quot;if&quot; clause before with &quot;left&quot; and &quot;right&quot; exchanged */\n        else\n        &#123;\n            brother = node-&gt;parent-&gt;left;\n            if (rbtree_is_red(brother))\n            &#123;\n                rbtree_black(brother);\n                rbtree_red(node-&gt;parent);\n                rbtree_left_rotate(tree, node-&gt;parent);\n                brother = node-&gt;parent-&gt;left;\n            &#125;\n\n            if (rbtree_is_black(brother-&gt;left) &amp;&amp; rbtree_is_black(brother-&gt;right))\n            &#123;\n                rbtree_red(brother);\n                node = node-&gt;parent;\n            &#125;\n            else\n            &#123;\n                if (rbtree_is_black(brother-&gt;left))\n                &#123;\n                    rbtree_black(brother-&gt;right);\n                    rbtree_red(brother);\n                    rbtree_right_rotate(tree, brother);\n                    brother = node-&gt;parent-&gt;left;\n                &#125;\n                rbtree_copy_color(brother, node-&gt;parent);\n                rbtree_black(node-&gt;parent);\n                rbtree_black(brother-&gt;left);\n                rbtree_left_rotate(tree, node-&gt;parent);\n                node = tree-&gt;root;\n            &#125;\n        &#125;\n    &#125;\n\n    rbtree_black(node);\n&#125;\n\n/* public methods */\nvoid rbtree_insert_value(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    /* Using ** to know wether the new node will be a left kid */\n    /* or a right kid of its parent node. */\n    rbtree_node_t** tmp = &amp;tree-&gt;root;\n    rbtree_node_t* parent;\n\n    while(*tmp != tree-&gt;sentinel)\n    &#123;\n        parent = *tmp;\n\n        /* update node_cnt */\n        (parent-&gt;node_cnt)++;\n\n        tmp = (node-&gt;key &lt; parent-&gt;key) ? &amp;parent-&gt;left : &amp;parent-&gt;right;\n    &#125;\n\n    /* The pointer knows wether the node should be on the left side */\n    /* or on the right one. */\n    *tmp = node;\n    node-&gt;parent = parent;\n    node-&gt;left = tree-&gt;sentinel;\n    node-&gt;right = tree-&gt;sentinel;\n    rbtree_red(node);\n&#125;\n\nvoid rbtree_visit(rbtree_node_t* node)\n&#123;\n    /* visiting the current node */\n&#125;\n\nvoid rbtree_insert(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    rbtree_node_t* sentinel = tree-&gt;sentinel;\n\n    /* if the tree is empty */\n    if (tree-&gt;root == sentinel)\n    &#123;\n        tree-&gt;root = node;\n        node-&gt;parent = sentinel;\n        node-&gt;left = sentinel;\n        node-&gt;right = sentinel;\n        rbtree_black(node);\n\n        return;\n    &#125;\n\n    /* generally */\n    tree-&gt;insert(tree, node);\n    rbtree_insert_fixup(tree, node);\n&#125;\n\nvoid rbtree_delete(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    rbtree_node_t* sentinel = tree-&gt;sentinel;\n    /* wether &quot;node&quot; is on the left side or the right one */\n    rbtree_node_t** ptr_to_node = NULL;\n    /* &quot;cover&quot; is the node which is going to cover &quot;node&quot; */\n    rbtree_node_t* cover = NULL;\n    /* wether we lossing a red node on the edge of the tree */\n    int loss_red = rbtree_is_red(node);\n    int is_root = (node == tree-&gt;root);\n\n    /* get &quot;cover&quot; &amp; &quot;loss_red&quot;  */\n    /* sentinel in &quot;node&quot;&#39;s kids */\n    if (node-&gt;left == sentinel)\n    &#123;\n        cover = node-&gt;right;\n    &#125;\n    else if (node-&gt;right == sentinel)\n    &#123;\n        cover = node-&gt;left;\n    &#125;\n    /* &quot;node&quot;&#39;s kids are both non-sentinel */\n    else\n    &#123;\n        /* update &quot;node&quot; &amp; &quot;loss_red&quot; &amp; &quot;is_root&quot; &amp; &quot;cover&quot; */\n        cover = rbtree_subtree_min(node-&gt;right, sentinel);\n        node-&gt;key = cover-&gt;key;\n        node-&gt;value = cover-&gt;value;\n        node = cover;\n        loss_red = rbtree_is_red(node);\n        is_root = 0;\n        /* move &quot;cover&quot;&#39;s kids */\n        /* &quot;cover&quot; can only be a left kid */\n        /* and can only have a right non-sentinel kid */\n        /* because of function &quot;rbtree_subtree_min&quot; */\n        cover = node-&gt;right;\n    &#125;\n\n    if (is_root)\n    &#123;\n        /* update root */\n        tree-&gt;root = cover;\n    &#125;\n    else\n    &#123;\n        /* downward link */\n        if (node == node-&gt;parent-&gt;left)\n        &#123;\n            node-&gt;parent-&gt;left = cover;\n        &#125;\n        else\n        &#123;\n            node-&gt;parent-&gt;right = cover;\n        &#125;\n    &#125;\n    /* upward link */\n    cover-&gt;parent = node-&gt;parent;\n    /* &quot;cover&quot; may be a sentinel */\n    if (cover != sentinel)\n    &#123;\n        /* set &quot;cover&quot; */\n        cover-&gt;left = node-&gt;left;\n        cover-&gt;right = node-&gt;right;\n        rbtree_copy_color(cover, node);\n    &#125;\n\n    /* clear &quot;node&quot; since it&#39;s useless */\n    node-&gt;key = -1;\n    node-&gt;parent = NULL;\n    node-&gt;left = NULL;\n    node-&gt;right = NULL;\n    node-&gt;value = NULL;\n\n    /* update node_cnt */\n    rbtree_node_t* tmp = cover-&gt;parent;\n    while(tmp != sentinel)\n    &#123;\n        (tmp-&gt;node_cnt)--;\n        tmp = tmp-&gt;parent;\n    &#125;\n\n    if (loss_red)\n    &#123;\n        return;\n    &#125;\n\n    /* When lossing a black node on edge */\n    /* the fifth rule of red-black tree will be broke. */\n    /* So the tree need to be fixed. */\n    rbtree_delete_fixup(tree, cover);\n&#125;\n\n/* find the node in the tree corresponding to the given key value */\nrbtree_node_t* rbtree_find(rbtree_t* tree, rbtree_key_t key)\n&#123;\n    rbtree_node_t* tmp = tree-&gt;root;\n    /* next line is just fot test */\n    // int step_cnt = 0;\n\n    /* search the binary tree */\n    while(tmp != tree-&gt;sentinel)\n    &#123;\n        /* next line is just fot test */\n        // step_cnt++;\n        if(key == tmp-&gt;key)\n        &#123;\n            /* next line is just for test */\n            // printf(&quot;step count: %d, color: %s, &quot;, step_cnt, rbtree_is_red(tmp) ? &quot;red&quot; : &quot;black&quot;);\n            return tmp;\n        &#125;\n\n        tmp = (key &lt; tmp-&gt;key) ? tmp-&gt;left : tmp-&gt;right;\n    &#125;\n\n    return NULL;\n&#125;\n\n/* find the node in the tree corresponding to the given order number */\nrbtree_node_t* rbtree_index(rbtree_t* tree, int index)\n&#123;\n    if (index &lt; 0 || index &gt;= rbtree_count(tree))\n    &#123;\n        return NULL;\n    &#125;\n\n    rbtree_node_t* tmp = tree-&gt;root;\n    int left_cnt = 0;\n    int sub_left_cnt;\n\n    while(tmp-&gt;node_cnt &gt; 0)\n    &#123;\n        sub_left_cnt = tmp-&gt;left-&gt;node_cnt;\n        if (left_cnt + sub_left_cnt == index)\n        &#123;\n            return tmp;\n        &#125;\n\n        if (left_cnt + sub_left_cnt &lt; index)\n        &#123;\n            left_cnt += sub_left_cnt + 1;\n            tmp = tmp-&gt;right;\n        &#125;\n        else\n        &#123;\n            tmp = tmp-&gt;left;\n        &#125;\n    &#125;\n&#125;\n\n/* get the height of the subtree */\nint rbtree_height(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    if (node == tree-&gt;sentinel)\n    &#123;\n        return 0;\n    &#125;\n\n    int left_height = rbtree_height(tree, node-&gt;left);\n    int right_height = rbtree_height(tree, node-&gt;right);\n    int sub_height = (left_height &gt; right_height) ? left_height : right_height;\n    return sub_height+1;\n&#125;\n\n/* get the count of nodes in the tree */\nint rbtree_count(rbtree_t* tree)\n&#123;\n    return tree-&gt;root-&gt;node_cnt;\n&#125;\n\n/* visit every node of the subtree whose root is given in order */\nvoid rbtree_traversal(rbtree_t* tree, rbtree_node_t* node, rbtree_visit_p visit)\n&#123;\n    if (node != tree-&gt;sentinel)\n    &#123;\n        rbtree_traversal(tree, node-&gt;left, visit);\n        visit(node);\n        rbtree_traversal(tree, node-&gt;right, visit);\n    &#125;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 还是做个压力测试。<br>&nbsp;&nbsp;&nbsp; test.c：</p>\n<pre><code class=\"hljs\">#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;time.h&gt;\n#include &quot;rbtree.h&quot;\n\nint main(int argc, char const *argv[])\n&#123;\n    double duration;\n    double room;\n\n    rbtree_t t = &#123;&#125;;\n    rbtree_node_t s = &#123;&#125;;\n    rbtree_init(&amp;t, &amp;s, rbtree_insert_value);\n\n    const int cnt = 1&lt;&lt;20;\n    const int max_len = 15;\n\n#define TEST_VALUES &#123;&quot;apple&quot;, &quot;banana&quot;, &quot;cherry&quot;, &quot;grape&quot;, &quot;lemon&quot;, &quot;mango&quot;, &quot;pear&quot;, &quot;pineapple&quot;, &quot;strawberry&quot;, &quot;watermelon&quot;&#125;\n\n    /* for gcc */\n    char* v[] = TEST_VALUES;\n    /* for g++ */\n    // char v[][max_len] = TEST_VALUES;\n\n    /* Default stack size in Ubuntu Kylin 14.04 is 8MB. */\n    /* It&#39;s not enough. So I use memory in heap which offers a lot larger room. */\n    rbtree_node_t* n = (rbtree_node_t*)calloc(cnt, sizeof(rbtree_node_t));\n    int i;\n\n    long time1 = clock();\n\n    for (i = 0; i &lt; cnt; i++)\n    &#123;\n        n[i].key = i+1;\n        n[i].value = v[i%10];\n        n[i].node_cnt = 1;\n        rbtree_insert(&amp;t, &amp;n[i]);\n    &#125;\n\n    srand( (unsigned int)time(0) );\n    int no = rand()%cnt;\n    printf(&quot;n[%d]-&gt;key = %d\\n&quot;, no, rbtree_index(&amp;t, no)-&gt;key);\n\n    long time2 = clock();\n    room = 48.0*cnt/(1&lt;&lt;20);\n    duration = (double)(time2 - time1) / CLOCKS_PER_SEC;\n    printf(&quot;Inserting %d nodes costs %.2fMB and spends %f seconds.\\n&quot;, cnt, room, duration);\n\n    const int search_cnt = 1&lt;&lt;10;\n    for( i = 0 ; i &lt; search_cnt ; i++ )\n    &#123;\n        rbtree_find(&amp;t, (rand()%cnt)+1);\n    &#125;\n\n    long time3 = clock();\n    duration = (double)(time3 - time2) / CLOCKS_PER_SEC;\n    printf(&quot;Searching %d nodes among %d spends %f seconds.\\n&quot;, search_cnt, cnt, duration);\n\n    const int index_cnt = 1&lt;&lt;10;\n    for( i = 0 ; i &lt; index_cnt ; i++ )\n    &#123;\n        rbtree_index(&amp;t, (rand()%cnt));\n    &#125;\n\n    long time4 = clock();\n    duration = (double)(time4 - time3) / CLOCKS_PER_SEC;\n    printf(&quot;Indexing %d nodes among %d spends %f seconds.\\n&quot;, index_cnt, cnt, duration);\n\n    const int delete_cnt = 1&lt;&lt;10;\n    int nums[delete_cnt];\n    int num;\n    /* Let&#39;s hash! */\n    char* mark = (char*)calloc(cnt, sizeof(char));\n    memset(mark, 0, cnt*sizeof(char));\n    for(i = 0; i &lt; delete_cnt; i++)\n    &#123;\n        for(;;)\n        &#123;\n            num = rand()%cnt;\n            if (mark[num] == 0)\n            &#123;\n                mark[num] = 1;\n                nums[i] = num;\n                break;\n            &#125;\n        &#125;\n    &#125;\n\n    long time5 = clock();\n    duration = (double)(time5 - time4) / CLOCKS_PER_SEC;\n    printf(&quot;Hash %d times spends %f seconds.\\n&quot;, delete_cnt, duration);\n\n    for(i = 0; i &lt; delete_cnt; i++)\n    &#123;\n        rbtree_delete(&amp;t, &amp;n[nums[i]]);\n    &#125;\n\n    long time6 = clock();\n    duration = (double)(time6 - time5) / CLOCKS_PER_SEC;\n    printf(&quot;Deleting %d nodes among %d spends %f seconds.\\n&quot;, delete_cnt, cnt, duration);\n    free(mark);\n\n    int h = rbtree_height(&amp;t, t.root);\n    long time7 = clock();\n    duration = (double)(time7 - time6) / CLOCKS_PER_SEC;\n    printf(&quot;The height of the tree is %d. Getting it spends %f seconds.\\n&quot;, h, duration);\n\n    rbtree_traversal(&amp;t, t.root, rbtree_visit);\n    long time8 = clock();\n    duration = (double)(time8 - time7) / CLOCKS_PER_SEC;\n    printf(&quot;Traversal the tree spends %f seconds.\\n&quot;, duration);\n\n    printf(&quot;Count of nodes in the tree is %d.\\n&quot;, rbtree_count(&amp;t));\n\n    free(n);\n\n    return 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 上一个版本的压力测试结果：</p>\n<pre><code class=\"hljs\">Inserting 1048576 nodes costs 48.00MB and spends 0.425416 seconds.\nSearching 1024 nodes among 1048576 spends 0.001140 seconds.\nHash 1024 times spends 0.000334 seconds.\nDeleting 1024 nodes among 1048576 spends 0.000783 seconds.\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 扩展版本的压力测试结果：</p>\n<pre><code class=\"hljs\">Inserting 1048576 nodes costs 48.00MB and spends 0.467859 seconds.\nSearching 1024 nodes among 1048576 spends 0.001188 seconds.\nIndexing 1024 nodes among 1048576 spends 0.001484 seconds.\nHash 1024 times spends 0.000355 seconds.\nDeleting 1024 nodes among 1048576 spends 0.001417 seconds.\nThe height of the tree is 28. Getting it spends 0.021669 seconds.\nTraversal the tree spends 0.023913 seconds.\nCount of nodes in the tree is 1047552.\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 比较一下可以发现：<br>&nbsp;&nbsp;&nbsp; 1.插入结点略慢了一点，因为插入时多维护了一个node_cnt项。<br>&nbsp;&nbsp;&nbsp; 2.按key查找结点速度没有变化。<br>&nbsp;&nbsp;&nbsp; 3.哈希查找速度没有变化。<br>&nbsp;&nbsp;&nbsp; 4.删除结点花的时间几乎是原来的两倍，因为每次删除后都要一路向上更新node_cnt，几乎相当于包含了一次按key查询。<br>&nbsp;&nbsp;&nbsp; 5.按序号查询比按key查询略慢，因为每次进入右子树需要多做一次加法。<br>&nbsp;&nbsp;&nbsp; 6.遍历花的时间与求树高相同，因为它们的实质都是遍历树，时间效率O(n)数量级，具体点为2n次结点访问，分别为结点入栈和出栈时。<br>&nbsp;&nbsp;&nbsp; 别问我max、min、mid在哪，能按序号查询了这些还是问题吗？</p>\n",
            "tags": [
                "nginx",
                "rbtree",
                "C"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/08/16/Linux%E4%B8%8BSublime%E7%9A%84C-C-%E5%A4%9A%E6%96%87%E4%BB%B6%E7%A8%8B%E5%BA%8FMakefile-%E6%B8%85%E7%90%86-%E6%89%A7%E8%A1%8C%E9%85%8D%E7%BD%AE/",
            "url": "https://blog.bipedalbit.net/2015/08/16/Linux%E4%B8%8BSublime%E7%9A%84C-C-%E5%A4%9A%E6%96%87%E4%BB%B6%E7%A8%8B%E5%BA%8FMakefile-%E6%B8%85%E7%90%86-%E6%89%A7%E8%A1%8C%E9%85%8D%E7%BD%AE/",
            "title": "Linux下Sublime的C/C++多文件程序Makefile+清理+执行配置",
            "date_published": "2015-08-16T14:45:46.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 不自己动手为Sublime配个C&#x2F;C++的通用Makefile脚本吗？不能自动编译链接多文件的编辑器不是好IDE。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 首先我们需要了解几个事实：</p>\n<p>&nbsp;&nbsp;&nbsp; 1.Sublime自带的C&#x2F;C++编译+执行配置使用的是g++编译器，此外这套配置只针对单文件程序。如果要编译多文件，只能采用入口函数所在文件包含需要的源文件而非头文件的方式。比起我们熟悉的几种IDE，这显然无法令人接受。</p>\n<p>&nbsp;&nbsp;&nbsp; 2.Linux下的C&#x2F;C++程序员应该熟悉Makefile，Makefile可以算是一种脚本，执行关键字是一般是make，它可以设计多文件程序的编译+链接过程，生成.o文件和可执行文件。</p>\n<p>&nbsp;&nbsp;&nbsp; 3.Sublime也有默认的Make配置，但是第一，Sublime没有提供通用的C&#x2F;C++的Makefile脚本（自动组织而非每次手动重写），第二点是个小瑕疵，Sublime提供的Make配置只有编译、链接、清理功能，执行程序需要手动。</p>\n<p>&nbsp;&nbsp;&nbsp; 之前重写红黑树最重要的副产品就是一个通用的C&#x2F;C++的Makefile脚本。每次使用基本只需要改改输出的可执行文件名，或者干脆想个默认文件名以后都不改了，gcc&#x2F;g++编译器的选择是自动的，当然也可以手动配置一些编译选项，这个自己看脚本注释就好。上干货：</p>\n<pre><code class=\"hljs\">#############################################################\n# Generic Makefile for C/C++ Program\n#\n# License: GPL (General Public License)\n# Author:  whyglinux &lt;whyglinux AT gmail DOT com&gt;\n# Date:    2006/03/04 (version 0.1)\n#          2007/03/24 (version 0.2)\n#          2007/04/09 (version 0.3)\n#          2007/06/26 (version 0.4)\n#          2008/04/05 (version 0.5)\n#\n# Description:\n# ------------\n# This is an easily customizable makefile template. The purpose is to\n# provide an instant building environment for C/C++ programs.\n#\n# It searches all the C/C++ source files in the specified directories,\n# makes dependencies, compiles and links to form an executable.\n#\n# Besides its default ability to build C/C++ programs which use only\n# standard C/C++ libraries, you can customize the Makefile to build\n# those using other libraries. Once done, without any changes you can\n# then build programs using the same or less libraries, even if source\n# files are renamed, added or removed. Therefore, it is particularly\n# convenient to use it to build codes for experimental or study use.\n#\n# GNU make is expected to use the Makefile. Other versions of makes\n# may or may not work.\n#\n# Usage:\n# ------\n# 1. Copy the Makefile to your program directory.\n# 2. Customize in the &quot;Customizable Section&quot; only if necessary:\n#    * to use non-standard C/C++ libraries, set pre-processor or compiler\n#      options to &lt;MY_CFLAGS&gt; and linker ones to &lt;MY_LIBS&gt;\n#      (See Makefile.gtk+-2.0 for an example)\n#    * to search sources in more directories, set to &lt;SRCDIRS&gt;\n#    * to specify your favorite program name, set to &lt;PROGRAM&gt;\n# 3. Type make to start building your program.\n#\n# Make Target:\n# ------------\n# The Makefile provides the following targets to make:\n#   $ make           compile and link\n#   $ make NODEP=yes compile and link without generating dependencies\n#   $ make objs      compile only (no linking)\n#   $ make tags      create tags for Emacs editor\n#   $ make ctags     create ctags for VI editor\n#   $ make clean     clean objects and the executable file\n#   $ make distclean clean objects, the executable and dependencies\n#   $ make help      get the usage of the makefile\n#\n#===========================================================================\n\n## Customizable Section: adapt those variables to suit your program.\n##==========================================================================\n\n# The pre-processor and compiler options.\nMY_CFLAGS =\n\n# The linker options.\nMY_LIBS   =\n\n# The pre-processor options used by the cpp (man cpp for more).\n# CPPFLAGS  = -Wall\n\n# The options used in linking as well as in any direct use of ld.\nLDFLAGS   =\n\n# The directories in which source files reside.\n# If not specified, only the current directory will be serached.\nSRCDIRS   =\n\n# The executable file name.\n# If not specified, current directory name or `a.out&#39; will be used.\nPROGRAM   = test\n\n## Implicit Section: change the following only when necessary.\n##==========================================================================\n\n# The source file types (headers excluded).\n# .c indicates C source files, and others C++ ones.\nSRCEXTS = .c .C .cc .cpp .CPP .c++ .cxx .cp\n\n# The header file types.\nHDREXTS = .h .H .hh .hpp .HPP .h++ .hxx .hp\n\n# The pre-processor and compiler options.\n# Users can override those variables from the command line.\n# CFLAGS  = -g -O2\n# CXXFLAGS= -g -O2\n\n# The C program compiler.\n# CC     = gcc\n\n# The C++ program compiler.\n#CXX    = g++\n\n# Un-comment the following line to compile C programs as C++ ones.\n#CC     = $(CXX)\n\n# The command used to delete file.\n#RM     = rm -f\n\nETAGS = etags\nETAGSFLAGS =\n\nCTAGS = ctags\nCTAGSFLAGS =\n\n## Stable Section: usually no need to be changed. But you can add more.\n##==========================================================================\nSHELL   = /bin/sh\nEMPTY   =\nSPACE   = $(EMPTY) $(EMPTY)\nifeq ($(PROGRAM),)\n  CUR_PATH_NAMES = $(subst /,$(SPACE),$(subst $(SPACE),_,$(CURDIR)))\n  PROGRAM = $(word $(words $(CUR_PATH_NAMES)),$(CUR_PATH_NAMES))\n  ifeq ($(PROGRAM),)\n    PROGRAM = a.out\n  endif\nendif\nifeq ($(SRCDIRS),)\n  SRCDIRS = .\nendif\nSOURCES = $(foreach d,$(SRCDIRS),$(wildcard $(addprefix $(d)/*,$(SRCEXTS))))\nHEADERS = $(foreach d,$(SRCDIRS),$(wildcard $(addprefix $(d)/*,$(HDREXTS))))\nSRC_CXX = $(filter-out %.c,$(SOURCES))\nOBJS    = $(addsuffix .o, $(basename $(SOURCES)))\nDEPS    = $(OBJS:.o=.d)\n\n## Define some useful variables.\nDEP_OPT = $(shell if `$(CC) --version | grep &quot;GCC&quot; &gt;/dev/null`; then \\\n                  echo &quot;-MM -MP&quot;; else echo &quot;-M&quot;; fi )\nDEPEND      = $(CC)  $(DEP_OPT)  $(MY_CFLAGS) $(CFLAGS) $(CPPFLAGS)\nDEPEND.d    = $(subst -g ,,$(DEPEND))\nCOMPILE.c   = $(CC)  $(MY_CFLAGS) $(CFLAGS)   $(CPPFLAGS) -c\nCOMPILE.cxx = $(CXX) $(MY_CFLAGS) $(CXXFLAGS) $(CPPFLAGS) -c\nLINK.c      = $(CC)  $(MY_CFLAGS) $(CFLAGS)   $(CPPFLAGS) $(LDFLAGS)\nLINK.cxx    = $(CXX) $(MY_CFLAGS) $(CXXFLAGS) $(CPPFLAGS) $(LDFLAGS)\n\n.PHONY: all objs tags ctags clean distclean help show\n\n# Delete the default suffixes\n.SUFFIXES:\n\nall: $(PROGRAM)\n\n# Rules for creating dependency files (.d).\n#------------------------------------------\n\n%.d:%.c\n    @echo -n $(dir $&lt;) &gt; $@\n    @$(DEPEND.d) $&lt; &gt;&gt; $@\n\n%.d:%.C\n    @echo -n $(dir $&lt;) &gt; $@\n    @$(DEPEND.d) $&lt; &gt;&gt; $@\n\n%.d:%.cc\n    @echo -n $(dir $&lt;) &gt; $@\n    @$(DEPEND.d) $&lt; &gt;&gt; $@\n\n%.d:%.cpp\n    @echo -n $(dir $&lt;) &gt; $@\n    @$(DEPEND.d) $&lt; &gt;&gt; $@\n\n%.d:%.CPP\n    @echo -n $(dir $&lt;) &gt; $@\n    @$(DEPEND.d) $&lt; &gt;&gt; $@\n\n%.d:%.c++\n    @echo -n $(dir $&lt;) &gt; $@\n    @$(DEPEND.d) $&lt; &gt;&gt; $@\n\n%.d:%.cp\n    @echo -n $(dir $&lt;) &gt; $@\n    @$(DEPEND.d) $&lt; &gt;&gt; $@\n\n%.d:%.cxx\n    @echo -n $(dir $&lt;) &gt; $@\n    @$(DEPEND.d) $&lt; &gt;&gt; $@\n\n# Rules for generating object files (.o).\n#----------------------------------------\nobjs:$(OBJS)\n\n%.o:%.c\n    $(COMPILE.c) $&lt; -o $@\n\n%.o:%.C\n    $(COMPILE.cxx) $&lt; -o $@\n\n%.o:%.cc\n    $(COMPILE.cxx) $&lt; -o $@\n\n%.o:%.cpp\n    $(COMPILE.cxx) $&lt; -o $@\n\n%.o:%.CPP\n    $(COMPILE.cxx) $&lt; -o $@\n\n%.o:%.c++\n    $(COMPILE.cxx) $&lt; -o $@\n\n%.o:%.cp\n    $(COMPILE.cxx) $&lt; -o $@\n\n%.o:%.cxx\n    $(COMPILE.cxx) $&lt; -o $@\n\n# Rules for generating the tags.\n#-------------------------------------\ntags: $(HEADERS) $(SOURCES)\n    $(ETAGS) $(ETAGSFLAGS) $(HEADERS) $(SOURCES)\n\nctags: $(HEADERS) $(SOURCES)\n    $(CTAGS) $(CTAGSFLAGS) $(HEADERS) $(SOURCES)\n\n# Rules for generating the executable.\n#-------------------------------------\n$(PROGRAM):$(OBJS)\nifeq ($(SRC_CXX),)              # C program\n    $(LINK.c)   $(OBJS) $(MY_LIBS) -o $@\n    @echo Type ./$@ to execute the program.\nelse                            # C++ program\n    $(LINK.cxx) $(OBJS) $(MY_LIBS) -o $@\n    @echo Type ./$@ to execute the program.\nendif\n\nifndef NODEP\nifneq ($(DEPS),)\n  sinclude $(DEPS)\nendif\nendif\n\nclean:\n    $(RM) $(OBJS) $(PROGRAM) $(PROGRAM).exe\n\ndistclean: clean\n    $(RM) $(DEPS) TAGS\n\n# Show help.\nhelp:\n    @echo &#39;Generic Makefile for C/C++ Programs (gcmakefile) version 0.5&#39;\n    @echo &#39;Copyright (C) 2007, 2008 whyglinux &lt;whyglinux@hotmail.com&gt;&#39;\n    @echo\n    @echo &#39;Usage: make [TARGET]&#39;\n    @echo &#39;TARGETS:&#39;\n    @echo &#39;  all       (=make) compile and link.&#39;\n    @echo &#39;  NODEP=yes make without generating dependencies.&#39;\n    @echo &#39;  objs      compile only (no linking).&#39;\n    @echo &#39;  tags      create tags for Emacs editor.&#39;\n    @echo &#39;  ctags     create ctags for VI editor.&#39;\n    @echo &#39;  clean     clean objects and the executable file.&#39;\n    @echo &#39;  distclean clean objects, the executable and dependencies.&#39;\n    @echo &#39;  show      show variables (for debug use only).&#39;\n    @echo &#39;  help      print this message.&#39;\n    @echo\n    @echo &#39;Report bugs to &lt;whyglinux AT gmail DOT com&gt;.&#39;\n\n# Show variables (for debug use only.)\nshow:\n    @echo &#39;PROGRAM     :&#39; $(PROGRAM)\n    @echo &#39;SRCDIRS     :&#39; $(SRCDIRS)\n    @echo &#39;HEADERS     :&#39; $(HEADERS)\n    @echo &#39;SOURCES     :&#39; $(SOURCES)\n    @echo &#39;SRC_CXX     :&#39; $(SRC_CXX)\n    @echo &#39;OBJS        :&#39; $(OBJS)\n    @echo &#39;DEPS        :&#39; $(DEPS)\n    @echo &#39;DEPEND      :&#39; $(DEPEND)\n    @echo &#39;COMPILE.c   :&#39; $(COMPILE.c)\n    @echo &#39;COMPILE.cxx :&#39; $(COMPILE.cxx)\n    @echo &#39;link.c      :&#39; $(LINK.c)\n    @echo &#39;link.cxx    :&#39; $(LINK.cxx)\n\n## End of the Makefile ##  Suggestions are welcome  ## All rights reserved ##\n##############################################################\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 感谢whyglinux大大！然后上Sublime的配置C C++ Multiple Files.sublime-build：</p>\n<pre><code class=\"hljs\">&#123;\n    &quot;shell_cmd&quot;: &quot;make&quot;,\n    &quot;file_regex&quot;: &quot;^(..[^:\\n]*):([0-9]+):?([0-9]+)?:? (.*)$&quot;,\n    &quot;working_dir&quot;: &quot;$&#123;folder:$&#123;project_path:$&#123;file_path&#125;&#125;&#125;&quot;,\n    &quot;selector&quot;: &quot;source.c, source.cpp&quot;,\n    &quot;syntax&quot;: &quot;Packages/Makefile/Make.build-language&quot;,\n    &quot;keyfiles&quot;: [&quot;Makefile&quot;, &quot;makefile&quot;],\n\n    &quot;variants&quot;:\n    [\n        &#123;\n            &quot;name&quot;: &quot;Clean&quot;,\n            &quot;shell_cmd&quot;: &quot;make clean&quot;\n        &#125;,\n        &#123;\n            &quot;name&quot;: &quot;Run&quot;,\n            &quot;shell_cmd&quot;: &quot;$&#123;file_path&#125;/$&#123;file_base_name&#125;&quot;\n        &#125;\n    ]\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 你们大可以配成执行时自动弹出终端，这样还能交互。我为了解决Sublime里中文输入法的问题用了gtk2，但是gnome-terminal用的是gtk3，不兼容了。写写控制台程序也不用那么多交互，懒得折腾了，你们随意。</p>\n",
            "tags": [
                "C",
                "sublime",
                "C++",
                "makefile"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/08/16/%E3%80%90%E5%9B%9B%E3%80%91nginx%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-2-%E2%80%94%E2%80%94%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%E9%87%8D%E5%86%99%E7%BA%A2%E9%BB%91%E6%A0%91/",
            "url": "https://blog.bipedalbit.net/2015/08/16/%E3%80%90%E5%9B%9B%E3%80%91nginx%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-2-%E2%80%94%E2%80%94%E8%87%AA%E5%B7%B1%E5%8A%A8%E6%89%8B%E9%87%8D%E5%86%99%E7%BA%A2%E9%BB%91%E6%A0%91/",
            "title": "【四】nginx的数据结构(2)——自己动手重写红黑树",
            "date_published": "2015-08-16T14:06:30.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 不管看了多少遍有多滚瓜烂熟，数据结构或者算法的代码如果不亲自码一遍，我总是不敢说自己懂了。这次就来自己动手重写红黑树。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 费话不多说，上重写代码，这次姑且用英语写的注释当复习英语了。<br>&nbsp;&nbsp;&nbsp; rbtree.h：</p>\n<pre><code class=\"hljs\">/*\n * Copyright (C) Bipedal Bit\n * Verson 1.0.0.1\n */\n\n#ifndef _RBTREE_H_INCLUDED_\n#define _RBTREE_H_INCLUDED_\n\n/* the node structure of the red-black tree */\ntypedef struct rbtree_node_s rbtree_node_t;\n/* Using type int means its range is -0x7fffffff-1~0x7fffffff. */\ntypedef int rbtree_key_t;\n/* Abstract type is complicated to achieve with C so I use char* instead. */\ntypedef char* rbtree_data_t;\n\nstruct rbtree_node_s\n&#123;\n    /* key of the node */\n    rbtree_key_t    key;\n    /* pointer of the parent of the node */\n    rbtree_node_t*  parent;\n    /* pointer of the left kid of the node */\n    rbtree_node_t*  left;\n    /* pointer of the right kid of the node */\n    rbtree_node_t*  right;\n    /* color of the node */\n    unsigned char   color;\n    /* pointer of the value of the node corresponding to the key */\n    rbtree_data_t   value;\n&#125;;\n\n/* the tree object stucture of the red-black tree */\ntypedef struct rbtree_s rbtree_t;\n/* foundational insert function pointer*/\ntypedef void (*rbtree_insert_p) (rbtree_t* root, rbtree_node_t* node);\n\nstruct rbtree_s\n&#123;\n    /* the pointer of the root node of the tree */\n    rbtree_node_t* root;\n    /* black leaf nodes as sentinel */\n    rbtree_node_t* sentinel;\n    /* the polymorphic insert function pointer */\n    rbtree_insert_p insert;\n&#125;;\n\n/* macros */\n#define rbtree_init(tree, s, i)     \\\nrbtree_sentinel_init(s);            \\\n(tree)-&gt;root = s;               \\\n(tree)-&gt;sentinel = s;           \\\n(tree)-&gt;insert = i\n\n#define rbtree_red(node)    ((node)-&gt;color = 1)\n#define rbtree_black(node)  ((node)-&gt;color = 0)\n#define rbtree_is_red(node) ((node)-&gt;color)\n#define rbtree_is_black(node)   (!rbtree_is_red(node))\n /* copy n2&#39;s color to n1 */\n#define rbtree_copy_color(n1, n2)   (n1-&gt;color = n2-&gt;color)\n/* sentinel must be black cuz it&#39;s leaf node */\n#define rbtree_sentinel_init(node)  rbtree_black(node)\n\n/* statements of public methods */\nvoid rbtree_insert_value(rbtree_t* tree, rbtree_node_t* node);\nvoid rbtree_insert(rbtree_t* tree, rbtree_node_t* node);\nvoid rbtree_delete(rbtree_t* tree, rbtree_node_t* node);\nrbtree_node_t* rbtree_find(rbtree_t* tree, rbtree_key_t key);\n\n#endif  /* _RBTREE_H_INCLUDED_ */\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 看过nginx源码的有心人会发现，我的头文件相对于ngx_rbree.h改动不大，非常像。<br>&nbsp;&nbsp;&nbsp; 关键的rbtree.c：</p>\n<pre><code class=\"hljs\">/*\n * Copyright (C) Bipedal Bit\n * Verson 1.0.0.1\n */\n\n#include &lt;stddef.h&gt;\n#include &quot;rbtree.h&quot;\n\n/* inline methods */\n/* get the node with the minimum key in a subtree of the red-black tree */\nstatic inline rbtree_node_t*\nrbtree_subtree_min(rbtree_node_t* node, rbtree_node_t* sentinel)\n&#123;\n    while(node-&gt;left != sentinel)\n    &#123;\n        node = node-&gt;left;\n    &#125;\n\n    return node;\n&#125;\n\n/* replace the node &quot;node&quot; in the tree with node &quot;tmp&quot; */\nstatic inline void rbtree_replace(rbtree_t* tree,\n    rbtree_node_t* node, rbtree_node_t* tmp)\n&#123;\n    /* upward: p[node] &lt;- p[tmp] */\n    tmp-&gt;parent = node-&gt;parent;\n\n    if (node == tree-&gt;root)\n    &#123;\n        tree-&gt;root = tmp;\n    &#125;\n    else if (node == node-&gt;parent-&gt;left)\n    &#123;\n        /* downward: left[p[node]] &lt;- tmp */\n        node-&gt;parent-&gt;left = tmp;\n    &#125;\n    else\n    &#123;\n        /* downward: right[p[node]] &lt;- tmp */\n        node-&gt;parent-&gt;right = tmp;\n    &#125;\n\n    node-&gt;parent = tmp;\n&#125;\n\n/* change the topologic structure of the tree keeping the order of the nodes */\nstatic inline void rbtree_left_rotate(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    /* node as the var x in CLRS while tmp as the var y */\n    rbtree_node_t* tmp = node-&gt;right;\n\n    /* replace y with left[y] */\n    /* downward: right[x] &lt;- left[y] */\n    node-&gt;right = tmp-&gt;left;\n    /* if left[[y] is not NIL it has a parent */\n    if (tmp-&gt;left != tree-&gt;sentinel)\n    &#123;\n        /* upward: p[left[y]] &lt;- x */\n        tmp-&gt;left-&gt;parent = node;\n    &#125;\n\n    /* replace x with y */\n    rbtree_replace(tree, node, tmp);\n    tmp-&gt;left = node;\n&#125;\n\nstatic inline void rbtree_right_rotate(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    rbtree_node_t* tmp = node-&gt;left;\n\n    /* replace y with right[y] */\n    node-&gt;left = tmp-&gt;right;\n    if (tmp-&gt;right != tree-&gt;sentinel)\n    &#123;\n        tmp-&gt;right-&gt;parent = node;\n    &#125;\n\n    /* replace x with y */\n    rbtree_replace(tree, node, tmp);\n    tmp-&gt;right = node;\n&#125;\n\n/* static methods */\n/* fix the red-black tree after the new node inserted */\nstatic void rbtree_insert_fixup(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    while(rbtree_is_red(node-&gt;parent))\n    &#123;\n        if (node-&gt;parent == node-&gt;parent-&gt;parent-&gt;left)\n        &#123;\n            /* case 1: node&#39;s uncle is red */\n            if (rbtree_is_red(node-&gt;parent-&gt;parent-&gt;right))\n            &#123;\n                rbtree_black(node-&gt;parent);\n                rbtree_black(node-&gt;parent-&gt;parent-&gt;right);\n                rbtree_red(node-&gt;parent-&gt;parent);\n                node = node-&gt;parent-&gt;parent;\n                /* Then we can consider the whole subtree */\n                /* which is represented by the new &quot;node&quot; as the &quot;node&quot; before */\n                /* and keep looping till &quot;node&quot; become the root. */\n            &#125;\n            /* case 2: node&#39;s uncle is black */\n            else\n            &#123;\n                /* ensure node is the left kid of its parent */\n                if (node == node-&gt;parent-&gt;right)\n                &#123;\n                    node = node-&gt;parent;\n                    rbtree_left_rotate(tree, node);\n                &#125;\n                /* case 2 -&gt; case 1 */\n                rbtree_black(node-&gt;parent);\n                rbtree_red(node-&gt;parent-&gt;parent);\n                rbtree_right_rotate(tree, node-&gt;parent-&gt;parent);\n            &#125;\n        &#125;\n        /* same as the &quot;if&quot; clause before with &quot;left&quot; and &quot;right&quot; exchanged */\n        else\n        &#123;\n            if (rbtree_is_red(node-&gt;parent-&gt;parent-&gt;left))\n            &#123;\n                rbtree_black(node-&gt;parent);\n                rbtree_black(node-&gt;parent-&gt;parent-&gt;left);\n                rbtree_red(node-&gt;parent-&gt;parent);\n                node = node-&gt;parent-&gt;parent;\n            &#125;\n            else\n            &#123;\n                if (node == node-&gt;parent-&gt;left)\n                &#123;\n                    node = node-&gt;parent;\n                    rbtree_right_rotate(tree, node);\n                &#125;\n                rbtree_black(node-&gt;parent);\n                rbtree_red(node-&gt;parent-&gt;parent);\n                rbtree_left_rotate(tree, node-&gt;parent-&gt;parent);\n            &#125;\n        &#125;\n    &#125;\n    /* ensure the root node being black */\n    rbtree_black(tree-&gt;root);\n&#125;\n\nstatic void rbtree_delete_fixup(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    rbtree_node_t* brother = NULL;\n\n    while(node != tree-&gt;root &amp;&amp; rbtree_is_black(node))\n    &#123;\n        if (node == node-&gt;parent-&gt;left)\n        &#123;\n            brother = node-&gt;parent-&gt;right;\n            if (rbtree_is_red(brother))\n            &#123;\n                rbtree_black(brother);\n                rbtree_red(node-&gt;parent);\n                rbtree_left_rotate(tree, node-&gt;parent);\n                /* update brother after topologic change of the tree */\n                brother = node-&gt;parent-&gt;right;\n            &#125;\n\n            if (rbtree_is_black(brother-&gt;left) &amp;&amp; rbtree_is_black(brother-&gt;right))\n            &#123;\n                rbtree_red(brother);\n                /* go upward and keep on fixing color */\n                node = node-&gt;parent;\n            &#125;\n            else\n            &#123;\n                if (rbtree_is_black(brother-&gt;right))\n                &#123;\n                    rbtree_black(brother-&gt;left);\n                    rbtree_red(brother);\n                    rbtree_right_rotate(tree, brother);\n                    /* update brother after topologic change of the tree */\n                    brother = node-&gt;parent-&gt;right;\n                &#125;\n                rbtree_copy_color(brother, node-&gt;parent);\n                rbtree_black(node-&gt;parent);\n                rbtree_black(brother-&gt;right);\n                rbtree_left_rotate(tree, node-&gt;parent);\n                /* end the loop and ensure root is black */\n                node = tree-&gt;root;\n            &#125;\n        &#125;\n        /* same as the &quot;if&quot; clause before with &quot;left&quot; and &quot;right&quot; exchanged */\n        else\n        &#123;\n            brother = node-&gt;parent-&gt;left;\n            if (rbtree_is_red(brother))\n            &#123;\n                rbtree_black(brother);\n                rbtree_red(node-&gt;parent);\n                rbtree_left_rotate(tree, node-&gt;parent);\n                brother = node-&gt;parent-&gt;left;\n            &#125;\n\n            if (rbtree_is_black(brother-&gt;left) &amp;&amp; rbtree_is_black(brother-&gt;right))\n            &#123;\n                rbtree_red(brother);\n                node = node-&gt;parent;\n            &#125;\n            else\n            &#123;\n                if (rbtree_is_black(brother-&gt;left))\n                &#123;\n                    rbtree_black(brother-&gt;right);\n                    rbtree_red(brother);\n                    rbtree_right_rotate(tree, brother);\n                    brother = node-&gt;parent-&gt;left;\n                &#125;\n                rbtree_copy_color(brother, node-&gt;parent);\n                rbtree_black(node-&gt;parent);\n                rbtree_black(brother-&gt;left);\n                rbtree_left_rotate(tree, node-&gt;parent);\n                node = tree-&gt;root;\n            &#125;\n        &#125;\n    &#125;\n\n    rbtree_black(node);\n&#125;\n\n/* public methods */\nvoid rbtree_insert_value(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    /* Using ** to know wether the new node will be a left kid */\n    /* or a right kid of its parent node. */\n    rbtree_node_t** tmp = &amp;tree-&gt;root;\n    rbtree_node_t* parent;\n\n    while(*tmp != tree-&gt;sentinel)\n    &#123;\n        parent = *tmp;\n        tmp = (node-&gt;key &lt; parent-&gt;key) ? &amp;parent-&gt;left : &amp;parent-&gt;right;\n    &#125;\n\n    /* The pointer knows wether the node should be on the left side */\n    /* or on the right one. */\n    *tmp = node;\n    node-&gt;parent = parent;\n    node-&gt;left = tree-&gt;sentinel;\n    node-&gt;right = tree-&gt;sentinel;\n    rbtree_red(node);\n&#125;\n\nvoid rbtree_insert(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    rbtree_node_t* sentinel = tree-&gt;sentinel;\n\n    /* if the tree is empty */\n    if (tree-&gt;root == sentinel)\n    &#123;\n        tree-&gt;root = node;\n        node-&gt;parent = sentinel;\n        node-&gt;left = sentinel;\n        node-&gt;right = sentinel;\n        rbtree_black(node);\n\n        return;\n    &#125;\n\n    /* generally */\n    tree-&gt;insert(tree, node);\n    rbtree_insert_fixup(tree, node);\n&#125;\n\nvoid rbtree_delete(rbtree_t* tree, rbtree_node_t* node)\n&#123;\n    rbtree_node_t* sentinel = tree-&gt;sentinel;\n    /* wether &quot;node&quot; is on the left side or the right one */\n    rbtree_node_t** ptr_to_node = NULL;\n    /* &quot;cover&quot; is the node which is going to cover &quot;node&quot; */\n    rbtree_node_t* cover = NULL;\n    /* wether we lossing a red node on the edge of the tree */\n    int loss_red = rbtree_is_red(node);\n    int is_root = (node == tree-&gt;root);\n\n    /* get &quot;cover&quot; &amp; &quot;loss_red&quot;  */\n    /* sentinel in &quot;node&quot;&#39;s kids */\n    if (node-&gt;left == sentinel)\n    &#123;\n        cover = node-&gt;right;\n    &#125;\n    else if (node-&gt;right == sentinel)\n    &#123;\n        cover = node-&gt;left;\n    &#125;\n    /* &quot;node&quot;&#39;s kids are both non-sentinel */\n    else\n    &#123;\n        /* update &quot;node&quot; &amp; &quot;loss_red&quot; &amp; &quot;is_root&quot; &amp; &quot;cover&quot; */\n        cover = rbtree_subtree_min(node-&gt;right, sentinel);\n        node-&gt;key = cover-&gt;key;\n        node-&gt;value = cover-&gt;value;\n        node = cover;\n        loss_red = rbtree_is_red(node);\n        is_root = 0;\n        /* move &quot;cover&quot;&#39;s kids */\n        /* &quot;cover&quot; can only be a left kid */\n        /* and can only have a right non-sentinel kid */\n        /* because of function &quot;rbtree_subtree_min&quot; */\n        cover = node-&gt;right;\n    &#125;\n\n    if (is_root)\n    &#123;\n        /* update root */\n        tree-&gt;root = cover;\n    &#125;\n    else\n    &#123;\n        /* downward link */\n        if (node == node-&gt;parent-&gt;left)\n        &#123;\n            node-&gt;parent-&gt;left = cover;\n        &#125;\n        else\n        &#123;\n            node-&gt;parent-&gt;right = cover;\n        &#125;\n    &#125;\n    /* upward link */\n    cover-&gt;parent = node-&gt;parent;\n    /* &quot;cover&quot; may be a sentinel */\n    if (cover != sentinel)\n    &#123;\n        /* set &quot;cover&quot; */\n        cover-&gt;left = node-&gt;left;\n        cover-&gt;right = node-&gt;right;\n        rbtree_copy_color(cover, node);\n    &#125;\n\n    /* clear &quot;node&quot; since it&#39;s useless */\n    node-&gt;key = -1;\n    node-&gt;parent = NULL;\n    node-&gt;left = NULL;\n    node-&gt;right = NULL;\n    node-&gt;value = NULL;\n\n    if (loss_red)\n    &#123;\n        return;\n    &#125;\n\n    /* When lossing a black node on edge */\n    /* the fifth rule of red-black tree will be broke. */\n    /* So the tree need to be fixed. */\n    rbtree_delete_fixup(tree, cover);\n&#125;\n\n/* find the node in the tree corresponding to the given key value */\nrbtree_node_t* rbtree_find(rbtree_t* tree, rbtree_key_t key)\n&#123;\n    rbtree_node_t* tmp = tree-&gt;root;\n    int step_cnt = 0;\n\n    /* search the binary tree */\n    while(tmp != tree-&gt;sentinel)\n    &#123;\n        /* next line is just fot test */\n        // step_cnt++;\n        if(key == tmp-&gt;key)\n        &#123;\n            /* next line is just for test */\n            // printf(&quot;step count: %d, color: %s, &quot;, step_cnt, rbtree_is_red(tmp) ? &quot;red&quot; : &quot;black&quot;);\n            return tmp;\n        &#125;\n\n        tmp = (key &lt; tmp-&gt;key) ? tmp-&gt;left : tmp-&gt;right;\n    &#125;\n\n    return NULL;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp;  虽然明白nginx源码中100+行的长函数体也是一种避免太多函数调用增加时间空间开销的优化，我还是把所有函数都分类分割成100行以下。增加可读性是一方面，可能也是有点强迫症吧。之后会扩展几个统计方法，像max、min和mid，还会扩展一个遍历方法。<br>&nbsp;&nbsp;&nbsp; 下面是调用测试，test.c：</p>\n<pre><code class=\"hljs\">#include &lt;stdio.h&gt;\n#include &quot;rbtree.h&quot;\n\nint main(int argc, char const *argv[])\n&#123;\n    rbtree_t t = &#123;&#125;;\n    rbtree_node_t s = &#123;&#125;;\n    rbtree_init(&amp;t, &amp;s, rbtree_insert_value);\n\n    const int cnt = 10;\n    const int max_len = 15;\n\n#define TEST_VALUES &#123;&quot;apple&quot;, &quot;banana&quot;, &quot;cherry&quot;, &quot;grape&quot;, &quot;lemon&quot;, &quot;mango&quot;, &quot;pear&quot;, &quot;pineapple&quot;, &quot;strawberry&quot;, &quot;watermelon&quot;&#125;\n\n    /* for gcc */\n    char* v[] = TEST_VALUES;\n    /* for g++ */\n    // char v[][max_len] = TEST_VALUES;\n\n    rbtree_node_t n[cnt];\n    int i;\n    for (i = 0; i &lt; cnt; i++)\n    &#123;\n        n[i].key = i+1;\n        n[i].value = v[i];\n        rbtree_insert(&amp;t, &amp;n[i]);\n    &#125;\n\n    rbtree_node_t* p[cnt];\n\n    for (i = 1; i &lt;= cnt; i++)\n    &#123;\n        printf(&quot;key: %d\\n&quot;, i);\n        p[i] = rbtree_find(&amp;t, i);\n        printf(&quot;value: %s\\n&quot;, (p[i] != NULL) ? p[i]-&gt;value : &quot;?&quot;);\n    &#125;\n\n    rbtree_delete(&amp;t, &amp;n[5]);\n\n    printf(&quot;\\nafter delete 6-&gt;mango:\\n\\n&quot;);\n\n    for (i = 1; i &lt;= cnt; i++)\n    &#123;\n        printf(&quot;key: %d\\n&quot;, i);\n        p[i] = rbtree_find(&amp;t, i);\n        printf(&quot;value: %s\\n&quot;, (p[i] != NULL) ? p[i]-&gt;value : &quot;?&quot;);\n    &#125;\n\n    return 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 解开rbtree_find方法里的测试行注释，顺利执行：</p>\n<pre><code class=\"hljs\">key: 1\nstep count: 3, color: black, value: apple\nkey: 2\nstep count: 2, color: black, value: banana\nkey: 3\nstep count: 3, color: black, value: cherry\nkey: 4\nstep count: 1, color: black, value: grape\nkey: 5\nstep count: 3, color: black, value: lemon\nkey: 6\nstep count: 2, color: black, value: mango\nkey: 7\nstep count: 4, color: black, value: pear\nkey: 8\nstep count: 3, color: red, value: pineapple\nkey: 9\nstep count: 4, color: black, value: strawberry\nkey: 10\nstep count: 5, color: red, value: watermelon\n\nafter delete 6-&gt;mango:\n\nkey: 1\nstep count: 3, color: black, value: apple\nkey: 2\nstep count: 2, color: black, value: banana\nkey: 3\nstep count: 3, color: black, value: cherry\nkey: 4\nstep count: 1, color: black, value: grape\nkey: 5\nstep count: 3, color: black, value: lemon\nkey: 6\nvalue: ?\nkey: 7\nstep count: 2, color: black, value: pear\nkey: 8\nstep count: 4, color: black, value: pineapple\nkey: 9\nstep count: 3, color: red, value: strawberry\nkey: 10\nstep count: 4, color: black, value: watermelon\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 下面分别是删除6-&gt;mango前的红黑树和删除后的红黑树示意图：<br><img src=\"http://img.blog.csdn.net/20150816200143108\" alt=\"\" height=\"422\" width=\"400\" /><br><img src=\"http://img.blog.csdn.net/20150816200200052\" alt=\"\" height=\"331\" width=\"400\" /><br>&nbsp;&nbsp;&nbsp; 下面我们来做个大量数据的压力测试，注意把rbtree_find方法里的测试行注释掉，不然后果恐怕会比较吓人：</p>\n<pre><code class=\"hljs\">#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;time.h&gt;\n#include &quot;rbtree.h&quot;\n\nint main(int argc, char const *argv[])\n&#123;\n    double duration;\n    double room;\n\n    rbtree_t t = &#123;&#125;;\n    rbtree_node_t s = &#123;&#125;;\n    rbtree_init(&amp;t, &amp;s, rbtree_insert_value);\n\n    const int cnt = 1&lt;&lt;20;\n    const int max_len = 15;\n\n#define TEST_VALUES &#123;&quot;apple&quot;, &quot;banana&quot;, &quot;cherry&quot;, &quot;grape&quot;, &quot;lemon&quot;, &quot;mango&quot;, &quot;pear&quot;, &quot;pineapple&quot;, &quot;strawberry&quot;, &quot;watermelon&quot;&#125;\n\n    /* for gcc */\n    char* v[] = TEST_VALUES;\n    /* for g++ */\n    // char v[][max_len] = TEST_VALUES;\n\n    /* Default stack size in Ubuntu Kylin 14.04 is 8MB. */\n    /* It&#39;s not enough. So I use memory in heap which offers a lot larger room. */\n    rbtree_node_t* n = (rbtree_node_t*)calloc(cnt, sizeof(rbtree_node_t));\n    int i;\n\n    long time1 = clock();\n\n    for (i = 0; i &lt; cnt; i++)\n    &#123;\n        n[i].key = i+1;\n        n[i].value = v[i%10];\n        rbtree_insert(&amp;t, &amp;n[i]);\n    &#125;\n\n    long time2 = clock();\n    room = 48.0*cnt/(1&lt;&lt;20);\n    duration = (double)(time2 - time1) / CLOCKS_PER_SEC;\n    printf(&quot;Inserting %d nodes costs %.2fMB and spends %f seconds.\\n&quot;, cnt, room, duration);\n\n    const int search_cnt = 1&lt;&lt;10;\n    srand( (unsigned int)time(0) );\n    for( i = 0 ; i &lt; search_cnt ; i++ )\n    &#123;\n        rbtree_find(&amp;t, (rand()%cnt)+1);\n    &#125;\n\n    long time3 = clock();\n    duration = (double)(time3 - time2) / CLOCKS_PER_SEC;\n    printf(&quot;Searching %d nodes among %d spends %f seconds.\\n&quot;, search_cnt, cnt, duration);\n\n    const int delete_cnt = 1&lt;&lt;10;\n    int nums[delete_cnt];\n    int num;\n    /* Let&#39;s hash! */\n    char* mark = (char*)calloc(cnt, sizeof(char));\n    memset(mark, 0, cnt*sizeof(char));\n    for(i = 0; i &lt; delete_cnt; i++)\n    &#123;\n        for(;;)\n        &#123;\n            num = rand()%cnt;\n            if (mark[num] == 0)\n            &#123;\n                mark[num] = 1;\n                nums[i] = num;\n                break;\n            &#125;\n        &#125;\n    &#125;\n\n    long time4 = clock();\n    duration = (double)(time4 - time3) / CLOCKS_PER_SEC;\n    printf(&quot;Hash %d times spends %f seconds.\\n&quot;, delete_cnt, duration);\n\n    for(i = 0; i &lt; delete_cnt; i++)\n    &#123;\n        rbtree_delete(&amp;t, &amp;n[nums[i]]);\n    &#125;\n\n    long time5 = clock();\n    duration = (double)(time5 - time4) / CLOCKS_PER_SEC;\n    printf(&quot;Deleting %d nodes among %d spends %f seconds.\\n&quot;, delete_cnt, cnt, duration);\n    free(mark);\n    free(n);\n\n    return 0;\n&#125;\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 来看看结果：</p>\n<pre><code class=\"hljs\">Inserting 1048576 nodes costs 48.00MB and spends 0.425416 seconds.\nSearching 1024 nodes among 1048576 spends 0.001140 seconds.\nHash 1024 times spends 0.000334 seconds.\nDeleting 1024 nodes among 1048576 spends 0.000783 seconds.\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; 删除比查找还快，耗时只有哈希查找的两倍多点，上百万的插入也耗时不足半秒，嗯我还挺满意的。<br>&nbsp;&nbsp;&nbsp; 写统计和遍历方法去了。</p>\n",
            "tags": [
                "nginx",
                "rbtree",
                "C"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/08/11/C%E8%AF%AD%E8%A8%80%E7%9A%84static%E5%85%B3%E9%94%AE%E5%AD%97/",
            "url": "https://blog.bipedalbit.net/2015/08/11/C%E8%AF%AD%E8%A8%80%E7%9A%84static%E5%85%B3%E9%94%AE%E5%AD%97/",
            "title": "C语言的static关键字",
            "date_published": "2015-08-11T12:09:08.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; static这个关键字可谓熟悉又陌生，要比较系统地理解它，更好地使用它，需要对它有更加深入的了解。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; C程序一直由下列部分组成：<br>&nbsp;&nbsp;&nbsp; 1）正文段——CPU执行的机器指令部分；一个程序只有一个副本；只读，防止程序由于意外事故而修改自身指令。<br>&nbsp;&nbsp;&nbsp; 2）初始化数据段（数据段）——在程序中所有赋了初值的全局变量，存放在这里。<br>&nbsp;&nbsp;&nbsp; 3）非初始化数据段（bss段）——在程序中没有初始化的全局变量；内核将此段初始化为0。<br>&nbsp;&nbsp;&nbsp; 4）栈——增长方向：自顶向下增长；自动变量以及每次函数调用时所需要保存的信息（返回地址、环境信息）。<br>&nbsp;&nbsp;&nbsp; 5）堆——动态存储分配的内存。</p>\n<p><span style=\"color:#FF0000;\"><span style=\"color:#000000;\">1.</span>全局静态变量</span></p>\n<p>&nbsp;&nbsp;&nbsp; 在全局变量之前加上关键字static，全局变量就被定义成为一个全局静态变量。<br>&nbsp;&nbsp;&nbsp; 1）内存中的位置：静态存储区。（静态存储区在整个程序运行期间都存在）<br>&nbsp;&nbsp;&nbsp; 2）初始化：未经初始化的全局静态变量会被程序自动初始化为0。（自动对象的值是任意的，除非他被显示初始化）<br>&nbsp;&nbsp;&nbsp; 3）作用域：全局静态变量在声明他的文件之外是不可见的。准确地讲从定义之处开始到文件结尾。</p>\n<p>&nbsp;&nbsp;&nbsp; 定义全局静态变量的好处：<br>&nbsp;&nbsp;&nbsp; 1）不会被其他文件所访问，修改。<br>&nbsp;&nbsp;&nbsp; 2）其他文件中可以使用相同名字的变量，不会发生冲突。</p>\n<p><span style=\"color:#FF0000;\"><span style=\"color:#000000;\">2.</span>局部静态变量</span></p>\n<p>&nbsp;&nbsp;&nbsp; 在局部变量之前加上关键字static，局部变量就被定义成为一个局部静态变量。<br>&nbsp;&nbsp;&nbsp; 1）内存中的位置：静态存储区。<br>&nbsp;&nbsp;&nbsp; 2）初始化：未经初始化的全局静态变量会被程序自动初始化为0。（自动对象的值是任意的，除非他被显示初始化）<br>&nbsp;&nbsp;&nbsp; 3）作用域：作用域仍为局部作用域，当定义它的函数或者语句块结束的时候，作用域随之结束。</p>\n<p>&nbsp;&nbsp;&nbsp;<span style=\"color:#FF0000;\">注：当static用来修饰局部变量的时候，它就改变了局部变量的存储位置，从原来的栈中存放改为静态存储区。但是局部静态变量在离开作用域之后，并没有被销毁，而是仍然驻留在内存当中，直到程序结束，只不过我们不能再对他进行访问。</span><br>&nbsp;&nbsp;&nbsp; 当static用来修饰全局变量的时候，它就改变了全局变量的作用域（在声明他的文件之外是不可见的），但是没有改变它的存放位置，还是在静态存储区中。</p>\n<p>3.<span style=\"color:#FF0000;\">静态函数</span><br>&nbsp;&nbsp;&nbsp; 在函数的返回类型前加上关键字static，函数就被定义成为静态函数。<br>&nbsp;&nbsp;&nbsp; 函数的定义和声明默认情况下是extern的，但静态函数只是在声明他的文件当中可见，不能被其他文件所用。</p>\n<p>&nbsp;&nbsp;&nbsp; 定义静态函数的好处：<br>&nbsp;&nbsp;&nbsp; 1）其他文件中可以定义相同名字的函数，不会发生冲突<br>&nbsp;&nbsp;&nbsp; 2）静态函数不能被其他文件所用。存储说明符auto，register，extern，static，对应两种存储期：自动存储期和静态存储期。auto和register对应自动存储期。具有自动存储期的变量在进入声明该变量的程序块时被建立，它在该程序块活动时存在，退出该程序块时撤销。</p>\n<p>&nbsp;&nbsp;&nbsp; 关键字extern和static用来说明具有静态存储期的变量和函数。用static声明的局部变量具有静态存储持续期（static storage duration），或静态范围（static extent）。虽然他的值在函数调用之间保持有效，但是其名字的可视性仍限制在其局部域内。静态局部对象在程序执行到该对象的声明处时被首次初始化。</p>\n<p>&nbsp;&nbsp;&nbsp; 由于static变量的以上特性，可实现一些特定功能。</p>\n<p>&nbsp;&nbsp;&nbsp; 统计次数功能：<br>&nbsp;&nbsp;&nbsp; 声明函数的一个局部变量，并设为static类型，作为一个计数器，这样函数每次被调用的时候就可以进行计数。这是统计函数被调用次数的最好的办法，因为这个变量是和函数息息相关的，而函数可能在多个不同的地方被调用，所以从调用者的角度来统计比较困难。</p>\n<p><span style=\"color:#FF0000;\">&nbsp;&nbsp;&nbsp; 使用静态函数的好处：<br>&nbsp;&nbsp;&nbsp; 静态函数会被自动分配在一个一直使用的存储区，直到退出应用程序实例，避免了调用函数时压栈出栈，速度快很多。<br>&nbsp;&nbsp;&nbsp; 关键字“static”，译成中文就是“静态的”，所以内部函数又称静态函数。但此处“static”的含义不是指存储方式，而是指对函数的作用域仅局限于本文件。使用内部函数的好处是：不同的人编写不同的函数时，不用担心自己定义的函数，是否会与其它文件中的函数同名，因为同名也没有关系。</span></p>\n",
            "tags": [
                "C",
                "static",
                "内存分布"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/08/06/%E3%80%90%E4%B8%89%E3%80%91nginx%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1-%E2%80%94%E2%80%94ngx-int-t%E4%B8%8Engx-rbtree-t/",
            "url": "https://blog.bipedalbit.net/2015/08/06/%E3%80%90%E4%B8%89%E3%80%91nginx%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1-%E2%80%94%E2%80%94ngx-int-t%E4%B8%8Engx-rbtree-t/",
            "title": "【三】nginx的数据结构(1)——ngx_int_t与ngx_rbtree_t",
            "date_published": "2015-08-05T23:18:00.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 就来挑两个特别的数据结构ngx_int_t、ngx_rbtree_t作为研读nginx源码的开始吧。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 面对<span style=\"font-family:Times New Roman;\">.&#x2F;src&#x2F;core</span><span style=\"font-family:宋体;\">子目录中</span><span style=\"font-family:Times New Roman;\">71</span><span style=\"font-family:宋体;\">个源文件，有点无从下手。浏览包含主函数的</span><span style=\"font-family:Times New Roman;\">nginx.c</span><span style=\"font-family:宋体;\">文件，发现</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">使用了很多自行封装的数据结构，不弄清楚这是些什么样的数据结构就很难理解主函数中操作的意义。于是我们挑看起来基础的数据结构开始研究。组织</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">所有数据结构的是</span><span style=\"font-family:Times New Roman;\">ngx_core.h</span><span style=\"font-family:宋体;\">文件。它首先包含了</span><span style=\"font-family:Times New Roman;\">ngx_config.h</span><span style=\"font-family:宋体;\">，我们在</span><span style=\"font-family:Times New Roman;\">ngx_config.h</span><span style=\"font-family:宋体;\">中发现了三个类型定义。</span></p>\n<h1 id=\"1-ngx-int-t、ngx-uint-t、ngx-flag-t\"><a href=\"#1-ngx-int-t、ngx-uint-t、ngx-flag-t\" class=\"headerlink\" title=\"1. ngx_int_t、ngx_uint_t、ngx_flag_t\"></a>1. ngx_int_t<span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">ngx_uint_t</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">ngx_flag_t</span></h1><p>&nbsp;&nbsp;&nbsp; nginx.c<span style=\"font-family:宋体;\">中看到的第一个陌生数据类型是</span><span style=\"font-family:Times New Roman;\">ngx_int_t</span><span style=\"font-family:宋体;\">，在</span><span style=\"font-family:Times New Roman;\">nginx_config.h</span><span style=\"font-family:宋体;\">中找到了它的定义。</span></p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs c\"><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-type\">intptr_t</span> <span class=\"hljs-type\">ngx_int_t</span>;<br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-type\">uintptr_t</span> <span class=\"hljs-type\">ngx_uint_t</span>;<br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-type\">intptr_t</span> <span class=\"hljs-type\">ngx_flag_t</span>;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 顺藤摸瓜找到了三个数据类型的定义。本科<span style=\"font-family:Times New Roman;\">c</span><span style=\"font-family:宋体;\">入门教学中并没有对</span><span style=\"font-family:Times New Roman;\">intptr_t&#x2F;uintptr_t</span><span style=\"font-family:宋体;\">的介绍，我在</span><span style=\"font-family:Times New Roman;\">c</span><span style=\"font-family:宋体;\">的</span><span style=\"font-family:Times New Roman;\">stdint.h</span><span style=\"font-family:宋体;\">头文件中发现了它们的定义。</span></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-comment\">/* Types for `void *&#x27; pointers.  */</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">if</span> __WORDSIZE == 64</span><br><span class=\"hljs-meta\"># <span class=\"hljs-keyword\">ifndef</span> __intptr_t_defined</span><br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-type\">long</span> <span class=\"hljs-type\">int</span>    <span class=\"hljs-type\">intptr_t</span>;<br><span class=\"hljs-meta\">#  <span class=\"hljs-keyword\">define</span> __intptr_t_defined</span><br><span class=\"hljs-meta\"># <span class=\"hljs-keyword\">endif</span></span><br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-type\">unsigned</span> <span class=\"hljs-type\">long</span> <span class=\"hljs-type\">int</span>   <span class=\"hljs-type\">uintptr_t</span>;<br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">else</span></span><br><span class=\"hljs-meta\"># <span class=\"hljs-keyword\">ifndef</span> __intptr_t_defined</span><br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-type\">int</span> <span class=\"hljs-type\">intptr_t</span>;<br><span class=\"hljs-meta\">#  <span class=\"hljs-keyword\">define</span> __intptr_t_defined</span><br><span class=\"hljs-meta\"># <span class=\"hljs-keyword\">endif</span></span><br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-type\">unsigned</span> <span class=\"hljs-type\">int</span>    <span class=\"hljs-type\">uintptr_t</span>;<br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">endif</span></span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 首先注释说这两种类型是<span style=\"font-family:Times New Roman;\">“void&nbsp;*”</span><span style=\"font-family:宋体;\">的指针类型，尽管字面上看，</span><span style=\"font-family:Times New Roman;\">intptr_t</span><span style=\"font-family:宋体;\">和</span><span style=\"font-family:Times New Roman;\">uintptr_t</span><span style=\"font-family:宋体;\">确实是整型指针类型和无符号整型指针类型，但是让人摸不着头脑，为什么要使用整型作为整型的指针类型呢？先放一放，看后面的宏，机器是</span><span style=\"font-family:Times New Roman;\">64</span><span style=\"font-family:宋体;\">位字长则</span><span style=\"font-family:Times New Roman;\">intptr_t</span><span style=\"font-family:宋体;\">为</span><span style=\"font-family:Times New Roman;\">long&nbsp;int</span><span style=\"font-family:宋体;\">，</span><span style=\"font-family:Times New Roman;\">uintptr_t</span><span style=\"font-family:宋体;\">为</span><span style=\"font-family:Times New Roman;\">unsigned&nbsp;long&nbsp;int</span><span style=\"font-family:宋体;\">，正好我机器上是</span><span style=\"font-family:Times New Roman;\">64</span><span style=\"font-family:宋体;\">位编译器，</span><span style=\"font-family:Times New Roman;\">sizeof()</span><span style=\"font-family:宋体;\">了一下，是</span><span style=\"font-family:Times New Roman;\">8</span><span style=\"font-family:宋体;\">个字节</span><span style=\"font-family:Times New Roman;\">64</span><span style=\"font-family:宋体;\">位，小于</span><span style=\"font-family:Times New Roman;\">64</span><span style=\"font-family:宋体;\">位字长的</span><span style=\"font-family:Times New Roman;\">intptr_t</span><span style=\"font-family:宋体;\">为</span><span style=\"font-family:Times New Roman;\">int</span><span style=\"font-family:宋体;\">，</span><span style=\"font-family:Times New Roman;\">uintptr_t</span><span style=\"font-family:宋体;\">为</span><span style=\"font-family:Times New Roman;\">unsigned&nbsp;int</span><span style=\"font-family:宋体;\">，查表得知</span><span style=\"font-family:Times New Roman;\">32</span><span style=\"font-family:宋体;\">位编译器下</span><span style=\"font-family:Times New Roman;\">int</span><span style=\"font-family:宋体;\">和</span><span style=\"font-family:Times New Roman;\">unsigned</span><span style=\"font-family:宋体;\">为</span><span style=\"font-family:Times New Roman;\">4</span><span style=\"font-family:宋体;\">个字节，</span><span style=\"font-family:Times New Roman;\">16</span><span style=\"font-family:宋体;\">位编译器下为</span><span style=\"font-family:Times New Roman;\">2</span><span style=\"font-family:宋体;\">个字节。那么</span><span style=\"font-family:Times New Roman;\">intptr_t&#x2F;uintptr_t</span><span style=\"font-family:宋体;\">应该是会随着平台字长变化而发生对应变化的整型类型。经过了解，发现《深入分析</span><span style=\"font-family:Times New Roman;\">Linux</span><span style=\"font-family:宋体;\">内核源码》中对此的解释是，系统内核在操作内存时，将内存当做一个大数组，而指针就是数组索引</span><span style=\"font-family:Times New Roman;\">&#x2F;</span><span style=\"font-family:宋体;\">下标，内核程序员使用这种特殊的整型来接受内存地址值、操作内存相比使用指针更加直观，不容易犯错。看起来，</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">中，只是单纯的想要使用一些平台相关的</span><span style=\"font-family:Times New Roman;\">int</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">unsigned&nbsp;int</span><span style=\"font-family:宋体;\">类型变量而已。</span></p>\n<h1 id=\"2-ngx-rbtree-t\"><a href=\"#2-ngx-rbtree-t\" class=\"headerlink\" title=\"2. ngx_rbtree_t\"></a>2. ngx_rbtree_t</h1><h2 id=\"2-1-什么是红黑树\"><a href=\"#2-1-什么是红黑树\" class=\"headerlink\" title=\"2.1 什么是红黑树\"></a>2.1 <span style=\"font-family:宋体;\">什么是红黑树</span></h2><p>&nbsp;&nbsp;&nbsp; 作为一个曾经常年在<span style=\"font-family:Times New Roman;\">ACM</span><span style=\"font-family:宋体;\">比赛里划水的退役队员，对红黑树这样的有名数据结构还是比较敏感的。红黑树是一种特殊约束形式下的平衡二叉查找树实现。学过数据结构课的同学应该知道，课本上的最早的自平衡二叉树</span><span style=\"font-family:Times New Roman;\">AVL</span><span style=\"font-family:宋体;\">树严格的要求子树的高度差不超过</span><span style=\"font-family:Times New Roman;\">2</span><span style=\"font-family:宋体;\">，以获得根结点到所有叶结点距离基本相同（平衡）的特性。</span></p>\n<p>&nbsp;&nbsp;&nbsp; 红黑树不追求严格的平衡，而是通过<span style=\"font-family:Times New Roman;\">5</span><span style=\"font-family:宋体;\">个约束实现基本平衡：</span><br>&nbsp;&nbsp;&nbsp; ①结点是红色或黑色；<br>&nbsp;&nbsp;&nbsp; ②根是黑色；<br>&nbsp;&nbsp;&nbsp; ③叶结点是黑色；<br>&nbsp;&nbsp;&nbsp; ④红色结点的子结点都是黑色；<br>&nbsp;&nbsp;&nbsp; ⑤任一结点到其叶结点的简单路径中黑色结点数相同。</p>\n<p>&nbsp;&nbsp;&nbsp; AVL树根到叶结点最长距离与最短距离的比不超过2。红黑树的约束也保证了这一特性（最长路径是红黑相间，最短路径是全黑，这种情况下最长路径刚好是最短路径的2倍长）。</p>\n<p>&nbsp;&nbsp;&nbsp; 既然是平衡二叉查找树的一种实现，那么红黑树自然是内部有序的，同时跟AVL树一样支持O(log2n)时间复杂度的查找、插入和删除。</p>\n<p>&nbsp;&nbsp;&nbsp; 相比AVL树，红黑可以保证在每次插入或删除操作之后的重平衡过程中，全树拓扑结构的更新仅涉及常数个结点。尽管最坏情况下需对O(log2n)个结点重染色，但就分摊意义（平均效率）而言，仅为O(1)个。但是因为没有严格约束树的平衡特性，红黑树的左右子树高度差比AVL树要大。</p>\n<h2 id=\"2-2-ngx-rbtree-h\"><a href=\"#2-2-ngx-rbtree-h\" class=\"headerlink\" title=\"2.2 ngx_rbtree.h\"></a>2.2 ngx_rbtree.h</h2><p>&nbsp;&nbsp;&nbsp; 机会难得，我们就把nginx的源码作为素材来深入了解一下红黑树的实现。首先是结点的结构：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-type\">ngx_uint_t</span> <span class=\"hljs-type\">ngx_rbtree_key_t</span>;<br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-type\">ngx_int_t</span> <span class=\"hljs-type\">ngx_rbtree_key_int_t</span>;<br><br><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title class_\">ngx_rbtree_node_s</span> <span class=\"hljs-type\">ngx_rbtree_node_t</span>;<br><br><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title class_\">ngx_rbtree_node_s</span> &#123;<br>    <span class=\"hljs-type\">ngx_rbtree_key_t</span>    key;<span class=\"hljs-comment\">//平台相关的无符号整型关键字</span><br>    <span class=\"hljs-type\">ngx_rbtree_node_t</span>   *left;<span class=\"hljs-comment\">//左子结点指针</span><br>    <span class=\"hljs-type\">ngx_rbtree_node_t</span>   *right;<span class=\"hljs-comment\">//&lt;span style=&amp;quot;font-family:宋体;&amp;quot;&gt;右&lt;/span&gt;子结点指针</span><br>    <span class=\"hljs-type\">ngx_rbtree_node_t</span>   *parent;<span class=\"hljs-comment\">//父结点指针</span><br>    u_char          color;<span class=\"hljs-comment\">//结点颜色</span><br>    u_char          data;<span class=\"hljs-comment\">//结点数据</span><br>&#125;;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 然后是红黑树的结构定义：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title class_\">ngx_rbtree_s</span>  <span class=\"hljs-type\">ngx_rbtree_t</span>;  <span class=\"hljs-comment\">//“_s”是结构体“_t”是类型</span><br><span class=\"hljs-comment\">//下面是一个函数指针变量类型的定义，是红黑树插入函数的指针</span><br><span class=\"hljs-comment\">//参数有树根结点、插入结点和哨兵结点的指针</span><br><span class=\"hljs-function\"><span class=\"hljs-keyword\">typedef</span> <span class=\"hljs-title\">void</span> <span class=\"hljs-params\">(*ngx_rbtree_insert_pt)</span> <span class=\"hljs-params\">(<span class=\"hljs-type\">ngx_rbtree_node_t</span> *root,</span></span><br><span class=\"hljs-params\"><span class=\"hljs-function\">    <span class=\"hljs-type\">ngx_rbtree_node_t</span> *node, <span class=\"hljs-type\">ngx_rbtree_node_t</span> *sentinel)</span></span>;<br><br><span class=\"hljs-keyword\">struct</span> <span class=\"hljs-title class_\">ngx_rbtree_s</span> &#123;<br>    <span class=\"hljs-type\">ngx_rbtree_node_t</span> *root;    <span class=\"hljs-comment\">//根节点指针</span><br>    <span class=\"hljs-type\">ngx_rbtree_node_t</span> *sentinel;    <span class=\"hljs-comment\">//哨兵结点指针</span><br>    ngx_rbtree_insert_pt   insert;  <span class=\"hljs-comment\">//插入函数指针</span><br>&#125;;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 将函数指针变量作为结构体成员变量以达成可以把结构体当做类来使用（既有成员变量又有成员方法）的效果，这种手法在<span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">的源码中相当普遍。关于函数，</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">还有一种更神奇的手段</span><span style=\"font-family:Times New Roman;\">——</span><span style=\"font-family:宋体;\">宏：</span></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> ngx_rbtree_init(tree, s, i)                 \\</span><br><span class=\"hljs-meta\">    ngx_rbtree_sentinel_init(s);                \\</span><br><span class=\"hljs-meta\">    (tree)-&gt;root = s;                       \\</span><br><span class=\"hljs-meta\">    (tree)-&gt;sentinel = s;                   \\</span><br><span class=\"hljs-meta\">    (tree)-&gt;insert = i<span class=\"hljs-comment\">//这里insert函数指针的赋值实现了多态</span></span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 借助宏来达成内联函数的效果（函数实现如果比较简单，就干脆把实现过程整个搬到类中），令人费解的是，<span style=\"font-family:Times New Roman;\">C</span><span style=\"font-family:宋体;\">不是没有内联关键字，甚至同一个头文件中就有一个内联函数的定义。研究内联函数之前，下面还有几个宏要看一看：</span></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> ngx_rbt_red(node)           ((node)-&gt;color = 1)</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> ngx_rbt_black(node)         ((node)-&gt;color = 0)</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> ngx_rbt_is_red(node)            ((node)-&gt;color)</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> ngx_rbt_is_black(node)          (!ngx_rbt_is_red(node))</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> ngx_rbt_copy_color(n1, n2)      (n1-&gt;color = n2-&gt;color)</span><br><br><span class=\"hljs-comment\">/* a sentinel must be black */</span><br><span class=\"hljs-meta\">#<span class=\"hljs-keyword\">define</span> ngx_rbtree_sentinel_init(node)  ngx_rbt_black(node)</span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; nginx<span style=\"font-family:宋体;\">源码中的变量都很容易看懂以至于我们不怎么需要查资料或找注释。</span><span style=\"font-family:Times New Roman;\">color</span><span style=\"font-family:宋体;\">置</span><span style=\"font-family:Times New Roman;\">1</span><span style=\"font-family:宋体;\">染红置</span><span style=\"font-family:Times New Roman;\">0</span><span style=\"font-family:宋体;\">染黑，</span><span style=\"font-family:Times New Roman;\">color</span><span style=\"font-family:宋体;\">为</span><span style=\"font-family:Times New Roman;\">1</span><span style=\"font-family:宋体;\">则结点为红色，不为红色的则为黑色，复制结点颜色即复制</span><span style=\"font-family:Times New Roman;\">color</span><span style=\"font-family:宋体;\">值，哨兵结点一定要染成黑色。</span></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-function\"><span class=\"hljs-type\">static</span> ngx_inline <span class=\"hljs-type\">ngx_rbtree_node_t</span> *</span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ngx_rbtree_min</span><span class=\"hljs-params\">(<span class=\"hljs-type\">ngx_rbtree_node_t</span> *node, <span class=\"hljs-type\">ngx_rbtree_node_t</span> *sentinel)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    <span class=\"hljs-keyword\">while</span> (node-&gt;left != sentinel) &#123;<br>        node = node-&gt;left;<br>    &#125;<br>    <span class=\"hljs-keyword\">return</span> node;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; ngx_inline是一个宏，实际值就是关键字inline。这个内联函数非常好懂，目的看起来是寻找以任意结点为根结点的子树中结点值最小的结点。实现方法是找到红黑树子树最边缘的左子结点。那么我们有理由猜测，哨兵结点是空结点或边缘标识。</p>\n<h2 id=\"2-3-红黑树的结点插入\"><a href=\"#2-3-红黑树的结点插入\" class=\"headerlink\" title=\"2.3 红黑树的结点插入\"></a><span style=\"font-family:宋体;\">2.3 红黑树的结点插入</span></h2><p>&nbsp;&nbsp;&nbsp; 接下来我们来深入<span style=\"font-family:Times New Roman;\">ngx_rbtree.c</span><span style=\"font-family:宋体;\">看看</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">如何实现几个关键的红黑树方法。</span></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-function\"><span class=\"hljs-type\">void</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ngx_rbtree_insert</span><span class=\"hljs-params\">(<span class=\"hljs-type\">ngx_rbtree_t</span> *tree, <span class=\"hljs-type\">ngx_rbtree_node_t</span> *node)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    <span class=\"hljs-comment\">//根结点指针的指针，或者根结点指针数组，会有多个根结点吗，令人费解</span><br>    <span class=\"hljs-comment\">//临时结点指针</span><br>    <span class=\"hljs-comment\">//哨兵结点指针，推测哨兵在每次查询时可能都不一样，也许指待插位置</span><br>    <span class=\"hljs-comment\">//变量不分行，我写注释都很不方便</span><br>    <span class=\"hljs-type\">ngx_rbtree_node_t</span>  **root, *temp, *sentinel;<br><br>    <span class=\"hljs-comment\">/* a binary tree insert */</span><br><br>    root = (<span class=\"hljs-type\">ngx_rbtree_node_t</span> **) &amp;tree-&gt;root;<span class=\"hljs-comment\">//树根指针的指针赋给了root</span><br>    sentinel = tree-&gt;sentinel;<span class=\"hljs-comment\">//哨兵指针赋给了哨兵指针</span><br><br>    <span class=\"hljs-keyword\">if</span> (*root == sentinel) &#123;<span class=\"hljs-comment\">//特判，如果根是哨兵，即树是空的</span><br>        node-&gt;parent = <span class=\"hljs-literal\">NULL</span>;<span class=\"hljs-comment\">//新插入的结点变成了根</span><br>        node-&gt;left = sentinel;<span class=\"hljs-comment\">//新结点的左子结点是哨兵</span><br>        node-&gt;right = sentinel;<span class=\"hljs-comment\">//新结点的右子结点也是哨兵</span><br>        <span class=\"hljs-built_in\">ngx_rbt_black</span>(node);<span class=\"hljs-comment\">//新根染黑</span><br>        *root = node;<span class=\"hljs-comment\">//确认新结点为新根</span><br><br>        <span class=\"hljs-keyword\">return</span>;<span class=\"hljs-comment\">//插入结束</span><br>    &#125;<br><br>    <span class=\"hljs-comment\">//树初始化时给了insert指针一个函数地址</span><br>    <span class=\"hljs-comment\">//查看前面的宏ngx_rbtree_init(tree, s, i)</span><br>    <span class=\"hljs-comment\">//发现只是把指定结点染黑，同时赋为根和哨兵，给insert指针指定一个函数</span><br>    <span class=\"hljs-comment\">//ngx_rbtree.c中有两个参数表符合的可选函数：插入值、插入计时器值</span><br>    <span class=\"hljs-comment\">//稍后来看两种插入分别如何实现又有什么区别</span><br>    tree-&gt;<span class=\"hljs-built_in\">insert</span>(*root, node, sentinel);<br><br>    <span class=\"hljs-comment\">/* re-balance tree */</span><br>    <span class=\"hljs-comment\">//如果新结点不是根且其父结点是红的，循环</span><br>    <span class=\"hljs-keyword\">while</span> (node != *root &amp;&amp; <span class=\"hljs-built_in\">ngx_rbt_is_red</span>(node-&gt;parent)) &#123;<br>        <span class=\"hljs-comment\">//如果父结点是左子结点，获得父结点的右兄弟</span><br>        <span class=\"hljs-keyword\">if</span> (node-&gt;parent == node-&gt;parent-&gt;parent-&gt;left) &#123;<br>            temp = node-&gt;parent-&gt;parent-&gt;right;<br>            <span class=\"hljs-comment\">//如果父结点的右兄弟是红的</span><br>            <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">ngx_rbt_is_red</span>(temp)) &#123;<br>                <span class=\"hljs-built_in\">ngx_rbt_black</span>(node-&gt;parent);<span class=\"hljs-comment\">//父结点染黑</span><br>                <span class=\"hljs-built_in\">ngx_rbt_black</span>(temp);<span class=\"hljs-comment\">//父结点的右兄弟染黑</span><br>                <span class=\"hljs-built_in\">ngx_rbt_red</span>(node-&gt;parent-&gt;parent);<span class=\"hljs-comment\">//父结点的父结点染红</span><br>                node = node-&gt;parent-&gt;parent;<span class=\"hljs-comment\">//父结点的父结点成为当前结点</span><br><br>            &#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//如果父结点的右兄弟是黑的</span><br>                <span class=\"hljs-keyword\">if</span> (node == node-&gt;parent-&gt;right) &#123;<span class=\"hljs-comment\">//如果新结点是右子结点</span><br>                    node = node-&gt;parent;<span class=\"hljs-comment\">//父结点成为新node</span><br>                    <span class=\"hljs-built_in\">ngx_rbtree_left_rotate</span>(root, sentinel, node);<span class=\"hljs-comment\">//node左旋</span><br><br>                &#125;<br><br>                <span class=\"hljs-built_in\">ngx_rbt_black</span>(node-&gt;parent);<span class=\"hljs-comment\">//node的父结点染黑</span><br>                <span class=\"hljs-comment\">//node的父结点的父结点染红</span><br>                <span class=\"hljs-built_in\">ngx_rbt_red</span>(node-&gt;parent-&gt;parent);<br>                <span class=\"hljs-built_in\">ngx_rbtree_right_rotate</span>(root, sentinel, node-&gt;parent-&gt;parent);<span class=\"hljs-comment\">//node的父结点的父结点右旋</span><br>            &#125;<br><br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//如果父结点是右子结点，获得父结点的左兄弟</span><br>            temp = node-&gt;parent-&gt;parent-&gt;left;<br>            <span class=\"hljs-comment\">//如果父结点的左兄弟是红的</span><br>            <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">ngx_rbt_is_red</span>(temp)) &#123;<br>                <span class=\"hljs-built_in\">ngx_rbt_black</span>(node-&gt;parent);<span class=\"hljs-comment\">//父结点染黑</span><br>                <span class=\"hljs-built_in\">ngx_rbt_black</span>(temp);<span class=\"hljs-comment\">//父结点的左兄弟染黑</span><br>                <span class=\"hljs-built_in\">ngx_rbt_red</span>(node-&gt;parent-&gt;parent);<span class=\"hljs-comment\">//父结点的父结点染红</span><br>                node = node-&gt;parent-&gt;parent;<br><br>            &#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//如果父结点的左兄弟是黑的</span><br>                <span class=\"hljs-keyword\">if</span> (node == node-&gt;parent-&gt;left) &#123;<span class=\"hljs-comment\">//如果新结点是左子结点</span><br>                    node = node-&gt;parent;<span class=\"hljs-comment\">//父结点成为当前结点</span><br>                    <span class=\"hljs-built_in\">ngx_rbtree_right_rotate</span>(root, sentinel, node);<br>                    <span class=\"hljs-comment\">//当前结点右旋</span><br>                &#125;<br><br>                <span class=\"hljs-built_in\">ngx_rbt_black</span>(node-&gt;parent);<span class=\"hljs-comment\">//当前结点染黑</span><br>                <span class=\"hljs-comment\">//当前结点父结点的父结点染红</span><br>                <span class=\"hljs-built_in\">ngx_rbt_red</span>(node-&gt;parent-&gt;parent);<br>                <span class=\"hljs-built_in\">ngx_rbtree_left_rotate</span>(root, sentinel, node-&gt;parent-&gt;parent);<span class=\"hljs-comment\">//当前结点的父结点的父结点左旋</span><br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-built_in\">ngx_rbt_black</span>(*root);<span class=\"hljs-comment\">//根结点染黑</span><br>&#125;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 然后是对应ngx_rbtree_insert_pt指针的基础的结点插入函数：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-function\"><span class=\"hljs-type\">void</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ngx_rbtree_insert_value</span><span class=\"hljs-params\">(<span class=\"hljs-type\">ngx_rbtree_node_t</span> *temp, <span class=\"hljs-type\">ngx_rbtree_node_t</span> *node,</span></span><br><span class=\"hljs-params\"><span class=\"hljs-function\">    <span class=\"hljs-type\">ngx_rbtree_node_t</span> *sentinel)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    <span class=\"hljs-type\">ngx_rbtree_node_t</span>  **p;<span class=\"hljs-comment\">//虽然无关紧要，但两层指针令人费解</span><br><br>    <span class=\"hljs-keyword\">for</span> ( ;; ) &#123;<span class=\"hljs-comment\">//无条件循环或者说死循环，等同于while(1)但节省了一个字符</span><br><br>        p = (node-&gt;key &lt; temp-&gt;key) ? &amp;temp-&gt;left : &amp;temp-&gt;right;<br><br>        <span class=\"hljs-keyword\">if</span> (*p == sentinel) &#123;<span class=\"hljs-comment\">//在二叉树中查找新结点合适的叶结点位置</span><br>            <span class=\"hljs-keyword\">break</span>;<br>        &#125;<br><br>        temp = *p;<br>    &#125;<br>    <span class=\"hljs-comment\">//令新结点占据合适的哨兵位置成为新的叶结点，染红，产生新哨兵</span><br>    *p = node;<br>    node-&gt;parent = temp;<br>    node-&gt;left = sentinel;<br>    node-&gt;right = sentinel;<br>    <span class=\"hljs-built_in\">ngx_rbt_red</span>(node);<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; ngx_rbtree_insert_timer_value<span style=\"font-family:宋体;\">函数跟</span><span style=\"font-family:Times New Roman;\">ngx_rbtree_insert_value</span><span style=\"font-family:宋体;\">函数唯一区别就是判断大小时，采用了两个值相减，避免溢出。</span></p>\n<p>&nbsp;&nbsp;&nbsp; 以上是插入结点涉及的函数，老实说我不太喜欢这么长的函数实现，换我自己写肯定分块了。分支操作太多，看代码逻辑已经乱了，我们需要画几个图。首先，如果树为空：</p>\n<p><img src=\"http://img.blog.csdn.net/20150806074055339\" alt=\"\" /><br /></p>\n<p>&nbsp;&nbsp;&nbsp; 如果树中只有一个根结点：</p>\n<img src=\"http://img.blog.csdn.net/20150806074132691\" alt=\"\" />\n\n<p>&nbsp;&nbsp;&nbsp; 如果<span style=\"font-family:Times New Roman;\">C&gt;A</span><span style=\"font-family:宋体;\">：</span></p>\n<img src=\"http://img.blog.csdn.net/20150806074207378\" alt=\"\" />\n\n<p>&nbsp;&nbsp;&nbsp; 如果<span style=\"font-family:Times New Roman;\">C&lt;B&lt;A</span><span style=\"font-family:宋体;\">，</span><span style=\"font-family:Times New Roman;\">C</span><span style=\"font-family:宋体;\">染红，</span><span style=\"font-family:Times New Roman;\">B</span><span style=\"font-family:宋体;\">染黑</span><span style=\"font-family:Times New Roman;\">A</span><span style=\"font-family:宋体;\">染红，</span><span style=\"font-family:Times New Roman;\">A</span><span style=\"font-family:宋体;\">右旋。右旋函数如下：</span></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-function\"><span class=\"hljs-type\">static</span> ngx_inline <span class=\"hljs-type\">void</span></span><br><span class=\"hljs-function\"><span class=\"hljs-title\">ngx_rbtree_right_rotate</span><span class=\"hljs-params\">(<span class=\"hljs-type\">ngx_rbtree_node_t</span> **root, <span class=\"hljs-type\">ngx_rbtree_node_t</span> *sentinel,</span></span><br><span class=\"hljs-params\"><span class=\"hljs-function\">    <span class=\"hljs-type\">ngx_rbtree_node_t</span> *node)</span></span><br><span class=\"hljs-function\"></span>&#123;<br>    <span class=\"hljs-type\">ngx_rbtree_node_t</span>  *temp;<br><br>    temp = node-&gt;left;<br>    node-&gt;left = temp-&gt;right;<span class=\"hljs-comment\">//左子结点指向原左子结点的右结点</span><br><br>    <span class=\"hljs-keyword\">if</span> (temp-&gt;right != sentinel) &#123;<span class=\"hljs-comment\">//如果左子结点的右结点不为哨兵</span><br>        temp-&gt;right-&gt;parent = node;<span class=\"hljs-comment\">//左子结点的右子结点挂在右旋结点上</span><br>    &#125;<br><br>    temp-&gt;parent = node-&gt;parent;<span class=\"hljs-comment\">//左子结点挂在右旋结点的父结点上</span><br><br>    <span class=\"hljs-keyword\">if</span> (node == *root) &#123;<span class=\"hljs-comment\">//如果右旋结点为根节点</span><br>        *root = temp;<span class=\"hljs-comment\">//根节点赋为左子结点</span><br><br>    &#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (node == node-&gt;parent-&gt;right) &#123;<span class=\"hljs-comment\">//如果右旋结点为右子结点</span><br>        node-&gt;parent-&gt;right = temp;<span class=\"hljs-comment\">//左子结点挂父结点右边</span><br><br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//否则左子结点挂父结点左边</span><br>        node-&gt;parent-&gt;left = temp;<br>    &#125;<br><br>    temp-&gt;right = node;<span class=\"hljs-comment\">//右旋结点挂左子结点右边</span><br>    node-&gt;parent = temp;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 显然<span style=\"font-family:Times New Roman;\">B</span><span style=\"font-family:宋体;\">将成为新的根，左</span><span style=\"font-family:Times New Roman;\">C</span><span style=\"font-family:宋体;\">右</span><span style=\"font-family:Times New Roman;\">A</span><span style=\"font-family:宋体;\">：</span></p>\n<img src=\"http://img.blog.csdn.net/20150806074443292\" alt=\"\" />\n\n<p>&nbsp;&nbsp;&nbsp; 如果<span style=\"font-family:Times New Roman;\">B&lt;C&lt;A</span><span style=\"font-family:宋体;\">，会先做一次左旋再做一次右旋，其实除开染色过程，我觉得这跟</span><span style=\"font-family:Times New Roman;\">AVL</span><span style=\"font-family:宋体;\">树的插入过程没有什么区别：</span></p>\n<img src=\"http://img.blog.csdn.net/20150806074520668\" alt=\"\" />\n\n<p>&nbsp;&nbsp;&nbsp; 其他的插入情景要么与以上几个对称，要么发生在树的其他子树中，实际过程完全一样。LL<span style=\"font-family:宋体;\">型右旋，</span><span style=\"font-family:Times New Roman;\">RR</span><span style=\"font-family:宋体;\">型左旋，</span><span style=\"font-family:Times New Roman;\">LR</span><span style=\"font-family:宋体;\">型先右旋后左旋，</span><span style=\"font-family:Times New Roman;\">RL</span><span style=\"font-family:宋体;\">型先左旋后右旋。</span>与<span style=\"font-family:Times New Roman;\">AVL</span><span style=\"font-family:宋体;\">树不同的是，插入结点时红黑树左旋或右旋的判定条件明确为附近一两个结点的颜色，其他过程没有任何区别。</span></p>\n<h2 id=\"2-4-红黑树的结点删除\"><a href=\"#2-4-红黑树的结点删除\" class=\"headerlink\" title=\"2.4 红黑树的结点删除\"></a>2.4 红黑树的结点删除</h2><p>&nbsp;&nbsp;&nbsp; 据说红黑树和<span style=\"font-family:Times New Roman;\">AVL</span><span style=\"font-family:宋体;\">树的区别主要体现在删除节点时，我们就来看一看。</span>我刚说什么来着，删除结点的函数体更长了，足足<span style=\"font-family:Times New Roman;\">165</span><span style=\"font-family:宋体;\">行，我决定分段研究，</span>先看第一部分：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-keyword\">if</span> (node-&gt;left == sentinel) &#123;<span class=\"hljs-comment\">//如果左子结点是哨兵或左右子结点都是哨兵</span><br>    temp = node-&gt;right;<span class=\"hljs-comment\">//获得右子结点，后面让它接替node位置</span><br>    subst = node;<span class=\"hljs-comment\">//node赋给subst</span><br><br>&#125; <span class=\"hljs-keyword\">else</span> <span class=\"hljs-keyword\">if</span> (node-&gt;right == sentinel) &#123;<span class=\"hljs-comment\">//如果右子结点是哨兵</span><br>    temp = node-&gt;left;<span class=\"hljs-comment\">//获得左子结点，后面让它接替node位置</span><br>    subst = node;<span class=\"hljs-comment\">//node赋给subst</span><br><br>&#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//如果左右子结点都不是哨兵</span><br>    subst = <span class=\"hljs-built_in\">ngx_rbtree_min</span>(node-&gt;right, sentinel);<span class=\"hljs-comment\">//获得右子树中最小的结点</span><br><br>    <span class=\"hljs-keyword\">if</span> (subst-&gt;left != sentinel) &#123;<span class=\"hljs-comment\">//如果右子树的最小结点的左子结点不是哨兵</span><br>        temp = subst-&gt;left;<span class=\"hljs-comment\">//获得右子树的最小结点的左子结点</span><br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//否则获得右子树最小结点的右子结点</span><br>        temp = subst-&gt;right;<br>    &#125;<span class=\"hljs-comment\">//看起来subst将被从原位置删掉然后接替node的位置</span><br>&#125;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 下面我们来看看<span style=\"font-family:Times New Roman;\">temp</span><span style=\"font-family:宋体;\">和</span><span style=\"font-family:Times New Roman;\">subst</span><span style=\"font-family:宋体;\">要干什么用：</span></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-keyword\">if</span> (subst == *root) &#123;<span class=\"hljs-comment\">//如果subst是根</span><br>    *root = temp;<span class=\"hljs-comment\">//temp接替根</span><br>    <span class=\"hljs-built_in\">ngx_rbt_black</span>(temp);<span class=\"hljs-comment\">//染黑temp</span><br><br>    <span class=\"hljs-comment\">/* DEBUG stuff */</span><br>    node-&gt;left = <span class=\"hljs-literal\">NULL</span>;<span class=\"hljs-comment\">//清空了待删结点</span><br>    node-&gt;right = <span class=\"hljs-literal\">NULL</span>;<br>    node-&gt;parent = <span class=\"hljs-literal\">NULL</span>;<br>    node-&gt;key = <span class=\"hljs-number\">0</span>;<br><br>    <span class=\"hljs-keyword\">return</span>;<br>&#125;<br><br>red = <span class=\"hljs-built_in\">ngx_rbt_is_red</span>(subst);<span class=\"hljs-comment\">//获得subst是否是红色</span><br><br><span class=\"hljs-keyword\">if</span> (subst == subst-&gt;parent-&gt;left) &#123;<span class=\"hljs-comment\">//如果subst是左子结点</span><br>    subst-&gt;parent-&gt;left = temp;<span class=\"hljs-comment\">//把接替结点挂到subst位置</span><br><br>&#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//如果subst是右子结点</span><br>    subst-&gt;parent-&gt;right = temp;<span class=\"hljs-comment\">//把接替结点挂到subst位置</span><br>&#125;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 下一段：</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-keyword\">if</span> (subst == node) &#123;<span class=\"hljs-comment\">//如果subst是待删结点</span><br>    temp-&gt;parent = subst-&gt;parent;<span class=\"hljs-comment\">//接替结点直接接替，删除完成</span><br><br>&#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//如果subst不是待删结点</span><br>     <span class=\"hljs-keyword\">if</span> (subst-&gt;parent == node) &#123;<span class=\"hljs-comment\">//如果subst的父结点就是待删结点</span><br>        temp-&gt;parent = subst;<span class=\"hljs-comment\">//接替结点挂在subst上</span><br>     &#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//如果待删结点比subst的父结点更高</span><br>        temp-&gt;parent = subst-&gt;parent;<span class=\"hljs-comment\">//把接替结点挂在subst的父结点上</span><br>    &#125;<br>    <span class=\"hljs-comment\">//subst接替待删结点node的位置，复制待删结点跟周围结点的关系</span><br>    subst-&gt;left = node-&gt;left;<br>    subst-&gt;right = node-&gt;right;<br>    subst-&gt;parent = node-&gt;parent;<br>    <span class=\"hljs-built_in\">ngx_rbt_copy_color</span>(subst, node);<span class=\"hljs-comment\">//复制颜色</span><br><br>    <span class=\"hljs-keyword\">if</span> (node == *root) &#123;<span class=\"hljs-comment\">//如果待删结点是根</span><br>        *root = subst;<span class=\"hljs-comment\">//subst接替根</span><br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//如果待删结点不是根，subst接替它</span><br>        <span class=\"hljs-keyword\">if</span> (node == node-&gt;parent-&gt;left) &#123;<br>            node-&gt;parent-&gt;left = subst;<br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>            node-&gt;parent-&gt;right = subst;<br>        &#125;<br>    &#125;<br><br>    <span class=\"hljs-keyword\">if</span> (subst-&gt;left != sentinel) &#123;<span class=\"hljs-comment\">//如果subst左子结点不是哨兵</span><br>        subst-&gt;left-&gt;parent = subst;<span class=\"hljs-comment\">//subst的左子结点放弃node，挂上来</span><br>    &#125;<br><br>    <span class=\"hljs-keyword\">if</span> (subst-&gt;right != sentinel) &#123;<span class=\"hljs-comment\">//如果subst右子结点不是哨兵</span><br>        subst-&gt;right-&gt;parent = subst;<span class=\"hljs-comment\">//subst右子结点放弃node，挂上来</span><br>    &#125;<br>&#125;<br><span class=\"hljs-comment\">//清空待删结点node</span><br><span class=\"hljs-comment\">/* DEBUG stuff */</span><br>node-&gt;left = <span class=\"hljs-literal\">NULL</span>;<br>node-&gt;right = <span class=\"hljs-literal\">NULL</span>;<br>node-&gt;parent = <span class=\"hljs-literal\">NULL</span>;<br>node-&gt;key = <span class=\"hljs-number\">0</span>;<br><span class=\"hljs-comment\">//如果subst是红色，红黑树约束依然被遵守，删除工作就可以结束了</span><br><span class=\"hljs-keyword\">if</span> (red) &#123;<br>    <span class=\"hljs-keyword\">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 看起来结点的删除过程已经顺利完成了，但是如果<span style=\"font-family:Times New Roman;\">subst</span><span style=\"font-family:宋体;\">是黑色，我们需要修复红黑树的约束。下面这一段代码的主角是接替</span><span style=\"font-family:Times New Roman;\">subst</span><span style=\"font-family:宋体;\">位置的</span><span style=\"font-family:Times New Roman;\">temp</span><span style=\"font-family:宋体;\">结点：</span></p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><code class=\"hljs cpp\"><span class=\"hljs-comment\">//当subst的接替结点不是根且为黑色，循环</span><br><span class=\"hljs-keyword\">while</span> (temp != *root &amp;&amp; <span class=\"hljs-built_in\">ngx_rbt_is_black</span>(temp)) &#123;<br>    <span class=\"hljs-keyword\">if</span> (temp == temp-&gt;parent-&gt;left) &#123;<span class=\"hljs-comment\">//如果temp是左子结点</span><br>        w = temp-&gt;parent-&gt;right;<span class=\"hljs-comment\">//获得其右兄弟</span><br><br>        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">ngx_rbt_is_red</span>(w)) &#123;<span class=\"hljs-comment\">//如果temp的右兄弟是红色</span><br>            <span class=\"hljs-built_in\">ngx_rbt_black</span>(w);<span class=\"hljs-comment\">//染黑temp的右兄弟</span><br>            <span class=\"hljs-built_in\">ngx_rbt_red</span>(temp-&gt;parent);<span class=\"hljs-comment\">//染红temp的父结点</span><br>            <span class=\"hljs-comment\">//temp的父结点左旋</span><br>            <span class=\"hljs-built_in\">ngx_rbtree_left_rotate</span>(root, sentinel, temp-&gt;parent);<br>            w = temp-&gt;parent-&gt;right;<span class=\"hljs-comment\">//获得temp的新右兄弟</span><br>        &#125;<br>        <span class=\"hljs-comment\">//如果temp右兄弟的左右子结点都是黑的</span><br>        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">ngx_rbt_is_black</span>(w-&gt;left) &amp;&amp; <span class=\"hljs-built_in\">ngx_rbt_is_black</span>(w-&gt;right)) &#123;<br>            <span class=\"hljs-built_in\">ngx_rbt_red</span>(w);<span class=\"hljs-comment\">//染红temp的右兄弟</span><br>            temp = temp-&gt;parent;<span class=\"hljs-comment\">//获得temp的父结点为新temp</span><br><br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//如果temp右兄弟的子结点不全为黑</span><br>            <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">ngx_rbt_is_black</span>(w-&gt;right)) &#123;<span class=\"hljs-comment\">//如果其右子结点是黑色</span><br>                <span class=\"hljs-built_in\">ngx_rbt_black</span>(w-&gt;left);<span class=\"hljs-comment\">//染黑左子结点</span><br>                <span class=\"hljs-built_in\">ngx_rbt_red</span>(w);<span class=\"hljs-comment\">//染红temp的右兄弟</span><br>                <span class=\"hljs-built_in\">ngx_rbtree_right_rotate</span>(root, sentinel, w);<span class=\"hljs-comment\">//右兄弟右旋</span><br>                w = temp-&gt;parent-&gt;right;<span class=\"hljs-comment\">//获得temp的新右兄弟</span><br>            &#125;<br>            <span class=\"hljs-comment\">//temp右兄弟复制temp父结点颜色</span><br>            <span class=\"hljs-built_in\">ngx_rbt_copy_color</span>(w, temp-&gt;parent);<br>            <span class=\"hljs-built_in\">ngx_rbt_black</span>(temp-&gt;parent);<span class=\"hljs-comment\">//染黑temp父结点</span><br>            <span class=\"hljs-built_in\">ngx_rbt_black</span>(w-&gt;right);<span class=\"hljs-comment\">//染黑temp右兄弟的右子结点</span><br>            <span class=\"hljs-comment\">//temp父结点左旋</span><br>            <span class=\"hljs-built_in\">ngx_rbtree_left_rotate</span>(root, sentinel, temp-&gt;parent);<br>            temp = *root;<span class=\"hljs-comment\">//获得根</span><br>        &#125;<br>    &#125; <span class=\"hljs-keyword\">else</span> &#123;<span class=\"hljs-comment\">//如果temp是右子结点，做对称的事</span><br>        w = temp-&gt;parent-&gt;left;<br><br>        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">ngx_rbt_is_red</span>(w)) &#123;<br>            <span class=\"hljs-built_in\">ngx_rbt_black</span>(w);<br>            <span class=\"hljs-built_in\">ngx_rbt_red</span>(temp-&gt;parent);<br>            <span class=\"hljs-built_in\">ngx_rbtree_right_rotate</span>(root, sentinel, temp-&gt;parent);<br>            w = temp-&gt;parent-&gt;left;<br>        &#125;<br><br>        <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">ngx_rbt_is_black</span>(w-&gt;left) &amp;&amp; <span class=\"hljs-built_in\">ngx_rbt_is_black</span>(w-&gt;right)) &#123;<br>            <span class=\"hljs-built_in\">ngx_rbt_red</span>(w);<br>            temp = temp-&gt;parent;<br><br>        &#125; <span class=\"hljs-keyword\">else</span> &#123;<br>            <span class=\"hljs-keyword\">if</span> (<span class=\"hljs-built_in\">ngx_rbt_is_black</span>(w-&gt;left)) &#123;<br>                <span class=\"hljs-built_in\">ngx_rbt_black</span>(w-&gt;right);<br>                <span class=\"hljs-built_in\">ngx_rbt_red</span>(w);<br>                <span class=\"hljs-built_in\">ngx_rbtree_left_rotate</span>(root, sentinel, w);<br>                w = temp-&gt;parent-&gt;left;<br>            &#125;<br><br>            <span class=\"hljs-built_in\">ngx_rbt_copy_color</span>(w, temp-&gt;parent);<br>            <span class=\"hljs-built_in\">ngx_rbt_black</span>(temp-&gt;parent);<br>            <span class=\"hljs-built_in\">ngx_rbt_black</span>(w-&gt;left);<br>            <span class=\"hljs-built_in\">ngx_rbtree_right_rotate</span>(root, sentinel, temp-&gt;parent);<br>            temp = *root;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class=\"hljs-built_in\">ngx_rbt_black</span>(temp);<span class=\"hljs-comment\">//染黑当前temp</span><br></code></pre></td></tr></table></figure>\n<p>&nbsp;&nbsp;&nbsp; 跟插入结点时一样乱，我们梳理一下。</p>\n<p>&nbsp;&nbsp;&nbsp; 首先忽略红黑树的约束进行删除：<br>&nbsp;&nbsp;&nbsp; ①如果删除的是一个叶结点，即没有后继或后继全为哨兵的结点，直接删除即可；<br>&nbsp;&nbsp;&nbsp; ②如果只有一个后继，让其替换待删除结点即可；<br>&nbsp;&nbsp;&nbsp; ③如果有两个后继，需要从树的边缘选择一个结点，有两种等价的选择，待删结点左子树的最大结点和右子树的最小结点，<span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">选择的是后者，以这个结点的键与值（</span><span style=\"font-family:Times New Roman;\">key</span><span style=\"font-family:宋体;\">与</span><span style=\"font-family:Times New Roman;\">value&#x2F;data</span><span style=\"font-family:宋体;\">）替换待删结点的键与值，然后删除这个替身。</span></p>\n<p>&nbsp;&nbsp;&nbsp; 不论是①、②情景中的待删结点还是③情景中替身，在源码中都是subst。下面要围绕着它来进行讨论。</p>\n<p>&nbsp;&nbsp;&nbsp; 以上是不考虑红黑树平衡性的纯拓扑结构变动。下面要考虑是否调整树的拓扑结构使树重新平衡，是否调整结点的颜色使树重新符合红黑树的约束条件。我们知道红黑树有一条关键约束是任意结点到其子树中叶结点的简单路径中黑色结点数相同。那么如果<span style=\"font-family:Times New Roman;\">subst</span><span style=\"font-family:宋体;\">是一个红色结点，我们不需要对红黑树做任何调整，它仍是一棵红黑树；如果</span><span style=\"font-family:Times New Roman;\">subst</span><span style=\"font-family:宋体;\">是黑色的，所有经过</span><span style=\"font-family:Times New Roman;\">subst</span><span style=\"font-family:宋体;\">的简单路径上都会少一个黑色结点数，所以需要进行调整。</span></p>\n<p>&nbsp;&nbsp;&nbsp; 下面来根据不同情景分情况讨论，因为二叉树的情景左右颠倒时调整方式也可以左右颠倒，我们只讨论<span style=\"font-family:Times New Roman;\">subst</span><span style=\"font-family:宋体;\">是左子结点的情况。设刚接替</span><span style=\"font-family:Times New Roman;\">subst</span><span style=\"font-family:宋体;\">的</span><span style=\"font-family:Times New Roman;\">temp</span><span style=\"font-family:宋体;\">为</span><span style=\"font-family:Times New Roman;\">X</span><span style=\"font-family:宋体;\">，</span><span style=\"font-family:Times New Roman;\">X</span><span style=\"font-family:宋体;\">的新右兄弟为</span><span style=\"font-family:Times New Roman;\">W</span><span style=\"font-family:宋体;\">。从经过简化的源码来看，关于结点颜色的变化很令人费解，我们不妨先来看一看：</span><br>&nbsp;&nbsp;&nbsp; ①W为红色：将W染黑，将X与W的父结点X-&gt;parent染红，X-&gt;parent左旋，W重设为X的新右兄弟，然后转入情景①、②或③；<br>&nbsp;&nbsp;&nbsp; ②W为黑色，W两个后继都是黑色：将W染红，X重设为X-&gt;parent；<br>&nbsp;&nbsp;&nbsp; ③W为黑色，W右子结点为黑色：将W左子结点染黑，将W染红，W右旋，W重设为X的新右兄弟，然后将X-&gt;parent的颜色赋给W，将X-&gt;parent染黑，X-&gt;parent左旋，根赋给temp；<br>&nbsp;&nbsp;&nbsp; ④W为黑色，W右子结点为红色：将W左子结点染黑，将W染红，W右旋，W重设为X的新右兄弟，然后将X-&gt;parent的颜色赋给W，将X-&gt;parent染黑，将W右子结点染黑，X-&gt;parent左旋，根赋给temp。</p>\n<p>&nbsp;&nbsp;&nbsp; 最后还要把temp染黑。我们可以看到情景①中进行了一次左旋，情景②只进行了染色，情景③、④都进行了一次右旋和一次左旋。情景①处理结束时一定还要转入别的情景，情景②、③、④的出现则标志着本次调整的结束。那么，红黑树删除结点后的调整过程中，依情景①循环出现的次数，调整过程中旋转的最多见的次数将是1次、2次、3次，再往上次数越多越罕见（依情景①循环出现的次数），最多旋转次数将可能到达树高即log2n次。生产环境中，删除结点后平均每次调整中旋转的次数就像分析源码之前提到的，将是常数规模的。</p>\n<p>&nbsp;&nbsp;&nbsp; 接下来我打算以逐步翻新版本的方式重写红黑树，更精细、直观地了解红黑树这一数据结构。而在重写之前，我们需要了解，nginx的红黑中所有的叶结点，都是哨兵（sentinel），这在调整红黑树时达成了对红黑树的一种优化。通过增加一层全黑的子结点，红黑树中实际有值的子树里，就允许在子结点出现红色结点了。虽然我没有证明，但这常数规模地增加了删除结点时的旋转次数，也促进了插入新结点时进行调整的概率（增加了在红色结点下插入新结点的概率），同样增加了旋转的次数。而旋转将压缩红黑树子树的高度，提高查询效率。</p>\n<p>&nbsp;&nbsp;&nbsp; 在由朴素到精致地重写红黑树的过程中，我将由少到多地考虑使用nginx对红黑树的优化，或者加入我自己的优化。</p>\n<p>&nbsp;&nbsp;&nbsp; <span style=\"color:#FF0000;\">从杭州回来后翻了CLRS（算法导论），发现：<br>&nbsp;&nbsp;&nbsp; 首先，nginx的红黑树中，sentinel结点并非独创的优化手段，CLRS的红黑树也是带哨兵的，可以说，一般的，我们令红黑树带哨兵。目的是更直截了当的满足红黑树的叶结点全黑约束，同时更方便标识树的边缘。</span></p>\n<p>&nbsp;&nbsp;&nbsp; <span style=\"color:#FF0000;\">其次，所有的叶结点都是由同一个哨兵结点代表，节省了空间开销，省去了叶结点逐一染色的麻烦。</span></p>\n<p>&nbsp;&nbsp;&nbsp; <span style=\"color:#FF0000;\">另外，之前我感到迷惑的static inline组合用法，在oschina.net获得了解释：<br>&nbsp;&nbsp;&nbsp; 1.inline函数是不能像传统的函数那样放在.c中然后在.h中给出接口在其余文件中调用的,因为inline函数其实是跟宏定义类似，被调用时尝试在调用处直接展开整个函数体，不存在所谓的函数入口。<br>&nbsp;&nbsp;&nbsp; 2.因为第一点，会出现一个问题，如果inline函数在两个不同的文件中出现。也就是说一个头文件被两个不同的源文件包含，则会出现重名，链接失败。static inline 的用法就能很好的解决这个问题。使用static修饰符，函数仅在文件内部可见，不会污染命名空间。可以理解为一个inline函数在不同的源文件里面生成了不同的实例，而且名字是完全相同的 。</span></p>\n<p>&nbsp;&nbsp;&nbsp; <span style=\"color:#FF0000;\">总结一下。功能上，我们需要微型函数被大量调用时尝试内联展开以节省压栈弹栈的开销；实践中，为了防止不同文件中函数同名时的链接错误，我们需要加上static关键字的限制。（尽管inline关键字的效果有所不同，c99标准和gcc下static inline组合是兼容的，效果相同）</span></p>\n<p>&nbsp;&nbsp;&nbsp; <span style=\"color:#FF0000;\">之前看到nginx源码中函数参数有双重指针一直很费解，今天研究了一下才发现原因。ngx_rbtree_t中，root经常使用双重结点指针，也就是根结点地址的地址。如果树的修改过程中，根结点地址被别的结点地址替换掉，需要重新设置根的地址<em>root。假设ngx_rbtree_t中的根地址参数是</em>root单层指针，进入函数体时将是一个值传递，出函数体时无论函数体中如何更改根的地址，都是无效的，只有对根结点内容的修改能保留下来。所以要么使用双重指针作为根地址的参数，要么提供树结构体的地址，变相提供双重指针作为参数，当然可以提供树的结构体对象本身作为参数，但是值传递是要复制整个值对象的，显然当结构体比较大时这样做将明显增加开销。nginx选择双重指针而非结构体指针来避免树结构体内的变量遍历寻址，进一步提高效率。</span></p>\n",
            "tags": [
                "nginx",
                "ngx_int_t",
                "rbtree",
                "C"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/07/23/%E3%80%90%E4%BA%8C%E3%80%91nginx%E6%BA%90%E7%A0%81%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%8F%E8%A7%88/",
            "url": "https://blog.bipedalbit.net/2015/07/23/%E3%80%90%E4%BA%8C%E3%80%91nginx%E6%BA%90%E7%A0%81%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84%E6%B5%8F%E8%A7%88/",
            "title": "【二】nginx源码文件结构浏览",
            "date_published": "2015-07-23T07:01:33.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 要读大项目的源码，最好还是先把项目文件组织结构弄清楚，这样后面找源码会比较方便，对整体项目的架构也能有一个具体一些的概念。</p>\n<span id=\"more\"></span>\n<p>&nbsp;&nbsp;&nbsp; 我下载的<span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">源码版本不可考，按日期来看是</span><span style=\"font-family:Times New Roman;\">2015</span><span style=\"font-family:宋体;\">年</span><span style=\"font-family:Times New Roman;\">7</span><span style=\"font-family:宋体;\">月的最新版本。解压包获得源码文件夹，进入根目录发现有几个子目录：</span><span style=\"font-family:Times New Roman;\">auto</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">conf</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">contrib</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">docs</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">misc</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">src</span><span style=\"font-family:宋体;\">。从字面上猜测，是自动机或脚本（</span><span style=\"font-family:Times New Roman;\">auto&nbsp;script</span><span style=\"font-family:宋体;\">）、配置文件（</span><span style=\"font-family:Times New Roman;\">configuration</span><span style=\"font-family:宋体;\">）、支持文件（</span><span style=\"font-family:Times New Roman;\">contributions</span><span style=\"font-family:宋体;\">）、文档（</span><span style=\"font-family:Times New Roman;\">document</span><span style=\"font-family:宋体;\">）、杂项（</span><span style=\"font-family:Times New Roman;\">miscellaneous</span><span style=\"font-family:宋体;\">）、源码（</span><span style=\"font-family:Times New Roman;\">source&nbsp;code</span><span style=\"font-family:宋体;\">）。</span></p>\n<h3 id=\"1、浏览源码文件夹根目录\"><a href=\"#1、浏览源码文件夹根目录\" class=\"headerlink\" title=\"1、浏览源码文件夹根目录\"></a>1<span style=\"font-family:宋体;\">、浏览源码文件夹根目录</span></h3><p>&nbsp;&nbsp;&nbsp; 按照惯例，我选择先看看文档，但是<span style=\"font-family:Times New Roman;\">doc</span><span style=\"font-family:宋体;\">子目录里并没有详细的离线文档，只有</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">官网的链接和一些看不懂的小文件。</span></p>\n<p>&nbsp;&nbsp;&nbsp; 杂项<span style=\"font-family:Times New Roman;\">misc</span><span style=\"font-family:宋体;\">里也只有看不太懂的一个</span><span style=\"font-family:Times New Roman;\">GNUmakefile</span><span style=\"font-family:宋体;\">和一个</span><span style=\"font-family:Times New Roman;\">README</span><span style=\"font-family:宋体;\">文件。</span></p>\n<p>&nbsp;&nbsp;&nbsp; contrib<span style=\"font-family:宋体;\">子目录里有一个</span><span style=\"font-family:Times New Roman;\">geo2nginx.pl</span><span style=\"font-family:宋体;\">（</span><span style=\"font-family:Times New Roman;\">geo</span><span style=\"font-family:宋体;\">模块的</span><span style=\"font-family:Times New Roman;\">CSV</span><span style=\"font-family:宋体;\">数据库格式转换</span><span style=\"font-family:Times New Roman;\">perl</span><span style=\"font-family:宋体;\">脚本），一套编码转换文件（包括两个编码映射表和一个编码转换</span><span style=\"font-family:Times New Roman;\">perl</span><span style=\"font-family:宋体;\">脚本），和</span><span style=\"font-family:Times New Roman;\">vim</span><span style=\"font-family:宋体;\">的</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">专用语法高亮配置文件。</span></p>\n<p>&nbsp;&nbsp;&nbsp; conf<span style=\"font-family:宋体;\">子目录里有几个编码映射表、变量映射表和一个服务器配置文件。</span></p>\n<p>&nbsp;&nbsp;&nbsp; auto<span style=\"font-family:宋体;\">子目录里有包括服务器安装脚本在内的许多脚本，现在看脚本还比较吃力，所以只简单浏览一下。我们发现</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">支持很多主流的操作系统平台：苹果的开源系统</span><span style=\"font-family:Times New Roman;\">darwin</span><span style=\"font-family:宋体;\">、重要的</span><span style=\"font-family:Times New Roman;\">Unix</span><span style=\"font-family:宋体;\">分支</span><span style=\"font-family:Times New Roman;\">freebsd</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">linux</span><span style=\"font-family:宋体;\">、大多数版本已经开源的又一个</span><span style=\"font-family:Times New Roman;\">Unix</span><span style=\"font-family:宋体;\">分支</span><span style=\"font-family:Times New Roman;\">solaris</span><span style=\"font-family:宋体;\">、用户占有率最高的</span><span style=\"font-family:Times New Roman;\">win32</span><span style=\"font-family:宋体;\">。</span></p>\n<p>&nbsp;&nbsp;&nbsp; src<span style=\"font-family:宋体;\">子目录果然都是需要研究的</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">的</span><span style=\"font-family:Times New Roman;\">C</span><span style=\"font-family:宋体;\">源码，下面我们会深入浏览。</span></p>\n<h3 id=\"2、浏览src子目录\"><a href=\"#2、浏览src子目录\" class=\"headerlink\" title=\"2、浏览src子目录\"></a>2<span style=\"font-family:宋体;\">、浏览</span><span style=\"font-family:Times New Roman;\">src</span><span style=\"font-family:宋体;\">子目录</span></h3><p>&nbsp;&nbsp;&nbsp; 还是来看一下<span style=\"font-family:Times New Roman;\">src</span><span style=\"font-family:宋体;\">子目录下有哪些子目录：</span><span style=\"font-family:Times New Roman;\">core</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">event</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">http</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">mail</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">misc</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">mysql</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">os</span><span style=\"font-family:宋体;\">、</span><span style=\"font-family:Times New Roman;\">stream</span><span style=\"font-family:宋体;\">。还是来按照字面意思猜测一下：核心（主函数、数据结构、主要方法）、事件（事件处理机制）、超文本传输协议（</span><span style=\"font-family:Times New Roman;\">http</span><span style=\"font-family:宋体;\">相关）、邮件（邮件相关）、杂项（</span><span style=\"font-family:Times New Roman;\">google&nbsp;perftools</span><span style=\"font-family:宋体;\">相关源码）、</span><span style=\"font-family:Times New Roman;\">mysql</span><span style=\"font-family:宋体;\">数据库、操作系统（</span><span style=\"font-family:Times New Roman;\">Unix</span><span style=\"font-family:宋体;\">和</span><span style=\"font-family:Times New Roman;\">Win32</span><span style=\"font-family:宋体;\">两类系统的系统调用程序源码）、流（意义不明）。看起来</span><span style=\"font-family:Times New Roman;\">.&#x2F;src&#x2F;core</span><span style=\"font-family:宋体;\">子目录对研究源码来说是一个不错的开始。</span></p>\n<p align=\"center\">\n    <span style=\"font-family:宋体;\"><img src=\"http://img.blog.csdn.net/20150723165913000?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center\" alt=\"\" /></span>\n    图<span style=\"font-family:Times New Roman;\">2&nbsp;nginx</span><span style=\"font-family:宋体;\">源码文件结构图</span>\n</p>",
            "tags": [
                "nginx"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/07/23/%E3%80%90%E4%B8%80%E3%80%91nginx%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0/",
            "url": "https://blog.bipedalbit.net/2015/07/23/%E3%80%90%E4%B8%80%E3%80%91nginx%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84%E6%A6%82%E8%BF%B0/",
            "title": "【一】nginx核心架构概述",
            "date_published": "2015-07-23T03:01:28.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 毕业前，毕设完成后，我闲极无聊接触了一下socket编程，用C++的Qt框架写了玩具一样的TCP和UDP通信客户端。跟直系学长电话聊天时被建议深挖一下socket，尝试走走后端或者架构师路线。问该怎么深挖，答研究源码，要学习socket相关知识，研究服务器源码是最合适不过的了。至于选择哪个服务器，经过考量调查，发现比起比较沉重庞大的apache，nginx更加小巧，也非常优秀。于是在开始正式吃源码之前，我先开始了一番自我科普工作。</p>\n<span id=\"more\"></span>\n<h3 id=\"1、进程模型\"><a href=\"#1、进程模型\" class=\"headerlink\" title=\"1、进程模型\"></a>1<span style=\"font-family:宋体;\">、进程模型</span></h3><p>&nbsp;&nbsp;&nbsp; 首先，默认的，与其他服务器一样，<span style=\"font-family:Times New Roman;\">Unix</span><span style=\"font-family:宋体;\">下的</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">也以</span><span style=\"font-family:Times New Roman;\">daemon</span><span style=\"font-family:宋体;\">（守护进程）的形式持续在后台运行。虽然</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">也可以以调试为目的关掉后台模式，使用前台模式，甚至可以通过配置取消</span><span style=\"font-family:Times New Roman;\">master</span><span style=\"font-family:宋体;\">进程（后面会详细解释），使</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">以单进程的形式工作。但是这些与</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">引以为傲的架构关系不大，这里按下不表。尽管</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">也支持多线程方式，我们还是着重来了解下其默认的多进程方式。</span></p>\n<p>&nbsp;&nbsp;&nbsp; nginx<span style=\"font-family:宋体;\">在启动后会创建一个</span><span style=\"font-family:Times New Roman;\">master</span><span style=\"font-family:宋体;\">进程（主进程）和若干个</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程（从进程）。</span><span style=\"font-family:Times New Roman;\">master</span><span style=\"font-family:宋体;\">进程主要负责管理</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程，具体来说就是接收来自管理员的信号并转发给对应</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程；监控</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程的工作状态，在</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程异常终止时重新创建并启动</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程。而</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程负责处理基本的网络事件。</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程之间优先级对等、相互独立，公平竞争来自客户端的请求，每个请求只由一个</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程处理。</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">进程模型示意图如图</span><span style=\"font-family:Times New Roman;\">1</span><span style=\"font-family:宋体;\">所示。</span></p>\n<p align=\"center\">\n    &nbsp;<img src=\"http://img.blog.csdn.net/20150723104541689?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/Center\" alt=\"\" />\n    图<span style=\"font-family:Times New Roman;\">1&nbsp;nginx</span><span style=\"font-family:宋体;\">进程模型示意图</span>\n</p>\n&nbsp;&nbsp;&nbsp; worker<span style=\"font-family:宋体;\">进程的数量可以进行设置，一般设置与</span><span style=\"font-family:Times New Roman;\">CPU</span><span style=\"font-family:宋体;\">核数一致，这一原则与</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">的事件处理模型有关。后面会继续介绍</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">的事件处理模型。</span>\n### 2<span style=\"font-family:宋体;\">、信号与请求</span>\n\n<p>&nbsp;&nbsp;&nbsp; nginx<span style=\"font-family:宋体;\">与外界互动无非通过两种接口界面：来自管理员的信号和来自客户端的请求。下面我们举例说明</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">是如何处理信号与请求的。</span></p>\n<p>&nbsp;&nbsp;&nbsp; 管理员要控制<span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">需要与</span><span style=\"font-family:Times New Roman;\">master</span><span style=\"font-family:宋体;\">进程通信，向</span><span style=\"font-family:Times New Roman;\">master</span><span style=\"font-family:宋体;\">进程发送指令信号即可。比如，</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">在</span><span style=\"font-family:Times New Roman;\">0.8</span><span style=\"font-family:宋体;\">版本之前使用</span><span style=\"font-family:Times New Roman;\">kill&nbsp;-HUP pid</span><span style=\"font-family:宋体;\">命令来重启</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">。使用这个命令重启</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">将实现从容地重启过程，期间服务不中断。</span><span style=\"font-family:Times New Roman;\">master</span><span style=\"font-family:宋体;\">进程在接到</span><span style=\"font-family:Times New Roman;\">HUP</span><span style=\"font-family:宋体;\">指令后首先会重新加载配置文件，然后启动新的</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程，向旧的</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程发送停止信号。这时新的</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程开始接收网络请求，旧的</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程停止接收新的请求，等到处理完当前请求后，旧的</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程就退出销毁了。在</span><span style=\"font-family:Times New Roman;\">0.8</span><span style=\"font-family:宋体;\">版本以后，</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">引入了一系列命令行参数以方便管理服务器，比如</span><span style=\"font-family:Times New Roman;\">.&#x2F;nginx&nbsp;-s&nbsp;reload</span><span style=\"font-family:宋体;\">和</span><span style=\"font-family:Times New Roman;\">.&#x2F;nginx&nbsp;-s&nbsp;stop</span><span style=\"font-family:宋体;\">，分别用来重启和停止</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">。执行操作命令时，我们实际上启动了一个新的</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">进程，这个进程在解析命令中的参数后，自行向</span><span style=\"font-family:Times New Roman;\">master</span><span style=\"font-family:宋体;\">进程发送相应的信号，达成与之前手动发送信号相同的效果。</span></p>\n<h3 id=\"3、请求与事件\"><a href=\"#3、请求与事件\" class=\"headerlink\" title=\"3、请求与事件\"></a>3<span style=\"font-family:宋体;\">、请求与事件</span></h3><p>&nbsp;&nbsp;&nbsp; 服务器最常处理的就是<span style=\"font-family:Times New Roman;\">80</span><span style=\"font-family:宋体;\">端口</span><span style=\"font-family:Times New Roman;\">http</span><span style=\"font-family:宋体;\">协议的请求了，</span> 以此为例说明一下<span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">处理请求的过程。首先，每一个</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程都是从</span><span style=\"font-family:Times New Roman;\">master</span><span style=\"font-family:宋体;\">进程</span><span style=\"font-family:Times New Roman;\">fork</span><span style=\"font-family:宋体;\">（分叉）而成的，</span><span style=\"font-family:Times New Roman;\">master</span><span style=\"font-family:宋体;\">进程中先建立好需要监听的</span><span style=\"font-family:Times New Roman;\">socket</span><span style=\"font-family:宋体;\">（套接字，即</span><span style=\"font-family:Times New Roman;\">IP</span><span style=\"font-family:宋体;\">地址</span><span style=\"font-family:Times New Roman;\">+</span><span style=\"font-family:宋体;\">端口号）和相应的</span><span style=\"font-family:Times New Roman;\">listenfd</span><span style=\"font-family:宋体;\">（监听文件描述符或句柄）。我们知道</span><span style=\"font-family:Times New Roman;\">socket</span><span style=\"font-family:宋体;\">通信中每个进程都要分配一个端口号，</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程的</span><span style=\"font-family:Times New Roman;\">socket</span><span style=\"font-family:宋体;\">分配工作就由</span><span style=\"font-family:Times New Roman;\">master</span><span style=\"font-family:宋体;\">进程来完成。所有</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程的</span><span style=\"font-family:Times New Roman;\">listenfd</span><span style=\"font-family:宋体;\">在新的连接到来时变得可读，为保证只有一个</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程处理连接，各</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程在注册</span><span style=\"font-family:Times New Roman;\">listenfd</span><span style=\"font-family:宋体;\">读事件前先要抢</span><span style=\"font-family:Times New Roman;\">accept_mutex</span><span style=\"font-family:宋体;\">（接受连接互斥锁），一个</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程抢注连接成功后，开始读取请求、解析请求、处理请求并反馈数据给客户端。</span></p>\n<h3 id=\"4、进程模型分析\"><a href=\"#4、进程模型分析\" class=\"headerlink\" title=\"4、进程模型分析\"></a>4<span style=\"font-family:宋体;\">、进程模型分析</span></h3><p>&nbsp;&nbsp;&nbsp; nginx<span style=\"font-family:宋体;\">使用但不仅仅使用多进程请求处理模型（</span><span style=\"font-family:Times New Roman;\">PPC</span><span style=\"font-family:宋体;\">），每个</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程一次只处理一个请求，使得请求间资源独立不需要上锁，进程间互不影响能并行处理请求。一个请求处理失败导致一个</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程异常退出，不会使服务中断，而是由</span><span style=\"font-family:Times New Roman;\">master</span><span style=\"font-family:宋体;\">进程立刻重新启动一个新的</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程，降低了服务器面临的整体风险，使服务更加稳定。但是相比多线程模型（</span><span style=\"font-family:Times New Roman;\">TPC</span><span style=\"font-family:宋体;\">），系统开销略大，效率略低，这需要借助别的手段来改进。</span></p>\n<h3 id=\"5、nginx的高并发机制——异步非阻塞事件机制\"><a href=\"#5、nginx的高并发机制——异步非阻塞事件机制\" class=\"headerlink\" title=\"5、nginx的高并发机制——异步非阻塞事件机制\"></a>5<span style=\"font-family:宋体;\">、nginx的高并发机制</span><span style=\"font-family:Times New Roman;\">——</span><span style=\"font-family:宋体;\">异步非阻塞事件机制</span></h3><p>&nbsp;&nbsp;&nbsp; IIS<span style=\"font-family:宋体;\">的事件处理机制是多线程，每个请求独占一个工作线程。由于多线程比较占用内存，线程间的上下文切换（反复的对寄存器组进行保护现场和恢复现场的操作）带来的</span><span style=\"font-family:Times New Roman;\">CPU</span><span style=\"font-family:宋体;\">开销也很大，多线程机制的服务器在面临数千并发量时，会给系统造成很大的压力，高并发性能并不算理想，当然如果硬件足够出色，能够提供足够的系统资源，系统压力也就不再是问题了。</span></p>\n<p>&nbsp;&nbsp;&nbsp; 我们深入到系统层面讨论一下多进程与多线程，阻塞式机制与非阻塞式机制的区别。</p>\n<p>&nbsp;&nbsp;&nbsp; 熟悉操作系统的同学应该了解，多线程的出现是为了在资源充足的情况下更充分的调度使用<span style=\"font-family:Times New Roman;\">CPU</span><span style=\"font-family:宋体;\">，尤其对提高多核</span><span style=\"font-family:Times New Roman;\">CPU</span><span style=\"font-family:宋体;\">的利用率十分有益。但是线程是系统任务的最小单位，而进程却是系统分配资源的最小单位，这就意味着多线程将面临一个很大的问题：当线程数增多，资源需求变大，这些线程的母进程可能无法立即一口气申请到足够所有线程使用的资源，而当系统手里没有足够的资源满足一个进程时，它会选择让整个进程都等着。这时即使系统资源足够一部分线程正常工作，母进程也无法申请到这些资源，导致所有线程一起等待。直白的说，使用多线程，进程内的线程间可以灵活的进行调度（虽然增加了线程死锁的风险和线程切换的开销），但是却无法保证母进程在逐渐庞大沉重时还能够在系统中得到合理的调度。由此可见，多线程确实可以提高</span><span style=\"font-family:Times New Roman;\">CPU</span><span style=\"font-family:宋体;\">利用率，但是并不是解决服务器高并发请求问题的理想解决方案，且不说在高并发状态下</span><span style=\"font-family:Times New Roman;\">CPU</span><span style=\"font-family:宋体;\">的高利用率也无法维持。以上是</span><span style=\"font-family:Times New Roman;\">IIS</span><span style=\"font-family:宋体;\">的多线程阻塞式事件机制。</span></p>\n<p>&nbsp;&nbsp;&nbsp; nginx<span style=\"font-family:宋体;\">的多进程机制保证了每个请求独立申请系统资源，一旦满足条件，每一个请求都可以立即被处理，即非阻塞处理。但是创建进程需要的资源开销会比线程多一些，为了节约进程数，</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">使用了一些进程调度算法，使</span><span style=\"font-family:Times New Roman;\">I&#x2F;O</span><span style=\"font-family:宋体;\">事件处理不仅仅靠多进程机制，而是非阻塞的多进程机制。下面我们就来具体的引入</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">的异步非阻塞事件处理机制。</span></p>\n<h3 id=\"6、epoll\"><a href=\"#6、epoll\" class=\"headerlink\" title=\"6、epoll\"></a>6<span style=\"font-family:宋体;\">、epoll</span></h3><p>&nbsp;&nbsp;&nbsp; Linux<span style=\"font-family:宋体;\">下，言高并发的高性能网络必</span><span style=\"font-family:Times New Roman;\">epoll</span><span style=\"font-family:宋体;\">，</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">也正是使用了</span><span style=\"font-family:Times New Roman;\">epoll</span><span style=\"font-family:宋体;\">模型作为网络事件的处理机制。我们先看看</span><span style=\"font-family:Times New Roman;\">epoll</span><span style=\"font-family:宋体;\">是怎么来的。</span></p>\n<p>&nbsp;&nbsp;&nbsp; 最早的调度方案是异步忙轮询方式，即持续的轮询<span style=\"font-family:Times New Roman;\">I&#x2F;O</span><span style=\"font-family:宋体;\">事件也就是遍历</span><span style=\"font-family:Times New Roman;\">socket</span><span style=\"font-family:宋体;\">集合的访问状态，显然服务器空闲时这一方案造成了无谓的</span><span style=\"font-family:Times New Roman;\">CPU</span><span style=\"font-family:宋体;\">开销。</span></p>\n<p>&nbsp;&nbsp;&nbsp; 后来，<span style=\"font-family:Times New Roman;\">select</span><span style=\"font-family:宋体;\">和</span><span style=\"font-family:Times New Roman;\">poll</span><span style=\"font-family:宋体;\">作为调度进程和提高</span><span style=\"font-family:Times New Roman;\">CPU</span><span style=\"font-family:宋体;\">利用率的代理先后出现，字面上看，一个是</span><span style=\"font-family:Times New Roman;\">“</span><span style=\"font-family:宋体;\">选择</span><span style=\"font-family:Times New Roman;\">”</span><span style=\"font-family:宋体;\">，一个是</span><span style=\"font-family:Times New Roman;\">“</span><span style=\"font-family:宋体;\">投票</span><span style=\"font-family:Times New Roman;\">”</span><span style=\"font-family:宋体;\">，它们的本质相同，都是轮询</span><span style=\"font-family:Times New Roman;\">socket</span><span style=\"font-family:宋体;\">集合并处理请求，与之前不同的地方在于，它们能够监视</span><span style=\"font-family:Times New Roman;\">I&#x2F;O</span><span style=\"font-family:宋体;\">事件，空闲时轮询线程将被阻塞，而一个或多个</span><span style=\"font-family:Times New Roman;\">I&#x2F;O</span><span style=\"font-family:宋体;\">事件到来时则被唤醒，摆脱了</span><span style=\"font-family:Times New Roman;\">“</span><span style=\"font-family:宋体;\">忙轮询</span><span style=\"font-family:Times New Roman;\">”</span><span style=\"font-family:宋体;\">的</span><span style=\"font-family:Times New Roman;\">“</span><span style=\"font-family:宋体;\">忙</span><span style=\"font-family:Times New Roman;\">”</span><span style=\"font-family:宋体;\">，成为异步轮询方式。</span><span style=\"font-family:Times New Roman;\">select&#x2F;poll</span><span style=\"font-family:宋体;\">模型轮询的是整个</span><span style=\"font-family:Times New Roman;\">FD</span><span style=\"font-family:宋体;\">（文件描述符）集合即</span><span style=\"font-family:Times New Roman;\">socket</span><span style=\"font-family:宋体;\">集合，网络事件处理效率随着并发请求数线性降低，所以使用一个宏来限制最大并发连接数。同时，</span><span style=\"font-family:Times New Roman;\">select&#x2F;poll</span><span style=\"font-family:宋体;\">模型的内核空间与用户空间通信方式为内存复制，带来较高的开销。以上缺点催生了新模型的产生。</span></p>\n<p>&nbsp;&nbsp;&nbsp; epoll<span style=\"font-family:宋体;\">可以认为是</span><span style=\"font-family:Times New Roman;\">event&nbsp;poll</span><span style=\"font-family:宋体;\">的简写，</span>是<span style=\"font-family:Times New Roman;\">Linux</span><span style=\"font-family:宋体;\">内核为处理大批量文件描述符而作了改进的</span><span style=\"font-family:Times New Roman;\">poll</span><span style=\"font-family:宋体;\">，是</span><span style=\"font-family:Times New Roman;\">Linux</span><span style=\"font-family:宋体;\">下多路复用</span><span style=\"font-family:Times New Roman;\">I</span>&#x2F;O<span style=\"font-family:宋体;\">接口</span><span style=\"font-family:Times New Roman;\">select&#x2F;poll</span><span style=\"font-family:宋体;\">的增强版本，它能显著提高程序在大量并发连接中只有少量活跃的情况下的系统</span><span style=\"font-family:Times New Roman;\">CPU</span><span style=\"font-family:宋体;\">利用率。</span>首先，<span style=\"font-family:Times New Roman;\">epoll</span><span style=\"font-family:宋体;\">没有最大并发连接数的限制，上限是可以打开的最大文件数，这与硬件内存大小有关，</span><span style=\"font-family:Times New Roman;\">1GB</span><span style=\"font-family:宋体;\">的机器上大约是</span><span style=\"font-family:Times New Roman;\">10w</span><span style=\"font-family:宋体;\">左右；然后是</span><span style=\"font-family:Times New Roman;\">epoll</span><span style=\"font-family:宋体;\">最显著的优点，它只对</span><span style=\"font-family:Times New Roman;\">“</span><span style=\"font-family:宋体;\">活跃</span><span style=\"font-family:Times New Roman;\">”</span><span style=\"font-family:宋体;\">的</span><span style=\"font-family:Times New Roman;\">socket</span><span style=\"font-family:宋体;\">进行操作，因为只有那些被内核</span><span style=\"font-family:Times New Roman;\">I&#x2F;O</span><span style=\"font-family:宋体;\">读写事件异步唤醒的</span><span style=\"font-family:Times New Roman;\">socket</span><span style=\"font-family:宋体;\">才被放入</span><span style=\"font-family:Times New Roman;\">ready</span><span style=\"font-family:宋体;\">队列，准备进入</span><span style=\"font-family:Times New Roman;\">worker</span><span style=\"font-family:宋体;\">进程被处理，这在实际生产环境中节省了大量轮询开销，极大的提高了事件处理效率；最后，</span><span style=\"font-family:Times New Roman;\">epoll</span><span style=\"font-family:宋体;\">使用共享内存（</span><span style=\"font-family:Times New Roman;\">MMAP</span><span style=\"font-family:宋体;\">）的方式实现内核空间与用户空间的通信，省掉了内存复制的开销。额外的，</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">中使用</span><span style=\"font-family:Times New Roman;\">epoll</span><span style=\"font-family:宋体;\">的</span><span style=\"font-family:Times New Roman;\">ET</span><span style=\"font-family:宋体;\">（边缘触发）工作模式即快速工作模式。</span><span style=\"font-family:Times New Roman;\">ET</span><span style=\"font-family:宋体;\">模式下，只支持非阻塞</span><span style=\"font-family:Times New Roman;\">socket</span><span style=\"font-family:宋体;\">，</span><span style=\"font-family:Times New Roman;\">FD</span><span style=\"font-family:宋体;\">就绪即由内核通过</span><span style=\"font-family:Times New Roman;\">epoll</span><span style=\"font-family:宋体;\">发送通知，经过某些操作使</span><span style=\"font-family:Times New Roman;\">FD</span><span style=\"font-family:宋体;\">不再是就绪状态时也会发送通知，但如果一直没有</span><span style=\"font-family:Times New Roman;\">I&#x2F;O</span><span style=\"font-family:宋体;\">操作导致</span><span style=\"font-family:Times New Roman;\">FD</span><span style=\"font-family:宋体;\">变为未就绪状态将不再发送通知。总的来说，</span><span style=\"font-family:Times New Roman;\">nginx</span><span style=\"font-family:宋体;\">在</span><span style=\"font-family:Times New Roman;\">Linux</span><span style=\"font-family:宋体;\">下是基于事件，利用</span><span style=\"font-family:Times New Roman;\">epoll</span><span style=\"font-family:宋体;\">处理网络事件的。</span></p>\n",
            "tags": [
                "nginx",
                "select/poll",
                "epoll"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/06/09/Qt%E5%87%BA%E7%8E%B0%E9%94%99%E8%AF%AFundefined-reference-to-vtable-for-XXXXX-XXX/",
            "url": "https://blog.bipedalbit.net/2015/06/09/Qt%E5%87%BA%E7%8E%B0%E9%94%99%E8%AF%AFundefined-reference-to-vtable-for-XXXXX-XXX/",
            "title": "Qt出现错误undefined reference to 'vtable for XXXXX.XXX'",
            "date_published": "2015-06-09T05:19:10.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 如果新建一个类，继承了某个类，在这个类的头文件中式没有 Q_OBJECT宏声明的，如果想使用signal-slot信号，就需要添加Q_OBJECT宏，但是添加了这个宏后，就可能会出现这种错误，“undefined reference to vtable for XXXXX”的编译错误。</p>\n<p>&nbsp;&nbsp;&nbsp; 这是因为在Makefile里面没有这个类并没有Q_OBJECT信息，所以在执行Makefile时候也就没有moc xxx.h这条命令，最终导致连接失败。</p>\n<p>&nbsp;&nbsp;&nbsp; 知道了这个原因后，解决方法就很简单了，重新运行qmake，生成Makefile，然后再编译就OK了。</p>\n",
            "tags": [
                "Qt",
                "signal-slot",
                "Q_OBJECT"
            ]
        },
        {
            "id": "https://blog.bipedalbit.net/2015/05/03/win-Linux%E4%B8%8B%E5%8E%BB%E6%8E%89codeigniter%E6%A1%86%E6%9E%B6%E7%BD%91%E7%AB%99URL%E4%B8%AD%E7%9A%84index-php/",
            "url": "https://blog.bipedalbit.net/2015/05/03/win-Linux%E4%B8%8B%E5%8E%BB%E6%8E%89codeigniter%E6%A1%86%E6%9E%B6%E7%BD%91%E7%AB%99URL%E4%B8%AD%E7%9A%84index-php/",
            "title": "win/Linux下去掉codeigniter框架网站URL中的index.php",
            "date_published": "2015-05-03T04:31:20.000Z",
            "content_html": "<p>&nbsp;&nbsp;&nbsp; 使用PHP的codeigniter框架后在试验阶段遇到的第一个问题就是，无法隐藏地址栏中的index.php，这让我浑身难受。多方调查之后有了一套解决方案。</p>\n<span id=\"more\"></span>\n<h1 id=\"Linux\"><a href=\"#Linux\" class=\"headerlink\" title=\"Linux:\"></a>Linux:</h1><h2 id=\"一-Apache\"><a href=\"#一-Apache\" class=\"headerlink\" title=\"一.Apache\"></a>一.Apache</h2><h3 id=\"1-启用rewrite模块\"><a href=\"#1-启用rewrite模块\" class=\"headerlink\" title=\"1.启用rewrite模块\"></a>1.启用rewrite模块</h3><p>&nbsp;&nbsp;&nbsp; 手动启用是在Apache配置文件里把“LoadModule rewrite_module modules&#x2F;mod_rewrite.so”解注释。<br>&nbsp;&nbsp;&nbsp; 一些LAMP套件也提供更方便的模块管理。</p>\n<h3 id=\"2-rewrite规则设置\"><a href=\"#2-rewrite规则设置\" class=\"headerlink\" title=\"2.rewrite规则设置\"></a>2.rewrite规则设置</h3><p>&nbsp;&nbsp;&nbsp; 在 CI 的根目录下，即在 index.php ，system的同级目录下，建立.htaccess，直接建立该文件名不会成功，可以从application或system文件夹里复制一个过来，再修改内容。<br>&nbsp;&nbsp;&nbsp; 内容如下（ CI 手册上也有介绍）：</p>\n<pre><code class=\"hljs\">RewriteEngine On\nRewriteCond %&#123;REQUEST_FILENAME&#125; !-f\nRewriteCond %&#123;REQUEST_FILENAME&#125; !-d\nRewriteRule ^(.*)$ index.php/$1 [L]\n</code></pre>\n<p>&nbsp;&nbsp;&nbsp; <strong>如果.htaccess文件不是在www的根目录下，例如是： <a href=\"http://localhost/123/\">http://localhost/123/</a> index.php ，第三行需要改写为</strong><br>&nbsp;&nbsp;&nbsp; <code>RewriteRule ^(.*)$ /123/ index.php /$1 [L]</code></p>\n<h3 id=\"3-配置codeigniter\"><a href=\"#3-配置codeigniter\" class=\"headerlink\" title=\"3.配置codeigniter\"></a>3.配置codeigniter</h3><p>&nbsp;&nbsp;&nbsp; 找到CI文件夹&#x2F;application&#x2F;config&#x2F;config.php。<br>&nbsp;&nbsp;&nbsp; <code>$config[&#39;index_page&#39;] =&quot; index.php &quot;;</code>改写成<code>$config[&#39;index_page&#39;] = &quot;&quot;; </code></p>\n<h3 id=\"4-重启Apache\"><a href=\"#4-重启Apache\" class=\"headerlink\" title=\"4.重启Apache\"></a>4.重启Apache</h3><p>&nbsp;&nbsp;&nbsp; 这个各显神通，不累述，如Ubuntu的<code> $ sudo /etc/init.d/apache2 restart</code></p>\n<h2 id=\"二-nginx\"><a href=\"#二-nginx\" class=\"headerlink\" title=\"二.nginx\"></a>二.nginx</h2><h3 id=\"1-rewrite规则设置\"><a href=\"#1-rewrite规则设置\" class=\"headerlink\" title=\"1.rewrite规则设置\"></a>1.rewrite规则设置</h3><p>&nbsp;&nbsp;&nbsp; 修改nginx配置文件，在nginx.conf的SERVER段中添加如下代码：</p>\n<pre><code class=\"hljs\">location /&#123;\n   if (-f $request_filename) &#123;\n       expires max;\n       break;\n   &#125;\n   if (!-e $request_filename) &#123;\n       rewrite ^/(.*)$ /index.php/$1 last;\n   &#125;\n&#125;\n</code></pre>\n<h3 id=\"2-3同上\"><a href=\"#2-3同上\" class=\"headerlink\" title=\"2.3同上\"></a>2.3同上</h3><h3 id=\"4-重启nginx\"><a href=\"#4-重启nginx\" class=\"headerlink\" title=\"4.重启nginx\"></a>4.重启nginx</h3><p>&nbsp;&nbsp;&nbsp; <code>/usr/local/nginx/sbin/nginx -s reload</code></p>\n<h1 id=\"Windows：\"><a href=\"#Windows：\" class=\"headerlink\" title=\"Windows：\"></a>Windows：</h1><h2 id=\"一-IIS7\"><a href=\"#一-IIS7\" class=\"headerlink\" title=\"一.IIS7\"></a>一.IIS7</h2><h3 id=\"1-配置web-config\"><a href=\"#1-配置web-config\" class=\"headerlink\" title=\"1.配置web.config\"></a>1.配置web.config</h3><pre><code class=\"hljs\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;configuration&gt;\n    &lt;system.webServer&gt;\n        &lt;rewrite&gt;\n            &lt;rules&gt;\n                &lt;rule name=&quot;OrgPage&quot; stopProcessing=&quot;true&quot;&gt;\n                    &lt;match url=&quot;^(.*)$&quot; /&gt;\n                    &lt;conditions logicalGrouping=&quot;MatchAll&quot;&gt;\n                    &lt;add input=&quot;&#123;HTTP_HOST&#125;&quot; pattern=&quot;^(.*)$&quot; /&gt;\n                    &lt;add input=&quot;&#123;REQUEST_FILENAME&#125;&quot; matchType=&quot;IsFile&quot; negate=&quot;true&quot; /&gt;\n                    &lt;add input=&quot;&#123;REQUEST_FILENAME&#125;&quot; matchType=&quot;IsDirectory&quot; negate=&quot;true&quot; /&gt;\n                    &lt;/conditions&gt;\n                    &lt;action type=&quot;Rewrite&quot; url=&quot;index.php/&#123;R:1&#125;&quot; /&gt;\n                &lt;/rule&gt;\n            &lt;/rules&gt;\n        &lt;/rewrite&gt;\n    &lt;/system.webServer&gt;\n&lt;/configuration&gt;\n</code></pre>\n<h3 id=\"2-配置codeigniter\"><a href=\"#2-配置codeigniter\" class=\"headerlink\" title=\"2.配置codeigniter\"></a>2.配置codeigniter</h3><p>&nbsp;&nbsp;&nbsp; 找到CI文件夹&#x2F;application&#x2F;config&#x2F;config.php。<br>&nbsp;&nbsp;&nbsp; <code>$config[&#39;index_page&#39;] =&quot; index.php &quot;;</code>改写成<code>$config[&#39;index_page&#39;] = &quot;&quot;; </code></p>\n<h2 id=\"二-Apache\"><a href=\"#二-Apache\" class=\"headerlink\" title=\"二.Apache\"></a>二.Apache</h2><h3 id=\"1-启用rewrite模块-1\"><a href=\"#1-启用rewrite模块-1\" class=\"headerlink\" title=\"1.启用rewrite模块\"></a>1.启用rewrite模块</h3><p>&nbsp;&nbsp;&nbsp; 手动启用是在Apache配置文件里把“LoadModule rewrite_module modules&#x2F;mod_rewrite.so”解注释。<br>&nbsp;&nbsp;&nbsp; 一些WAMP套件也提供更方便的模块管理。</p>\n<h3 id=\"2-rewrite规则设置-1\"><a href=\"#2-rewrite规则设置-1\" class=\"headerlink\" title=\"2.rewrite规则设置\"></a>2.rewrite规则设置</h3><p>&nbsp;&nbsp;&nbsp; 找到Apache的虚拟主机配置文件，如Apache-20\\conf\\extra\\httpd-vhosts.conf。<br>&nbsp;&nbsp;&nbsp; 修改要配置的虚拟主机的Directory标签，如：</p>\n<pre><code class=\"hljs\">&lt;Directory G:/PHP/123&gt;\n    #隐藏index.php相关\n    RewriteEngine On\n    RewriteCond %&#123;REQUEST_FILENAME&#125; !-f\n    RewriteCond %&#123;REQUEST_FILENAME&#125; !-d\n    RewriteRule ^(.*)$ index.php/$1 [L]\n    Options FollowSymLinks\n    #访问权限设置\n    #不允许别人修改页面\n    AllowOverride None\n    #依次考察允许和拒绝ip访问的设置情况\n    order allow,deny\n    #允许来自所有ip的访问\n    Allow from all\n    #deny from 202.18 即拒绝来自202.18打头的ip的访问\n&lt;/Directory&gt;\n</code></pre>\n<h3 id=\"3-配置codeigniter-1\"><a href=\"#3-配置codeigniter-1\" class=\"headerlink\" title=\"3.配置codeigniter\"></a>3.配置codeigniter</h3><p>&nbsp;&nbsp;&nbsp; 找到CI文件夹&#x2F;application&#x2F;config&#x2F;config.php。<br>&nbsp;&nbsp;&nbsp; <code>$config[&#39;index_page&#39;] =&quot; index.php &quot;;</code>改写成<code>$config[&#39;index_page&#39;] = &quot;&quot;; </code></p>\n<h3 id=\"4-重启Apache-1\"><a href=\"#4-重启Apache-1\" class=\"headerlink\" title=\"4.重启Apache\"></a>4.重启Apache</h3><p>&nbsp;&nbsp;&nbsp; win下Apache有图形界面，很方便。</p>\n",
            "tags": [
                "nginx",
                "codeigniter",
                "php",
                "IIS7",
                "apache"
            ]
        }
    ]
}